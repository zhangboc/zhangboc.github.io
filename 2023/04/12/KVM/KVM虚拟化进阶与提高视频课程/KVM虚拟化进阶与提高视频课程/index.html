<!DOCTYPE html>

<html lang="en">

<head>
  
  <meta name="baidu-site-verification" content="code-J1Qg17G6wT" />
  <title>KVM虚拟化进阶与提高视频课程 - Hexo</title>
  <meta charset="UTF-8">
  <meta name="description" content="">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5">
  
  

    <!-- Site Verification -->
    <meta name="baidu-site-verification" content="code-J1Qg17G6wT" />

  <link rel="shortcut icon" href="/images/head/head.jpg" type="image/png" />
  <meta property="og:type" content="article">
<meta property="og:title" content="KVM虚拟化进阶与提高视频课程">
<meta property="og:url" content="https://zhangboc.github.io/2023/04/12/KVM/KVM%E8%99%9A%E6%8B%9F%E5%8C%96%E8%BF%9B%E9%98%B6%E4%B8%8E%E6%8F%90%E9%AB%98%E8%A7%86%E9%A2%91%E8%AF%BE%E7%A8%8B/KVM%E8%99%9A%E6%8B%9F%E5%8C%96%E8%BF%9B%E9%98%B6%E4%B8%8E%E6%8F%90%E9%AB%98%E8%A7%86%E9%A2%91%E8%AF%BE%E7%A8%8B/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://zhangboc.github.io/images/KVM%E8%99%9A%E6%8B%9F%E5%8C%96%E8%BF%9B%E9%98%B6%E4%B8%8E%E6%8F%90%E9%AB%98%E8%A7%86%E9%A2%91%E8%AF%BE%E7%A8%8B/1.jpg">
<meta property="og:image" content="https://zhangboc.github.io/images/KVM%E8%99%9A%E6%8B%9F%E5%8C%96%E8%BF%9B%E9%98%B6%E4%B8%8E%E6%8F%90%E9%AB%98%E8%A7%86%E9%A2%91%E8%AF%BE%E7%A8%8B/2.jpg">
<meta property="og:image" content="https://zhangboc.github.io/images/KVM%E8%99%9A%E6%8B%9F%E5%8C%96%E8%BF%9B%E9%98%B6%E4%B8%8E%E6%8F%90%E9%AB%98%E8%A7%86%E9%A2%91%E8%AF%BE%E7%A8%8B/3.jpg">
<meta property="og:image" content="https://zhangboc.github.io/images/KVM%E8%99%9A%E6%8B%9F%E5%8C%96%E8%BF%9B%E9%98%B6%E4%B8%8E%E6%8F%90%E9%AB%98%E8%A7%86%E9%A2%91%E8%AF%BE%E7%A8%8B/4.jpg">
<meta property="og:image" content="https://zhangboc.github.io/images/KVM%E8%99%9A%E6%8B%9F%E5%8C%96%E8%BF%9B%E9%98%B6%E4%B8%8E%E6%8F%90%E9%AB%98%E8%A7%86%E9%A2%91%E8%AF%BE%E7%A8%8B/5.jpg">
<meta property="og:image" content="https://zhangboc.github.io/images/KVM%E8%99%9A%E6%8B%9F%E5%8C%96%E8%BF%9B%E9%98%B6%E4%B8%8E%E6%8F%90%E9%AB%98%E8%A7%86%E9%A2%91%E8%AF%BE%E7%A8%8B/6.jpg">
<meta property="og:image" content="https://zhangboc.github.io/images/KVM%E8%99%9A%E6%8B%9F%E5%8C%96%E8%BF%9B%E9%98%B6%E4%B8%8E%E6%8F%90%E9%AB%98%E8%A7%86%E9%A2%91%E8%AF%BE%E7%A8%8B/7.jpg">
<meta property="og:image" content="https://zhangboc.github.io/images/KVM%E8%99%9A%E6%8B%9F%E5%8C%96%E8%BF%9B%E9%98%B6%E4%B8%8E%E6%8F%90%E9%AB%98%E8%A7%86%E9%A2%91%E8%AF%BE%E7%A8%8B/8.jpg">
<meta property="og:image" content="https://zhangboc.github.io/images/KVM%E8%99%9A%E6%8B%9F%E5%8C%96%E8%BF%9B%E9%98%B6%E4%B8%8E%E6%8F%90%E9%AB%98%E8%A7%86%E9%A2%91%E8%AF%BE%E7%A8%8B/9.jpg">
<meta property="og:image" content="https://zhangboc.github.io/images/KVM%E8%99%9A%E6%8B%9F%E5%8C%96%E8%BF%9B%E9%98%B6%E4%B8%8E%E6%8F%90%E9%AB%98%E8%A7%86%E9%A2%91%E8%AF%BE%E7%A8%8B/10.jpg">
<meta property="og:image" content="https://zhangboc.github.io/images/KVM%E8%99%9A%E6%8B%9F%E5%8C%96%E8%BF%9B%E9%98%B6%E4%B8%8E%E6%8F%90%E9%AB%98%E8%A7%86%E9%A2%91%E8%AF%BE%E7%A8%8B/11.jpg">
<meta property="og:image" content="https://zhangboc.github.io/images/KVM%E8%99%9A%E6%8B%9F%E5%8C%96%E8%BF%9B%E9%98%B6%E4%B8%8E%E6%8F%90%E9%AB%98%E8%A7%86%E9%A2%91%E8%AF%BE%E7%A8%8B/12.jpg">
<meta property="og:image" content="https://zhangboc.github.io/images/KVM%E8%99%9A%E6%8B%9F%E5%8C%96%E8%BF%9B%E9%98%B6%E4%B8%8E%E6%8F%90%E9%AB%98%E8%A7%86%E9%A2%91%E8%AF%BE%E7%A8%8B/13.jpg">
<meta property="og:image" content="https://zhangboc.github.io/images/KVM%E8%99%9A%E6%8B%9F%E5%8C%96%E8%BF%9B%E9%98%B6%E4%B8%8E%E6%8F%90%E9%AB%98%E8%A7%86%E9%A2%91%E8%AF%BE%E7%A8%8B/14.jpg">
<meta property="og:image" content="https://zhangboc.github.io/images/KVM%E8%99%9A%E6%8B%9F%E5%8C%96%E8%BF%9B%E9%98%B6%E4%B8%8E%E6%8F%90%E9%AB%98%E8%A7%86%E9%A2%91%E8%AF%BE%E7%A8%8B/15.jpg">
<meta property="og:image" content="https://zhangboc.github.io/images/KVM%E8%99%9A%E6%8B%9F%E5%8C%96%E8%BF%9B%E9%98%B6%E4%B8%8E%E6%8F%90%E9%AB%98%E8%A7%86%E9%A2%91%E8%AF%BE%E7%A8%8B/16.jpg">
<meta property="og:image" content="https://zhangboc.github.io/images/KVM%E8%99%9A%E6%8B%9F%E5%8C%96%E8%BF%9B%E9%98%B6%E4%B8%8E%E6%8F%90%E9%AB%98%E8%A7%86%E9%A2%91%E8%AF%BE%E7%A8%8B/17.jpg">
<meta property="og:image" content="https://zhangboc.github.io/images/KVM%E8%99%9A%E6%8B%9F%E5%8C%96%E8%BF%9B%E9%98%B6%E4%B8%8E%E6%8F%90%E9%AB%98%E8%A7%86%E9%A2%91%E8%AF%BE%E7%A8%8B/18.jpg">
<meta property="og:image" content="https://zhangboc.github.io/images/KVM%E8%99%9A%E6%8B%9F%E5%8C%96%E8%BF%9B%E9%98%B6%E4%B8%8E%E6%8F%90%E9%AB%98%E8%A7%86%E9%A2%91%E8%AF%BE%E7%A8%8B/19.jpg">
<meta property="og:image" content="https://zhangboc.github.io/images/KVM%E8%99%9A%E6%8B%9F%E5%8C%96%E8%BF%9B%E9%98%B6%E4%B8%8E%E6%8F%90%E9%AB%98%E8%A7%86%E9%A2%91%E8%AF%BE%E7%A8%8B/20.jpg">
<meta property="og:image" content="https://zhangboc.github.io/images/KVM%E8%99%9A%E6%8B%9F%E5%8C%96%E8%BF%9B%E9%98%B6%E4%B8%8E%E6%8F%90%E9%AB%98%E8%A7%86%E9%A2%91%E8%AF%BE%E7%A8%8B/21.jpg">
<meta property="og:image" content="https://zhangboc.github.io/images/KVM%E8%99%9A%E6%8B%9F%E5%8C%96%E8%BF%9B%E9%98%B6%E4%B8%8E%E6%8F%90%E9%AB%98%E8%A7%86%E9%A2%91%E8%AF%BE%E7%A8%8B/22.jpg">
<meta property="og:image" content="https://zhangboc.github.io/images/KVM%E8%99%9A%E6%8B%9F%E5%8C%96%E8%BF%9B%E9%98%B6%E4%B8%8E%E6%8F%90%E9%AB%98%E8%A7%86%E9%A2%91%E8%AF%BE%E7%A8%8B/23.jpg">
<meta property="og:image" content="https://zhangboc.github.io/images/KVM%E8%99%9A%E6%8B%9F%E5%8C%96%E8%BF%9B%E9%98%B6%E4%B8%8E%E6%8F%90%E9%AB%98%E8%A7%86%E9%A2%91%E8%AF%BE%E7%A8%8B/24.jpg">
<meta property="og:image" content="https://zhangboc.github.io/images/KVM%E8%99%9A%E6%8B%9F%E5%8C%96%E8%BF%9B%E9%98%B6%E4%B8%8E%E6%8F%90%E9%AB%98%E8%A7%86%E9%A2%91%E8%AF%BE%E7%A8%8B/25.jpg">
<meta property="og:image" content="https://zhangboc.github.io/images/KVM%E8%99%9A%E6%8B%9F%E5%8C%96%E8%BF%9B%E9%98%B6%E4%B8%8E%E6%8F%90%E9%AB%98%E8%A7%86%E9%A2%91%E8%AF%BE%E7%A8%8B/26.jpg">
<meta property="og:image" content="https://zhangboc.github.io/images/KVM%E8%99%9A%E6%8B%9F%E5%8C%96%E8%BF%9B%E9%98%B6%E4%B8%8E%E6%8F%90%E9%AB%98%E8%A7%86%E9%A2%91%E8%AF%BE%E7%A8%8B/27.jpg">
<meta property="og:image" content="https://zhangboc.github.io/images/KVM%E8%99%9A%E6%8B%9F%E5%8C%96%E8%BF%9B%E9%98%B6%E4%B8%8E%E6%8F%90%E9%AB%98%E8%A7%86%E9%A2%91%E8%AF%BE%E7%A8%8B/28.jpg">
<meta property="og:image" content="https://zhangboc.github.io/images/KVM%E8%99%9A%E6%8B%9F%E5%8C%96%E8%BF%9B%E9%98%B6%E4%B8%8E%E6%8F%90%E9%AB%98%E8%A7%86%E9%A2%91%E8%AF%BE%E7%A8%8B/29.png">
<meta property="og:image" content="https://zhangboc.github.io/images/KVM%E8%99%9A%E6%8B%9F%E5%8C%96%E8%BF%9B%E9%98%B6%E4%B8%8E%E6%8F%90%E9%AB%98%E8%A7%86%E9%A2%91%E8%AF%BE%E7%A8%8B/30.png">
<meta property="og:image" content="https://zhangboc.github.io/images/KVM%E8%99%9A%E6%8B%9F%E5%8C%96%E8%BF%9B%E9%98%B6%E4%B8%8E%E6%8F%90%E9%AB%98%E8%A7%86%E9%A2%91%E8%AF%BE%E7%A8%8B/31.jpg">
<meta property="og:image" content="https://zhangboc.github.io/images/KVM%E8%99%9A%E6%8B%9F%E5%8C%96%E8%BF%9B%E9%98%B6%E4%B8%8E%E6%8F%90%E9%AB%98%E8%A7%86%E9%A2%91%E8%AF%BE%E7%A8%8B/32.jpg">
<meta property="og:image" content="https://zhangboc.github.io/images/KVM%E8%99%9A%E6%8B%9F%E5%8C%96%E8%BF%9B%E9%98%B6%E4%B8%8E%E6%8F%90%E9%AB%98%E8%A7%86%E9%A2%91%E8%AF%BE%E7%A8%8B/33.jpg">
<meta property="og:image" content="https://zhangboc.github.io/images/KVM%E8%99%9A%E6%8B%9F%E5%8C%96%E8%BF%9B%E9%98%B6%E4%B8%8E%E6%8F%90%E9%AB%98%E8%A7%86%E9%A2%91%E8%AF%BE%E7%A8%8B/34.png">
<meta property="og:image" content="https://zhangboc.github.io/images/KVM%E8%99%9A%E6%8B%9F%E5%8C%96%E8%BF%9B%E9%98%B6%E4%B8%8E%E6%8F%90%E9%AB%98%E8%A7%86%E9%A2%91%E8%AF%BE%E7%A8%8B/35.png">
<meta property="og:image" content="https://zhangboc.github.io/images/KVM%E8%99%9A%E6%8B%9F%E5%8C%96%E8%BF%9B%E9%98%B6%E4%B8%8E%E6%8F%90%E9%AB%98%E8%A7%86%E9%A2%91%E8%AF%BE%E7%A8%8B/36.jpg">
<meta property="og:image" content="https://zhangboc.github.io/images/KVM%E8%99%9A%E6%8B%9F%E5%8C%96%E8%BF%9B%E9%98%B6%E4%B8%8E%E6%8F%90%E9%AB%98%E8%A7%86%E9%A2%91%E8%AF%BE%E7%A8%8B/37.jpg">
<meta property="og:image" content="https://zhangboc.github.io/images/KVM%E8%99%9A%E6%8B%9F%E5%8C%96%E8%BF%9B%E9%98%B6%E4%B8%8E%E6%8F%90%E9%AB%98%E8%A7%86%E9%A2%91%E8%AF%BE%E7%A8%8B/38.png">
<meta property="og:image" content="https://zhangboc.github.io/images/KVM%E8%99%9A%E6%8B%9F%E5%8C%96%E8%BF%9B%E9%98%B6%E4%B8%8E%E6%8F%90%E9%AB%98%E8%A7%86%E9%A2%91%E8%AF%BE%E7%A8%8B/39.jpg">
<meta property="og:image" content="https://zhangboc.github.io/images/KVM%E8%99%9A%E6%8B%9F%E5%8C%96%E8%BF%9B%E9%98%B6%E4%B8%8E%E6%8F%90%E9%AB%98%E8%A7%86%E9%A2%91%E8%AF%BE%E7%A8%8B/40.jpg">
<meta property="og:image" content="https://zhangboc.github.io/images/KVM%E8%99%9A%E6%8B%9F%E5%8C%96%E8%BF%9B%E9%98%B6%E4%B8%8E%E6%8F%90%E9%AB%98%E8%A7%86%E9%A2%91%E8%AF%BE%E7%A8%8B/41.jpg">
<meta property="og:image" content="https://zhangboc.github.io/images/KVM%E8%99%9A%E6%8B%9F%E5%8C%96%E8%BF%9B%E9%98%B6%E4%B8%8E%E6%8F%90%E9%AB%98%E8%A7%86%E9%A2%91%E8%AF%BE%E7%A8%8B/42.jpg">
<meta property="og:image" content="https://zhangboc.github.io/images/KVM%E8%99%9A%E6%8B%9F%E5%8C%96%E8%BF%9B%E9%98%B6%E4%B8%8E%E6%8F%90%E9%AB%98%E8%A7%86%E9%A2%91%E8%AF%BE%E7%A8%8B/43.jpg">
<meta property="og:image" content="https://zhangboc.github.io/images/KVM%E8%99%9A%E6%8B%9F%E5%8C%96%E8%BF%9B%E9%98%B6%E4%B8%8E%E6%8F%90%E9%AB%98%E8%A7%86%E9%A2%91%E8%AF%BE%E7%A8%8B/44.jpg">
<meta property="og:image" content="https://zhangboc.github.io/images/KVM%E8%99%9A%E6%8B%9F%E5%8C%96%E8%BF%9B%E9%98%B6%E4%B8%8E%E6%8F%90%E9%AB%98%E8%A7%86%E9%A2%91%E8%AF%BE%E7%A8%8B/45.png">
<meta property="article:published_time" content="2023-04-11T16:00:00.000Z">
<meta property="article:modified_time" content="2023-04-15T05:29:37.973Z">
<meta property="article:author" content="John Doe">
<meta property="article:tag" content="KVM">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://zhangboc.github.io/images/KVM%E8%99%9A%E6%8B%9F%E5%8C%96%E8%BF%9B%E9%98%B6%E4%B8%8E%E6%8F%90%E9%AB%98%E8%A7%86%E9%A2%91%E8%AF%BE%E7%A8%8B/1.jpg">
  <link rel="stylesheet" href="https://lib.baomitu.com/highlight.js/9.15.8/styles/atom-one-dark.min.css" crossorigin>
  <link rel="stylesheet" href="/lib/mdui_043tiny/css/mdui.css">
  <link rel="stylesheet" href="/lib/iconfont/iconfont.css">
  <link rel="stylesheet" href="/lib/fancybox/css/jquery.fancybox.min.css">
  <link rel="stylesheet" href="https://lib.baomitu.com/justifiedGallery/3.8.1/css/justifiedGallery.min.css">
  
    <link rel="stylesheet" href="//at.alicdn.com/t/font_2421060_8z08qcz5sq3.css">
  
  <link rel="stylesheet" href="/css/style.css?v=1681536611173">
<meta name="generator" content="Hexo 6.3.0"></head>

<body class="mdui-drawer-body-left">
  
  <div id="nexmoe-background">
    <div class="nexmoe-bg" style="background-image: url(/images/background/xiaomai.jpg)"></div>
    <div class="nexmoe-small" style="background-image: url(/images/background/lihui.png)"></div>
    <div class="mdui-appbar mdui-shadow-0">
      <div class="mdui-toolbar">
        <a mdui-drawer="{target: '#drawer', swipe: true}" title="menu" class="mdui-btn mdui-btn-icon mdui-ripple"><i class="mdui-icon nexmoefont icon-menu"></i></a>
        <div class="mdui-toolbar-spacer"></div>
        <!--<a href="javascript:;" class="mdui-btn mdui-btn-icon"><i class="mdui-icon material-icons">search</i></a>-->
        <a href="/" title="John Doe" class="mdui-btn mdui-btn-icon"><img src="/images/head/head.jpg" alt="John Doe"></a>
       </div>
    </div>
  </div>
  <div id="nexmoe-header">
      <div class="nexmoe-drawer mdui-drawer" id="drawer">
    <div class="nexmoe-avatar mdui-ripple">
        <a href="/" title="John Doe">
            <img src="/images/head/head.jpg" alt="John Doe" alt="John Doe">
        </a>
    </div>
    <div class="nexmoe-count">
        <div class="nexmoe-count-item"><span>文章</span>14 <div class="item-radius"></div><div class="item-radius item-right"></div> </div>
        <div class="nexmoe-count-item"><span>标签</span>9<div class="item-radius"></div><div class="item-radius item-right"></div></div>
        <div class="nexmoe-count-item"><span>分类</span>4<div class="item-radius"></div><div class="item-radius item-right"></div></div>
    </div>
    <div class="nexmoe-list mdui-list" mdui-collapse="{accordion: true}">
        
        <a class="nexmoe-list-item mdui-list-item mdui-ripple" href="/" title="回到首页">
            <i class="mdui-list-item-icon nexmoefont icon-meishi"></i>
            <div class="mdui-list-item-content">
                回到首页
            </div>
        </a>
        
        <a class="nexmoe-list-item mdui-list-item mdui-ripple" href="/archives.html" title="文章归档">
            <i class="mdui-list-item-icon nexmoefont icon-hanbao1"></i>
            <div class="mdui-list-item-content">
                文章归档
            </div>
        </a>
        
        <a class="nexmoe-list-item mdui-list-item mdui-ripple" href="/about/index.html" title="关于我">
            <i class="mdui-list-item-icon nexmoefont icon-jiubei1"></i>
            <div class="mdui-list-item-content">
                关于我
            </div>
        </a>
        
        <a class="nexmoe-list-item mdui-list-item mdui-ripple" href="/friend/index.html" title="我的朋友">
            <i class="mdui-list-item-icon nexmoefont icon-cola"></i>
            <div class="mdui-list-item-content">
                我的朋友
            </div>
        </a>
        
        <a class="nexmoe-list-item mdui-list-item mdui-ripple" href="/download/index.html" title="下载中心">
            <i class="mdui-list-item-icon nexmoefont icon-tangguo"></i>
            <div class="mdui-list-item-content">
                下载中心
            </div>
        </a>
        
    </div>
    <aside id="nexmoe-sidebar">
  
  
<!-- 站内搜索 -->

<div class="nexmoe-widget-wrap">
    <div class="nexmoe-widget nexmoe-search" >
        <form id="search-form">
            <label><input type="text" id="local-search-input" name="q" results="0" placeholder="站内搜索" class="input form-control" autocomplete="off" autocorrect="off"/></label>
            <!-- 清空/重置搜索框 -->
            <i class="fa fa-times" onclick="resetSearch()"></i>
        </form>
    </div>
    <div id="local-search-result"></div> <!-- 搜索结果区 -->
    <!-- <p class='no-result'></p> 无匹配时显示，注意在 CSS 中设置默认隐藏 -->
</div>


  
  <div class="nexmoe-widget-wrap">
    <div class="nexmoe-widget nexmoe-social">
        <a class="mdui-ripple" href="http://wpa.qq.com/msgrd?v=3&uin=1605643129&Site=%E5%8C%97%E4%BA%ACSEO&Menu=yes" target="_blank" mdui-tooltip="{content: 'QQ'}" style="color: rgb(64, 196, 255);background-color: rgba(64, 196, 255, .1);">
            <i class="nexmoefont icon-QQ"></i>
        </a><a class="mdui-ripple" href="mailto:1605643129@qq.com" target="_blank" mdui-tooltip="{content: 'mail'}" style="color: rgb(249,8,8);background-color: rgba(249,8,8,.1);">
            <i class="nexmoefont icon-mail-fill"></i>
        </a><a class="mdui-ripple" href="https://blog.csdn.net/qq_40855827?type=blog" target="_blank" mdui-tooltip="{content: 'CSDN'}" style="color: rgb(199,29,35);background-color: rgba(199,29,35,.1);">
            <i class="nexmoefont icon-csdn"></i>
        </a><a class="mdui-ripple" href="https://home.cnblogs.com/u/1882665" target="_blank" mdui-tooltip="{content: '博客园'}" style="color: rgb(66, 214, 29);background-color: rgba(66, 214, 29, .1);">
            <i class="nexmoefont icon-bokeyuan"></i>
        </a><a class="mdui-ripple" href="https://github.com/zhangboc" target="_blank" mdui-tooltip="{content: 'GitHub'}" style="color: rgb(25, 23, 23);background-color: rgba(25, 23, 23, .15);">
            <i class="nexmoefont icon-github"></i>
        </a><a class="mdui-ripple" href="https://gitee.com/with-the-wind-yue" target="_blank" mdui-tooltip="{content: 'gitee'}" style="color: rgb(255, 255, 255);background-color: rgb(199,29,35);">
            <i class="nexmoefont icon-mayun"></i>
        </a>
    </div>
</div>
  
  
  <div class="nexmoe-widget-wrap">
    <h3 class="nexmoe-widget-title">分类</h3>
    <div class="nexmoe-widget">

      <ul class="category-list">

        


        

        

        <li class="category-list-item">
          <a class="category-list-link" href="/categories/Ceph/">Ceph</a>
          <span class="category-list-count">9</span>
        </li>

        

        <li class="category-list-item">
          <a class="category-list-link" href="/categories/KVM/">KVM</a>
          <span class="category-list-count">1</span>
        </li>

        

        <li class="category-list-item">
          <a class="category-list-link" href="/categories/Test/">Test</a>
          <span class="category-list-count">1</span>
        </li>

        

        <li class="category-list-item">
          <a class="category-list-link" href="/categories/hexo/">hexo</a>
          <span class="category-list-count">1</span>
        </li>

        
      </ul>

    </div>
  </div>


  
  
  <div class="nexmoe-widget-wrap">
    <div id="randomtagcloud" class="nexmoe-widget tagcloud nexmoe-rainbow">
      <a href="/tags/Ceph/" style="font-size: 20px;">Ceph</a> <a href="/tags/Ceph-FS/" style="font-size: 10px;">Ceph FS</a> <a href="/tags/Ceph%E7%AE%80%E4%BB%8B/" style="font-size: 10px;">Ceph简介</a> <a href="/tags/KVM/" style="font-size: 10px;">KVM</a> <a href="/tags/RBD/" style="font-size: 15px;">RBD</a> <a href="/tags/RGW/" style="font-size: 10px;">RGW</a> <a href="/tags/Test/" style="font-size: 10px;">Test</a> <a href="/tags/chatjs/" style="font-size: 10px;">chatjs</a> <a href="/tags/%E6%95%85%E9%9A%9C%E6%8E%92%E6%9F%A5/" style="font-size: 10px;">故障排查</a>
    </div>
    
  </div>

  
  
  <div class="nexmoe-widget-wrap">
    <h3 class="nexmoe-widget-title">文章</h3>
    <div class="nexmoe-widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/">2023</a><span class="archive-list-count">14</span></li></ul>
    </div>
  </div>


<style>
.nexmoe-widget .archive-list-count{
	position : absolute;
	right: 15px;
	top:9px;
	color: #DDD;
}
</style>

  
</aside>
    <div class="nexmoe-copyright">
        &copy; 2023 John Doe
        Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
        & <a href="https://github.com/zhangboc/hexo.github.io/" target="_blank">ZhangboCheng</a><br/>
        <a href="http://beian.miit.gov.cn" target="_blank">辽ICP备2021002341号</a><br/>
        
        <div style="font-size: 12px">
            <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
            本站总访问量  <a id="busuanzi_value_site_pv"></a> 次<br />
            本站访客数<a id="busuanzi_value_site_uv"></a>人次
        </div>
        <span id="timeDate">载入天数...</span><span id="times">载入时分秒...</span>
        <script>
            var now = new Date(); 
            function createtime() { 
                var grt= new Date("08/10/2018 17:38:00");//在此处修改你的建站时间，格式：月/日/年 时:分:秒
                now.setTime(now.getTime()+250); 
                days = (now - grt ) / 1000 / 60 / 60 / 24; dnum = Math.floor(days); 
                hours = (now - grt ) / 1000 / 60 / 60 - (24 * dnum); hnum = Math.floor(hours); 
                if(String(hnum).length ==1 ){hnum = "0" + hnum;} minutes = (now - grt ) / 1000 /60 - (24 * 60 * dnum) - (60 * hnum); 
                mnum = Math.floor(minutes); if(String(mnum).length ==1 ){mnum = "0" + mnum;} 
                seconds = (now - grt ) / 1000 - (24 * 60 * 60 * dnum) - (60 * 60 * hnum) - (60 * mnum); 
                snum = Math.round(seconds); if(String(snum).length ==1 ){snum = "0" + snum;} 
                document.getElementById("timeDate").innerHTML = "本站已安全运行 "+dnum+" 天 "; 
                document.getElementById("times").innerHTML = hnum + " 小时 " + mnum + " 分 " + snum + " 秒"; 
    } 
setInterval("createtime()",250);
</script>


        
        
    </div>

</div><!-- .nexmoe-drawer -->

  </div>
  <div id="nexmoe-content">
    <div class="nexmoe-primary">
        <div class="nexmoe-post">
    
        <div class="nexmoe-post-cover" style="padding-bottom: 26.666666666666668%;">
            <img data-src="https://img1.baidu.com/it/u=413643897,2296924942&fm=253&fmt=auto&app=138&f=JPEG?w=800&h=500" data-sizes="auto" alt="KVM虚拟化进阶与提高视频课程" class="lazyload">
            <h1>KVM虚拟化进阶与提高视频课程</h1>
        </div>
    

        <div class="nexmoe-post-meta nexmoe-rainbow" style="margin:10px 0!important;">
    <a><i class="nexmoefont icon-calendar-fill"></i>2023年04月12日</a>
    <a><i class="nexmoefont icon-areachart"></i>18.6k 字</a>
    <a><i class="nexmoefont icon-time-circle-fill"></i>大概 104 分钟</a>
</div>

        <div class="nexmoe-post-right">
            
        </div>

        <article>
            <h1><span id></span></h1><span id="more"></span>

<!-- toc -->

<ul>
<li><a href="#%E4%B8%80-%E8%99%9A%E6%8B%9F%E7%BD%91%E7%BB%9C%E9%AB%98%E7%BA%A7%E9%85%8D%E7%BD%AE">一、虚拟网络高级配置</a><ul>
<li><a href="#1-%E9%85%8D%E7%BD%AE%E7%BD%91%E5%8D%A1%E7%BB%91%E5%AE%9Abond">1、配置网卡绑定（bond）</a><ul>
<li><a href="#1-%E7%BB%91%E5%AE%9A%E7%BD%91%E5%8D%A1">1、绑定网卡</a></li>
<li><a href="#2-%E9%85%8D%E7%BD%AE%E7%BD%91%E6%A1%A5">2、配置网桥</a></li>
</ul>
</li>
<li><a href="#2-%E9%85%8D%E7%BD%AEvlan">2、配置Vlan</a><ul>
<li><a href="#1-nmcli%E6%96%B9%E6%B3%95">1、nmcli方法</a></li>
<li><a href="#2-%E9%80%9A%E8%BF%87%E5%91%BD%E4%BB%A4%E8%A1%8C%E5%88%9B%E5%BB%BA">2、通过命令行创建</a></li>
<li><a href="#3-%E9%80%9A%E8%BF%87virt-manager%E5%88%9B%E5%BB%BA">3、通过virt-manager创建</a></li>
<li><a href="#4-%E8%99%9A%E6%8B%9F%E6%9C%BA%E4%BD%BF%E7%94%A8vlan">4、虚拟机使用vlan</a></li>
</ul>
</li>
<li><a href="#3-%E9%85%8D%E7%BD%AE%E7%BD%91%E7%BB%9C%E8%BF%87%E6%BB%A4">3、配置网络过滤</a></li>
</ul>
</li>
<li><a href="#%E4%BA%8C-%E8%99%9A%E6%8B%9F%E6%9C%BA%E8%BF%81%E7%A7%BB">二、虚拟机迁移</a><ul>
<li><a href="#1-%E9%80%9A%E8%BF%87uri%E8%BF%9E%E6%8E%A5%E8%BF%9E%E6%8E%A5kvm%E4%B8%BB%E6%9C%BA">1、通过URI连接连接KVM主机</a></li>
<li><a href="#2-%E9%9D%99%E6%80%81%E8%BF%81%E7%A7%BB">2、静态迁移</a><ul>
<li><a href="#1-%E5%90%8C%E4%B8%80%E5%AE%BF%E4%B8%BB%E6%9C%BA%E5%86%85%E8%BF%81%E7%A7%BB">1、同一宿主机内迁移</a></li>
<li><a href="#2-%E4%B8%8D%E5%90%8C%E5%AE%BF%E4%B8%BB%E6%9C%BA%E8%BF%81%E7%A7%BB">2、不同宿主机迁移</a></li>
<li><a href="#3-%E4%B8%8D%E5%90%8C%E5%AE%BF%E4%B8%BB%E6%9C%BA%E8%BF%81%E7%A7%BB%E4%BD%BF%E7%94%A8virsh-migrate%E5%91%BD%E4%BB%A4">3、不同宿主机迁移使用virsh migrate命令</a></li>
</ul>
</li>
<li><a href="#3-%E5%9F%BA%E4%BA%8E%E5%85%B1%E4%BA%AB%E5%AD%98%E5%82%A8%E7%9A%84%E5%8A%A8%E6%80%81%E8%BF%81%E7%A7%BB">3、基于共享存储的动态迁移</a><ul>
<li><a href="#1-%E5%AE%89%E8%A3%85nfs%E6%9C%8D%E5%8A%A1%E5%99%A8%E7%BB%84%E4%BB%B6">1、安装NFS服务器组件</a></li>
<li><a href="#%E5%88%9B%E5%BB%BAnfs%E5%85%B1%E4%BA%AB%E6%96%87%E4%BB%B6%E5%A4%B9">创建NFS共享文件夹</a></li>
<li><a href="#%E5%B0%86kvm1%E4%B8%AD%E7%9A%84%E8%99%9A%E6%8B%9F%E6%9C%BA%E7%A1%AC%E7%9B%98%E8%BF%81%E7%A7%BB%E5%88%B0nfs%E6%9C%8D%E5%8A%A1%E5%99%A8%E7%9A%84%E5%85%B1%E4%BA%AB%E5%AD%98%E5%82%A8%E4%B8%8A">将KVM1中的虚拟机硬盘迁移到NFS服务器的共享存储上</a></li>
<li><a href="#2-%E4%BD%BF%E7%94%A8virt-manager%E8%BF%9B%E8%A1%8C%E8%BF%81%E7%A7%BB">2、使用virt-manager进行迁移</a></li>
<li><a href="#3-%E4%BD%BF%E7%94%A8virsh%E5%91%BD%E4%BB%A4%E8%BF%9B%E8%A1%8C%E8%BF%81%E7%A7%BB">3、使用virsh命令进行迁移</a></li>
</ul>
</li>
<li><a href="#4-%E5%9F%BA%E4%BA%8E%E6%9C%AC%E5%9C%B0%E5%AD%98%E5%82%A8%E7%9A%84%E5%8A%A8%E6%80%81%E8%BF%81%E7%A7%BB">4、基于本地存储的动态迁移</a></li>
</ul>
</li>
<li><a href="#%E4%B8%89-linux-ha%E7%BE%A4%E9%9B%86%E4%BD%93%E7%B3%BB%E6%9E%B6%E6%9E%84">三、Linux HA群集体系架构</a></li>
<li><a href="#%E5%9B%9B-linux%E7%BE%A4%E9%9B%86%E5%AE%89%E8%A3%85%E4%B8%8E%E9%85%8D%E7%BD%AE">四、Linux群集安装与配置</a><ul>
<li><a href="#1-%E8%A7%84%E5%88%92%E8%AE%BE%E8%AE%A1">1、规划设计</a></li>
<li><a href="#2-%E7%BE%A4%E9%9B%86%E7%BB%84%E4%BB%B6%E5%AE%89%E8%A3%85">2、群集组件安装</a></li>
<li><a href="#3-%E7%BE%A4%E9%9B%86%E8%8A%82%E7%82%B9%E5%87%86%E5%A4%87">3、群集节点准备</a><ul>
<li><a href="#1-%E9%85%8D%E7%BD%AE%E4%B8%BB%E6%9C%BA%E5%90%8D%E5%8F%8A%E8%A7%A3%E6%9E%90">1、配置主机名及解析</a></li>
<li><a href="#2-%E9%85%8D%E7%BD%AEssh-key%E4%BA%92%E4%BF%A1%E5%8F%AF%E9%80%89">2、配置SSH Key互信（可选）</a></li>
<li><a href="#3-%E9%85%8D%E7%BD%AE%E6%97%B6%E9%92%9F">3、配置时钟</a></li>
<li><a href="#4-%E9%85%8D%E7%BD%AEiptables%E9%98%B2%E7%81%AB%E5%A2%99%E5%85%81%E8%AE%B8%E9%9B%86%E7%BE%A4%E7%BB%84%E4%BB%B6%E8%BF%90%E8%A1%8C">4、配置iptables防火墙允许集群组件运行</a></li>
<li><a href="#5-%E9%85%8D%E7%BD%AEpcs%E5%AE%88%E6%8A%A4%E7%A8%8B%E5%BA%8F">5、配置pcs守护程序</a></li>
<li><a href="#6-%E9%85%8D%E7%BD%AEhacluster%E8%B4%A6%E6%88%B7%E5%AF%86%E7%A0%81">6、配置hacluster账户密码</a></li>
<li><a href="#7-%E7%BC%96%E8%BE%91%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6">7、编辑配置文件</a></li>
</ul>
</li>
<li><a href="#4-%E7%BE%A4%E9%9B%86%E7%9A%84%E5%88%9B%E5%BB%BA">4、群集的创建</a></li>
</ul>
</li>
<li><a href="#%E4%BA%94-%E5%9F%BA%E4%BA%8Enfs%E7%9A%84kvm%E7%BE%A4%E9%9B%86%E6%9E%84%E5%BB%BA">五、基于NFS的KVM群集构建</a><ul>
<li><a href="#1-%E8%A7%84%E5%88%92%E8%AE%BE%E8%AE%A1-1">1、规划设计</a></li>
<li><a href="#2-%E8%8A%82%E7%82%B9%E5%87%86%E5%A4%87">2、节点准备</a><ul>
<li><a href="#1-%E9%98%B6%E6%AE%B51%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E5%AE%89%E8%A3%85">1、阶段1：操作系统安装</a></li>
<li><a href="#2-%E9%98%B6%E6%AE%B52%E7%BE%A4%E9%9B%86%E7%BB%84%E4%BB%B6%E5%AE%89%E8%A3%85">2、阶段2：群集组件安装</a></li>
<li><a href="#3-%E9%98%B6%E6%AE%B53%E7%BE%A4%E9%9B%86%E8%8A%82%E7%82%B9%E5%AE%89%E8%A3%85">3、阶段3：群集节点安装</a></li>
</ul>
</li>
<li><a href="#3-%E9%85%8D%E7%BD%AEnfs%E8%B5%84%E6%BA%90">3、配置NFS资源</a></li>
<li><a href="#4-%E5%87%86%E5%A4%87%E8%99%9A%E6%8B%9F%E6%9C%BA">4、准备虚拟机</a></li>
<li><a href="#5-%E9%85%8D%E7%BD%AEstonthipmi">5、配置STONTH（IPMI）</a></li>
<li><a href="#6-%E5%90%91%E7%BE%A4%E9%9B%86%E6%B7%BB%E5%8A%A0%E8%99%9A%E6%8B%9F%E6%9C%BA%E8%B5%84%E6%BA%90">6、向群集添加虚拟机资源</a></li>
<li><a href="#7-%E7%BE%A4%E9%9B%86%E6%B5%8B%E8%AF%95">7、群集测试</a></li>
</ul>
</li>
<li><a href="#%E5%85%AD-%E5%9F%BA%E4%BA%8Eiscsi%E7%9A%84kvm%E7%BE%A4%E9%9B%86%E6%9E%84%E5%BB%BA">六、基于iSCSI的KVM群集构建</a></li>
<li><a href="#%E4%B8%83-%E5%9F%BA%E4%BA%8Edrbd%E7%9A%84kvm%E7%BE%A4%E9%9B%86%E6%9E%84%E5%BB%BA">七、基于DRBD的KVM群集构建</a></li>
<li><a href="#%E5%85%AB-p2v-v2v%E8%BF%81%E7%A7%BB">八、P2V、V2V迁移</a></li>
<li><a href="#%E4%B9%9D-%E5%B5%8C%E5%A5%97%E8%99%9A%E6%8B%9F%E5%8C%96">九、嵌套虚拟化</a></li>
<li><a href="#%E5%8D%81-%E5%A4%87%E4%BB%BD%E4%B8%8E%E6%81%A2%E5%A4%8D">十、备份与恢复</a></li>
<li><a href="#%E5%8D%81%E4%B8%80-%E6%80%A7%E8%83%BD%E7%9B%91%E8%A7%86%E4%B8%8E%E4%BC%98%E5%8C%96">十一、性能监视与优化</a></li>
<li><a href="#%E5%8D%81%E4%BA%8C-ovirtrhev%E5%AE%89%E8%A3%85%E4%B8%8E%E5%9F%BA%E6%9C%AC%E7%AE%A1%E7%90%86">十二、oVirt(RHEV)安装与基本管理</a></li>
</ul>
<!-- tocstop -->

<h1><span id="一-虚拟网络高级配置">一、虚拟网络高级配置</span></h1><h2><span id="1-配置网卡绑定bond">1、配置网卡绑定（bond）</span></h2><p><img src="/images/KVM%E8%99%9A%E6%8B%9F%E5%8C%96%E8%BF%9B%E9%98%B6%E4%B8%8E%E6%8F%90%E9%AB%98%E8%A7%86%E9%A2%91%E8%AF%BE%E7%A8%8B/1.jpg"><br><img src="/images/KVM%E8%99%9A%E6%8B%9F%E5%8C%96%E8%BF%9B%E9%98%B6%E4%B8%8E%E6%8F%90%E9%AB%98%E8%A7%86%E9%A2%91%E8%AF%BE%E7%A8%8B/2.jpg"></p>
<h3><span id="1-绑定网卡">1、绑定网卡</span></h3><pre><code>[root@kvm ~]# ip a  #查看需要绑定的网卡，ens33和ens36
1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
    inet 127.0.0.1/8 scope host lo
       valid_lft forever preferred_lft forever
    inet6 ::1/128 scope host 
       valid_lft forever preferred_lft forever
2: ens33: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast state UP group default qlen 1000
    link/ether 00:0c:29:0b:57:dc brd ff:ff:ff:ff:ff:ff
    inet 192.168.187.134/24 brd 192.168.187.255 scope global noprefixroute dynamic ens33
       valid_lft 1066sec preferred_lft 1066sec
    inet6 fe80::1fc1:66d:29af:eabe/64 scope link noprefixroute 
       valid_lft forever preferred_lft forever
3: virbr0: &lt;NO-CARRIER,BROADCAST,MULTICAST,UP&gt; mtu 1500 qdisc noqueue state DOWN group default qlen 1000
    link/ether 52:54:00:cc:c5:d5 brd ff:ff:ff:ff:ff:ff
    inet 192.168.122.1/24 brd 192.168.122.255 scope global virbr0
       valid_lft forever preferred_lft forever
4: virbr0-nic: &lt;BROADCAST,MULTICAST&gt; mtu 1500 qdisc pfifo_fast master virbr0 state DOWN group default qlen 1000
    link/ether 52:54:00:cc:c5:d5 brd ff:ff:ff:ff:ff:ff
5: ens36: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast state UP group default qlen 1000
    link/ether 00:0c:29:0b:57:e6 brd ff:ff:ff:ff:ff:ff
    inet 192.168.187.135/24 brd 192.168.187.255 scope global noprefixroute dynamic ens36
       valid_lft 1783sec preferred_lft 1783sec
    inet6 fe80::84be:5ac8:542c:705f/64 scope link noprefixroute 
       valid_lft forever preferred_lft forever
[root@kvm ~]# virsh net-list #查看当前kvm网络情况
 名称               状态     自动开始  持久
----------------------------------------------------------
 default              活动     是           是

[root@kvm ~]# brctl show #查看当前宿主机网桥情况
bridge name    bridge id        STP enabled    interfaces
virbr0        8000.525400ccc5d5    yes        virbr0-nic
[root@kvm ~]# virsh net-dumpxml --network default  #查看default的xml文件
&lt;network&gt;
  &lt;name&gt;default&lt;/name&gt;
  &lt;uuid&gt;8e682a63-b77a-4aad-bc25-5d4d63a2a66e&lt;/uuid&gt;
  &lt;forward mode=&#39;nat&#39;&gt;
    &lt;nat&gt;
      &lt;port start=&#39;1024&#39; end=&#39;65535&#39;/&gt;
    &lt;/nat&gt;
  &lt;/forward&gt;
  &lt;bridge name=&#39;virbr0&#39; stp=&#39;on&#39; delay=&#39;0&#39;/&gt;
  &lt;mac address=&#39;52:54:00:cc:c5:d5&#39;/&gt;
  &lt;ip address=&#39;192.168.122.1&#39; netmask=&#39;255.255.255.0&#39;&gt;
    &lt;dhcp&gt;
      &lt;range start=&#39;192.168.122.2&#39; end=&#39;192.168.122.254&#39;/&gt;
    &lt;/dhcp&gt;
  &lt;/ip&gt;
&lt;/network&gt;
[root@kvm ~]# virsh iface-list #查看宿主机网卡情况，没有认到新增加的网卡（ens36），需要增加ifcfg-ens36的配置文件，可以通过virt-manager进行添加
 名称               状态     MAC 地址
---------------------------------------------------
 ens33                活动     00:0c:29:0b:57:dc
 lo                   活动     00:00:00:00:00:00
</code></pre>
<p><img src="/images/KVM%E8%99%9A%E6%8B%9F%E5%8C%96%E8%BF%9B%E9%98%B6%E4%B8%8E%E6%8F%90%E9%AB%98%E8%A7%86%E9%A2%91%E8%AF%BE%E7%A8%8B/3.jpg"><br><img src="/images/KVM%E8%99%9A%E6%8B%9F%E5%8C%96%E8%BF%9B%E9%98%B6%E4%B8%8E%E6%8F%90%E9%AB%98%E8%A7%86%E9%A2%91%E8%AF%BE%E7%A8%8B/4.jpg"><br><img src="/images/KVM%E8%99%9A%E6%8B%9F%E5%8C%96%E8%BF%9B%E9%98%B6%E4%B8%8E%E6%8F%90%E9%AB%98%E8%A7%86%E9%A2%91%E8%AF%BE%E7%A8%8B/5.jpg"></p>
<pre><code>[root@kvm ~]# cat /etc/sysconfig/network-scripts/ifcfg-ens36  #查看通过virt-nanager自动生成的配置文件
DEVICE=&quot;ens36&quot;
HWADDR=&quot;00:0c:29:0b:57:e6&quot;
ONBOOT=&quot;no&quot;
BOOTPROTO=&quot;dhcp&quot;
[root@kvm ~]# virsh iface-list --all #可以识别到ens36网卡了
 名称               状态     MAC 地址
---------------------------------------------------
 ens33                活动     00:0c:29:0b:57:dc
 ens36                活动     00:0c:29:0b:57:e6
 lo                   活动     00:00:00:00:00:00
 [root@kvm ~]# modprobe --first-time bonding #查看系统是否安装了网桥的模块，如果没有就自动加载，这里没有报错，意思是当前系统没有加载，但是已经通过--first-time进行加载了
[root@kvm ~]# lsmod | grep bonding #查看已经正常加载
bonding               157075  0 
[root@kvm network-scripts]# pwd
/etc/sysconfig/network-scripts
[root@kvm network-scripts]# ls -lha ifcfg-ens* #查看当前网卡的配置文件
-rw-r--r--. 1 root root 280 4月   2 15:41 ifcfg-ens33
-rw-r--r--. 1 root root  71 4月   2 19:37 ifcfg-ens36
[root@kvm network-scripts]# cp ifcfg-ens33 ifcfg-ens33-bak #备份文件
[root@kvm network-scripts]# cp ifcfg-ens36 ifcfg-ens36-bak 
[root@kvm network-scripts]# vim ifcfg-ens33 #编辑网卡文件
TYPE=Ethernet
BOOTPROTO=none
NAME=ens33
DEVICE=ens33
ONBOOT=yes
MASTER=bond0
SLAVE=yes
NM_CONTROLLERD=no #非必须
USERCTL=no #非必须
[root@kvm network-scripts]# vim ifcfg-ens36 #编辑网卡文件
TYPE=Ethernet
BOOTPROTO=none
NAME=ens36
DEVICE=ens36
ONBOOT=yes
MASTER=bond0
SLAVE=yes
NM_CONTROLLERD=no
USERCTL=no 
[root@kvm network-scripts]# vim ifcfg-bond0 #新建bond0文件
DEVICE=bond0
ONBOOT=yes
NM_CONTROLLERD=no
USERCTL=no
BONDING_OPTS=&quot;mode=1 miimon=100 fail_over_mac=1&quot;
BOOTPROTO=static
IPADDR=192.168.187.134
NETMASK=255.255.255.0
GATEWAY=192.168.187.1
DNS1=223.5.5.5
[root@kvm network-scripts]# systemctl restart network #重启网络服务，远程时谨慎！
连接已成功激活（master waiting for slaves）（D-Bus 活动路径：/org/freedesktop/NetworkManager/ActiveConnection/5）
[root@kvm network-scripts]# ip a 
1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
    inet 127.0.0.1/8 scope host lo
       valid_lft forever preferred_lft forever
    inet6 ::1/128 scope host 
       valid_lft forever preferred_lft forever
2: ens33: &lt;BROADCAST,MULTICAST,SLAVE,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast master bond0 state UP group default qlen 1000
    link/ether 00:0c:29:0b:57:dc brd ff:ff:ff:ff:ff:ff
3: virbr0: &lt;NO-CARRIER,BROADCAST,MULTICAST,UP&gt; mtu 1500 qdisc noqueue state DOWN group default qlen 1000
    link/ether 52:54:00:cc:c5:d5 brd ff:ff:ff:ff:ff:ff
    inet 192.168.122.1/24 brd 192.168.122.255 scope global virbr0
       valid_lft forever preferred_lft forever
4: virbr0-nic: &lt;BROADCAST,MULTICAST&gt; mtu 1500 qdisc pfifo_fast master virbr0 state DOWN group default qlen 1000
    link/ether 52:54:00:cc:c5:d5 brd ff:ff:ff:ff:ff:ff
5: ens36: &lt;BROADCAST,MULTICAST,SLAVE,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast master bond0 state UP group default qlen 1000
    link/ether 00:0c:29:0b:57:dc brd ff:ff:ff:ff:ff:ff
6: bond0: &lt;BROADCAST,MULTICAST,MASTER,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue state UP group default qlen 1000
    link/ether 00:0c:29:0b:57:dc brd ff:ff:ff:ff:ff:ff
    inet 192.168.187.134/24 brd 192.168.187.255 scope global noprefixroute bond0
       valid_lft forever preferred_lft forever
    inet6 fe80::20c:29ff:fe0b:57dc/64 scope link 
       valid_lft forever preferred_lft forever
[root@kvm network-scripts]# dmesg |grep bond0 #查看日志
[ 2586.969003] IPv6: ADDRCONF(NETDEV_UP): bond0: link is not ready
[ 2586.969152] IPv6: ADDRCONF(NETDEV_UP): bond0: link is not ready
[ 2586.971585] IPv6: ADDRCONF(NETDEV_UP): bond0: link is not ready
[ 2586.979903] IPv6: ADDRCONF(NETDEV_UP): bond0: link is not ready
[ 2587.011775] IPv6: ADDRCONF(NETDEV_UP): bond0: link is not ready
[ 2635.311460] IPv6: ADDRCONF(NETDEV_UP): bond0: link is not ready
[ 2635.457459] IPv6: ADDRCONF(NETDEV_UP): bond0: link is not ready
[ 2635.590868] bond0: making interface ens33 the new active one
[ 2635.596124] bond0: Enslaving ens33 as an active interface with an up link
[ 2635.596466] IPv6: ADDRCONF(NETDEV_CHANGE): bond0: link becomes ready
[ 2635.700504] bond0: Releasing backup interface ens33
[ 2637.395032] bond0: Enslaving ens33 as a backup interface with a down link
[ 2637.483876] bond0: link status definitely up for interface ens33, 1000 Mbps full duplex
[ 2637.483882] bond0: making interface ens33 the new active one
[ 2637.491125] bond0: first active interface up!
[ 2637.764573] bond0: Enslaving ens36 as a backup interface with a down link
[ 2637.793398] bond0: link status definitely up for interface ens36, 1000 Mbps full duplex
[root@kvm network-scripts]# cat /proc/net/bonding/bond0  #查看内存中的文件
Ethernet Channel Bonding Driver: v3.7.1 (April 27, 2011)

Bonding Mode: fault-tolerance (active-backup) #bond模式
Primary Slave: None
Currently Active Slave: ens33 #当前的主设备是ens33
MII Status: up #主设备的当前状态
MII Polling Interval (ms): 100
Up Delay (ms): 0
Down Delay (ms): 0

Slave Interface: ens33
MII Status: up
Speed: 1000 Mbps
Duplex: full
Link Failure Count: 0
Permanent HW addr: 00:0c:29:0b:57:dc
Slave queue ID: 0

Slave Interface: ens36
MII Status: up
Speed: 1000 Mbps
Duplex: full
Link Failure Count: 0
Permanent HW addr: 00:0c:29:0b:57:e6
Slave queue ID: 0
</code></pre>
<blockquote>
<p>与真机环境有所不同，vmware虚拟机下给linux系统做bond0网卡配置，照这样做完后，测试发现down掉eth0后，bond0网卡ping不通，无法起到网卡备份效果。BONDING_OPTS&#x3D;“fail_over_mac&#x3D;1”配置解释: 默认fail_over_mac&#x3D;0，当发生错误时，只改slave的mac不改bond；fail_over_mac&#x3D;1时，只改bond不改slave。</p>
</blockquote>
<h4><span id="1-bond的模式">1、Bond的模式</span></h4><blockquote>
<p><a target="_blank" rel="noopener" href="https://www.likecs.com/show-308299629.html">网卡的7种bond模式</a><br><a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_45548465/article/details/122625777">Linux网卡bond的七种模式详解，⽹卡绑定(bond)怎么实现？有哪些绑定⽅式</a>：</p>
</blockquote>
<table>
<thead>
<tr>
<th>模式</th>
<th>名称</th>
<th>特点</th>
<th>负载均衡</th>
<th>交换机配置</th>
<th>条件</th>
</tr>
</thead>
<tbody><tr>
<td>0</td>
<td>(balance-rr) Round-robin policy（平衡抡循环策略）</td>
<td>输数据包顺序是依次传输（即：第1个包走eth0，下一个包就走eth1….一直循环下去，直到最后一个传 输完毕），此模式提供负载平衡和容错能力。</td>
<td>是</td>
<td>静态聚合</td>
<td></td>
</tr>
<tr>
<td>1</td>
<td>(active-backup) Active-backup policy（主-备份策略）</td>
<td>只有一个设备处于活动状态，当一个宕掉另一个马上由备份转换为主设备。mac地址是外部可见得，从外面看来，bond的MAC地址是唯一的，以避免switch(交换机)发生混乱。此模式只提供了容错能力；由此可见此算法的优点是可以提供高网络连接的可用性，但是它的资源利用率较低，只有一个接口处于工作状态，在有 N 个网络接口的情况下，资源利用率为1&#x2F;N。</td>
<td>否</td>
<td>否</td>
<td></td>
</tr>
<tr>
<td>2</td>
<td>(balance-xor) XOR policy（平衡策略）</td>
<td>åº于指定的传输HASH策略传输数据包。缺省的策略是：(源MAC地址 XOR 目标MAC地址) % slave数量。</td>
<td>是</td>
<td>静态聚合</td>
<td></td>
</tr>
<tr>
<td>3</td>
<td>broadcast（广播策略</td>
<td>每个slave接口上传输每个数据包，此模式提供了容错能力。</td>
<td>否</td>
<td>静态聚合</td>
<td></td>
</tr>
<tr>
<td>4</td>
<td>(802.3ad) IEEE 802.3adDynamic link aggregation（IEEE 802.3ad 动态链接聚合）</td>
<td>创建一个聚合组，它们共享同样的速率和双工设定。根据802.3ad规范将多个slave工作在同一个激活的聚合体下。</td>
<td>是</td>
<td>支持IEEE 802.3ad动态聚合</td>
<td>条件1：ethtool支持获取每个slave的速率和双工设定。<br>条件2：switch(交换机)支持IEEE 802.3ad Dynamic link aggregation。<br>条件3：大多数switch(交换机)需要经过特定配置才能支持802.3ad模式。<br></td>
</tr>
<tr>
<td>5</td>
<td>(balance-tlb) Adaptive transmit load balancing（适配器传输负载均衡）</td>
<td>不需要任何特别的switch(交换机)支持的通道bonding。在每个slave上根据当前的负载（根据速度计算）分配外出流量。如果正在接受数据的slave出故障了，另一个slave接管失败的slave的MAC地址。</td>
<td>是</td>
<td>否</td>
<td></td>
</tr>
<tr>
<td>6</td>
<td>(balance-alb) Adaptive load balancing（适配器适应性负载均衡）</td>
<td>该模式包含了balance-tlb模式，同时加上针对IPV4流量的接收负载均衡(receive load balance,rlb)，而且不需要任何switch(交换机)的支持。</td>
<td>是</td>
<td>否</td>
<td></td>
</tr>
</tbody></table>
<h3><span id="2-配置网桥">2、配置网桥</span></h3><pre><code>[root@kvm ~]# vim /etc/sysconfig/network-scripts/ifcfg-virbr1 #新建网桥virbr1的配置文件
DEVICE=virbr1
ONBOOT=yes
TYPE=Bridge
NM_CONTROLLER=no
USERCTL=no
BOOTPROTO=static
IPADDR=192.168.187.134
NETMASK=255.255.255.0
GATEWAY=192.168.187.1
[root@kvm ~]# vim /etc/sysconfig/network-scripts/ifcfg-bond0  #修改bond0的配置文件
DEVICE=bond0
ONBOOT=yes
NM_CONTROLLERD=no
USERCTL=no
BONDING_OPTS=&quot;mode=1 miimon=100 fail_over_mac=1&quot;
BOOTPROTO=none
BRIDGE=virbr1
[root@kvm ~]# systemctl restart network #重启网络服务
[root@kvm ~]# brctl show  #查看当前系统网桥
bridge name    bridge id        STP enabled    interfaces
virbr0        8000.525400ccc5d5    yes        virbr0-nic
virbr1        8000.000c290b57dc    no        bond0
[root@kvm ~]# ip addr show virbr1 #查看IP已经到网桥1中了
18: virbr1: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue state UP group default qlen 1000
    link/ether 00:0c:29:0b:57:dc brd ff:ff:ff:ff:ff:ff
    inet 192.168.187.134/24 brd 192.168.187.255 scope global noprefixroute virbr1
       valid_lft forever preferred_lft forever
    inet6 fe80::5c15:77ff:fece:bc31/64 scope link 
       valid_lft forever preferred_lft forever
[root@kvm qemu]# cat /etc/libvirt/qemu/generic.xml #查看连接的虚拟机接口配置
    &lt;interface type=&#39;bridge&#39;&gt;
      &lt;mac address=&#39;52:54:00:8e:67:0a&#39;/&gt;
      &lt;source bridge=&#39;virbr1&#39;/&gt;
      &lt;model type=&#39;rtl8139&#39;/&gt;
      &lt;address type=&#39;pci&#39; domain=&#39;0x0000&#39; bus=&#39;0x00&#39; slot=&#39;0x03&#39; function=&#39;0x0&#39;/&gt;
    &lt;/interface&gt;
[root@kvm qemu]# brctl show #查看多了个net0
bridge name    bridge id        STP enabled    interfaces
virbr0        8000.525400ccc5d5    yes        virbr0-nic
virbr1        8000.000c290b57dc    no        bond0
                            vnet0
[root@kvm qemu]# virsh domiflist --domain generic  #查看接口信息，模式是8139，可以修改成virto优化性能
Interface  Type       Source     Model       MAC
-------------------------------------------------------
vnet0      bridge     virbr1     rtl8139     52:54:00:8e:67:0a
</code></pre>
<h2><span id="2-配置vlan">2、配置Vlan</span></h2><p><img src="/images/KVM%E8%99%9A%E6%8B%9F%E5%8C%96%E8%BF%9B%E9%98%B6%E4%B8%8E%E6%8F%90%E9%AB%98%E8%A7%86%E9%A2%91%E8%AF%BE%E7%A8%8B/6.jpg"></p>
<p><strong>不建议使用nmcli创建</strong></p>
<table>
<thead>
<tr>
<th>网络</th>
<th>地址段</th>
<th>Vlan-id</th>
</tr>
</thead>
<tbody><tr>
<td>管理网络</td>
<td>192.168.200.0&#x2F;24</td>
<td>&#x2F;</td>
</tr>
<tr>
<td>生产网络</td>
<td>172.16.11.0&#x2F;24 172.16.11.11</td>
<td>11</td>
</tr>
<tr>
<td>生产网络</td>
<td>172.16.12.0&#x2F;24 172.16.12.12</td>
<td>12</td>
</tr>
</tbody></table>
<p><img src="/images/KVM%E8%99%9A%E6%8B%9F%E5%8C%96%E8%BF%9B%E9%98%B6%E4%B8%8E%E6%8F%90%E9%AB%98%E8%A7%86%E9%A2%91%E8%AF%BE%E7%A8%8B/7.jpg"></p>
<h3><span id="1-nmcli方法">1、nmcli方法</span></h3><pre><code>[root@kvm ~]# nmcli --help #查看帮助文档
Usage: nmcli [OPTIONS] OBJECT &#123; COMMAND | help &#125;

OPTIONS
  -a, --ask                                ask for missing parameters
  -c, --colors auto|yes|no                 whether to use colors in output
  -e, --escape yes|no                      escape columns separators in values
  -f, --fields &lt;field,...&gt;|all|common      specify fields to output
  -g, --get-values &lt;field,...&gt;|all|common  shortcut for -m tabular -t -f
  -h, --help                               print this help
  -m, --mode tabular|multiline             output mode
  -o, --overview                           overview mode
  -p, --pretty                             pretty output
  -s, --show-secrets                       allow displaying passwords
  -t, --terse                              terse output
  -v, --version                            show program version
  -w, --wait &lt;seconds&gt;                     set timeout waiting for finishing operations

OBJECT
  g[eneral]       NetworkManager&#39;s general status and operations
  n[etworking]    overall networking control
  r[adio]         NetworkManager radio switches
  c[onnection]    NetworkManager&#39;s connections
  d[evice]        devices managed by NetworkManager
  a[gent]         NetworkManager secret agent or polkit agent
  m[onitor]       monitor NetworkManager changes
[root@kvm network-scripts]# nmcli connection show  #查看当前网络信息
NAME          UUID                                  TYPE      DEVICE 
System ens33  c96bc909-188e-ec64-3a96-6a90982b08ad  ethernet  ens33  
System ens36  418da202-9a8c-b73c-e8a1-397e00f3c6b2  ethernet  ens36  
virbr0        41366568-f66f-4c8b-a2f6-cb4df1714e06  bridge    virbr0 
有线连接 1    52522e57-4b72-3d75-a602-ce47588f745d  ethernet  --     
[root@kvm network-scripts]# nmcli connection add type vlan ifname VLAN11 dev ens33 id 11 #基于ens33创建vlan11
Connection &#39;vlan-VLAN11&#39; (193348c2-73b4-4962-981c-4fdd7a966926) successfully added.
[root@kvm network-scripts]# nmcli connection add type vlan ifname VLAN12 dev ens33 id 12 #基于ens33创建vlan12    
Connection &#39;vlan-VLAN12&#39; (60496196-b1ee-4ff6-93fc-e167f25e63c7) successfully added.
[root@kvm network-scripts]# pwd 
/etc/sysconfig/network-scripts
[root@kvm network-scripts]# ls -lha | grep vlan  #查看自动创建的文件
-rw-r--r--. 1 root root  357 Apr  8 05:08 ifcfg-vlan-VLAN11
-rw-r--r--. 1 root root  357 Apr  8 05:08 ifcfg-vlan-VLAN12
[root@kvm network-scripts]# cat ifcfg-vlan-VLAN11 #查看具体信息
VLAN=yes
TYPE=Vlan
PHYSDEV=ens33
VLAN_ID=11
REORDER_HDR=yes
GVRP=no
MVRP=no
HWADDR=
PROXY_METHOD=none
BROWSER_ONLY=no
BOOTPROTO=dhcp
DEFROUTE=yes
IPV4_FAILURE_FATAL=no
IPV6INIT=yes
IPV6_AUTOCONF=yes
IPV6_DEFROUTE=yes
IPV6_FAILURE_FATAL=no
IPV6_ADDR_GEN_MODE=stable-privacy
NAME=vlan-VLAN11
UUID=193348c2-73b4-4962-981c-4fdd7a966926
DEVICE=VLAN11
ONBOOT=yes
[root@kvm network-scripts]# nmcli connection show  #查看创建的链接
NAME          UUID                                  TYPE      DEVICE 
System ens33  c96bc909-188e-ec64-3a96-6a90982b08ad  ethernet  ens33  
System ens36  418da202-9a8c-b73c-e8a1-397e00f3c6b2  ethernet  ens36  
virbr0        41366568-f66f-4c8b-a2f6-cb4df1714e06  bridge    virbr0 
vlan-VLAN11   193348c2-73b4-4962-981c-4fdd7a966926  vlan      --     
vlan-VLAN12   60496196-b1ee-4ff6-93fc-e167f25e63c7  vlan      --     
有线连接 1    52522e57-4b72-3d75-a602-ce47588f745d  ethernet  --  
[root@kvm network-scripts]# ip a #查看创建结果
1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
    inet 127.0.0.1/8 scope host lo
       valid_lft forever preferred_lft forever
    inet6 ::1/128 scope host 
       valid_lft forever preferred_lft forever
2: ens33: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast state UP group default qlen 1000
    link/ether 00:0c:29:0b:57:dc brd ff:ff:ff:ff:ff:ff
    inet 192.168.200.128/24 brd 192.168.200.255 scope global noprefixroute ens33
       valid_lft forever preferred_lft forever
    inet6 fe80::20c:29ff:fe0b:57dc/64 scope link 
       valid_lft forever preferred_lft forever
3: ens36: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast state UP group default qlen 1000
    link/ether 00:0c:29:0b:57:e6 brd ff:ff:ff:ff:ff:ff
    inet 192.168.200.135/24 brd 192.168.200.255 scope global noprefixroute ens36
       valid_lft forever preferred_lft forever
6: virbr0: &lt;NO-CARRIER,BROADCAST,MULTICAST,UP&gt; mtu 1500 qdisc noqueue state DOWN group default qlen 1000
    link/ether 52:54:00:cc:c5:d5 brd ff:ff:ff:ff:ff:ff
    inet 192.168.122.1/24 brd 192.168.122.255 scope global virbr0
       valid_lft forever preferred_lft forever
7: virbr0-nic: &lt;BROADCAST,MULTICAST&gt; mtu 1500 qdisc pfifo_fast master virbr0 state DOWN group default qlen 1000
    link/ether 52:54:00:cc:c5:d5 brd ff:ff:ff:ff:ff:ff
13: vnet0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast state UNKNOWN group default qlen 1000
    link/ether fe:54:00:8e:67:0a brd ff:ff:ff:ff:ff:ff
    inet6 fe80::fc54:ff:fe8e:670a/64 scope link 
       valid_lft forever preferred_lft forever
25: VLAN12@ens33: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue state UP group default qlen 1000
    link/ether 00:0c:29:0b:57:dc brd ff:ff:ff:ff:ff:ff
    inet6 fe80::eb51:86e8:ea1f:f322/64 scope link noprefixroute 
       valid_lft forever preferred_lft forever
26: VLAN11@ens33: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue state UNKNOWN group default qlen 1000
    link/ether 00:0c:29:0b:57:dc brd ff:ff:ff:ff:ff:ff
    inet6 fe80::a47d:f2c7:75fc:7e54/64 scope link tentative noprefixroute 
       valid_lft forever preferred_lft forever
[root@kvm network-scripts]# tail -n 20 /var/log/messages #查看日志
Apr  8 05:17:47 kvm NetworkManager[786]: &lt;info&gt;  [1680902267.5135] dhcp4 (VLAN12): canceled DHCP transaction, DHCP client pid 15817
Apr  8 05:17:47 kvm NetworkManager[786]: &lt;info&gt;  [1680902267.5136] dhcp4 (VLAN12): state changed timeout -&gt; done
Apr  8 05:17:47 kvm NetworkManager[786]: &lt;info&gt;  [1680902267.5141] device (VLAN12): state change: ip-config -&gt; failed (reason &#39;ip-config-unavailable&#39;, sys-iface-state: &#39;managed&#39;)
Apr  8 05:17:47 kvm NetworkManager[786]: &lt;warn&gt;  [1680902267.5150] device (VLAN12): Activation: failed for connection &#39;vlan-VLAN12&#39;
Apr  8 05:17:47 kvm NetworkManager[786]: &lt;info&gt;  [1680902267.5152] device (VLAN12): state change: failed -&gt; disconnected (reason &#39;none&#39;, sys-iface-state: &#39;managed&#39;)
Apr  8 05:17:47 kvm NetworkManager[786]: &lt;info&gt;  [1680902267.5602] device (VLAN12): state change: disconnected -&gt; unmanaged (reason &#39;user-requested&#39;, sys-iface-state: &#39;managed&#39;)
Apr  8 05:17:47 kvm NetworkManager[786]: &lt;info&gt;  [1680902267.5609] policy: auto-activating connection &#39;vlan-VLAN12&#39; (60496196-b1ee-4ff6-93fc-e167f25e63c7)
Apr  8 05:17:47 kvm kernel: IPv6: ADDRCONF(NETDEV_UP): VLAN12: link is not ready
Apr  8 05:17:47 kvm NetworkManager[786]: &lt;info&gt;  [1680902267.5637] device (VLAN12): state change: unmanaged -&gt; unavailable (reason &#39;managed&#39;, sys-iface-state: &#39;external&#39;)
Apr  8 05:17:47 kvm NetworkManager[786]: &lt;info&gt;  [1680902267.5862] device (VLAN12): carrier: link connected
Apr  8 05:17:47 kvm NetworkManager[786]: &lt;info&gt;  [1680902267.5881] device (VLAN12): state change: unavailable -&gt; disconnected (reason &#39;user-requested&#39;, sys-iface-state: &#39;managed&#39;)
Apr  8 05:17:47 kvm NetworkManager[786]: &lt;info&gt;  [1680902267.6013] device (VLAN12): Activation: starting connection &#39;vlan-VLAN12&#39; (60496196-b1ee-4ff6-93fc-e167f25e63c7)
Apr  8 05:17:47 kvm NetworkManager[786]: &lt;info&gt;  [1680902267.6023] device (VLAN12): state change: disconnected -&gt; prepare (reason &#39;none&#39;, sys-iface-state: &#39;managed&#39;)
Apr  8 05:17:47 kvm NetworkManager[786]: &lt;info&gt;  [1680902267.6033] device (VLAN12): state change: prepare -&gt; config (reason &#39;none&#39;, sys-iface-state: &#39;managed&#39;)
Apr  8 05:17:47 kvm NetworkManager[786]: &lt;info&gt;  [1680902267.6366] device (VLAN12): state change: config -&gt; ip-config (reason &#39;none&#39;, sys-iface-state: &#39;managed&#39;)
Apr  8 05:17:47 kvm NetworkManager[786]: &lt;info&gt;  [1680902267.6373] dhcp4 (VLAN12): activation: beginning transaction (timeout in 45 seconds)
Apr  8 05:17:47 kvm NetworkManager[786]: &lt;info&gt;  [1680902267.6465] dhcp4 (VLAN12): dhclient started with pid 15847
Apr  8 05:17:47 kvm dhclient[15847]: DHCPDISCOVER on VLAN12 to 255.255.255.255 port 67 interval 7 (xid=0x1a408bc7)
Apr  8 05:17:52 kvm dhclient[15834]: DHCPDISCOVER on VLAN11 to 255.255.255.255 port 67 interval 6 (xid=0x6c741821)
Apr  8 05:17:54 kvm dhclient[15847]: DHCPDISCOVER on VLAN12 to 255.255.255.255 port 67 interval 20 (xid=0x1a408bc7)
[root@kvm network-scripts]# virsh iface-list #在kvm上看
 Name                 State      MAC Address
---------------------------------------------------
 ens33                active     00:0c:29:0b:57:dc
 ens36                active     00:0c:29:0b:57:e6
 lo                   active     00:00:00:00:00:00
 VLAN11               active     00:0c:29:0b:57:dc
 VLAN12               active     00:0c:29:0b:57:dc
[root@kvm network-scripts]# rm -rf ifcfg-vlan-VLAN1* #恢复设置
[root@kvm network-scripts]# systemctl restart network #重启
[root@kvm network-scripts]# nmtui #图形化界面，不好用
</code></pre>
<p><img src="/images/KVM%E8%99%9A%E6%8B%9F%E5%8C%96%E8%BF%9B%E9%98%B6%E4%B8%8E%E6%8F%90%E9%AB%98%E8%A7%86%E9%A2%91%E8%AF%BE%E7%A8%8B/8.jpg"><br><img src="/images/KVM%E8%99%9A%E6%8B%9F%E5%8C%96%E8%BF%9B%E9%98%B6%E4%B8%8E%E6%8F%90%E9%AB%98%E8%A7%86%E9%A2%91%E8%AF%BE%E7%A8%8B/9.jpg"></p>
<h3><span id="2-通过命令行创建">2、通过命令行创建</span></h3><pre><code>[root@kvm network-scripts]# vim ifcfg-ens36.11 #创建vlan11配置文件
DEVICE=&quot;ens36.11&quot;
VLAN=&quot;yes&quot;
ONBOOT=&quot;yes&quot;
BOOTPROTO=&quot;none&quot;
IPADDR=&quot;172.16.11.11&quot;
NETMASK=&quot;255.255.255.0&quot;
[root@kvm network-scripts]# cp ifcfg-ens36.11 ifcfg-ens36.12 #创建vlan11配置文件并修改
[root@kvm network-scripts]# vim ifcfg-ens36.12 #配置
DEVICE=&quot;ens36.12&quot;
VLAN=&quot;yes&quot;
ONBOOT=&quot;yes&quot;
BOOTPROTO=&quot;none&quot;
IPADDR=&quot;172.16.12.12&quot;
NETMASK=&quot;255.255.255.0&quot;
[root@kvm network-scripts]# systemctl restart network #重启网络配置
[root@kvm network-scripts]# nmcli connection show  #查看配置是否生效
NAME           UUID                                  TYPE      DEVICE   
System ens33   c96bc909-188e-ec64-3a96-6a90982b08ad  ethernet  ens33    
Vlan ens36.11  5aaffcd1-84a5-3046-15e7-adb62160402b  vlan      ens36.11 
Vlan ens36.12  d100f2b5-85f7-4961-2105-8874b119178a  vlan      ens36.12 
System ens36   418da202-9a8c-b73c-e8a1-397e00f3c6b2  ethernet  ens36    
virbr0         41366568-f66f-4c8b-a2f6-cb4df1714e06  bridge    virbr0   
有线连接 1     52522e57-4b72-3d75-a602-ce47588f745d  ethernet  --      
[root@kvm network-scripts]# ip addr #查看IP
1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
    inet 127.0.0.1/8 scope host lo
       valid_lft forever preferred_lft forever
    inet6 ::1/128 scope host 
       valid_lft forever preferred_lft forever
2: ens33: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast state UP group default qlen 1000
    link/ether 00:0c:29:0b:57:dc brd ff:ff:ff:ff:ff:ff
    inet 192.168.200.128/24 brd 192.168.200.255 scope global noprefixroute ens33
       valid_lft forever preferred_lft forever
    inet6 fe80::20c:29ff:fe0b:57dc/64 scope link 
       valid_lft forever preferred_lft forever
3: ens36: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast state UP group default qlen 1000
    link/ether 00:0c:29:0b:57:e6 brd ff:ff:ff:ff:ff:ff
    inet 192.168.200.135/24 brd 192.168.200.255 scope global noprefixroute ens36
       valid_lft forever preferred_lft forever
6: virbr0: &lt;NO-CARRIER,BROADCAST,MULTICAST,UP&gt; mtu 1500 qdisc noqueue state DOWN group default qlen 1000
    link/ether 52:54:00:cc:c5:d5 brd ff:ff:ff:ff:ff:ff
    inet 192.168.122.1/24 brd 192.168.122.255 scope global virbr0
       valid_lft forever preferred_lft forever
7: virbr0-nic: &lt;BROADCAST,MULTICAST&gt; mtu 1500 qdisc pfifo_fast master virbr0 state DOWN group default qlen 1000
    link/ether 52:54:00:cc:c5:d5 brd ff:ff:ff:ff:ff:ff
13: vnet0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast state UNKNOWN group default qlen 1000
    link/ether fe:54:00:8e:67:0a brd ff:ff:ff:ff:ff:ff
    inet6 fe80::fc54:ff:fe8e:670a/64 scope link 
       valid_lft forever preferred_lft forever
32: ens36.12@ens36: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue state UP group default qlen 1000
    link/ether 00:0c:29:0b:57:e6 brd ff:ff:ff:ff:ff:ff
    inet 172.16.12.12/24 brd 172.16.12.255 scope global noprefixroute ens36.12
       valid_lft forever preferred_lft forever
    inet6 fe80::20c:29ff:fe0b:57e6/64 scope link 
       valid_lft forever preferred_lft forever
33: ens36.11@ens36: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue state UP group default qlen 1000
    link/ether 00:0c:29:0b:57:e6 brd ff:ff:ff:ff:ff:ff
    inet 172.16.11.11/24 brd 172.16.11.255 scope global noprefixroute ens36.11
       valid_lft forever preferred_lft forever
    inet6 fe80::20c:29ff:fe0b:57e6/64 scope link 
       valid_lft forever preferred_lft forever
[root@kvm network-scripts]# virsh iface-list --all  #查看
 Name                 State      MAC Address
---------------------------------------------------
 ens33                active     00:0c:29:0b:57:dc
 ens36                active     00:0c:29:0b:57:e6
 ens36.11             active     00:0c:29:0b:57:e6
 ens36.12             active     00:0c:29:0b:57:e6
 lo                   active     00:00:00:00:00:00
</code></pre>
<p><img src="/images/KVM%E8%99%9A%E6%8B%9F%E5%8C%96%E8%BF%9B%E9%98%B6%E4%B8%8E%E6%8F%90%E9%AB%98%E8%A7%86%E9%A2%91%E8%AF%BE%E7%A8%8B/10.jpg"></p>
<h3><span id="3-通过virt-manager创建">3、通过virt-manager创建</span></h3><p><img src="/images/KVM%E8%99%9A%E6%8B%9F%E5%8C%96%E8%BF%9B%E9%98%B6%E4%B8%8E%E6%8F%90%E9%AB%98%E8%A7%86%E9%A2%91%E8%AF%BE%E7%A8%8B/11.jpg"><br><img src="/images/KVM%E8%99%9A%E6%8B%9F%E5%8C%96%E8%BF%9B%E9%98%B6%E4%B8%8E%E6%8F%90%E9%AB%98%E8%A7%86%E9%A2%91%E8%AF%BE%E7%A8%8B/12.jpg"><br><img src="/images/KVM%E8%99%9A%E6%8B%9F%E5%8C%96%E8%BF%9B%E9%98%B6%E4%B8%8E%E6%8F%90%E9%AB%98%E8%A7%86%E9%A2%91%E8%AF%BE%E7%A8%8B/13.jpg"></p>
<pre><code>[root@kvm network-scripts]# cat ifcfg-ens36.11 
DEVICE=&quot;ens36.11&quot;
VLAN=&quot;yes&quot;
ONBOOT=&quot;yes&quot;
BOOTPROTO=&quot;none&quot;
IPADDR=&quot;192.168.200.135&quot;
NETMASK=&quot;255.255.255.0&quot;
GATEWAY=&quot;192.168.200.2&quot;
</code></pre>
<h3><span id="4-虚拟机使用vlan">4、虚拟机使用vlan</span></h3><p><strong>一个vlan使用一个网桥，调用即可</strong><br><img src="/images/KVM%E8%99%9A%E6%8B%9F%E5%8C%96%E8%BF%9B%E9%98%B6%E4%B8%8E%E6%8F%90%E9%AB%98%E8%A7%86%E9%A2%91%E8%AF%BE%E7%A8%8B/14.jpg"></p>
<h2><span id="3-配置网络过滤">3、配置网络过滤</span></h2><p><strong>通过libvirtd使用ebtailes创建的规则</strong><br><img src="/images/KVM%E8%99%9A%E6%8B%9F%E5%8C%96%E8%BF%9B%E9%98%B6%E4%B8%8E%E6%8F%90%E9%AB%98%E8%A7%86%E9%A2%91%E8%AF%BE%E7%A8%8B/15.jpg"></p>
<pre><code>[root@kvm network-scripts]# virsh --help
  Network Filter (help keyword &#39;filter&#39;)
    nwfilter-define                define or update a network filter from an XML file
    nwfilter-dumpxml               network filter information in XML
    nwfilter-edit                  edit XML configuration for a network filter
    nwfilter-list                  list network filters
    nwfilter-undefine              undefine a network filter
    
    nwfilter-binding-create        create a network filter binding from an XML file
    nwfilter-binding-delete        delete a network filter binding
    nwfilter-binding-dumpxml       network filter information in XML
    nwfilter-binding-list          list network filter bindings
[root@kvm network-scripts]#  virsh nwfilter-list  #查看网络过滤列表
 UUID                                  Name                 
------------------------------------------------------------------
 3ce9cf03-2589-4b6a-8c1b-6e8b24e38f8e  allow-arp           
 a803defa-b342-47b4-af29-613250ff5281  allow-dhcp          
 5deae120-0ca4-4451-b8d4-92b6cd165962  allow-dhcp-server   
 49bdc080-9c7a-4278-9d83-59371bc9b981  allow-incoming-ipv4 
 64495a87-4efc-44f3-9aa2-1ef8e0a08600  allow-ipv4          
 cbd5d978-e475-4859-863d-1395d03da480  clean-traffic        #干净的流量
 14ed106c-6baa-4ffd-8f28-d5038fea01ef  clean-traffic-gateway
 f88bd332-81af-480f-af36-57a7cd35104e  no-arp-ip-spoofing  
 a7611c9f-2a3a-4f62-9039-4e5be77881b3  no-arp-mac-spoofing 
 92dfc42c-0ed9-4482-a8f4-eee46f168cb8  no-arp-spoofing     
 20951a13-4570-4a87-9aa5-587d128c899e  no-ip-multicast     
 be8c0f6f-c811-451d-ae18-7cef13c56380  no-ip-spoofing      
 d85ecc2e-5573-43a7-85c1-e88b4daa6fdd  no-mac-broadcast    
 108c0c1a-8471-48b5-998a-6d92226f084e  no-mac-spoofing     
 7101e610-2e76-495f-976a-e4a37dd3f6ef  no-other-l2-traffic 
 60911d33-fb36-46bf-8eec-eeacc2f0fe62  no-other-rarp-traffic
 40be9024-b924-4df0-b4c4-839e1026873f  qemu-announce-self  
 8bea3031-76ab-4077-9712-04d5b850e5fa  qemu-announce-self-rarp
[root@kvm network-scripts]# virsh nwfilter-dumpxml clean-traffic #查看详细信息
&lt;filter name=&#39;clean-traffic&#39; chain=&#39;root&#39;&gt; #默认规则及规则名称
  &lt;uuid&gt;cbd5d978-e475-4859-863d-1395d03da480&lt;/uuid&gt; #规则UUID
  &lt;filterref filter=&#39;no-mac-spoofing&#39;/&gt; #禁止MAC地址七篇
  &lt;filterref filter=&#39;no-ip-spoofing&#39;/&gt; #禁止IP地址欺骗
  &lt;rule action=&#39;accept&#39; direction=&#39;out&#39; priority=&#39;-650&#39;&gt; #accept代表动作，direction代表方向，in，out，inout，prioiy优先级，优先级值越低，优先级越高
    &lt;mac protocolid=&#39;ipv4&#39;/&gt; #ipv4的mac地址
  &lt;/rule&gt;
  &lt;filterref filter=&#39;allow-incoming-ipv4&#39;/&gt; #调用其他规则
  &lt;filterref filter=&#39;no-arp-spoofing&#39;/&gt;
  &lt;rule action=&#39;accept&#39; direction=&#39;inout&#39; priority=&#39;-500&#39;&gt;
    &lt;mac protocolid=&#39;arp&#39;/&gt;
  &lt;/rule&gt;
  &lt;filterref filter=&#39;no-other-l2-traffic&#39;/&gt; #调用其他规则
  &lt;filterref filter=&#39;qemu-announce-self&#39;/&gt;
&lt;/filter&gt;
[root@kvm network-scripts]# ebtables -t nat -L #查看ebtables的NAT表规则
Bridge table: nat

Bridge chain: PREROUTING, entries: 1, policy: ACCEPT
-j PREROUTING_direct

Bridge chain: OUTPUT, entries: 1, policy: ACCEPT
-j OUTPUT_direct

Bridge chain: POSTROUTING, entries: 1, policy: ACCEPT
-j POSTROUTING_direct

Bridge chain: PREROUTING_direct, entries: 1, policy: ACCEPT
-j RETURN 

Bridge chain: POSTROUTING_direct, entries: 1, policy: ACCEPT
-j RETURN 

Bridge chain: OUTPUT_direct, entries: 1, policy: ACCEPT
-j RETURN 
[root@kvm network-scripts]# virsh list --all  #查看虚拟机，准备于过滤规则绑定
 Id    Name                           State
----------------------------------------------------
 5     generic                        running
 -     centos7.0                      shut off
[root@kvm network-scripts]# virsh dumpxml --domain generic
    &lt;interface type=&#39;bridge&#39;&gt;
      &lt;mac address=&#39;52:54:00:8e:67:0a&#39;/&gt;
      &lt;source bridge=&#39;virbr1&#39;/&gt;
      &lt;target dev=&#39;vnet0&#39;/&gt;
      &lt;model type=&#39;rtl8139&#39;/&gt;
      &lt;alias name=&#39;net0&#39;/&gt;
      &lt;address type=&#39;pci&#39; domain=&#39;0x0000&#39; bus=&#39;0x00&#39; slot=&#39;0x03&#39; function=&#39;0x0&#39;/&gt;
    &lt;/interface&gt;
[root@kvm ~]# vim nwtest.xml
    &lt;interface type=&#39;bridge&#39;&gt;
      &lt;mac address=&#39;52:54:00:8e:67:0a&#39;/&gt;
      &lt;source bridge=&#39;virbr1&#39;/&gt;
      &lt;target dev=&#39;vnet0&#39;/&gt;
      &lt;model type=&#39;rtl8139&#39;/&gt;
      &lt;alias name=&#39;net0&#39;/&gt;
      &lt;address type=&#39;pci&#39; domain=&#39;0x0000&#39; bus=&#39;0x00&#39; slot=&#39;0x03&#39; function=&#39;0x0&#39;/&gt;
      &lt;filterref filter=&#39;clean-traffic&#39;/&gt; #增加过滤规则，调用clean-traffic
    &lt;/interface&gt;
[root@kvm ~]# virsh update-device --domain generic --file /root/nwtest.xml --persistent --live #更新generic主机，--file选择创建的文件，--persistent 代表永久生效，--live代表当前主机正在运行
Device updated successfully
[root@kvm ~]#  ebtables -t nat -L  #查看规则生效情况
Bridge table: nat

Bridge chain: PREROUTING, entries: 2, policy: ACCEPT
-j PREROUTING_direct
-i vnet0 -j libvirt-I-vnet0

Bridge chain: OUTPUT, entries: 1, policy: ACCEPT
-j OUTPUT_direct

Bridge chain: POSTROUTING, entries: 1, policy: ACCEPT
-j POSTROUTING_direct

Bridge chain: PREROUTING_direct, entries: 1, policy: ACCEPT
-j RETURN 

Bridge chain: POSTROUTING_direct, entries: 1, policy: ACCEPT
-j RETURN 

Bridge chain: OUTPUT_direct, entries: 1, policy: ACCEPT
-j RETURN 

Bridge chain: libvirt-I-vnet0, entries: 4, policy: ACCEPT
-s ! 52:54:0:8e:67:a -j DROP 
-p IPv4 -j ACCEPT 
-p ARP -j ACCEPT 
-j DROP 
[root@kvm ~]# virsh shutdown --domain generic  #关闭虚拟机
Domain generic is being shutdown

[root@kvm ~]# virsh list --all  #查看主机是否正常关闭
 Id    Name                           State
----------------------------------------------------
 -     centos7.0                      shut off
 -     generic                        shut off

[root@kvm ~]#  ebtables -t nat -L  #查看规则清空
Bridge table: nat

Bridge chain: PREROUTING, entries: 1, policy: ACCEPT
-j PREROUTING_direct

Bridge chain: OUTPUT, entries: 1, policy: ACCEPT
-j OUTPUT_direct

Bridge chain: POSTROUTING, entries: 1, policy: ACCEPT
-j POSTROUTING_direct

Bridge chain: PREROUTING_direct, entries: 1, policy: ACCEPT
-j RETURN 

Bridge chain: POSTROUTING_direct, entries: 1, policy: ACCEPT
-j RETURN 

Bridge chain: OUTPUT_direct, entries: 1, policy: ACCEPT
-j RETURN 
[root@kvm ~]# virsh start --domain generic  #重新启动主机



Domain generic started
[root@kvm ~]#  ebtables -t nat -L  #再次查看规则
Bridge table: nat

Bridge chain: PREROUTING, entries: 2, policy: ACCEPT
-j PREROUTING_direct
-i vnet0 -j libvirt-I-vnet0

Bridge chain: OUTPUT, entries: 1, policy: ACCEPT
-j OUTPUT_direct

Bridge chain: POSTROUTING, entries: 1, policy: ACCEPT
-j POSTROUTING_direct

Bridge chain: PREROUTING_direct, entries: 1, policy: ACCEPT
-j RETURN 

Bridge chain: POSTROUTING_direct, entries: 1, policy: ACCEPT
-j RETURN 

Bridge chain: OUTPUT_direct, entries: 1, policy: ACCEPT
-j RETURN 

Bridge chain: libvirt-I-vnet0, entries: 4, policy: ACCEPT
-s ! 52:54:0:8e:67:a -j DROP 
-p IPv4 -j ACCEPT 
-p ARP -j ACCEPT 
-j DROP 
</code></pre>
<p><img src="/images/KVM%E8%99%9A%E6%8B%9F%E5%8C%96%E8%BF%9B%E9%98%B6%E4%B8%8E%E6%8F%90%E9%AB%98%E8%A7%86%E9%A2%91%E8%AF%BE%E7%A8%8B/16.jpg"></p>
<h1><span id="二-虚拟机迁移">二、虚拟机迁移</span></h1><p><strong>静态迁移中可以通过将虚拟机暂停，迁移完成后重置虚拟机状态，完成迁移，但是也会影响业务</strong></p>
<p><img src="/images/KVM%E8%99%9A%E6%8B%9F%E5%8C%96%E8%BF%9B%E9%98%B6%E4%B8%8E%E6%8F%90%E9%AB%98%E8%A7%86%E9%A2%91%E8%AF%BE%E7%A8%8B/17.jpg"><br><img src="/images/KVM%E8%99%9A%E6%8B%9F%E5%8C%96%E8%BF%9B%E9%98%B6%E4%B8%8E%E6%8F%90%E9%AB%98%E8%A7%86%E9%A2%91%E8%AF%BE%E7%A8%8B/18.jpg"><br><img src="/images/KVM%E8%99%9A%E6%8B%9F%E5%8C%96%E8%BF%9B%E9%98%B6%E4%B8%8E%E6%8F%90%E9%AB%98%E8%A7%86%E9%A2%91%E8%AF%BE%E7%A8%8B/19.jpg"></p>
<h2><span id="1-通过uri连接连接kvm主机">1、通过URI连接连接KVM主机</span></h2><p><img src="/images/KVM%E8%99%9A%E6%8B%9F%E5%8C%96%E8%BF%9B%E9%98%B6%E4%B8%8E%E6%8F%90%E9%AB%98%E8%A7%86%E9%A2%91%E8%AF%BE%E7%A8%8B/20.jpg"></p>
<pre><code>[root@kvm ~]# virsh --help

virsh [options]... [&lt;command_string&gt;]
virsh [options]... &lt;command&gt; [args...]

  options:
    -c | --connect=URI      hypervisor connection URI
[root@kvm ~]# virsh -c qemu+ssh://root@122.200.93.9/system #远程连接其他KVM主机
root@122.200.93.9&#39;s password: 
Welcome to virsh, the virtualization interactive terminal.

Type:  &#39;help&#39; for help with commands
       &#39;quit&#39; to quit

virsh # list --all
 Id    Name                           State
----------------------------------------------------
 -     centos7.0                      shut off
 -     centos7.0-2                    shut off
 -     centos7.0-3                    shut off
 -     generic         
 virsh # hostname 
kvm.novalocal
</code></pre>
<p><img src="/images/KVM%E8%99%9A%E6%8B%9F%E5%8C%96%E8%BF%9B%E9%98%B6%E4%B8%8E%E6%8F%90%E9%AB%98%E8%A7%86%E9%A2%91%E8%AF%BE%E7%A8%8B/21.jpg"></p>
<h2><span id="2-静态迁移">2、静态迁移</span></h2><h3><span id="1-同一宿主机内迁移">1、同一宿主机内迁移</span></h3><p><img src="/images/KVM%E8%99%9A%E6%8B%9F%E5%8C%96%E8%BF%9B%E9%98%B6%E4%B8%8E%E6%8F%90%E9%AB%98%E8%A7%86%E9%A2%91%E8%AF%BE%E7%A8%8B/22.jpg"></p>
<pre><code>[root@kvm ~]# virsh list --all  #查看虚拟机状态
 Id    Name                           State
----------------------------------------------------
 7     generic                        running
 -     centos7.0                      shut off

[root@kvm ~]# virsh domblklist --domain generic  #查看硬盘路径
Target     Source
------------------------------------------------
hda        /vm/centos7.6.raw
hdb        -

[root@kvm ~]# virsh shutdown --domain generic #关闭虚拟机
Domain generic is being shutdown
[root@kvm ~]# virsh list --all #再次查看状态
 Id    Name                           State
----------------------------------------------------
 -     centos7.0                      shut off
 -     generic                        shut off
[root@kvm ~]# mkdir /vm1 #创建迁移后的文件夹
[root@kvm ~]# mv /vm/centos7.6.raw /vm1/ #迁移硬盘
[root@kvm ~]# ls -lha /vm1 #查看迁移结果
total 21G
drwxr-xr-x.  2 root root  27 Apr  8 06:41 .
dr-xr-xr-x. 22 root root 279 Apr  8 06:41 ..
-rw-------.  1 root root 20G Apr  8 06:40 centos7.6.raw
[root@kvm ~]# virsh start --domain generic  #尝试启动虚拟机，报错，需要修改配置文件
error: Failed to start domain generic
error: Cannot access storage file &#39;/vm/centos7.6.raw&#39;: 没有那个文件或目录
[root@kvm ~]# virsh edit --domain generic
    &lt;disk type=&#39;file&#39; device=&#39;disk&#39;&gt;
      &lt;driver name=&#39;qemu&#39; type=&#39;raw&#39;/&gt;
      &lt;source file=&#39;/vm1/centos7.6.raw&#39;/&gt; #修改源文件路径
      &lt;target dev=&#39;hda&#39; bus=&#39;ide&#39;/&gt;
      &lt;address type=&#39;drive&#39; controller=&#39;0&#39; bus=&#39;0&#39; target=&#39;0&#39; unit=&#39;0&#39;/&gt;
    &lt;/disk&gt;
[root@kvm ~]# virsh start --domain generic #启动成功，迁移完毕
Domain generic started
</code></pre>
<h3><span id="2-不同宿主机迁移">2、不同宿主机迁移</span></h3><p><img src="/images/KVM%E8%99%9A%E6%8B%9F%E5%8C%96%E8%BF%9B%E9%98%B6%E4%B8%8E%E6%8F%90%E9%AB%98%E8%A7%86%E9%A2%91%E8%AF%BE%E7%A8%8B/23.jpg"><br><img src="/images/KVM%E8%99%9A%E6%8B%9F%E5%8C%96%E8%BF%9B%E9%98%B6%E4%B8%8E%E6%8F%90%E9%AB%98%E8%A7%86%E9%A2%91%E8%AF%BE%E7%A8%8B/24.jpg"></p>
<table>
<thead>
<tr>
<th>序号</th>
<th>主机名称</th>
<th>主机IP</th>
</tr>
</thead>
<tbody><tr>
<td>1</td>
<td>kvm</td>
<td>192.168.200.128</td>
</tr>
<tr>
<td>2</td>
<td>kvm2</td>
<td>192.168.200.129</td>
</tr>
</tbody></table>
<h4><span id="kvm">kvm：</span></h4><p><strong>静态迁移要确保虚拟机处于关闭状态</strong></p>
<blockquote>
<p>迁移可以使用scp或者rsync -avSHP进行数据传输</p>
</blockquote>
<pre><code>[root@kvm ~]# cat /etc/hosts
127.0.0.1   localhost localhost.localdomain localhost4 localhost4.localdomain4
::1         localhost localhost.localdomain localhost6 localhost6.localdomain6
192.168.200.128 kvm
192.168.200.129 kvm2
[root@kvm ~]# virsh list --all 
 Id    Name                           State
----------------------------------------------------
 -     centos7.0                      shut off
 -     generic                        shut off #迁移此台主机
 [root@kvm ~]# scp /etc/libvirt/qemu/generic.xml root@192.168.200.129:/etc/libvirt/qemu/ #将配置文件传送过去，确保主机当前状态是关机
The authenticity of host &#39;192.168.200.129 (192.168.200.129)&#39; can&#39;t be established.
ECDSA key fingerprint is SHA256:s2qiffBOYjuMJQOHEI9r87NTNjd0XyoEf81myM78kbQ.
ECDSA key fingerprint is MD5:a5:8f:de:d4:07:9f:b7:b3:6f:7c:b0:c3:55:eb:bb:b0.
Are you sure you want to continue connecting (yes/no)? yes
Warning: Permanently added &#39;192.168.200.129&#39; (ECDSA) to the list of known hosts.

root@192.168.200.129&#39;s password: 
generic.xml                                                                                                                                                                                                                                                                               100% 4329     5.0MB/s   00:00    
[root@kvm ~]# virsh domblklist --domain generic #查看硬盘文件
Target     Source
------------------------------------------------
hda        /vm1/centos7.6.raw
hdb        -
[root@kvm ~]# scp /vm1/centos7.6.raw root@kvm2:/vm1/ #传输硬盘文件到目标主机上，路径最好保持一致，否则需要修改XML文件
</code></pre>
<h4><span id="kvm2">kvm2：</span></h4><pre><code>[root@kvm2 ~]# cat /etc/hosts
127.0.0.1   localhost localhost.localdomain localhost4 localhost4.localdomain4
::1         localhost localhost.localdomain localhost6 localhost6.localdomain6
192.168.200.128 kvm
192.168.200.129 kvm2
[root@kvm2 ~]# virsh list --all 
 Id    Name                           State
----------------------------------------------------
[root@kvm2 ~]# mkdir /vm1 #需要提前创建出目录，否则上述传输的时候会报错
[root@kvm2 vm1]# ls -lha /etc/libvirt/qemu/generic.xml  #查看传输过来的xml配置文件
-rw-------. 1 root root 4.3K Apr 10 16:02 /etc/libvirt/qemu/generic.xml
[root@kvm2 vm1]# ls /vm1/centos7.6.raw #查看硬盘文件 
/vm1/centos7.6.raw
[root@kvm2 vm1]# virsh define --file /etc/libvirt/qemu/generic.xml  #定义硬盘文件
Domain generic defined from /etc/libvirt/qemu/generic.xml
[root@kvm2 vm1]# virsh list --all #查看识别到此主机，准备启动
 Id    Name                           State
----------------------------------------------------
 -     generic                        shut off
[root@kvm2 vm1]# virsh start generic #启动成功
Domain generic started
</code></pre>
<p><img src="/images/KVM%E8%99%9A%E6%8B%9F%E5%8C%96%E8%BF%9B%E9%98%B6%E4%B8%8E%E6%8F%90%E9%AB%98%E8%A7%86%E9%A2%91%E8%AF%BE%E7%A8%8B/25.jpg"></p>
<p><strong>尝试本地远程成功，迁移完毕</strong></p>
<pre><code>[root@kvm2 vm1]# ssh root@192.168.122.149
root@192.168.122.149&#39;s password: 
Last login: Mon Apr 10 04:35:12 2023
[root@localhost ~]# ip a 
1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
    inet 127.0.0.1/8 scope host lo
       valid_lft forever preferred_lft forever
    inet6 ::1/128 scope host 
       valid_lft forever preferred_lft forever
2: ens3: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast state UP group default qlen 1000
    link/ether 52:54:00:8e:67:0a brd ff:ff:ff:ff:ff:ff
    inet 192.168.122.149/24 brd 192.168.122.255 scope global noprefixroute dynamic ens3
       valid_lft 3503sec preferred_lft 3503sec
    inet6 fe80::aaa:8f11:d0df:a3a7/64 scope link noprefixroute 
       valid_lft forever preferred_lft forever
</code></pre>
<blockquote>
<p><strong>确保正常启动且无问题后删除源宿主机的相关配置，防止IP、Mac等冲突，引起不必要的问题</strong></p>
</blockquote>
<h3><span id="3-不同宿主机迁移使用virsh-migrate命令">3、不同宿主机迁移使用virsh migrate命令</span></h3><p><img src="/images/KVM%E8%99%9A%E6%8B%9F%E5%8C%96%E8%BF%9B%E9%98%B6%E4%B8%8E%E6%8F%90%E9%AB%98%E8%A7%86%E9%A2%91%E8%AF%BE%E7%A8%8B/26.jpg"></p>
<p><strong>如果做了上述动作，需要先还原环境，本方法只作为了解，实际和scp效果一样</strong></p>
<p>1、在KVM2主机中查看主机列表</p>
<pre><code>[root@kvm2 vm1]# virsh list --all 
 Id    Name                           State
----------------------------------------------------
 1     generic                        running
</code></pre>
<p>2、在KVM2主机中关闭启动的generic主机</p>
<pre><code>[root@kvm2 vm1]# virsh shutdown --domain generic 
Domain generic is being shutdown
</code></pre>
<p>3、在KVM2主机中取消generic的xml文件定义</p>
<pre><code>[root@kvm2 vm1]# virsh undefine --domain generic
Domain generic has been undefined
</code></pre>
<p>4、在KVM2主机中删除generic的硬盘文件</p>
<pre><code>[root@kvm2 vm1]# cd /vm1
[root@kvm2 vm1]# ls -lha 
total 20G
drwxr-xr-x.  2 root root  27 Apr 10 16:03 .
dr-xr-xr-x. 22 root root 279 Apr  8 06:41 ..
-rw-------.  1 root root 20G Apr 10 16:46 centos7.6.raw
[root@kvm2 vm1]# rm -rf centos7.6.raw 
</code></pre>
<p>5、在KVM1主机中将generic主机关机<br><code>[root@kvm ~]# virsh shutdown --domain generic</code></p>
<p>6、在KVM1主机中查看migrate帮助</p>
<pre><code>[root@kvm ~]# virsh migrate --help 
  NAME
    migrate - 将域迁移到另一个主机中

  SYNOPSIS
    migrate &lt;domain&gt; &lt;desturi&gt; [--live] [--offline] [--p2p] [--direct] [--tunnelled] [--persistent] [--undefinesource] [--suspend] [--copy-storage-all] [--copy-storage-inc] [--change-protection] [--unsafe] [--verbose] [--compressed] [--auto-converge] [--rdma-pin-all] [--abort-on-error] [--postcopy] [--postcopy-after-precopy] [--migrateuri &lt;string&gt;] [--graphicsuri &lt;string&gt;] [--listen-address &lt;string&gt;] [--dname &lt;string&gt;] [--timeout &lt;number&gt;] [--timeout-suspend] [--timeout-postcopy] [--xml &lt;string&gt;] [--migrate-disks &lt;string&gt;] [--disks-port &lt;number&gt;] [--comp-methods &lt;string&gt;] [--comp-mt-level &lt;number&gt;] [--comp-mt-threads &lt;number&gt;] [--comp-mt-dthreads &lt;number&gt;] [--comp-xbzrle-cache &lt;number&gt;] [--auto-converge-initial &lt;number&gt;] [--auto-converge-increment &lt;number&gt;] [--persistent-xml &lt;string&gt;] [--tls]

  DESCRIPTION
    将域迁移到另一个主机中。热迁移时添加 --live。

  OPTIONS
    [--domain] &lt;string&gt;  domain name, id or uuid
    [--desturi] &lt;string&gt;  客户端（常规迁移）或者源（p2p 迁移）中看到到目的地主机连接 URI
    --live           热迁移
    --offline        离线迁移
    --p2p            点对点迁移
    --direct         直接迁移
    --tunnelled      管道迁移
    --persistent     目的地中的持久 VM
    --undefinesource  在源中取消定义 VM
    --suspend        部启用目的地主机中的域
    --copy-storage-all  使用全磁盘复制的非共享存储进行迁移
    --copy-storage-inc  使用增值复制（源和目的地共享同一基础映像）的非共享存储进行迁移
    --change-protection  迁移结束前不得对域进行任何配置更改
    --unsafe         即使不安全也要强制迁移
    --verbose        显示迁移进程
    --compressed     实时迁移过程中压缩重复的页
    --auto-converge  force convergence during live migration
    --rdma-pin-all   pin all memory before starting RDMA live migration
    --abort-on-error  在迁移过程中忽略软错误
    --postcopy       enable post-copy migration; switch to it using migrate-postcopy command
    --postcopy-after-precopy  automatically switch to post-copy migration after one pass of pre-copy
    --migrateuri &lt;string&gt;  迁移 URI， 通常可省略
    --graphicsuri &lt;string&gt;  无空隙图形迁移中使用的图形 URI
    --listen-address &lt;string&gt;  listen address that destination should bind to for incoming migration
    --dname &lt;string&gt;  在迁移过长中重新命名为一个新名称（如果支持）
    --timeout &lt;number&gt;  run action specified by --timeout-* option (suspend by default) if live migration exceeds timeout (in seconds)
    --timeout-suspend  suspend the guest after timeout
    --timeout-postcopy  switch to post-copy after timeout
    --xml &lt;string&gt;   包含为目标更新的 XML 的文件名
    --migrate-disks &lt;string&gt;  comma separated list of disks to be migrated
    --disks-port &lt;number&gt;  port to use by target server for incoming disks migration
    --comp-methods &lt;string&gt;  comma separated list of compression methods to be used
    --comp-mt-level &lt;number&gt;  compress level for multithread compression
    --comp-mt-threads &lt;number&gt;  number of compression threads for multithread compression
    --comp-mt-dthreads &lt;number&gt;  number of decompression threads for multithread compression
    --comp-xbzrle-cache &lt;number&gt;  page cache size for xbzrle compression
    --auto-converge-initial &lt;number&gt;  initial CPU throttling rate for auto-convergence
    --auto-converge-increment &lt;number&gt;  CPU throttling rate increment for auto-convergence
    --persistent-xml &lt;string&gt;  filename containing updated persistent XML for the target
    --tls            use TLS for migration
</code></pre>
<p>7、在KVM1主机中使用migrate命令迁移</p>
<pre><code>[root@kvm ~]# virsh migrate --domain generic --desturi qemu+ssh://root@kvm2/system --offline --persistent 
root@kvm2&#39;s password: 
</code></pre>
<p>8、在KVM2主机中查看主机是否迁移并尝试启动主机</p>
<pre><code>[root@kvm2 vm1]# virsh list --all 
 Id    Name                           State
----------------------------------------------------
 -     generic                        shut off

[root@kvm2 vm1]# virsh start --domain generic 
error: Failed to start domain generic
error: Cannot access storage file &#39;/vm1/centos7.6.raw&#39;: 没有那个文件或目录
</code></pre>
<p>9、在KVM1主机中将所需的硬盘文件复制到KVM2主机的vm1目录下</p>
<pre><code>[root@kvm ~]# rsync -avSHP /vm1/centos7.6.raw root@kvm2:/vm1
root@kvm2&#39;s password: 
sending incremental file list
centos7.6.raw
 21,474,836,480 100%   57.68MB/s    0:05:55 (xfr#1, to-chk=0/1)

sent 21,480,079,452 bytes  received 35 bytes  59,749,873.40 bytes/sec
total size is 21,474,836,480  speedup is 1.00
</code></pre>
<p>10、在KVM2主机中再次尝试启动主机</p>
<pre><code>[root@kvm2 vm1]# virsh start --domain generic 
Domain generic started
</code></pre>
<h2><span id="3-基于共享存储的动态迁移">3、基于共享存储的动态迁移</span></h2><blockquote>
<p><strong>确保防火墙等安全防护工具处于关闭状态或者端口放行状态</strong></p>
</blockquote>
<p><strong>需要安装NFS服务器</strong></p>
<table>
<thead>
<tr>
<th>主机</th>
<th>Lan</th>
<th>Private</th>
<th>Stroage</th>
</tr>
</thead>
<tbody><tr>
<td>kvm1</td>
<td>192.168.200.135</td>
<td>172.16.1.135</td>
<td>10.0.1.231</td>
</tr>
<tr>
<td>kvm2</td>
<td>192.168.200.136</td>
<td>172.16.1.136</td>
<td>10.0.1.232</td>
</tr>
<tr>
<td>NFS</td>
<td>192.168.200.137</td>
<td></td>
<td>10.0.1.230</td>
</tr>
</tbody></table>
<h3><span id="1-安装nfs服务器组件">1、安装NFS服务器组件</span></h3><p><img src="/images/KVM%E8%99%9A%E6%8B%9F%E5%8C%96%E8%BF%9B%E9%98%B6%E4%B8%8E%E6%8F%90%E9%AB%98%E8%A7%86%E9%A2%91%E8%AF%BE%E7%A8%8B/27.jpg"></p>
<pre><code>[root@nfs ~]# yum -y install nfs-utils
[root@nfs ~]# systemctl start rpcbind
[root@nfs ~]# systemctl start nfs-server
[root@nfs ~]# systemctl enable rpcbind
[root@nfs ~]# systemctl enable nfs-server
Created symlink from /etc/systemd/system/multi-user.target.wants/nfs-server.service to /usr/lib/systemd/system/nfs-server.service.
</code></pre>
<h3><span id="创建nfs共享文件夹">创建NFS共享文件夹</span></h3><pre><code>[root@nfs ~]# mkdir /vm1
[root@nfs ~]# touch /vm1/testfile1.txt
[root@nfs ~]# vim /etc/exports  #修改export文件
/vm1 *(rw,no_root_squash,sync)
[root@nfs ~]# systemctl restart nfs-server #重启服务
[root@nfs ~]# showmount -e localhost #查看对外提供的共享文件夹
Export list for localhost:
/vm1 *
</code></pre>
<h3><span id="将kvm1中的虚拟机硬盘迁移到nfs服务器的共享存储上">将KVM1中的虚拟机硬盘迁移到NFS服务器的共享存储上</span></h3><pre><code>[root@kvm ~]# mkdir /vmdata #在KVM1服务器中创建挂载点
[root@kvm ~]# mount 192.168.200.137:/vm1 /vmdata/ #挂载NFS服务器中的vm1共享文件夹到本地的/vmdata。这里的IP建议使用专有的隧道网络，如万兆光等
[root@kvm ~]# df -HT  #查看挂载情况
文件系统                类型      容量  已用  可用 已用% 挂载点
devtmpfs                devtmpfs  2.0G     0  2.0G    0% /dev
tmpfs                   tmpfs     2.0G     0  2.0G    0% /dev/shm
tmpfs                   tmpfs     2.0G   13M  2.0G    1% /run
tmpfs                   tmpfs     2.0G     0  2.0G    0% /sys/fs/cgroup
/dev/mapper/centos-root xfs        38G   35G  3.7G   91% /
/dev/sda1               xfs       1.1G  206M  859M   20% /boot
tmpfs                   tmpfs     396M     0  396M    0% /run/user/0
192.168.200.137:/vm1    nfs4       38G   15G   24G   39% /vmdata
[root@kvm ~]# virsh list --all #查看迁移的主机
 Id    名称                         状态
----------------------------------------------------
 -     generic                        关闭

[root@kvm ~]# virsh edit --domain generic #编辑xml文件中的disk，如果直接修改xml文件，源硬盘会被直接迁移到nfs的共享目录中，老版本可能需要手动复制到挂载点
    &lt;disk type=&#39;file&#39; device=&#39;disk&#39;&gt;
      &lt;driver name=&#39;qemu&#39; type=&#39;raw&#39;/&gt;
      &lt;source file=&#39;/vmdata/centos7.6.raw&#39;/&gt; #修改
      &lt;target dev=&#39;hda&#39; bus=&#39;ide&#39;/&gt;
      &lt;address type=&#39;drive&#39; controller=&#39;0&#39; bus=&#39;0&#39; target=&#39;0&#39; unit=&#39;0&#39;/&gt;
    &lt;/disk&gt;
[root@kvm vmdata]# ls -lh /vmdata/ #查看共享文件中已经存在相关硬盘文件
总用量 1.8G
-rw-------. 1 root root 20G 4月  10 17:10 centos7.6.raw
-rw-r--r--. 1 root root   0 4月  12 2023 testfile1.txt
[root@kvm vmdata]# virsh start --domain generic  #尝试启动
错误：开始域 generic 失败
错误：内部错误：process exited while connecting to monitor: 2023-04-10T09:59:16.927297Z qemu-kvm: -drive file=/vmdata/centos7.6.raw,format=raw,if=none,id=drive-ide0-0-0: could not open disk image /vmdata/centos7.6.raw: Could not open &#39;/vmdata/centos7.6.raw&#39;: Permission denied
[root@kvm vmdata]# sestatus #查看selinux启动，导致无法启动虚拟机
SELinux status:                 enabled
SELinuxfs mount:                /sys/fs/selinux
SELinux root directory:         /etc/selinux
Loaded policy name:             targeted
Current mode:                   enforcing
Mode from config file:          enforcing
Policy MLS status:              enabled
Policy deny_unknown status:     allowed
Max kernel policy version:      31
[root@kvm vmdata]# setenforce 
usage:  setenforce [ Enforcing | Permissive | 1 | 0 ]
[root@kvm vmdata]# setenforce 0 #临时关闭selinux
[root@kvm vmdata]# virsh start --domain generic  #正常启动
域 generic 已开始
</code></pre>
<blockquote>
<p>如果修改完后虚拟机无法正常启动，提示权限错误，可能是由于Selinux的问题</p>
</blockquote>
<p><img src="/images/KVM%E8%99%9A%E6%8B%9F%E5%8C%96%E8%BF%9B%E9%98%B6%E4%B8%8E%E6%8F%90%E9%AB%98%E8%A7%86%E9%A2%91%E8%AF%BE%E7%A8%8B/28.jpg"></p>
<blockquote>
<p>建议不要关闭selinux，可以放行nfs的相关服务</p>
</blockquote>
<p><img src="/images/KVM%E8%99%9A%E6%8B%9F%E5%8C%96%E8%BF%9B%E9%98%B6%E4%B8%8E%E6%8F%90%E9%AB%98%E8%A7%86%E9%A2%91%E8%AF%BE%E7%A8%8B/29.png"></p>
<pre><code>[root@kvm vmdata]# virsh shutdown --domain generic #关闭虚拟机
域 generic 被关闭
[root@kvm vmdata]# sestatus #查看当前Selinux状态为临时关闭
SELinux status:                 enabled
SELinuxfs mount:                /sys/fs/selinux
SELinux root directory:         /etc/selinux
Loaded policy name:             targeted
Current mode:                   permissive
Mode from config file:          enforcing
Policy MLS status:              enabled
Policy deny_unknown status:     allowed
Max kernel policy version:      31
[root@kvm vmdata]# setenforce 1 #启用Selinux
[root@kvm vmdata]# sestatus #再次查看为启动状态
SELinux status:                 enabled
SELinuxfs mount:                /sys/fs/selinux
SELinux root directory:         /etc/selinux
Loaded policy name:             targeted
Current mode:                   enforcing
Mode from config file:          enforcing
Policy MLS status:              enabled
Policy deny_unknown status:     allowed
Max kernel policy version:      31
[root@kvm vmdata]# setsebool -P virt_use_nfs 1 #需要在所有的计算节点开启
[root@kvm vmdata]# virsh start --domain generic  #尝试可以正常启动
域 generic 已开始
[root@kvm vmdata]# virsh shutdown --domain generic #关机，准备迁移
域 generic 被关闭
</code></pre>
<h3><span id="2-使用virt-manager进行迁移">2、使用virt-manager进行迁移</span></h3><p>KVM2：</p>
<pre><code>[root@kvm2 ~]# mkdir /vmdata
[root@kvm2 ~]# ls -lh /vmdata
total 0
[root@kvm2 ~]# mount 192.168.200.137:/vm1 /vmdata/
[root@kvm2 ~]# ls -lh /vmdata
total 1.8G
-rw-------. 1 root root 20G Apr 12 17:40 centos7.6.raw
-rw-r--r--. 1 root root   0 Apr 12 16:57 testfile1.txt
</code></pre>
<p>KVM1:</p>
<p><img src="/images/KVM%E8%99%9A%E6%8B%9F%E5%8C%96%E8%BF%9B%E9%98%B6%E4%B8%8E%E6%8F%90%E9%AB%98%E8%A7%86%E9%A2%91%E8%AF%BE%E7%A8%8B/30.png"></p>
<p><img src="/images/KVM%E8%99%9A%E6%8B%9F%E5%8C%96%E8%BF%9B%E9%98%B6%E4%B8%8E%E6%8F%90%E9%AB%98%E8%A7%86%E9%A2%91%E8%AF%BE%E7%A8%8B/31.jpg"></p>
<p><img src="/images/KVM%E8%99%9A%E6%8B%9F%E5%8C%96%E8%BF%9B%E9%98%B6%E4%B8%8E%E6%8F%90%E9%AB%98%E8%A7%86%E9%A2%91%E8%AF%BE%E7%A8%8B/32.jpg"></p>
<p><img src="/images/KVM%E8%99%9A%E6%8B%9F%E5%8C%96%E8%BF%9B%E9%98%B6%E4%B8%8E%E6%8F%90%E9%AB%98%E8%A7%86%E9%A2%91%E8%AF%BE%E7%A8%8B/33.jpg"></p>
<p><img src="/images/KVM%E8%99%9A%E6%8B%9F%E5%8C%96%E8%BF%9B%E9%98%B6%E4%B8%8E%E6%8F%90%E9%AB%98%E8%A7%86%E9%A2%91%E8%AF%BE%E7%A8%8B/34.png"></p>
<p><img src="/images/KVM%E8%99%9A%E6%8B%9F%E5%8C%96%E8%BF%9B%E9%98%B6%E4%B8%8E%E6%8F%90%E9%AB%98%E8%A7%86%E9%A2%91%E8%AF%BE%E7%A8%8B/35.png"></p>
<p><img src="/images/KVM%E8%99%9A%E6%8B%9F%E5%8C%96%E8%BF%9B%E9%98%B6%E4%B8%8E%E6%8F%90%E9%AB%98%E8%A7%86%E9%A2%91%E8%AF%BE%E7%A8%8B/36.jpg"></p>
<p><img src="/images/KVM%E8%99%9A%E6%8B%9F%E5%8C%96%E8%BF%9B%E9%98%B6%E4%B8%8E%E6%8F%90%E9%AB%98%E8%A7%86%E9%A2%91%E8%AF%BE%E7%A8%8B/37.jpg"></p>
<p><img src="/images/KVM%E8%99%9A%E6%8B%9F%E5%8C%96%E8%BF%9B%E9%98%B6%E4%B8%8E%E6%8F%90%E9%AB%98%E8%A7%86%E9%A2%91%E8%AF%BE%E7%A8%8B/38.png"></p>
<p><img src="/images/KVM%E8%99%9A%E6%8B%9F%E5%8C%96%E8%BF%9B%E9%98%B6%E4%B8%8E%E6%8F%90%E9%AB%98%E8%A7%86%E9%A2%91%E8%AF%BE%E7%A8%8B/39.jpg"></p>
<pre><code>[root@kvm2 ~]# setsebool -P virt_use_nfs 1
[root@kvm2 ~]# iptables -I INPUT -p tcp --dport 49152:49215 -j ACCEPT
[root@kvm2 ~]# iptables -I INPUT -p tcp --dport 16509 -j ACCEPT
</code></pre>
<p><img src="/images/KVM%E8%99%9A%E6%8B%9F%E5%8C%96%E8%BF%9B%E9%98%B6%E4%B8%8E%E6%8F%90%E9%AB%98%E8%A7%86%E9%A2%91%E8%AF%BE%E7%A8%8B/40.jpg"></p>
<p><img src="/images/KVM%E8%99%9A%E6%8B%9F%E5%8C%96%E8%BF%9B%E9%98%B6%E4%B8%8E%E6%8F%90%E9%AB%98%E8%A7%86%E9%A2%91%E8%AF%BE%E7%A8%8B/41.jpg"></p>
<p>Allow unsafe：CPU缓存的模式，默认使用none<br>Temporary move：临时移动，移动后不删除源主机的相关配置</p>
<h3><span id="3-使用virsh命令进行迁移">3、使用virsh命令进行迁移</span></h3><h4><span id="1-查看帮助">1、查看帮助</span></h4><pre><code>[root@kvm ~]# virsh  migrate --help 
  名称：
    migrate-将域迁移到另一台主机

  简介：
    migrate &lt;domain&gt; &lt;desturi&gt; [--live] [--offline] [--p2p] [--direct] [--tunnelled] [--persistent] [--undefinesource] [--suspend] [--copy-storage-all] [--copy-storage-inc] [--change-protection] [--unsafe] [--verbose] [--compressed] [--auto-converge] [--rdma-pin-all] [--abort-on-error] [--postcopy] [--postcopy-after-precopy] [--migrateuri &lt;string&gt;] [--graphicsuri &lt;string&gt;] [--listen-address &lt;string&gt;] [--dname &lt;string&gt;] [--timeout &lt;number&gt;] [--timeout-suspend] [--timeout-postcopy] [--xml &lt;string&gt;] [--migrate-disks &lt;string&gt;] [--disks-port &lt;number&gt;] [--comp-methods &lt;string&gt;] [--comp-mt-level &lt;number&gt;] [--comp-mt-threads &lt;number&gt;] [--comp-mt-dthreads &lt;number&gt;] [--comp-xbzrle-cache &lt;number&gt;] [--auto-converge-initial &lt;number&gt;] [--auto-converge-increment &lt;number&gt;] [--persistent-xml &lt;string&gt;] [--tls]

  说明：
    将域迁移到另一台主机。添加--实时迁移。

  选项：
    [--domain] &lt;string&gt;  域名、id或uuid
    [--desturi] &lt;string&gt;  从客户端（正常迁移）或源（p2p迁移）看到的目标主机的连接URI
    --live           热迁移
    --offline        离线迁移
    --p2p            对等迁移
    --direct         直接迁移
    --tunnelled      隧道迁移
    --persistent     在目标上持久化VM
    --undefinesource  源上未定义VM
    --suspend        不要在目标主机上重新启动域
    --copy-storage-all  使用带有完整磁盘拷贝的非共享存储进行迁移
    --copy-storage-inc  使用带有增量拷贝的非共享存储进行迁移（源和目标之间共享相同的基本映像）
    --change-protection  在迁移结束之前，禁止对域进行任何配置更改
    --unsafe         强制迁移，即使可能不安全
    --verbose        显示迁移进度
    --compressed     在实时迁移过程中压缩重复的页面
    --auto-converge  现场迁移过程中的力收敛
    --rdma-pin-all   在开始RDMA实时迁移之前固定所有内存
    --abort-on-error  迁移过程中出现软错误时中止
    --postcopy       启用复制后迁移；使用“移植”后复制命令切换到它
    --postcopy-after-precopy  经过一次预复制后自动切换到复制后迁移
    --migrateuri &lt;string&gt;  迁移URI，通常可以省略
    --graphicsuri &lt;string&gt;  用于无缝图形迁移的图形URI
    --listen-address &lt;string&gt;  目标应绑定到的侦听地址以进行传入迁移
    --dname &lt;string&gt;  迁移期间重命名为新名称（如果支持）
    --timeout &lt;number&gt;  如果实时迁移超过超时（以秒为单位），则运行由--timeout-*选项指定的操作（默认情况下为挂起）
    --timeout-suspend  超时后暂停来宾
    --timeout-postcopy  超时后切换到后复制
    --xml &lt;string&gt;   切换到超时后发布复制包含目标的更新XML的文件名
    --migrate-disks &lt;string&gt;  要迁移的磁盘的逗号分隔列表
    --disks-port &lt;number&gt;  目标服务器用于传入磁盘迁移的端口
    --comp-methods &lt;string&gt;  要使用的压缩方法的逗号分隔列表
    --comp-mt-level &lt;number&gt;  多线程压缩的压缩级别
    --comp-mt-threads &lt;number&gt;  用于多线程压缩的压缩线程数
    --comp-mt-dthreads &lt;number&gt;  用于多线程压缩的解压缩线程数
    --comp-xbzrle-cache &lt;number&gt;  xbzrle压缩的页面缓存大小
    --auto-converge-initial &lt;number&gt;  用于自动收敛的初始CPU节流速率
    --auto-converge-increment &lt;number&gt;  用于自动收敛的CPU节流速率增量
    --persistent-xml &lt;string&gt;  包含目标的更新的持久XML的文件名
    --tls            使用TLS进行迁移
</code></pre>
<p><img src="/images/KVM%E8%99%9A%E6%8B%9F%E5%8C%96%E8%BF%9B%E9%98%B6%E4%B8%8E%E6%8F%90%E9%AB%98%E8%A7%86%E9%A2%91%E8%AF%BE%E7%A8%8B/42.jpg"></p>
<h4><span id="2-迁移">2、迁移</span></h4><p><img src="/images/KVM%E8%99%9A%E6%8B%9F%E5%8C%96%E8%BF%9B%E9%98%B6%E4%B8%8E%E6%8F%90%E9%AB%98%E8%A7%86%E9%A2%91%E8%AF%BE%E7%A8%8B/43.jpg"><br><img src="/images/KVM%E8%99%9A%E6%8B%9F%E5%8C%96%E8%BF%9B%E9%98%B6%E4%B8%8E%E6%8F%90%E9%AB%98%E8%A7%86%E9%A2%91%E8%AF%BE%E7%A8%8B/44.jpg"></p>
<p><strong>使用TCP指定迁移时使用的网络</strong></p>
<p><code> virsh migrate centos64a gemu+ssh://root@labkvml/system--migrateuri tcp://172.16.1.231 --live--persistent --undefinesource</code></p>
<p><strong>查看kvm2主机上的xml文件</strong></p>
<pre><code>[root@kvm2 qemu]# ls
generic.xml  networks
[root@kvm2 qemu]# pwd
/etc/libvirt/qemu
</code></pre>
<p><strong>迁移</strong></p>
<pre><code>[root@kvm2 qemu]# virsh list 
 Id    Name                           State
----------------------------------------------------
 3     generic                        running

[root@kvm2 qemu]# virsh migrate --domain generic --desturi qemu+ssh://root@kvm/system --live --unsafe --persistent --undefinesource 
root@kvm&#39;s password: 
error: 无法在 &#39;kvm :49152&#39; 连接到服务器: 没有到主机的路由
</code></pre>
<p><strong>上述报错是由于目标防火墙没开通49152端口导致的，开放相关端口即可</strong></p>
<pre><code>[root@kvm qemu]# iptables -I INPUT -p tcp --dport 49152 -j ACCEPT
</code></pre>
<p><strong>重新尝试迁移</strong></p>
<pre><code>[root@kvm2 qemu]# virsh migrate --domain generic --desturi qemu+ssh://root@kvm/system --live --unsafe --persistent --undefinesource 
root@kvm&#39;s password: 
[root@kvm2 qemu]# ls #迁移成功，且配置文件被删除
networks
</code></pre>
<p><strong>在目标端查看迁移结果</strong></p>
<pre><code>[root@kvm qemu]# virsh list 
 Id    Name                           State
----------------------------------------------------
 9     generic                        running
</code></pre>
<h2><span id="4-基于本地存储的动态迁移">4、基于本地存储的动态迁移</span></h2><p><img src="/images/KVM%E8%99%9A%E6%8B%9F%E5%8C%96%E8%BF%9B%E9%98%B6%E4%B8%8E%E6%8F%90%E9%AB%98%E8%A7%86%E9%A2%91%E8%AF%BE%E7%A8%8B/45.png"></p>
<h2><span id="查看主机状态及硬盘路径969696rootkvm-qemu-virsh-list-all-id-name-state"><strong>查看主机状态及硬盘路径</strong><br>&#96;&#96;&#96;<br>[root@kvm qemu]# virsh list –all<br> Id    Name                           State</span></h2><p> 10    generic                        running</p>
<ul>
<li><pre><code>centos7.0                      shut off
</code></pre>
</li>
</ul>
<h2><span id="rootkvm-qemu-virsh-domblklist-domain-generictarget-source">[root@kvm qemu]# virsh domblklist –domain generic<br>Target     Source</span></h2><p>hda        &#x2F;vm&#x2F;centos7.6.raw<br>hdb        -</p>
<pre><code>**迁移**

</code></pre>
<p>[root@kvm qemu]# virsh migrate –domain generic –desturi qemu+ssh:&#x2F;&#x2F;kvm2&#x2F;system –live –persistent –undefinesource<br>root@kvm2’s password:<br>error: 不安全的迁移:Migration without shared storage is unsafe</p>
<p>[root@kvm qemu]# virsh migrate –domain generic –desturi qemu+ssh:&#x2F;&#x2F;kvm2&#x2F;system –live –persistent –undefinesource –unsafe<br>root@kvm2’s password:<br>error: Cannot access storage file ‘&#x2F;vm&#x2F;centos7.6.raw’: 没有那个文件或目录</p>
<p>[root@kvm qemu]# virsh migrate –domain generic –desturi qemu+ssh:&#x2F;&#x2F;kvm2&#x2F;system –live –persistent –undefinesource –unsafe –copy-storage-all<br>root@kvm2’s password:<br>error: Cannot access storage file ‘&#x2F;vm&#x2F;centos7.6.raw’: 没有那个文件或目录</p>
<p>[root@kvm qemu]# yum install centos-release-qemu-ev qemu-kvm-ev -y #目标宿主机和本机都需要执行<br>[root@kvm qemu]# reboot #目标宿主机和本机都需要执行</p>
<pre><code>
&gt; centos-release-qemu-ev qemu-kvm-ev 这两个安装包会在yum的配置文件下生成相关配置文件，并且会对现有的kvm和libvirt版本进行升级和替换，生产环境中谨慎操作，建议升级后重启宿主机。目前Centos 7版本有这个问题，Ubuntu没有测试

![](images/KVM虚拟化进阶与提高视频课程/46.jpg)
![](images/KVM虚拟化进阶与提高视频课程/47.jpg)
</code></pre>
<p>[root@kvm ~]# virsh migrate –domain generic –desturi qemu+ssh:&#x2F;&#x2F;kvm2&#x2F;system –live –persistent –undefinesource –unsafe –copy-storage-all<br>root@kvm2’s password:<br>error: 不支持的配置：Hypervisor 不支持 CPU 型号 Broadwell-noTSX-IBRS</p>
<pre><code>
&gt; 上述报错是由于KVM2主机上的kvm版本不一致导致的，发现qemu-kvm-ev的软件包没有没安装成功，重新安装后解决此问题；
</code></pre>
<p>[root@kvm ~]# virsh migrate –domain generic –desturi qemu+ssh:&#x2F;&#x2F;kvm2&#x2F;system –live –persistent –undefinesource –unsafe –copy-storage-all<br>root@kvm2’s password:<br>error: 内部错误：无法执行 QEMU 命令 ‘drive-mirror’：Failed to connect socket: No route to host</p>
<pre><code>
&gt; 上述报错是由于KVM2主机的防火墙没有放行相关端口，执行iptables -I INPUT -p tcp -s 192.168.200.128 -j ACCEPT 即可解决；
</code></pre>
<p>[root@kvm ~]# virsh migrate –domain generic –desturi qemu+ssh:&#x2F;&#x2F;kvm2&#x2F;system –live –persistent –undefinesource –unsafe –copy-storage-all –verbose<br>root@kvm2’s password: </p>
<h2><span id="rootkvm2-~-virsh-list-all-id-name-state">[root@kvm2 ~]# virsh list –all<br> Id    Name                           State</span></h2><p> 5     generic                        running</p>
<pre><code>&gt; 迁移成功，需要保证主机两端的存储池都是一致的,迁移过程中可以使用sar -n DEV 1 4 （间隔一秒，采样四次），进行流量观察，也可以使用iostat等命令观察硬盘IO的情况


&gt; 在基于本地硬盘的迁移中，如果一个虚拟机由A宿主机迁移到B宿主机正常迁移后，想再次从B宿主机迁移回A宿主机，那么此时就需要重启B宿主机的libvirtd服务，否则会报下列错误
</code></pre>
<p>[root@node2 &#x2F;]# virsh migrate –domain Centos7.9 –desturi qemu+ssh:&#x2F;&#x2F;root@node1&#x2F;system –live –persistent –undefinesource –unsafe –copy-storage-all –verbose –<br>error: Cannot access storage file ‘&#x2F;vm&#x2F;Centos7.9.qcow2’ (as uid:107, gid:107): 没有那个文件或目录<br>[root@node2 &#x2F;]# qemu-img info &#x2F;vm&#x2F;Centos7.9.qcow2<br>qemu-img: Could not open ‘&#x2F;vm&#x2F;Centos7.9.qcow2’: Failed to get shared “write” lock<br>Is another process using the image [&#x2F;vm&#x2F;Centos7.9.qcow2]?</p>
<pre><code>
# 三、Linux HA群集体系架构
![](images/KVM虚拟化进阶与提高视频课程/48.jpg)
![](images/KVM虚拟化进阶与提高视频课程/49.jpg)
![](images/KVM虚拟化进阶与提高视频课程/50.jpg)
![](images/KVM虚拟化进阶与提高视频课程/51.jpg)
![](images/KVM虚拟化进阶与提高视频课程/52.jpg)
![](images/KVM虚拟化进阶与提高视频课程/53.jpg)
![](images/KVM虚拟化进阶与提高视频课程/54.jpg)
![](images/KVM虚拟化进阶与提高视频课程/55.png)
![](images/KVM虚拟化进阶与提高视频课程/56.png)
![](images/KVM虚拟化进阶与提高视频课程/58.jpg)
![](images/KVM虚拟化进阶与提高视频课程/58.jpg)
![](images/KVM虚拟化进阶与提高视频课程/59.png)

# 四、Linux群集安装与配置

## 1、规划设计

![](images/KVM虚拟化进阶与提高视频课程/60.jpg)
![](images/KVM虚拟化进阶与提高视频课程/61.jpg)
![](images/KVM虚拟化进阶与提高视频课程/62.png)
![](images/KVM虚拟化进阶与提高视频课程/63.png)
![](images/KVM虚拟化进阶与提高视频课程/64.png)
![](images/KVM虚拟化进阶与提高视频课程/65.png)
![](images/KVM虚拟化进阶与提高视频课程/65.png)
![](images/KVM虚拟化进阶与提高视频课程/66.png)


| 主机名称 | 管理地址 | 心跳地址 | 存储地址 |
| --- | --- | --- | --- |
| KVM | 192.168.200.200 | 192.168.0.200 | 192.168.1.200 |
| KVM2 | 192.168.200.201 | 192.168.0.201 | 192.168.1.201 |

## 2、群集组件安装

**1、查看需要安装的软件包**

![](images/KVM虚拟化进阶与提高视频课程/67.jpg)
</code></pre>
<p>[root@kvm ~]# yum list  | grep pacemaker<br>drbd-pacemaker.x86_64                    9.17.0-1.el7                  epel<br>pacemaker.x86_64                         1.1.23-1.el7_9.1              updates<br>pacemaker-cli.x86_64                     1.1.23-1.el7_9.1              updates<br>pacemaker-cluster-libs.i686              1.1.23-1.el7_9.1              updates<br>pacemaker-cluster-libs.x86_64            1.1.23-1.el7_9.1              updates<br>pacemaker-cts.x86_64                     1.1.23-1.el7_9.1              updates<br>pacemaker-doc.x86_64                     1.1.23-1.el7_9.1              updates<br>pacemaker-libs.i686                      1.1.23-1.el7_9.1              updates<br>pacemaker-libs.x86_64                    1.1.23-1.el7_9.1              updates<br>pacemaker-libs-devel.i686                1.1.23-1.el7_9.1              updates<br>pacemaker-libs-devel.x86_64              1.1.23-1.el7_9.1              updates<br>pacemaker-nagios-plugins-metadata.x86_64 1.1.23-1.el7_9.1              updates<br>pacemaker-remote.x86_64                  1.1.23-1.el7_9.1              updates</p>
<pre><code>**2、安装相关软件**
</code></pre>
<p>[root@kvm ~]# yum install -y pacemaker corosync pcs psmisc policycoreutils-python fence-agents-all #所有集群节点都需要安装<br>Installed:<br>  corosync.x86_64 0:2.4.5-7.el7_9.2                         fence-agents-all.x86_64 0:4.2.1-41.el7_9.6                         pacemaker.x86_64 0:1.1.23-1.el7_9.1                         pcs.x86_64 0:0.9.169-3.el7.centos.3                         policycoreutils-python.x86_64 0:2.5-34.el7                        </p>
<p>Dependency Installed:<br>  OpenIPMI.x86_64 0:2.0.27-1.el7                      OpenIPMI-libs.x86_64 0:2.0.27-1.el7                  OpenIPMI-modalias.x86_64 0:2.0.27-1.el7            audit-libs-python.x86_64 0:2.8.5-4.el7               checkpolicy.x86_64 0:2.5-8.el7                    cifs-utils.x86_64 0:6.2-10.el7<br>  clufter-bin.x86_64 0:0.77.1-1.el7                   clufter-common.noarch 0:0.77.1-1.el7                 corosynclib.x86_64 0:2.4.5-7.el7_9.2               device-mapper-multipath.x86_64 0:0.4.9-136.el7_9     fence-agents-amt-ws.x86_64 0:4.2.1-41.el7_9.6     fence-agents-apc.x86_64 0:4.2.1-41.el7_9.6<br>  fence-agents-apc-snmp.x86_64 0:4.2.1-41.el7_9.6     fence-agents-bladecenter.x86_64 0:4.2.1-41.el7_9.6   fence-agents-brocade.x86_64 0:4.2.1-41.el7_9.6     fence-agents-cisco-mds.x86_64 0:4.2.1-41.el7_9.6     fence-agents-cisco-ucs.x86_64 0:4.2.1-41.el7_9.6  fence-agents-common.x86_64 0:4.2.1-41.el7_9.6<br>  fence-agents-compute.x86_64 0:4.2.1-41.el7_9.6      fence-agents-drac5.x86_64 0:4.2.1-41.el7_9.6         fence-agents-eaton-snmp.x86_64 0:4.2.1-41.el7_9.6  fence-agents-emerson.x86_64 0:4.2.1-41.el7_9.6       fence-agents-eps.x86_64 0:4.2.1-41.el7_9.6        fence-agents-heuristics-ping.x86_64 0:4.2.1-41.el7_9.6<br>  fence-agents-hpblade.x86_64 0:4.2.1-41.el7_9.6      fence-agents-ibmblade.x86_64 0:4.2.1-41.el7_9.6      fence-agents-ifmib.x86_64 0:4.2.1-41.el7_9.6       fence-agents-ilo-moonshot.x86_64 0:4.2.1-41.el7_9.6  fence-agents-ilo-mp.x86_64 0:4.2.1-41.el7_9.6     fence-agents-ilo-ssh.x86_64 0:4.2.1-41.el7_9.6<br>  fence-agents-ilo2.x86_64 0:4.2.1-41.el7_9.6         fence-agents-intelmodular.x86_64 0:4.2.1-41.el7_9.6  fence-agents-ipdu.x86_64 0:4.2.1-41.el7_9.6        fence-agents-ipmilan.x86_64 0:4.2.1-41.el7_9.6       fence-agents-kdump.x86_64 0:4.2.1-41.el7_9.6      fence-agents-mpath.x86_64 0:4.2.1-41.el7_9.6<br>  fence-agents-redfish.x86_64 0:4.2.1-41.el7_9.6      fence-agents-rhevm.x86_64 0:4.2.1-41.el7_9.6         fence-agents-rsa.x86_64 0:4.2.1-41.el7_9.6         fence-agents-rsb.x86_64 0:4.2.1-41.el7_9.6           fence-agents-sbd.x86_64 0:4.2.1-41.el7_9.6        fence-agents-scsi.x86_64 0:4.2.1-41.el7_9.6<br>  fence-agents-vmware-rest.x86_64 0:4.2.1-41.el7_9.6  fence-agents-vmware-soap.x86_64 0:4.2.1-41.el7_9.6   fence-agents-wti.x86_64 0:4.2.1-41.el7_9.6         fence-virt.x86_64 0:0.3.2-16.el7                     ipmitool.x86_64 0:1.8.18-10.el7_9                 liberation-fonts-common.noarch 1:1.07.2-16.el7<br>  liberation-sans-fonts.noarch 1:1.07.2-16.el7        libldb.x86_64 0:1.5.4-2.el7                          libqb.x86_64 0:1.0.1-9.el7                         libsemanage-python.x86_64 0:2.5-14.el7               libtalloc.x86_64 0:2.1.16-1.el7                   libtdb.x86_64 0:1.3.18-1.el7<br>  libtevent.x86_64 0:0.9.39-1.el7                     libwbclient.x86_64 0:4.10.16-24.el7_9                libwsman1.x86_64 0:2.6.3-7.git4391e5c.el7          net-snmp-libs.x86_64 1:5.7.2-49.el7_9.2              net-snmp-utils.x86_64 1:5.7.2-49.el7_9.2          openwsman-python.x86_64 0:2.6.3-7.git4391e5c.el7<br>  overpass-fonts.noarch 0:2.1-1.el7                   pacemaker-cli.x86_64 0:1.1.23-1.el7_9.1              pacemaker-cluster-libs.x86_64 0:1.1.23-1.el7_9.1   pacemaker-libs.x86_64 0:1.1.23-1.el7_9.1             perl-TimeDate.noarch 1:2.30-2.el7                 pexpect.noarch 0:2.3-11.el7<br>  python-IPy.noarch 0:0.75-6.el7                      python-clufter.noarch 0:0.77.1-1.el7                 python-lxml.x86_64 0:3.2.1-4.el7                   python2-subprocess32.x86_64 0:3.2.6-14.el7           resource-agents.x86_64 0:4.1.1-61.el7_9.18        ruby.x86_64 0:2.0.0.648-39.el7_9<br>  ruby-irb.noarch 0:2.0.0.648-39.el7_9                ruby-libs.x86_64 0:2.0.0.648-39.el7_9                rubygem-bigdecimal.x86_64 0:1.2.0-39.el7_9         rubygem-io-console.x86_64 0:0.4.2-39.el7_9           rubygem-json.x86_64 0:1.7.7-39.el7_9              rubygem-psych.x86_64 0:2.0.0-39.el7_9<br>  rubygem-rdoc.noarch 0:4.0.0-39.el7_9                rubygems.noarch 0:2.0.14.1-39.el7_9                  samba-client-libs.x86_64 0:4.10.16-24.el7_9        samba-common.noarch 0:4.10.16-24.el7_9               samba-common-libs.x86_64 0:4.10.16-24.el7_9       setools-libs.x86_64 0:3.3.8-4.el7<br>  telnet.x86_64 1:0.17-66.el7                        </p>
<p>[root@kvm ~]# yum update -y</p>
<pre><code>
**3、查看相关软件描述**

**pacemaker**
</code></pre>
<p>[root@kvm ~]# rpm -qi pacemaker<br>Name        : pacemaker<br>Version     : 1.1.23<br>Release     : 1.el7_9.1<br>Architecture: x86_64<br>Install Date: Thu 13 Apr 2023 03:21:10 PM CST<br>Group       : System Environment&#x2F;Daemons<br>Size        : 1285198<br>License     : GPLv2+ and LGPLv2+<br>Signature   : RSA&#x2F;SHA256, Fri 18 Dec 2020 04:35:18 AM CST, Key ID 24c6a8a7f4a80eb5<br>Source RPM  : pacemaker-1.1.23-1.el7_9.1.src.rpm<br>Build Date  : Wed 16 Dec 2020 12:40:01 AM CST<br>Build Host  : x86-02.bsys.centos.org<br>Relocations : (not relocatable)<br>Packager    : CentOS BuildSystem <a target="_blank" rel="noopener" href="http://bugs.centos.org/">http://bugs.centos.org</a><br>Vendor      : CentOS<br>URL         : <a target="_blank" rel="noopener" href="http://www.clusterlabs.org/">http://www.clusterlabs.org</a><br>Summary     : Scalable High-Availability cluster resource manager<br>Description :Pacemaker是一种先进的、可扩展的高可用性集群资源Corosync、CMAN和&#x2F;或Linux HA的管理器。它支持超过16个具有重要功能的节点群集用于管理资源和依赖关系。它将在初始化时运行脚本，当机器上升或下降时，当相关资源出现故障时，可以配置为定期检查资源健康。<br>可用的重建重建选项：<br>-with(out) :cman覆盖范围文档stonithd硬化预释放分析</p>
<pre><code>
**corosync**
</code></pre>
<p>[root@kvm ~]# rpm -qi corosync<br>Name        : corosync<br>Version     : 2.4.5<br>Release     : 7.el7_9.2<br>Architecture: x86_64<br>Install Date: Thu 13 Apr 2023 03:21:06 PM CST<br>Group       : System Environment&#x2F;Base<br>Size        : 485644<br>License     : BSD<br>Signature   : RSA&#x2F;SHA256, Wed 01 Dec 2021 10:14:09 PM CST, Key ID 24c6a8a7f4a80eb5<br>Source RPM  : corosync-2.4.5-7.el7_9.2.src.rpm<br>Build Date  : Thu 25 Nov 2021 12:33:10 AM CST<br>Build Host  : x86-02.bsys.centos.org<br>Relocations : (not relocatable)<br>Packager    : CentOS BuildSystem <a target="_blank" rel="noopener" href="http://bugs.centos.org/">http://bugs.centos.org</a><br>Vendor      : CentOS<br>URL         : <a target="_blank" rel="noopener" href="http://corosync.github.io/corosync/">http://corosync.github.io/corosync/</a><br>Summary     : The Corosync Cluster Engine and Application Programming Interfaces<br>Description :<br>此软件包包含Corosync Cluster Engine Executive，几个默认配置API和库、默认配置文件以及init脚本。</p>
<pre><code>
**pcs**
</code></pre>
<p>[root@kvm ~]# rpm -qi pcs<br>Name        : pcs<br>Version     : 0.9.169<br>Release     : 3.el7.centos.3<br>Architecture: x86_64<br>Install Date: Thu 13 Apr 2023 03:21:17 PM CST<br>Group       : System Environment&#x2F;Base<br>Size        : 11483086<br>License     : GPLv2<br>Signature   : RSA&#x2F;SHA256, Sat 12 Nov 2022 12:15:48 AM CST, Key ID 24c6a8a7f4a80eb5<br>Source RPM  : pcs-0.9.169-3.el7.centos.3.src.rpm<br>Build Date  : Thu 10 Nov 2022 09:56:56 PM CST<br>Build Host  : x86-02.bsys.centos.org<br>Relocations : (not relocatable)<br>Packager    : CentOS BuildSystem <a target="_blank" rel="noopener" href="http://bugs.centos.org/">http://bugs.centos.org</a><br>Vendor      : CentOS<br>URL         : <a target="_blank" rel="noopener" href="https://github.com/ClusterLabs/pcs">https://github.com/ClusterLabs/pcs</a><br>Summary     : Pacemaker Configuration System<br>Description :<br>pcs是一种同步器和起搏器配置工具。它允许用户轻松查看、修改和创建基于起搏器的集群。</p>
<pre><code>**psmisc**
</code></pre>
<p>[root@kvm ~]# rpm -qi psmisc<br>Name        : psmisc<br>Version     : 22.20<br>Release     : 17.el7<br>Architecture: x86_64<br>Install Date: Sun 02 Apr 2023 03:58:57 PM CST<br>Group       : Applications&#x2F;System<br>Size        : 486607<br>License     : GPLv2+<br>Signature   : RSA&#x2F;SHA256, Thu 15 Oct 2020 02:59:05 AM CST, Key ID 24c6a8a7f4a80eb5<br>Source RPM  : psmisc-22.20-17.el7.src.rpm<br>Build Date  : Thu 01 Oct 2020 01:20:29 AM CST<br>Build Host  : x86-01.bsys.centos.org<br>Relocations : (not relocatable)<br>Packager    : CentOS BuildSystem <a target="_blank" rel="noopener" href="http://bugs.centos.org/">http://bugs.centos.org</a><br>Vendor      : CentOS<br>URL         : <a target="_blank" rel="noopener" href="http://sourceforge.net/projects/psmisc">http://sourceforge.net/projects/psmisc</a><br>Summary     : Utilities for managing processes on your system<br>Description :<br>psmisc包包含用于管理<br>系统：pstree、killall和fuser。pstree命令显示一个树<br>系统上所有正在运行的进程的结构。杀手<br>命令将指定的信号（如果未指定任何内容，则为SIGTERM）发送到<br>通过名称标识的进程。热熔器命令识别PID<br>使用指定文件或文件系统的进程。</p>
<pre><code>**policycoreutils-python**
</code></pre>
<p>[root@kvm ~]# rpm -qi policycoreutils-python<br>Name        : policycoreutils-python<br>Version     : 2.5<br>Release     : 34.el7<br>Architecture: x86_64<br>Install Date: Thu 13 Apr 2023 03:21:11 PM CST<br>Group       : System Environment&#x2F;Base<br>Size        : 1304826<br>License     : GPLv2<br>Signature   : RSA&#x2F;SHA256, Sat 04 Apr 2020 05:05:35 AM CST, Key ID 24c6a8a7f4a80eb5<br>Source RPM  : policycoreutils-2.5-34.el7.src.rpm<br>Build Date  : Wed 01 Apr 2020 12:04:58 PM CST<br>Build Host  : x86-02.bsys.centos.org<br>Relocations : (not relocatable)<br>Packager    : CentOS BuildSystem <a target="_blank" rel="noopener" href="http://bugs.centos.org/">http://bugs.centos.org</a><br>Vendor      : CentOS<br>URL         : <a target="_blank" rel="noopener" href="http://www.selinuxproject.org/">http://www.selinuxproject.org</a><br>Summary     : SELinux policy core python utilities<br>Description :<br>policycoreutils-python包包含用于管理的管理工具SELinux环境。</p>
<pre><code>
**fence-agents-all**
</code></pre>
<p>[root@kvm ~]# rpm -qi fence-agents-all<br>Name        : fence-agents-all<br>Version     : 4.2.1<br>Release     : 41.el7_9.6<br>Architecture: x86_64<br>Install Date: Thu 13 Apr 2023 03:21:15 PM CST<br>Group       : System Environment&#x2F;Base<br>Size        : 0<br>License     : GPLv2+ and LGPLv2+ and ASL 2.0<br>Signature   : RSA&#x2F;SHA256, Thu 07 Apr 2022 01:04:19 AM CST, Key ID 24c6a8a7f4a80eb5<br>Source RPM  : fence-agents-4.2.1-41.el7_9.6.src.rpm<br>Build Date  : Wed 06 Apr 2022 12:26:21 AM CST<br>Build Host  : x86-01.bsys.centos.org<br>Relocations : (not relocatable)<br>Packager    : CentOS BuildSystem <a target="_blank" rel="noopener" href="http://bugs.centos.org/">http://bugs.centos.org</a><br>Vendor      : CentOS<br>URL         : <a target="_blank" rel="noopener" href="https://github.com/ClusterLabs/fence-agents">https://github.com/ClusterLabs/fence-agents</a><br>Summary     : Fence agents<br>Description :<br>Red Hat围栏代理是所有受支持的围栏代理的集合。</p>
<pre><code>
## 3、群集节点准备

### 1、配置主机名及解析
![](images/KVM虚拟化进阶与提高视频课程/67.jpg)
![](images/KVM虚拟化进阶与提高视频课程/68.jpg)
node1:
</code></pre>
<p>[root@kvm ~]# hostnamectl set-hostname node1<br>[root@kvm ~]# bash<br>[root@node1 ~]# vim &#x2F;etc&#x2F;hosts<br>127.0.0.1   localhost localhost.localdomain localhost4 localhost4.localdomain4<br>::1         localhost localhost.localdomain localhost6 localhost6.localdomain6<br>192.168.200.200 node1-manage<br>192.168.200.201 node2-manage<br>192.168.0.200 node1-heartbeat<br>192.168.0.201 node2-heartbeat<br>192.168.1.200 node1-storage<br>192.168.1.201 node2-storage</p>
<p>[root@node1 ~]# ping node2-manage<br>PING node2-manage (192.168.200.201) 56(84) bytes of data.<br>64 bytes from node2-manage (192.168.200.201): icmp_seq&#x3D;1 ttl&#x3D;64 time&#x3D;1.26 ms<br>— node2-manage ping statistics —<br>1 packets transmitted, 1 received, 0% packet loss, time 0ms<br>rtt min&#x2F;avg&#x2F;max&#x2F;mdev &#x3D; 1.268&#x2F;1.268&#x2F;1.268&#x2F;0.000 ms</p>
<p>[root@node1 ~]# ping node2-heartbeat<br>PING node2-heartbeat (192.168.0.201) 56(84) bytes of data.<br>64 bytes from node2-heartbeat (192.168.0.201): icmp_seq&#x3D;1 ttl&#x3D;64 time&#x3D;9.27 ms<br>— node2-heartbeat ping statistics —<br>1 packets transmitted, 1 received, 0% packet loss, time 0ms<br>rtt min&#x2F;avg&#x2F;max&#x2F;mdev &#x3D; 9.276&#x2F;9.276&#x2F;9.276&#x2F;0.000 ms</p>
<p>[root@node1 ~]# ping node2-storage<br>PING node2-storage (192.168.1.201) 56(84) bytes of data.<br>64 bytes from node2-storage (192.168.1.201): icmp_seq&#x3D;1 ttl&#x3D;64 time&#x3D;0.700 ms<br>— node2-storage ping statistics —<br>1 packets transmitted, 1 received, 0% packet loss, time 0ms<br>rtt min&#x2F;avg&#x2F;max&#x2F;mdev &#x3D; 0.700&#x2F;0.700&#x2F;0.700&#x2F;0.000 ms</p>
<pre><code>node2:
</code></pre>
<p>[root@kvm2 ~]# hostnamectl set-hostname node2<br>[root@kvm2 ~]# bash<br>[root@node2 ~]# vim &#x2F;etc&#x2F;hosts<br>127.0.0.1   localhost localhost.localdomain localhost4 localhost4.localdomain4<br>::1         localhost localhost.localdomain localhost6 localhost6.localdomain6<br>192.168.200.200 node1-manage<br>192.168.200.201 node2-manage<br>192.168.0.200 node1-heartbeat<br>192.168.0.201 node2-heartbeat<br>192.168.1.200 node1-storage<br>192.168.1.201 node2-storage<br>[root@node2 ~]# ping node1-manage<br>PING node1-manage (192.168.200.200) 56(84) bytes of data.<br>64 bytes from node1-manage (192.168.200.200): icmp_seq&#x3D;1 ttl&#x3D;64 time&#x3D;1.06 ms<br>— node1-manage ping statistics —<br>1 packets transmitted, 1 received, 0% packet loss, time 0ms<br>rtt min&#x2F;avg&#x2F;max&#x2F;mdev &#x3D; 1.063&#x2F;1.063&#x2F;1.063&#x2F;0.000 ms</p>
<p>[root@node2 ~]# ping node1-heartbeat<br>PING node1-heartbeat (192.168.0.200) 56(84) bytes of data.<br>64 bytes from node1-heartbeat (192.168.0.200): icmp_seq&#x3D;1 ttl&#x3D;64 time&#x3D;10.6 ms<br>— node1-heartbeat ping statistics —<br>1 packets transmitted, 1 received, 0% packet loss, time 0ms<br>rtt min&#x2F;avg&#x2F;max&#x2F;mdev &#x3D; 10.616&#x2F;10.616&#x2F;10.616&#x2F;0.000 ms</p>
<p>[root@node2 ~]# ping node1-storage<br>PING node1-storage (192.168.1.200) 56(84) bytes of data.<br>64 bytes from node1-storage (192.168.1.200): icmp_seq&#x3D;1 ttl&#x3D;64 time&#x3D;0.269 ms<br>— node1-storage ping statistics —<br>1 packets transmitted, 1 received, 0% packet loss, time 0ms<br>rtt min&#x2F;avg&#x2F;max&#x2F;mdev &#x3D; 0.269&#x2F;0.269&#x2F;0.269&#x2F;0.000 ms</p>
<pre><code>
### 2、配置SSH Key互信（可选）
![](images/KVM虚拟化进阶与提高视频课程/69.jpg)

node1:
</code></pre>
<p>[root@node1 ~]# ssh-keygen -t rsa -P ‘’<br>Generating public&#x2F;private rsa key pair.<br>Enter file in which to save the key (&#x2F;root&#x2F;.ssh&#x2F;id_rsa):<br>Your identification has been saved in &#x2F;root&#x2F;.ssh&#x2F;id_rsa.<br>Your public key has been saved in &#x2F;root&#x2F;.ssh&#x2F;id_rsa.pub.<br>The key fingerprint is:<br>SHA256:OGWrktFMBJXAHiwVbzg5pX9ZTg5Do99QQyCJWxjlUaI root@node1<br>The key’s randomart image is:<br>+—[RSA 2048]—-+<br>|   +<em>XO+&#x3D;o+      |<br>|  . <em>X+</em> o .     |<br>|   oE+</em> * o      |<br>|    oO &#x3D; %       |<br>|    . * S +      |<br>|     o +         |<br>|    o .          |<br>|     .           |<br>|                 |<br>+—-[SHA256]—–+</p>
<p>[root@node1 ~]# ssh-copy-id -i &#x2F;root&#x2F;.ssh&#x2F;id_rsa.pub root@node2<br>&#x2F;usr&#x2F;bin&#x2F;ssh-copy-id: INFO: Source of key(s) to be installed: “&#x2F;root&#x2F;.ssh&#x2F;id_rsa.pub”<br>&#x2F;usr&#x2F;bin&#x2F;ssh-copy-id: INFO: attempting to log in with the new key(s), to filter out any that are already installed</p>
<p>&#x2F;usr&#x2F;bin&#x2F;ssh-copy-id: ERROR: ssh: Could not resolve hostname node2: Name or service not known</p>
<p>[root@node1 ~]# ssh-copy-id -i &#x2F;root&#x2F;.ssh&#x2F;id_rsa.pub root@node2-manage<br>&#x2F;usr&#x2F;bin&#x2F;ssh-copy-id: INFO: Source of key(s) to be installed: “&#x2F;root&#x2F;.ssh&#x2F;id_rsa.pub”<br>The authenticity of host ‘node2-manage (192.168.200.201)’ can’t be established.<br>ECDSA key fingerprint is SHA256:s2qiffBOYjuMJQOHEI9r87NTNjd0XyoEf81myM78kbQ.<br>ECDSA key fingerprint is MD5:a5:8f:de:d4:07:9f:b7:b3:6f:7c:b0:c3:55:eb:bb:b0.<br>Are you sure you want to continue connecting (yes&#x2F;no)? yes<br>&#x2F;usr&#x2F;bin&#x2F;ssh-copy-id: INFO: attempting to log in with the new key(s), to filter out any that are already installed<br>&#x2F;usr&#x2F;bin&#x2F;ssh-copy-id: INFO: 1 key(s) remain to be installed – if you are prompted now it is to install the new keys<br>root@node2-manage’s password: </p>
<p>Number of key(s) added: 1</p>
<p>Now try logging into the machine, with:   “ssh ‘root@node2-manage’”<br>and check to make sure that only the key(s) you wanted were added.<br>[root@node1 ~]# ssh root@node2-manage<br>Last login: Thu Apr 13 15:16:28 2023 from 192.168.200.1<br>[root@node2 ~]# exit<br>logout<br>Connection to node2-manage closed.</p>
<pre><code>node2:
</code></pre>
<p>[root@node2 ~]# ssh-keygen -t rsa -P ‘’<br>Generating public&#x2F;private rsa key pair.<br>Enter file in which to save the key (&#x2F;root&#x2F;.ssh&#x2F;id_rsa):<br>Your identification has been saved in &#x2F;root&#x2F;.ssh&#x2F;id_rsa.<br>Your public key has been saved in &#x2F;root&#x2F;.ssh&#x2F;id_rsa.pub.<br>The key fingerprint is:<br>SHA256:E9njGHnhnwZtQGy5CmomfuxGQENWeVNRWHe9W0q9QRw root@node2<br>The key’s randomart image is:<br>+—[RSA 2048]—-+<br>| .o… .oB*.. oE.|<br>| .o . o .&#x3D;+&#x3D; . o.|<br>| . . . .&#x3D;.*.o …|<br>|  .   .  *.&#x3D; ..oo|<br>|   . . .S.. +. .&#x3D;|<br>|  . &#x3D;   .. .  .o |<br>| . *             |<br>|  . +            |<br>|   +.            |<br>+—-[SHA256]—–+<br>[root@node2 ~]# ssh-copy-id -i &#x2F;root&#x2F;.ssh&#x2F;id_rsa.pub root@node1-manage<br>&#x2F;usr&#x2F;bin&#x2F;ssh-copy-id: INFO: Source of key(s) to be installed: “&#x2F;root&#x2F;.ssh&#x2F;id_rsa.pub”<br>The authenticity of host ‘node1-manage (192.168.200.200)’ can’t be established.<br>ECDSA key fingerprint is SHA256:s2qiffBOYjuMJQOHEI9r87NTNjd0XyoEf81myM78kbQ.<br>ECDSA key fingerprint is MD5:a5:8f:de:d4:07:9f:b7:b3:6f:7c:b0:c3:55:eb:bb:b0.<br>Are you sure you want to continue connecting (yes&#x2F;no)? yes<br>&#x2F;usr&#x2F;bin&#x2F;ssh-copy-id: INFO: attempting to log in with the new key(s), to filter out any that are already installed<br>&#x2F;usr&#x2F;bin&#x2F;ssh-copy-id: INFO: 1 key(s) remain to be installed – if you are prompted now it is to install the new keys<br>root@node1-manage’s password: </p>
<p>Number of key(s) added: 1</p>
<p>Now try logging into the machine, with:   “ssh ‘root@node1-manage’”<br>and check to make sure that only the key(s) you wanted were added.</p>
<p>[root@node2 ~]# ssh root@node1-manage<br>Last login: Thu Apr 13 15:16:27 2023 from 192.168.200.1<br>[root@node1 ~]# exit<br>logout<br>Connection to node1-manage closed.</p>
<pre><code>
### 3、配置时钟
![](images/KVM虚拟化进阶与提高视频课程/70.jpg)

node1:
</code></pre>
<p>[root@node1 ~]# ntpdate time.windows.com<br>13 Apr 16:20:11 ntpdate[6059]: adjust time server 52.231.114.183 offset 0.021235 sec<br>[root@node1 ~]# crontab -e<br>no crontab for root - using an empty one<br>crontab: installing new crontab<br>[root@node1 ~]# crontab -l<br>*&#x2F;30 * * * * &#x2F;sbin&#x2F;ntpdate ntp1.aliyun.com &amp;&gt; &#x2F;dev&#x2F;null</p>
<pre><code>
node2:
</code></pre>
<p>[root@node1 ~]# ntpdate time.windows.com<br>13 Apr 16:20:11 ntpdate[6059]: adjust time server 52.231.114.183 offset 0.021235 sec<br>[root@node1 ~]# crontab -e<br>no crontab for root - using an empty one<br>crontab: installing new crontab<br>[root@node1 ~]# crontab -l<br>*&#x2F;30 * * * * &#x2F;sbin&#x2F;ntpdate ntp1.aliyun.com &amp;&gt; &#x2F;dev&#x2F;null</p>
<pre><code>
### 4、配置iptables防火墙允许集群组件运行

![](images/KVM虚拟化进阶与提高视频课程/71.jpg)

node1:
</code></pre>
<p>[root@node1 ~]# firewall-cmd –permanent –add-service&#x3D;high-availability<br>success<br>[root@node1 ~]# firewall-cmd –add-service&#x3D;high-availability<br>success<br>[root@node1 ~]# firewall-cmd –reload<br>success</p>
<p>[root@node1 ~]# firewall-cmd –get-service<br>RH-Satellite-6 RH-Satellite-6-capsule amanda-client amanda-k5-client amqp amqps apcupsd audit bacula bacula-client bgp bitcoin bitcoin-rpc bitcoin-testnet bitcoin-testnet-rpc ceph ceph-mon cfengine condor-collector ctdb dhcp dhcpv6 dhcpv6-client distcc dns docker-registry docker-swarm dropbox-lansync elasticsearch etcd-client etcd-server finger freeipa-ldap freeipa-ldaps freeipa-replication freeipa-trust ftp ganglia-client ganglia-master git gre high-availability http https imap imaps ipp ipp-client ipsec irc ircs iscsi-target isns jenkins kadmin kerberos kibana klogin kpasswd kprop kshell ldap ldaps libvirt libvirt-tls lightning-network llmnr managesieve matrix mdns minidlna mongodb mosh mountd mqtt mqtt-tls ms-wbt mssql murmur mysql nfs nfs3 nmea-0183 nrpe ntp nut openvpn ovirt-imageio ovirt-storageconsole ovirt-vmconsole plex pmcd pmproxy pmwebapi pmwebapis pop3 pop3s postgresql privoxy proxy-dhcp ptp pulseaudio puppetmaster quassel radius redis rpc-bind rsh rsyncd rtsp salt-master samba samba-client samba-dc sane sip sips slp smtp smtp-submission smtps snmp snmptrap spideroak-lansync squid ssh steam-streaming svdrp svn syncthing syncthing-gui synergy syslog syslog-tls telnet tftp tftp-client tinc tor-socks transmission-client upnp-client vdsm vnc-server wbem-http wbem-https wsman wsmans xdmcp xmpp-bosh xmpp-client xmpp-local xmpp-server zabbix-agent zabbix-server</p>
<pre><code>
node2:
</code></pre>
<p>[root@node1 ~]# firewall-cmd –permanent –add-service&#x3D;high-availability<br>success<br>[root@node1 ~]# firewall-cmd –add-service&#x3D;high-availability<br>success<br>[root@node1 ~]# firewall-cmd –reload<br>success</p>
<pre><code>
### 5、配置pcs守护程序

![](images/KVM虚拟化进阶与提高视频课程/72.jpg)

node1:
</code></pre>
<p>[root@node1 ~]# systemctl start pcsd<br>[root@node1 ~]# systemctl enable pcsd<br>Created symlink from &#x2F;etc&#x2F;systemd&#x2F;system&#x2F;multi-user.target.wants&#x2F;pcsd.service to &#x2F;usr&#x2F;lib&#x2F;systemd&#x2F;system&#x2F;pcsd.service.<br>[root@node1 ~]# systemctl status pcsd<br>● pcsd.service - PCS GUI and remote configuration interface<br>   Loaded: loaded (&#x2F;usr&#x2F;lib&#x2F;systemd&#x2F;system&#x2F;pcsd.service; enabled; vendor preset: disabled)<br>   Active: active (running) since Thu 2023-04-13 16:36:13 CST; 8s ago<br>     Docs: man:pcsd(8)<br>           man:pcs(8)<br> Main PID: 6161 (pcsd)<br>   CGroup: &#x2F;system.slice&#x2F;pcsd.service<br>           └─6161 &#x2F;usr&#x2F;bin&#x2F;ruby &#x2F;usr&#x2F;lib&#x2F;pcsd&#x2F;pcsd</p>
<p>Apr 13 16:36:13 node1 systemd[1]: Starting PCS GUI and remote configuration interface…<br>Apr 13 16:36:13 node1 systemd[1]: Started PCS GUI and remote configuration interface.</p>
<pre><code>
node2:
</code></pre>
<p>[root@node2 ~]# systemctl start pcsd<br>[root@node2 ~]# systemctl enable pcsd<br>Created symlink from &#x2F;etc&#x2F;systemd&#x2F;system&#x2F;multi-user.target.wants&#x2F;pcsd.service to &#x2F;usr&#x2F;lib&#x2F;systemd&#x2F;system&#x2F;pcsd.service.<br>[root@node2 ~]# systemctl status pcsd<br>● pcsd.service - PCS GUI and remote configuration interface<br>   Loaded: loaded (&#x2F;usr&#x2F;lib&#x2F;systemd&#x2F;system&#x2F;pcsd.service; enabled; vendor preset: disabled)<br>   Active: active (running) since Thu 2023-04-13 16:35:20 CST; 19s ago<br>     Docs: man:pcsd(8)<br>           man:pcs(8)<br> Main PID: 6483 (pcsd)<br>   CGroup: &#x2F;system.slice&#x2F;pcsd.service<br>           └─6483 &#x2F;usr&#x2F;bin&#x2F;ruby &#x2F;usr&#x2F;lib&#x2F;pcsd&#x2F;pcsd</p>
<p>Apr 13 16:35:20 node2 systemd[1]: Starting PCS GUI and remote configuration interface…<br>Apr 13 16:35:20 node2 systemd[1]: Started PCS GUI and remote configuration interface.</p>
<pre><code>
![](images/KVM虚拟化进阶与提高视频课程/73.jpg)

### 6、配置hacluster账户密码

![](images/KVM虚拟化进阶与提高视频课程/74.jpg)

node1:
</code></pre>
<p>[root@node1 ~]# echo “password” | passwd –stdin hacluster<br>Changing password for user hacluster.<br>passwd: all authentication tokens updated successfully.</p>
<pre><code>
node2:
</code></pre>
<p>[root@node2 ~]# echo “password” | passwd –stdin hacluster<br>Changing password for user hacluster.<br>passwd: all authentication tokens updated successfully.</p>
<pre><code>
### 7、编辑配置文件

![](images/KVM虚拟化进阶与提高视频课程/75.jpg)

## 4、群集的创建

![](images/KVM虚拟化进阶与提高视频课程/76.jpg)
![](images/KVM虚拟化进阶与提高视频课程/77.jpg)

node1:
</code></pre>
<p>[root@node1 ~]# pcs cluster auth node1-heartbeat node2-heartbeat<br>Username: hacluster<br>Password: password<br>node1-heartbeat: Authorized<br>node2-heartbeat: Authorized<br>[root@node1 corosync]# pcs cluster setup –name cluster1 node1-heartbeat node2-heartbeat<br>[root@node1 corosync]# pwd<br>&#x2F;etc&#x2F;corosync<br>[root@node1 corosync]# ls -lh<br>total 16K<br>-rw-r–r–. 1 root root  397 Apr 13 16:56 corosync.conf<br>-rw-r–r–. 1 root root 2.9K Nov 25  2021 corosync.conf.example<br>-rw-r–r–. 1 root root  767 Nov 25  2021 corosync.conf.example.udpu<br>-rw-r–r–. 1 root root 3.3K Nov 25  2021 corosync.xml.example<br>drwxr-xr-x. 2 root root    6 Nov 25  2021 uidgid.d<br>[root@node1 corosync]# pcs cluster status<br>Error: cluster is not currently running on this node<br>[root@node1 corosync]# cat corosync.conf<br>totem {<br>    version: 2 #集群版本<br>    cluster_name: cluster1 #集群名称<br>    secauth: off #安全身份验证协议<br>    transport: udpu #节点之间的传输协议<br>}</p>
<p>nodelist { #节点的列表，可以使用Ip或者定义的主机名称<br>    node {<br>        ring0_addr: node1-heartbeat #心跳网络<br>        nodeid: 1<br>    }</p>
<pre><code>node &#123;
    ring0_addr: node1-heartbeat #心跳网络
    nodeid: 2
&#125;
</code></pre>
<p>}</p>
<p>quorum {<br>    provider: corosync_votequorum<br>    two_node: 1  #告诉集群当前是双节点的，只剩一个节点时不要将集群停止<br>}</p>
<p>logging { #日志相关<br>    to_logfile: yes<br>    logfile: &#x2F;var&#x2F;log&#x2F;cluster&#x2F;corosync.log<br>    to_syslog: yes<br>}<br>[root@node1 corosync]# pcs cluster start –help  #查看启动帮助</p>
<p>Usage: pcs cluster start…<br>    start [–all | <node>… ] [–wait[&#x3D;<n>]] [–request-timeout&#x3D;<seconds>]<br>        Start a cluster on specified node(s). If no nodes are specified then<br>        start a cluster on the local node. If –all is specified then start<br>        a cluster on all nodes. If the cluster has many nodes then the start<br>        request may time out. In that case you should consider setting<br>        –request-timeout to a suitable value. If –wait is specified, pcs<br>        waits up to ‘n’ seconds for the cluster to get ready to provide<br>        services after the cluster has successfully started.<br>[root@node1 corosync]# pcs cluster start  –all  #启动所有节点，不使用–all的时候默认启动当前节点，此时可以在其他主机的syslog中查看相关日志信息<br>node1-heartbeat: Starting Cluster (corosync)…<br>node2-heartbeat: Starting Cluster (corosync)…<br>node1-heartbeat: Starting Cluster (pacemaker)…<br>node2-heartbeat: Starting Cluster (pacemaker)…<br>[root@node1 corosync]# pcs status #查看pcs状态<br>Cluster name: cluster1 #集群的名称</seconds></n></node></p>
<p>WARNINGS:<br>No stonith devices and stonith-enabled is not false #目前是正常现象，还没有配置stonith</p>
<p>Stack: corosync #使用corosync作为心跳<br>Current DC: node1-heartbeat (version 1.1.23-1.el7_9.1-9acf116022) - partition WITHOUT quorum<br>Last updated: Fri Apr 14 09:25:54 2023 #获取信息时间<br>Last change: Fri Apr 14 09:24:26 2023 by hacluster via crmd on node1-heartbeat #获取信息时间</p>
<p>2 nodes configured #双节点的集群<br>0 resource instances configured  #目前没有配置资源</p>
<p>Online: [ node1-heartbeat node2-heartbeat ] #当前集群运行的主机</p>
<p>No resources</p>
<p>Daemon Status: #响应的守护程序<br>  corosync: active&#x2F;disabled<br>  pacemaker: active&#x2F;disabled<br>  pcsd: active&#x2F;enabled</p>
<p>[root@node1 corosync]# pcs cluster status #查看集群当前状态<br>Cluster Status:<br> Stack: corosync<br> Current DC: node1-heartbeat (version 1.1.23-1.el7_9.1-9acf116022) - partition WITHOUT quorum #当前的DC<br> Last updated: Fri Apr 14 09:25:00 2023<br> Last change: Fri Apr 14 09:24:26 2023 by hacluster via crmd on node1-heartbeat<br> 2 nodes configured<br> 0 resource instances configured</p>
<p>PCSD Status: #当前集群两个节点的状态都是在线的<br>  node1-heartbeat: Online<br>  node2-heartbeat: Online</p>
<p>[root@node1 corosync]# systemctl status pacemaker.service -l #查看响应的服务状态<br>● pacemaker.service - Pacemaker High Availability Cluster Manager<br>   Loaded: loaded (&#x2F;usr&#x2F;lib&#x2F;systemd&#x2F;system&#x2F;pacemaker.service; disabled; vendor preset: disabled)<br>   Active: active (running) since Fri 2023-04-14 09:32:57 CST; 4min 10s ago<br>     Docs: man:pacemakerd<br>           <a target="_blank" rel="noopener" href="https://clusterlabs.org/pacemaker/doc/en-US/Pacemaker/1.1/html-single/Pacemaker_Explained/index.html">https://clusterlabs.org/pacemaker/doc/en-US/Pacemaker/1.1/html-single/Pacemaker_Explained/index.html</a><br> Main PID: 12054 (pacemakerd)<br>    Tasks: 7<br>   CGroup: &#x2F;system.slice&#x2F;pacemaker.service<br>           ├─12054 &#x2F;usr&#x2F;sbin&#x2F;pacemakerd -f<br>           ├─12055 &#x2F;usr&#x2F;libexec&#x2F;pacemaker&#x2F;cib<br>           ├─12056 &#x2F;usr&#x2F;libexec&#x2F;pacemaker&#x2F;stonithd<br>           ├─12057 &#x2F;usr&#x2F;libexec&#x2F;pacemaker&#x2F;lrmd<br>           ├─12058 &#x2F;usr&#x2F;libexec&#x2F;pacemaker&#x2F;attrd<br>           ├─12059 &#x2F;usr&#x2F;libexec&#x2F;pacemaker&#x2F;pengine<br>           └─12060 &#x2F;usr&#x2F;libexec&#x2F;pacemaker&#x2F;crmd</p>
<p>Apr 14 09:32:58 node1 crmd[12060]:   notice: Quorum acquired<br>Apr 14 09:32:58 node1 crmd[12060]:   notice: Node node1-heartbeat state is now member<br>Apr 14 09:32:58 node1 crmd[12060]:   notice: Node node2-heartbeat state is now member<br>Apr 14 09:32:58 node1 crmd[12060]:   notice: The local CRM is operational<br>Apr 14 09:32:58 node1 crmd[12060]:   notice: State transition S_STARTING -&gt; S_PENDING<br>Apr 14 09:33:00 node1 crmd[12060]:   notice: Fencer successfully connected<br>Apr 14 09:33:19 node1 crmd[12060]:  warning: Input I_DC_TIMEOUT received in state S_PENDING from crm_timer_popped<br>Apr 14 09:33:19 node1 crmd[12060]:   notice: State transition S_ELECTION -&gt; S_PENDING<br>Apr 14 09:33:19 node1 crmd[12060]:   notice: State transition S_PENDING -&gt; S_NOT_DC<br>Apr 14 09:33:19 node1 attrd[12058]:   notice: Updating all attributes after cib_refresh_notify event</p>
<p>[root@node1 corosync]# systemctl status corosync -l<br>● corosync.service - Corosync Cluster Engine<br>   Loaded: loaded (&#x2F;usr&#x2F;lib&#x2F;systemd&#x2F;system&#x2F;corosync.service; disabled; vendor preset: disabled)<br>   Active: active (running) since Fri 2023-04-14 09:32:57 CST; 4min 39s ago<br>     Docs: man:corosync<br>           man:corosync.conf<br>           man:corosync_overview<br>  Process: 12025 ExecStart&#x3D;&#x2F;usr&#x2F;share&#x2F;corosync&#x2F;corosync start (code&#x3D;exited, status&#x3D;0&#x2F;SUCCESS)<br> Main PID: 12034 (corosync)<br>    Tasks: 2<br>   CGroup: &#x2F;system.slice&#x2F;corosync.service<br>           └─12034 corosync</p>
<p>Apr 14 09:32:56 node1 corosync[12034]:  [QUORUM] Members[1]: 1<br>Apr 14 09:32:56 node1 corosync[12034]:  [MAIN  ] Completed service synchronization, ready to provide service.<br>Apr 14 09:32:56 node1 corosync[12034]:  [TOTEM ] A new membership (192.168.0.200:14) was formed. Members joined: 2<br>Apr 14 09:32:56 node1 corosync[12034]:  [CPG   ] downlist left_list: 0 received<br>Apr 14 09:32:56 node1 corosync[12034]:  [CPG   ] downlist left_list: 0 received<br>Apr 14 09:32:56 node1 corosync[12034]:  [QUORUM] This node is within the primary component and will provide service.<br>Apr 14 09:32:56 node1 corosync[12034]:  [QUORUM] Members[2]: 1 2<br>Apr 14 09:32:56 node1 corosync[12034]:  [MAIN  ] Completed service synchronization, ready to provide service.<br>Apr 14 09:32:57 node1 corosync[12025]: Starting Corosync Cluster Engine (corosync): [  确定  ]<br>Apr 14 09:32:57 node1 systemd[1]: Started Corosync Cluster Engine.</p>
<p>[root@node1 corosync]# systemctl status pcsd -l<br>● pcsd.service - PCS GUI and remote configuration interface<br>   Loaded: loaded (&#x2F;usr&#x2F;lib&#x2F;systemd&#x2F;system&#x2F;pcsd.service; enabled; vendor preset: disabled)<br>   Active: active (running) since Thu 2023-04-13 16:56:20 CST; 16h ago<br>     Docs: man:pcsd(8)<br>           man:pcs(8)<br> Main PID: 6555 (pcsd)<br>    Tasks: 6<br>   CGroup: &#x2F;system.slice&#x2F;pcsd.service<br>           └─6555 &#x2F;usr&#x2F;bin&#x2F;ruby &#x2F;usr&#x2F;lib&#x2F;pcsd&#x2F;pcsd</p>
<p>Apr 13 16:56:19 node1 systemd[1]: Stopped PCS GUI and remote configuration interface.<br>Apr 13 16:56:19 node1 systemd[1]: Starting PCS GUI and remote configuration interface…<br>Apr 13 16:56:20 node1 systemd[1]: Started PCS GUI and remote configuration interface.</p>
<p>[root@node1 corosync]# netstat -ntlp | grep 2224 #集群安装并启动后会运行一个GUI的服务，默认端口使用的是2224，使用https的方式来进行访问，用户名密码使用上述创建的，hacluster&#x2F;password<br>tcp6       0      0 :::2224                 :::*                    LISTEN      6555&#x2F;ruby</p>
<pre><code>![](images/KVM虚拟化进阶与提高视频课程/78.jpg)
![](images/KVM虚拟化进阶与提高视频课程/79.jpg)

# 五、基于NFS的KVM群集构建

## 1、规划设计

| 主机名称 | 管理地址 | 心跳地址 | 存储地址 |
| --- | --- | --- | --- |
| node1 | 192.168.200.200 | 192.168.0.200 | 192.168.1.200 |
| node2 | 192.168.200.201 | 192.168.0.201 | 192.168.1.201 |
| stor1 | 192.168.200.202 |  | 192.168.1.202 |

![](images/KVM虚拟化进阶与提高视频课程/80.jpg)


## 2、节点准备

### 1、阶段1：操作系统安装

![](images/KVM虚拟化进阶与提高视频课程/81.jpg)

### 2、阶段2：群集组件安装

![](images/KVM虚拟化进阶与提高视频课程/82.jpg)

### 3、阶段3：群集节点安装

![](images/KVM虚拟化进阶与提高视频课程/83.jpg)

&gt; 需要注意各个节点的防火墙配置！

## 3、配置NFS资源

![](images/KVM虚拟化进阶与提高视频课程/84.jpg)

&gt; 防火墙是指NFS服务器防火墙

![](images/KVM虚拟化进阶与提高视频课程/85.jpg)

## 4、准备虚拟机

**所有节点的host应一致**
</code></pre>
<p>[root@node1 corosync]# cat &#x2F;etc&#x2F;hosts<br>127.0.0.1   localhost localhost.localdomain localhost4 localhost4.localdomain4<br>::1         localhost localhost.localdomain localhost6 localhost6.localdomain6<br>192.168.200.200 node1<br>192.168.200.201 node2<br>192.168.0.200 node1-heartbeat<br>192.168.0.201 node2-heartbeat<br>192.168.1.200 node1-storage<br>192.168.1.201 node2-storage<br>192.168.1.202 nfs</p>
<pre><code>
**所有主机都应该测试能否访问NFS服务器**

</code></pre>
<p>[root@node1 vmdata]# showmount -e 192.168.1.202<br>Export list for 192.168.1.202:<br>&#x2F;vmdata *<br>[root@node1 vmdata]# mount nfs:&#x2F;vmdata &#x2F;vmdata #将NFS服务器的共享目录挂载到本地的&#x2F;vmdata中，所有主机都执行<br>[root@node1 vmdata]# df -HT  #查看挂载情况<br>Filesystem              Type      Size  Used Avail Use% Mounted on<br>devtmpfs                devtmpfs  2.0G     0  2.0G   0% &#x2F;dev<br>tmpfs                   tmpfs     2.0G   40M  2.0G   3% &#x2F;dev&#x2F;shm<br>tmpfs                   tmpfs     2.0G   13M  2.0G   1% &#x2F;run<br>tmpfs                   tmpfs     2.0G     0  2.0G   0% &#x2F;sys&#x2F;fs&#x2F;cgroup<br>&#x2F;dev&#x2F;mapper&#x2F;centos-root xfs        38G   37G  1.1G  98% &#x2F;<br>&#x2F;dev&#x2F;sda1               xfs       1.1G  206M  859M  20% &#x2F;boot<br>tmpfs                   tmpfs     396M     0  396M   0% &#x2F;run&#x2F;user&#x2F;0<br>nfs:&#x2F;vmdata             nfs4       38G   13G   26G  34% &#x2F;vmdata<br>[root@node1 ~]# cat &#x2F;etc&#x2F;fstab </p>
<h1><span id></span></h1><h1><span id="x2fetcx2ffstab">&#x2F;etc&#x2F;fstab</span></h1><h1><span id="created-by-anaconda-on-sun-apr-2-232850-2023">Created by anaconda on Sun Apr  2 23:28:50 2023</span></h1><h1><span id></span></h1><h1><span id="accessible-filesystems-by-reference-are-maintained-under-x2fdevx2fdisk">Accessible filesystems, by reference, are maintained under ‘&#x2F;dev&#x2F;disk’</span></h1><h1><span id="see-man-pages-fstab5-findfs8-mount8-andx2for-blkid8-for-more-info">See man pages fstab(5), findfs(8), mount(8) and&#x2F;or blkid(8) for more info</span></h1><h1><span id></span></h1><p>&#x2F;dev&#x2F;mapper&#x2F;centos-root &#x2F;                       xfs     defaults        0 0<br>UUID&#x3D;b283ae1c-89a3-40a1-b8f9-21699c857148 &#x2F;boot                   xfs     defaults        0 0<br>&#x2F;dev&#x2F;mapper&#x2F;centos-swap swap                    swap    defaults        0 0<br>nfs:&#x2F;vmdata &#x2F;vmdata nfs4    defaults 0 0<br>[root@node1 ~]# setsebool -P virt_use_nfs 1</p>
<pre><code>![](images/KVM虚拟化进阶与提高视频课程/86.jpg)
![](images/KVM虚拟化进阶与提高视频课程/87.jpg)

**配置虚拟机使用NFS作为后端存储**
</code></pre>
<h2><span id="rootnode1-vmdata-virsh-list-all-id-name-state">[root@node1 vmdata]# virsh list –all<br> Id    Name                           State</span></h2><p> 8     Centos7.9                      running</p>
<p>[root@node1 vmdata]# virsh shutdown –domain Centos7.9<br>Domain Centos7.9 is being shutdown</p>
<p>[root@node1 vmdata]# virsh edit –domain Centos7.9 </p>
<pre><code>  &lt;source file=&#39;/vmdata/Centos7.9.qcow2&#39;/&gt;
  
</code></pre>
<p>Domain Centos7.9 XML configuration edited.</p>
<p>[root@node1 vmdata]# virsh start –domain Centos7.9<br>Domain Centos7.9 started</p>
<pre><code>
**测试基于NFS的动态迁移**

node1 &gt; node2
</code></pre>
<p>[root@node1 vmdata]# virsh migrate –domain Centos7.9 –desturi qemu+ssh:&#x2F;&#x2F;root@node2&#x2F;system –live –persistent –undefinesource –unsafe  –verbose<br>Migration: [100 %]<br>[root@node1 vmdata]# iptables -I INPUT -p tcp -s 192.168.1.0&#x2F;24 -j ACCEPT</p>
<pre><code>node2 &gt; node1
</code></pre>
<p>[root@node2 vmdata]# virsh migrate –domain Centos7.9 –desturi qemu+ssh:&#x2F;&#x2F;root@node1&#x2F;system –live –persistent –undefinesource –unsafe –verbose –migrateuri tcp:&#x2F;&#x2F;192.168.1.200<br>Migration: [100 %]</p>
<pre><code>
## 5、配置STONTH（IPMI）

## 6、向群集添加虚拟机资源

## 7、群集测试


# 六、基于iSCSI的KVM群集构建

# 七、基于DRBD的KVM群集构建

# 八、P2V、V2V迁移

# 九、嵌套虚拟化

# 十、备份与恢复

# 十一、性能监视与优化

# 十二、oVirt(RHEV)安装与基本管理
</code></pre>
<script type="text&#x2F;javascript" src="https://unpkg.com/kity@2.0.4/dist/kity.min.js"></script><script type="text&#x2F;javascript" src="https://unpkg.com/kityminder-core@1.4.50/dist/kityminder.core.min.js"></script><script defer="true" type="text&#x2F;javascript" src="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.js"></script><link rel="stylesheet" type="text&#x2F;css" href="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.css">
        </article>

        
            
  <div class="nexmoe-post-copyright">
    <strong>Author：</strong>张博丞<br>
    
      <strong>From：</strong><a href="/%E5%8E%9F%E5%88%9B" title="原创" target="_blank" rel="noopener">原创</a><br>
    
    <strong>Link：</strong><a href="https://zhangboc.github.io/2023/04/12/KVM/KVM%E8%99%9A%E6%8B%9F%E5%8C%96%E8%BF%9B%E9%98%B6%E4%B8%8E%E6%8F%90%E9%AB%98%E8%A7%86%E9%A2%91%E8%AF%BE%E7%A8%8B/KVM%E8%99%9A%E6%8B%9F%E5%8C%96%E8%BF%9B%E9%98%B6%E4%B8%8E%E6%8F%90%E9%AB%98%E8%A7%86%E9%A2%91%E8%AF%BE%E7%A8%8B/" title="https:&#x2F;&#x2F;zhangboc.github.io&#x2F;2023&#x2F;04&#x2F;12&#x2F;KVM&#x2F;KVM%E8%99%9A%E6%8B%9F%E5%8C%96%E8%BF%9B%E9%98%B6%E4%B8%8E%E6%8F%90%E9%AB%98%E8%A7%86%E9%A2%91%E8%AF%BE%E7%A8%8B&#x2F;KVM%E8%99%9A%E6%8B%9F%E5%8C%96%E8%BF%9B%E9%98%B6%E4%B8%8E%E6%8F%90%E9%AB%98%E8%A7%86%E9%A2%91%E8%AF%BE%E7%A8%8B&#x2F;" target="_blank" rel="noopener">https:&#x2F;&#x2F;zhangboc.github.io&#x2F;2023&#x2F;04&#x2F;12&#x2F;KVM&#x2F;KVM%E8%99%9A%E6%8B%9F%E5%8C%96%E8%BF%9B%E9%98%B6%E4%B8%8E%E6%8F%90%E9%AB%98%E8%A7%86%E9%A2%91%E8%AF%BE%E7%A8%8B&#x2F;KVM%E8%99%9A%E6%8B%9F%E5%8C%96%E8%BF%9B%E9%98%B6%E4%B8%8E%E6%8F%90%E9%AB%98%E8%A7%86%E9%A2%91%E8%AF%BE%E7%A8%8B&#x2F;</a><br>

    
      <strong>版权声明：</strong>本文采用 <a href="https://creativecommons.org/licenses/by-nc-sa/3.0/cn/deed.zh" target="_blank">CC BY-NC-SA 3.0 CN</a> 协议进行许可
    
  </div>


        

        <div class="nexmoe-post-meta nexmoe-rainbow">
    
        <a class="nexmoefont icon-appstore-fill -link" href="/categories/KVM/">KVM</a>
    
    
        <a class="nexmoefont icon-tag-fill -none-link" href="/tags/KVM/" rel="tag">KVM</a>
    
</div>

    <div class="nexmoe-post-footer">
        <section class="nexmoe-comment">
    <div class="valine"></div>
<script src='https://lib.baomitu.com/valine/1.3.9/Valine.min.js'></script>
<script>
    // 使用方法 https://valine.js.org/quickstart.html
    new Valine({
        el: '.valine',
        appId: 'r5zxC0st0DDjPA9auXzMV7HY-gzGzoHsz',
        appKey: '3bqCsovpyfTPHUzTHovd3V3V'
    })
</script>
</section>
    </div>
</div>
<script type="text/javascript" src="/libs/codeBlock/codeBlockFuction.js"></script>
<!-- 代码语言 -->
<script type="text/javascript" src="/libs/codeBlock/codeLang.js"></script>
<!-- 代码块复制 -->
<script type="text/javascript" src="/libs/codeBlock/codeCopy.js"></script>
<script type="text/javascript" src="/libs/codeBlock/clipboard.min.js"></script>
<!-- 代码块收缩 -->
<script type="text/javascript" src="/libs/codeBlock/codeShrink.js"></script> 
<!-- 代码块折行 -->
<style type="text/css">code[class*="language-"], pre[class*="language-"] { white-space: pre !important; }</style>

        <div class="nexmoe-post-right">
          
            <div class="nexmoe-fixed">
              <div class="nexmoe-tool">
                <a href="#" aria-label="回到顶部" title="top"><button class="mdui-fab mdui-ripple"><i class="nexmoefont icon-caret-top"></i></button></a>
              </div>
            </div>
          
        </div>
    </div>
  </div>
  <div id="nexmoe-pendant">
    <div class="nexmoe-drawer mdui-drawer nexmoe-pd" id="drawer">
        
            <div class="nexmoe-pd-item">
                <div class="clock">
        <div class="memory"></div>
        <div class="memory"></div>
        <div class="memory"></div>
        <div class="memory"></div>
        <div class="memory"></div>
        <div class="memory"></div>
        <div class="memory"></div>
        <div class="memory"></div>
        <div class="memory"></div>
        <div class="memory"></div>
        <div class="memory"></div>
        <div class="memory"></div>
        <div class="memory"></div>
        <div class="memory"></div>
        <div class="memory"></div>
        <div class="memory"></div>
        <div class="memory"></div>
        <div class="memory"></div>
        <div class="memory"></div>
        <div class="memory"></div>
        <div class="memory"></div>
        <div class="memory"></div>
        <div class="memory"></div>
        <div class="memory"></div>
        <div class="memory"></div>
        <div class="memory"></div>
        <div class="memory"></div>
        <div class="memory"></div>
        <div class="memory"></div>
        <div class="memory"></div>
        <div class="memory"></div>
        <div class="memory"></div>
        <div class="memory"></div>
        <div class="memory"></div>
        <div class="memory"></div>
        <div class="memory"></div>
        <div class="memory"></div>
        <div class="memory"></div>
        <div class="memory"></div>
        <div class="memory"></div>
        <div class="memory"></div>
        <div class="memory"></div>
        <div class="memory"></div>
        <div class="memory"></div>
        <div class="memory"></div>
        <div class="memory"></div>
        <div class="memory"></div>
        <div class="memory"></div>
        <div class="memory"></div>
        <div class="memory"></div>
        <div class="memory"></div>
        <div class="memory"></div>
        <div class="memory"></div>
        <div class="memory"></div>
        <div class="memory"></div>
        <div class="memory"></div>
        <div class="memory"></div>
        <div class="memory"></div>
        <div class="memory"></div>
        <div class="memory"></div>
        <div class="needle" id="hours"></div>
        <div class="needle" id="minutes"></div>
        <div class="needle" id="seconds"></div>
        <div class="clock_logo">

        </div>

    </div>
<style>
    .clock {
        background-color: #ffffff;
        width: 70vw;
        height: 70vw;
        max-width: 70vh;
        max-height: 70vh;
        border: solid 2.8vw #242424;
        position: relative;
        overflow: hidden;
        border-radius: 50%;
        box-sizing: border-box;
        box-shadow: 0 1.4vw 2.8vw rgba(0, 0, 0, 0.8);
        zoom:0.2
    }

    .memory {
        position: absolute;
        top: 50%;
        left: 50%;
        transform-origin: center;
    }

    .memory:nth-child(1) {
        background-color: #424242;
        width: 2%;
        height: 8%;
        transform: translate(-50%, -50%) rotate(0deg) translateY(-520%);
    }

    .memory:nth-child(2) {
        background-color: #949494;
        width: 1%;
        height: 3%;
        transform: translate(-50%, -50%) rotate(6deg) translateY(-1461%);
    }

    .memory:nth-child(3) {
        background-color: #949494;
        width: 1%;
        height: 3%;
        transform: translate(-50%, -50%) rotate(12deg) translateY(-1461%);
    }

    .memory:nth-child(4) {
        background-color: #949494;
        width: 1%;
        height: 3%;
        transform: translate(-50%, -50%) rotate(18deg) translateY(-1461%);
    }

    .memory:nth-child(5) {
        background-color: #949494;
        width: 1%;
        height: 3%;
        transform: translate(-50%, -50%) rotate(24deg) translateY(-1461%);
    }

    .memory:nth-child(6) {
        background-color: #424242;
        width: 2%;
        height: 8%;
        transform: translate(-50%, -50%) rotate(30deg) translateY(-520%);
    }

    .memory:nth-child(7) {
        background-color: #949494;
        width: 1%;
        height: 3%;
        transform: translate(-50%, -50%) rotate(36deg) translateY(-1461%);
    }

    .memory:nth-child(8) {
        background-color: #949494;
        width: 1%;
        height: 3%;
        transform: translate(-50%, -50%) rotate(42deg) translateY(-1461%);
    }

    .memory:nth-child(9) {
        background-color: #949494;
        width: 1%;
        height: 3%;
        transform: translate(-50%, -50%) rotate(48deg) translateY(-1461%);
    }

    .memory:nth-child(10) {
        background-color: #949494;
        width: 1%;
        height: 3%;
        transform: translate(-50%, -50%) rotate(54deg) translateY(-1461%);
    }

    .memory:nth-child(11) {
        background-color: #424242;
        width: 2%;
        height: 8%;
        transform: translate(-50%, -50%) rotate(60deg) translateY(-520%);
    }

    .memory:nth-child(12) {
        background-color: #949494;
        width: 1%;
        height: 3%;
        transform: translate(-50%, -50%) rotate(66deg) translateY(-1461%);
    }

    .memory:nth-child(13) {
        background-color: #949494;
        width: 1%;
        height: 3%;
        transform: translate(-50%, -50%) rotate(72deg) translateY(-1461%);
    }

    .memory:nth-child(14) {
        background-color: #949494;
        width: 1%;
        height: 3%;
        transform: translate(-50%, -50%) rotate(78deg) translateY(-1461%);
    }

    .memory:nth-child(15) {
        background-color: #949494;
        width: 1%;
        height: 3%;
        transform: translate(-50%, -50%) rotate(84deg) translateY(-1461%);
    }

    .memory:nth-child(16) {
        background-color: #424242;
        width: 2%;
        height: 8%;
        transform: translate(-50%, -50%) rotate(90deg) translateY(-520%);
    }

    .memory:nth-child(17) {
        background-color: #949494;
        width: 1%;
        height: 3%;
        transform: translate(-50%, -50%) rotate(96deg) translateY(-1461%);
    }

    .memory:nth-child(18) {
        background-color: #949494;
        width: 1%;
        height: 3%;
        transform: translate(-50%, -50%) rotate(102deg) translateY(-1461%);
    }

    .memory:nth-child(19) {
        background-color: #949494;
        width: 1%;
        height: 3%;
        transform: translate(-50%, -50%) rotate(108deg) translateY(-1461%);
    }

    .memory:nth-child(20) {
        background-color: #949494;
        width: 1%;
        height: 3%;
        transform: translate(-50%, -50%) rotate(114deg) translateY(-1461%);
    }

    .memory:nth-child(21) {
        background-color: #424242;
        width: 2%;
        height: 8%;
        transform: translate(-50%, -50%) rotate(120deg) translateY(-520%);
    }

    .memory:nth-child(22) {
        background-color: #949494;
        width: 1%;
        height: 3%;
        transform: translate(-50%, -50%) rotate(126deg) translateY(-1461%);
    }

    .memory:nth-child(23) {
        background-color: #949494;
        width: 1%;
        height: 3%;
        transform: translate(-50%, -50%) rotate(132deg) translateY(-1461%);
    }

    .memory:nth-child(24) {
        background-color: #949494;
        width: 1%;
        height: 3%;
        transform: translate(-50%, -50%) rotate(138deg) translateY(-1461%);
    }

    .memory:nth-child(25) {
        background-color: #949494;
        width: 1%;
        height: 3%;
        transform: translate(-50%, -50%) rotate(144deg) translateY(-1461%);
    }

    .memory:nth-child(26) {
        background-color: #424242;
        width: 2%;
        height: 8%;
        transform: translate(-50%, -50%) rotate(150deg) translateY(-520%);
    }

    .memory:nth-child(27) {
        background-color: #949494;
        width: 1%;
        height: 3%;
        transform: translate(-50%, -50%) rotate(156deg) translateY(-1461%);
    }

    .memory:nth-child(28) {
        background-color: #949494;
        width: 1%;
        height: 3%;
        transform: translate(-50%, -50%) rotate(162deg) translateY(-1461%);
    }

    .memory:nth-child(29) {
        background-color: #949494;
        width: 1%;
        height: 3%;
        transform: translate(-50%, -50%) rotate(168deg) translateY(-1461%);
    }

    .memory:nth-child(30) {
        background-color: #949494;
        width: 1%;
        height: 3%;
        transform: translate(-50%, -50%) rotate(174deg) translateY(-1461%);
    }

    .memory:nth-child(31) {
        background-color: #424242;
        width: 2%;
        height: 8%;
        transform: translate(-50%, -50%) rotate(180deg) translateY(-520%);
    }

    .memory:nth-child(32) {
        background-color: #949494;
        width: 1%;
        height: 3%;
        transform: translate(-50%, -50%) rotate(186deg) translateY(-1461%);
    }

    .memory:nth-child(33) {
        background-color: #949494;
        width: 1%;
        height: 3%;
        transform: translate(-50%, -50%) rotate(192deg) translateY(-1461%);
    }

    .memory:nth-child(34) {
        background-color: #949494;
        width: 1%;
        height: 3%;
        transform: translate(-50%, -50%) rotate(198deg) translateY(-1461%);
    }

    .memory:nth-child(35) {
        background-color: #949494;
        width: 1%;
        height: 3%;
        transform: translate(-50%, -50%) rotate(204deg) translateY(-1461%);
    }

    .memory:nth-child(36) {
        background-color: #424242;
        width: 2%;
        height: 8%;
        transform: translate(-50%, -50%) rotate(210deg) translateY(-520%);
    }

    .memory:nth-child(37) {
        background-color: #949494;
        width: 1%;
        height: 3%;
        transform: translate(-50%, -50%) rotate(216deg) translateY(-1461%);
    }

    .memory:nth-child(38) {
        background-color: #949494;
        width: 1%;
        height: 3%;
        transform: translate(-50%, -50%) rotate(222deg) translateY(-1461%);
    }

    .memory:nth-child(39) {
        background-color: #949494;
        width: 1%;
        height: 3%;
        transform: translate(-50%, -50%) rotate(228deg) translateY(-1461%);
    }

    .memory:nth-child(40) {
        background-color: #949494;
        width: 1%;
        height: 3%;
        transform: translate(-50%, -50%) rotate(234deg) translateY(-1461%);
    }

    .memory:nth-child(41) {
        background-color: #424242;
        width: 2%;
        height: 8%;
        transform: translate(-50%, -50%) rotate(240deg) translateY(-520%);
    }

    .memory:nth-child(42) {
        background-color: #949494;
        width: 1%;
        height: 3%;
        transform: translate(-50%, -50%) rotate(246deg) translateY(-1461%);
    }

    .memory:nth-child(43) {
        background-color: #949494;
        width: 1%;
        height: 3%;
        transform: translate(-50%, -50%) rotate(252deg) translateY(-1461%);
    }

    .memory:nth-child(44) {
        background-color: #949494;
        width: 1%;
        height: 3%;
        transform: translate(-50%, -50%) rotate(258deg) translateY(-1461%);
    }

    .memory:nth-child(45) {
        background-color: #949494;
        width: 1%;
        height: 3%;
        transform: translate(-50%, -50%) rotate(264deg) translateY(-1461%);
    }

    .memory:nth-child(46) {
        background-color: #424242;
        width: 2%;
        height: 8%;
        transform: translate(-50%, -50%) rotate(270deg) translateY(-520%);
    }

    .memory:nth-child(47) {
        background-color: #949494;
        width: 1%;
        height: 3%;
        transform: translate(-50%, -50%) rotate(276deg) translateY(-1461%);
    }

    .memory:nth-child(48) {
        background-color: #949494;
        width: 1%;
        height: 3%;
        transform: translate(-50%, -50%) rotate(282deg) translateY(-1461%);
    }

    .memory:nth-child(49) {
        background-color: #949494;
        width: 1%;
        height: 3%;
        transform: translate(-50%, -50%) rotate(288deg) translateY(-1461%);
    }

    .memory:nth-child(50) {
        background-color: #949494;
        width: 1%;
        height: 3%;
        transform: translate(-50%, -50%) rotate(294deg) translateY(-1461%);
    }

    .memory:nth-child(51) {
        background-color: #424242;
        width: 2%;
        height: 8%;
        transform: translate(-50%, -50%) rotate(300deg) translateY(-520%);
    }

    .memory:nth-child(52) {
        background-color: #949494;
        width: 1%;
        height: 3%;
        transform: translate(-50%, -50%) rotate(306deg) translateY(-1461%);
    }

    .memory:nth-child(53) {
        background-color: #949494;
        width: 1%;
        height: 3%;
        transform: translate(-50%, -50%) rotate(312deg) translateY(-1461%);
    }

    .memory:nth-child(54) {
        background-color: #949494;
        width: 1%;
        height: 3%;
        transform: translate(-50%, -50%) rotate(318deg) translateY(-1461%);
    }

    .memory:nth-child(55) {
        background-color: #949494;
        width: 1%;
        height: 3%;
        transform: translate(-50%, -50%) rotate(324deg) translateY(-1461%);
    }

    .memory:nth-child(56) {
        background-color: #424242;
        width: 2%;
        height: 8%;
        transform: translate(-50%, -50%) rotate(330deg) translateY(-520%);
    }

    .memory:nth-child(57) {
        background-color: #949494;
        width: 1%;
        height: 3%;
        transform: translate(-50%, -50%) rotate(336deg) translateY(-1461%);
    }

    .memory:nth-child(58) {
        background-color: #949494;
        width: 1%;
        height: 3%;
        transform: translate(-50%, -50%) rotate(342deg) translateY(-1461%);
    }

    .memory:nth-child(59) {
        background-color: #949494;
        width: 1%;
        height: 3%;
        transform: translate(-50%, -50%) rotate(348deg) translateY(-1461%);
    }

    .memory:nth-child(60) {
        background-color: #949494;
        width: 1%;
        height: 3%;
        transform: translate(-50%, -50%) rotate(354deg) translateY(-1461%);
    }

    .needle {
        position: absolute;
        top: 50%;
        left: 50%;
        transform-origin: center;
    }

    .needle#hours {
        background-color: #1f1f1f;
        width: 4%;
        height: 30%;
        transform-origin: center 75%;
        transform: translate(-50%, -75%);
    }

    .needle#hours.moving {
        transition: transform 150ms ease-out;
    }

    .needle#hours:after {
        content: '';
        background-color: #1f1f1f;
        width: 4vw;
        height: 4vw;
        max-width: 4vh;
        max-height: 4vh;
        display: block;
        position: absolute;
        top: 75%;
        left: 50%;
        box-sizing: border-box;
        border-radius: 50%;
        transform: translate(-50%, -50%);
    }

    .needle#minutes {
        background-color: #1f1f1f;
        width: 2%;
        height: 45%;
        transform-origin: center 75%;
        transform: translate(-50%, -75%);
    }

    .needle#minutes.moving {
        transition: transform 150ms ease-out;
    }

    .needle#minutes:after {
        content: '';
        background-color: #1f1f1f;
        width: 4vw;
        height: 4vw;
        max-width: 4vh;
        max-height: 4vh;
        display: block;
        position: absolute;
        top: 75%;
        left: 50%;
        box-sizing: border-box;
        border-radius: 50%;
        transform: translate(-50%, -50%);
    }

    .needle#seconds {
        background-color: #cb2f2f;
        width: 1%;
        height: 50%;
        transform-origin: center 75%;
        transform: translate(-50%, -75%);
    }

    .needle#seconds.moving {
        transition: transform 150ms ease-out;
    }

    .needle#seconds:after {
        content: '';
        background-color: #cb2f2f;
        width: 2.5vw;
        height: 2.5vw;
        max-width: 2.5vh;
        max-height: 2.5vh;
        display: block;
        position: absolute;
        top: 75%;
        left: 50%;
        box-sizing: border-box;
        border-radius: 50%;
        transform: translate(-50%, -50%);
    }
    .clock_logo{
        width: 10vw;
        height: 10vw;
        max-width: 10vh;
        max-height: 10vh;
        position: absolute;
        top: 50%;
        left: 50%;
        box-sizing: border-box;
        border-radius: 50%;
        transform: translate(-50%, -50%);
        background-size: 100% 100%;
        background-repeat: no-repeat;
    }
    @media (min-width: 100vh) {
        .clock {
            border: solid 2.8vh #242424;
            box-shadow: 0 1.4vh 2.8vh rgba(0, 0, 0, 0.8);
        }
    }

</style>





            </div>
        
            <div class="nexmoe-pd-item">
                <div class="qweather" >
    <div id="he-plugin-standard"></div>
    <div class="qweather-logo">

    </div>

</div>
<style>
    .qweather{
        position: relative;
    }
    .qweather-logo{
        position: absolute;
        right: 0;
        top: -15px;
        width: 40px;
        height: 40px;
        background-size: 100% 100%;
        background-repeat: no-repeat;
    }
</style>
<script>
  WIDGET = {
    "CONFIG": {
      "layout": "2",
      "width": "260",
      "height": "220",
      "background": "5",
      "dataColor": "e67249",
      "borderRadius": "15",
      "key": "f74d1e1690e6432d801e97fa2f05a162"
    }
  }
</script>
<script src="https://widget.qweather.net/standard/static/js/he-standard-common.js?v=2.0"></script>

            </div>
        
</div>
<style>
    .nexmoe-pd {
        left: auto;
        top: 40px;
        right: 0;
    }
    .nexmoe-pd-item{
       display: flex;
        justify-content: center;
        margin-bottom: 30px;
    }
</style>

  </div>
  <script src="https://lib.baomitu.com/lazysizes/5.1.0/lazysizes.min.js"></script>
<script src="https://lib.baomitu.com/highlight.js/10.0.0/highlight.min.js"></script>
<script src="https://lib.baomitu.com/mdui/0.4.3/js/mdui.min.js"></script>

<script>
	hljs.initHighlightingOnLoad();
</script>

<script src="https://lib.baomitu.com/jquery/3.5.1/jquery.slim.min.js"></script>
<script src="/lib/fancybox/js/jquery.fancybox.min.js"></script>


<script src="/js/app.js?v=1681536611177"></script>

<script src="https://lib.baomitu.com/justifiedGallery/3.8.1/js/jquery.justifiedGallery.min.js"></script>
<script>
	$(".justified-gallery").justifiedGallery({
		rowHeight: 160,
		margins: 10,
	});
</script>

  





<!-- hexo injector body_end start -->
<script src="/js/clock.js"></script>

<script src="https://lib.baomitu.com/clipboard.js/2.0.8/clipboard.min.js"></script>

<script src="/lib/codeBlock/codeBlockFuction.js"></script>

<script src="/lib/codeBlock/codeLang.js"></script>

<script src="/lib/codeBlock/codeCopy.js"></script>

<script src="/lib/codeBlock/codeShrink.js"></script>

<link rel="stylesheet" href="/lib/codeBlock/matery.css">

<script src="https://code.jquery.com/jquery-3.6.0.js"></script>

<script src="/js/search.js"></script>

<script src="/js/webapp.js"></script>
<!-- hexo injector body_end end --><script src="/live2D/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2D/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"debug":true,"model":{"jsonPath":"/live2D/assets/xiaomai.model.json"},"display":{"position":"left","width":150,"height":300},"mobile":{"show":true},"react":{"opacity":1},"log":false});</script></body>
</html>

<script>(function(i,s,o,g,r,a,m){i["DaoVoiceObject"]=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;a.charset="utf-8";m.parentNode.insertBefore(a,m)})(window,document,"script",('https:' == document.location.protocol ? 'https:' : 'http:') + "//widget.daovoice.io/widget/5e784416.js","daovoice")</script>
<script>
  daovoice('init', {
    app_id: "5e784416"
  });
  daovoice('update');
</script>

