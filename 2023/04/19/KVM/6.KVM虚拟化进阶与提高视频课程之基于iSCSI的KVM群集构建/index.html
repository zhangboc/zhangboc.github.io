<!DOCTYPE html>

<html lang="en">

<head>
  
  <meta name="baidu-site-verification" content="code-J1Qg17G6wT" />
  <title>KVM虚拟化进阶之基于iSCSI的KVM群集构建 - Hexo</title>
  <meta charset="UTF-8">
  <meta name="description" content="">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5">
  
  

    <!-- Site Verification -->
    <meta name="baidu-site-verification" content="code-J1Qg17G6wT" />

  <link rel="shortcut icon" href="/images/head/head.jpg" type="image/png" />
  <meta property="og:type" content="article">
<meta property="og:title" content="KVM虚拟化进阶之基于iSCSI的KVM群集构建">
<meta property="og:url" content="https://zhangboc.github.io/2023/04/19/KVM/6.KVM%E8%99%9A%E6%8B%9F%E5%8C%96%E8%BF%9B%E9%98%B6%E4%B8%8E%E6%8F%90%E9%AB%98%E8%A7%86%E9%A2%91%E8%AF%BE%E7%A8%8B%E4%B9%8B%E5%9F%BA%E4%BA%8EiSCSI%E7%9A%84KVM%E7%BE%A4%E9%9B%86%E6%9E%84%E5%BB%BA/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://zhangboc.github.io/images/KVM/%E5%9F%BA%E4%BA%8EiSCSI%E7%9A%84KVM%E7%BE%A4%E9%9B%86%E6%9E%84%E5%BB%BA/80.jpg">
<meta property="og:image" content="https://zhangboc.github.io/images/KVM/%E5%9F%BA%E4%BA%8EiSCSI%E7%9A%84KVM%E7%BE%A4%E9%9B%86%E6%9E%84%E5%BB%BA/81.jpg">
<meta property="og:image" content="https://zhangboc.github.io/images/KVM/%E5%9F%BA%E4%BA%8EiSCSI%E7%9A%84KVM%E7%BE%A4%E9%9B%86%E6%9E%84%E5%BB%BA/82.jpg">
<meta property="og:image" content="https://zhangboc.github.io/images/KVM/%E5%9F%BA%E4%BA%8EiSCSI%E7%9A%84KVM%E7%BE%A4%E9%9B%86%E6%9E%84%E5%BB%BA/83.jpg">
<meta property="og:image" content="https://zhangboc.github.io/images/KVM/%E5%9F%BA%E4%BA%8EiSCSI%E7%9A%84KVM%E7%BE%A4%E9%9B%86%E6%9E%84%E5%BB%BA/93.jpg">
<meta property="og:image" content="https://zhangboc.github.io/images/KVM/%E5%9F%BA%E4%BA%8EiSCSI%E7%9A%84KVM%E7%BE%A4%E9%9B%86%E6%9E%84%E5%BB%BA/94.jpg">
<meta property="og:image" content="https://zhangboc.github.io/images/KVM/%E5%9F%BA%E4%BA%8EiSCSI%E7%9A%84KVM%E7%BE%A4%E9%9B%86%E6%9E%84%E5%BB%BA/95.jpg">
<meta property="og:image" content="https://zhangboc.github.io/images/KVM/%E5%9F%BA%E4%BA%8EiSCSI%E7%9A%84KVM%E7%BE%A4%E9%9B%86%E6%9E%84%E5%BB%BA/96.jpg">
<meta property="og:image" content="https://zhangboc.github.io/images/KVM/%E5%9F%BA%E4%BA%8EiSCSI%E7%9A%84KVM%E7%BE%A4%E9%9B%86%E6%9E%84%E5%BB%BA/97.jpg">
<meta property="og:image" content="https://zhangboc.github.io/images/KVM/%E5%9F%BA%E4%BA%8EiSCSI%E7%9A%84KVM%E7%BE%A4%E9%9B%86%E6%9E%84%E5%BB%BA/98.jpg">
<meta property="og:image" content="https://zhangboc.github.io/images/KVM/%E5%9F%BA%E4%BA%8EiSCSI%E7%9A%84KVM%E7%BE%A4%E9%9B%86%E6%9E%84%E5%BB%BA/99.jpg">
<meta property="og:image" content="https://zhangboc.github.io/images/KVM/%E5%9F%BA%E4%BA%8EiSCSI%E7%9A%84KVM%E7%BE%A4%E9%9B%86%E6%9E%84%E5%BB%BA/100.jpg">
<meta property="og:image" content="https://zhangboc.github.io/images/KVM/%E5%9F%BA%E4%BA%8EiSCSI%E7%9A%84KVM%E7%BE%A4%E9%9B%86%E6%9E%84%E5%BB%BA/101.jpg">
<meta property="og:image" content="https://zhangboc.github.io/images/KVM/%E5%9F%BA%E4%BA%8EiSCSI%E7%9A%84KVM%E7%BE%A4%E9%9B%86%E6%9E%84%E5%BB%BA/102.jpg">
<meta property="article:published_time" content="2023-04-18T16:00:00.000Z">
<meta property="article:modified_time" content="2023-04-19T03:47:23.780Z">
<meta property="article:author" content="John Doe">
<meta property="article:tag" content="KVM">
<meta property="article:tag" content="基于iSCSI的KVM群集构建">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://zhangboc.github.io/images/KVM/%E5%9F%BA%E4%BA%8EiSCSI%E7%9A%84KVM%E7%BE%A4%E9%9B%86%E6%9E%84%E5%BB%BA/80.jpg">
  <link rel="stylesheet" href="https://lib.baomitu.com/highlight.js/9.15.8/styles/atom-one-dark.min.css" crossorigin>
  <link rel="stylesheet" href="/lib/mdui_043tiny/css/mdui.css">
  <link rel="stylesheet" href="/lib/iconfont/iconfont.css">
  <link rel="stylesheet" href="/lib/fancybox/css/jquery.fancybox.min.css">
  <link rel="stylesheet" href="https://lib.baomitu.com/justifiedGallery/3.8.1/css/justifiedGallery.min.css">
  
    <link rel="stylesheet" href="//at.alicdn.com/t/font_2421060_8z08qcz5sq3.css">
  
  <link rel="stylesheet" href="/css/style.css?v=1682237265533">
<meta name="generator" content="Hexo 6.3.0"></head>

<body class="mdui-drawer-body-left">
  
  <div id="nexmoe-background">
    <div class="nexmoe-bg" style="background-image: url(/images/background/xiaomai.jpg)"></div>
    <div class="nexmoe-small" style="background-image: url(/images/background/lihui.png)"></div>
    <div class="mdui-appbar mdui-shadow-0">
      <div class="mdui-toolbar">
        <a mdui-drawer="{target: '#drawer', swipe: true}" title="menu" class="mdui-btn mdui-btn-icon mdui-ripple"><i class="mdui-icon nexmoefont icon-menu"></i></a>
        <div class="mdui-toolbar-spacer"></div>
        <!--<a href="javascript:;" class="mdui-btn mdui-btn-icon"><i class="mdui-icon material-icons">search</i></a>-->
        <a href="/" title="John Doe" class="mdui-btn mdui-btn-icon"><img src="/images/head/head.jpg" alt="John Doe"></a>
       </div>
    </div>
  </div>
  <div id="nexmoe-header">
      <div class="nexmoe-drawer mdui-drawer" id="drawer">
    <div class="nexmoe-avatar mdui-ripple">
        <a href="/" title="John Doe">
            <img src="/images/head/head.jpg" alt="John Doe" alt="John Doe">
        </a>
    </div>
    <div class="nexmoe-count">
        <div class="nexmoe-count-item"><span>文章</span>26 <div class="item-radius"></div><div class="item-radius item-right"></div> </div>
        <div class="nexmoe-count-item"><span>标签</span>20<div class="item-radius"></div><div class="item-radius item-right"></div></div>
        <div class="nexmoe-count-item"><span>分类</span>7<div class="item-radius"></div><div class="item-radius item-right"></div></div>
    </div>
    <div class="nexmoe-list mdui-list" mdui-collapse="{accordion: true}">
        
        <a class="nexmoe-list-item mdui-list-item mdui-ripple" href="/" title="回到首页">
            <i class="mdui-list-item-icon nexmoefont icon-meishi"></i>
            <div class="mdui-list-item-content">
                回到首页
            </div>
        </a>
        
        <a class="nexmoe-list-item mdui-list-item mdui-ripple" href="/archives.html" title="文章归档">
            <i class="mdui-list-item-icon nexmoefont icon-hanbao1"></i>
            <div class="mdui-list-item-content">
                文章归档
            </div>
        </a>
        
        <a class="nexmoe-list-item mdui-list-item mdui-ripple" href="/about/index.html" title="关于我">
            <i class="mdui-list-item-icon nexmoefont icon-jiubei1"></i>
            <div class="mdui-list-item-content">
                关于我
            </div>
        </a>
        
        <a class="nexmoe-list-item mdui-list-item mdui-ripple" href="/friend/index.html" title="我的朋友">
            <i class="mdui-list-item-icon nexmoefont icon-cola"></i>
            <div class="mdui-list-item-content">
                我的朋友
            </div>
        </a>
        
        <a class="nexmoe-list-item mdui-list-item mdui-ripple" href="/download/index.html" title="下载中心">
            <i class="mdui-list-item-icon nexmoefont icon-tangguo"></i>
            <div class="mdui-list-item-content">
                下载中心
            </div>
        </a>
        
    </div>
    <aside id="nexmoe-sidebar">
  
  
<!-- 站内搜索 -->

<div class="nexmoe-widget-wrap">
    <div class="nexmoe-widget nexmoe-search" >
        <form id="search-form">
            <label><input type="text" id="local-search-input" name="q" results="0" placeholder="站内搜索" class="input form-control" autocomplete="off" autocorrect="off"/></label>
            <!-- 清空/重置搜索框 -->
            <i class="fa fa-times" onclick="resetSearch()"></i>
        </form>
    </div>
    <div id="local-search-result"></div> <!-- 搜索结果区 -->
    <!-- <p class='no-result'></p> 无匹配时显示，注意在 CSS 中设置默认隐藏 -->
</div>


  
  <div class="nexmoe-widget-wrap">
    <div class="nexmoe-widget nexmoe-social">
        <a class="mdui-ripple" href="http://wpa.qq.com/msgrd?v=3&uin=1605643129&Site=%E5%8C%97%E4%BA%ACSEO&Menu=yes" target="_blank" mdui-tooltip="{content: 'QQ'}" style="color: rgb(64, 196, 255);background-color: rgba(64, 196, 255, .1);">
            <i class="nexmoefont icon-QQ"></i>
        </a><a class="mdui-ripple" href="mailto:1605643129@qq.com" target="_blank" mdui-tooltip="{content: 'mail'}" style="color: rgb(249,8,8);background-color: rgba(249,8,8,.1);">
            <i class="nexmoefont icon-mail-fill"></i>
        </a><a class="mdui-ripple" href="https://blog.csdn.net/qq_40855827?type=blog" target="_blank" mdui-tooltip="{content: 'CSDN'}" style="color: rgb(199,29,35);background-color: rgba(199,29,35,.1);">
            <i class="nexmoefont icon-csdn"></i>
        </a><a class="mdui-ripple" href="https://home.cnblogs.com/u/1882665" target="_blank" mdui-tooltip="{content: '博客园'}" style="color: rgb(66, 214, 29);background-color: rgba(66, 214, 29, .1);">
            <i class="nexmoefont icon-bokeyuan"></i>
        </a><a class="mdui-ripple" href="https://github.com/zhangboc" target="_blank" mdui-tooltip="{content: 'GitHub'}" style="color: rgb(25, 23, 23);background-color: rgba(25, 23, 23, .15);">
            <i class="nexmoefont icon-github"></i>
        </a><a class="mdui-ripple" href="https://gitee.com/with-the-wind-yue" target="_blank" mdui-tooltip="{content: 'gitee'}" style="color: rgb(255, 255, 255);background-color: rgb(199,29,35);">
            <i class="nexmoefont icon-mayun"></i>
        </a>
    </div>
</div>
  
  
  <div class="nexmoe-widget-wrap">
    <h3 class="nexmoe-widget-title">分类</h3>
    <div class="nexmoe-widget">

      <ul class="category-list">

        


        

        

        <li class="category-list-item">
          <a class="category-list-link" href="/categories/Ceph/">Ceph</a>
          <span class="category-list-count">19</span>
        </li>

        

        <li class="category-list-item">
          <a class="category-list-link" href="/categories/KVM/">KVM</a>
          <span class="category-list-count">7</span>
        </li>

        

        <li class="category-list-item">
          <a class="category-list-link" href="/categories/Ceph/Kubernetes/">Kubernetes</a>
          <span class="category-list-count">1</span>
        </li>

        

        <li class="category-list-item">
          <a class="category-list-link" href="/categories/Ceph/OpenStack/">OpenStack</a>
          <span class="category-list-count">2</span>
        </li>

        

        <li class="category-list-item">
          <a class="category-list-link" href="/categories/Ceph/SDK/">SDK</a>
          <span class="category-list-count">1</span>
        </li>

        

        <li class="category-list-item">
          <a class="category-list-link" href="/categories/hexo/">hexo</a>
          <span class="category-list-count">1</span>
        </li>

        
      </ul>

    </div>
  </div>


  
  
  <div class="nexmoe-widget-wrap">
    <div id="randomtagcloud" class="nexmoe-widget tagcloud nexmoe-rainbow">
      <a href="/tags/Ceph/" style="font-size: 20px;">Ceph</a> <a href="/tags/CephFS/" style="font-size: 10px;">CephFS</a> <a href="/tags/Ceph%E5%AE%88%E6%8A%A4%E8%BF%9B%E7%A8%8B/" style="font-size: 10px;">Ceph守护进程</a> <a href="/tags/Ceph%E7%AE%80%E4%BB%8B/" style="font-size: 10px;">Ceph简介</a> <a href="/tags/Cinder/" style="font-size: 10px;">Cinder</a> <a href="/tags/CrushMap/" style="font-size: 10px;">CrushMap</a> <a href="/tags/KVM/" style="font-size: 17.5px;">KVM</a> <a href="/tags/KVM%E8%99%9A%E6%8B%9F%E6%9C%BA%E8%BF%81%E7%A7%BB/" style="font-size: 10px;">KVM虚拟机迁移</a> <a href="/tags/KVM%E8%99%9A%E6%8B%9F%E7%BD%91%E7%BB%9C%E9%AB%98%E7%BA%A7%E9%85%8D%E7%BD%AE/" style="font-size: 10px;">KVM虚拟网络高级配置</a> <a href="/tags/Kubernetes/" style="font-size: 10px;">Kubernetes</a> <a href="/tags/Linux-HA/" style="font-size: 15px;">Linux HA</a> <a href="/tags/NFS/" style="font-size: 10px;">NFS</a> <a href="/tags/OSD/" style="font-size: 10px;">OSD</a> <a href="/tags/OpenStack/" style="font-size: 12.5px;">OpenStack</a> <a href="/tags/RBD/" style="font-size: 12.5px;">RBD</a> <a href="/tags/RGW/" style="font-size: 12.5px;">RGW</a> <a href="/tags/chatjs/" style="font-size: 10px;">chatjs</a> <a href="/tags/%E5%9F%BA%E4%BA%8EiSCSI%E7%9A%84KVM%E7%BE%A4%E9%9B%86%E6%9E%84%E5%BB%BA/" style="font-size: 10px;">基于iSCSI的KVM群集构建</a> <a href="/tags/%E6%95%85%E9%9A%9C%E6%8E%92%E6%9F%A5/" style="font-size: 10px;">故障排查</a> <a href="/tags/%E9%9B%86%E7%BE%A4%E6%B5%8B%E8%AF%95/" style="font-size: 10px;">集群测试</a>
    </div>
    
  </div>

  
  
  <div class="nexmoe-widget-wrap">
    <h3 class="nexmoe-widget-title">文章</h3>
    <div class="nexmoe-widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/">2023</a><span class="archive-list-count">26</span></li></ul>
    </div>
  </div>


<style>
.nexmoe-widget .archive-list-count{
	position : absolute;
	right: 15px;
	top:9px;
	color: #DDD;
}
</style>

  
</aside>
    <div class="nexmoe-copyright">
        &copy; 2023 John Doe
        Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
        & <a href="https://github.com/zhangboc/hexo.github.io/" target="_blank">ZhangboCheng</a><br/>
        <a href="http://beian.miit.gov.cn" target="_blank">辽ICP备2021002341号</a><br/>
        
        <div style="font-size: 12px">
            <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
            本站总访问量  <a id="busuanzi_value_site_pv"></a> 次<br />
            本站访客数<a id="busuanzi_value_site_uv"></a>人次
        </div>
        <span id="timeDate">载入天数...</span><span id="times">载入时分秒...</span>
        <script>
            var now = new Date(); 
            function createtime() { 
                var grt= new Date("08/10/2018 17:38:00");//在此处修改你的建站时间，格式：月/日/年 时:分:秒
                now.setTime(now.getTime()+250); 
                days = (now - grt ) / 1000 / 60 / 60 / 24; dnum = Math.floor(days); 
                hours = (now - grt ) / 1000 / 60 / 60 - (24 * dnum); hnum = Math.floor(hours); 
                if(String(hnum).length ==1 ){hnum = "0" + hnum;} minutes = (now - grt ) / 1000 /60 - (24 * 60 * dnum) - (60 * hnum); 
                mnum = Math.floor(minutes); if(String(mnum).length ==1 ){mnum = "0" + mnum;} 
                seconds = (now - grt ) / 1000 - (24 * 60 * 60 * dnum) - (60 * 60 * hnum) - (60 * mnum); 
                snum = Math.round(seconds); if(String(snum).length ==1 ){snum = "0" + snum;} 
                document.getElementById("timeDate").innerHTML = "本站已安全运行 "+dnum+" 天 "; 
                document.getElementById("times").innerHTML = hnum + " 小时 " + mnum + " 分 " + snum + " 秒"; 
    } 
setInterval("createtime()",250);
</script>


        
        
    </div>

</div><!-- .nexmoe-drawer -->

  </div>
  <div id="nexmoe-content">
    <div class="nexmoe-primary">
        <div class="nexmoe-post">
    
        <div class="nexmoe-post-cover" style="padding-bottom: 26.666666666666668%;">
            <img data-src="https://img1.baidu.com/it/u=413643897,2296924942&fm=253&fmt=auto&app=138&f=JPEG?w=800&h=500" data-sizes="auto" alt="KVM虚拟化进阶之基于iSCSI的KVM群集构建" class="lazyload">
            <h1>KVM虚拟化进阶之基于iSCSI的KVM群集构建</h1>
        </div>
    

        <div class="nexmoe-post-meta nexmoe-rainbow" style="margin:10px 0!important;">
    <a><i class="nexmoefont icon-calendar-fill"></i>2023年04月19日</a>
    <a><i class="nexmoefont icon-areachart"></i>6.5k 字</a>
    <a><i class="nexmoefont icon-time-circle-fill"></i>大概 39 分钟</a>
</div>

        <div class="nexmoe-post-right">
            
        </div>

        <article>
            <h1><span id></span></h1><span id="more"></span>

<!-- toc -->

<ul>
<li><a href="#1-%E8%A7%84%E5%88%92%E8%AE%BE%E8%AE%A1">1、规划设计</a></li>
<li><a href="#2-%E8%8A%82%E7%82%B9%E5%87%86%E5%A4%87">2、节点准备</a><ul>
<li><a href="#1-%E9%98%B6%E6%AE%B51%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E5%AE%89%E8%A3%85">1、阶段1：操作系统安装</a></li>
<li><a href="#2-%E9%98%B6%E6%AE%B52%E7%BE%A4%E9%9B%86%E7%BB%84%E4%BB%B6%E5%AE%89%E8%A3%85">2、阶段2：群集组件安装</a></li>
<li><a href="#3-%E9%98%B6%E6%AE%B53%E7%BE%A4%E9%9B%86%E8%8A%82%E7%82%B9%E5%AE%89%E8%A3%85">3、阶段3：群集节点安装</a></li>
</ul>
</li>
<li><a href="#3-%E9%85%8D%E7%BD%AEiscsi-target">3、配置iSCSI Target</a></li>
<li><a href="#4-%E9%85%8D%E7%BD%AEstonithdisk">4、配置STONITH（DISK）</a></li>
<li><a href="#5-%E9%85%8D%E7%BD%AEdlm">5、配置DLM</a></li>
<li><a href="#6-%E9%85%8D%E7%BD%AEclvm">6、配置CLVM</a></li>
<li><a href="#7-%E9%85%8D%E7%BD%AEgfs2">7、配置GFS2</a></li>
<li><a href="#8-%E5%90%91%E9%9B%86%E7%BE%A4%E4%B8%AD%E6%B7%BB%E5%8A%A0%E8%99%9A%E6%8B%9F%E6%9C%BA%E8%B5%84%E6%BA%90">8、向集群中添加虚拟机资源</a><ul>
<li><a href="#1-%E5%B0%86%E8%99%9A%E6%8B%9F%E6%9C%BA%E6%95%B0%E6%8D%AE%E8%BF%81%E7%A7%BB%E5%88%B0iscsi%E7%9A%84%E5%85%B1%E4%BA%AB%E7%9B%AE%E5%BD%95">1、将虚拟机数据迁移到iSCSI的共享目录</a></li>
<li><a href="#2-%E6%B5%8B%E8%AF%95%E5%8A%A8%E6%80%81%E8%BF%81%E7%A7%BB">2、测试动态迁移</a></li>
</ul>
</li>
</ul>
<!-- tocstop -->

<p>基于iSCSI的KVM群集构建</p>
<blockquote>
<p>群集节点约束：DLM &gt; CLVM &gt; File System &gt; Virtual Domain</p>
</blockquote>
<h1><span id="1-规划设计">1、规划设计</span></h1><table>
<thead>
<tr>
<th>主机名称</th>
<th>管理地址</th>
<th>心跳地址</th>
<th>存储地址</th>
</tr>
</thead>
<tbody><tr>
<td>node1</td>
<td>192.168.200.200</td>
<td>192.168.0.200</td>
<td>192.168.1.200</td>
</tr>
<tr>
<td>node2</td>
<td>192.168.200.201</td>
<td>192.168.0.201</td>
<td>192.168.1.201</td>
</tr>
<tr>
<td>stor1</td>
<td>192.168.200.202</td>
<td></td>
<td>192.168.1.202</td>
</tr>
</tbody></table>
<p><img src="/images/KVM/%E5%9F%BA%E4%BA%8EiSCSI%E7%9A%84KVM%E7%BE%A4%E9%9B%86%E6%9E%84%E5%BB%BA/80.jpg"></p>
<h1><span id="2-节点准备">2、节点准备</span></h1><h2><span id="1-阶段1操作系统安装">1、阶段1：操作系统安装</span></h2><p><img src="/images/KVM/%E5%9F%BA%E4%BA%8EiSCSI%E7%9A%84KVM%E7%BE%A4%E9%9B%86%E6%9E%84%E5%BB%BA/81.jpg"></p>
<h2><span id="2-阶段2群集组件安装">2、阶段2：群集组件安装</span></h2><p><img src="/images/KVM/%E5%9F%BA%E4%BA%8EiSCSI%E7%9A%84KVM%E7%BE%A4%E9%9B%86%E6%9E%84%E5%BB%BA/82.jpg"></p>
<h2><span id="3-阶段3群集节点安装">3、阶段3：群集节点安装</span></h2><p><img src="/images/KVM/%E5%9F%BA%E4%BA%8EiSCSI%E7%9A%84KVM%E7%BE%A4%E9%9B%86%E6%9E%84%E5%BB%BA/83.jpg"></p>
<blockquote>
<p>需要注意各个节点的防火墙配置！</p>
</blockquote>
<h1><span id="3-配置iscsi-target">3、配置iSCSI Target</span></h1><p><strong>在stor1服务器中安装targetcli</strong></p>
<pre><code>[root@stor1 ~]# yum install -y targetcli
[root@stor1 ~]# targetcli
Warning: Could not load preferences file /root/.targetcli/prefs.bin.
targetcli shell version 2.1.53
Copyright 2011-2013 by Datera, Inc and others.
For help on commands, type &#39;help&#39;.

/&gt; 
/&gt; 
/&gt; ls
o- / ......................................................................................................................... [...]
  o- backstores .............................................................................................................. [...]
  | o- block .................................................................................................. [Storage Objects: 0]
  | o- fileio ................................................................................................. [Storage Objects: 0]
  | o- pscsi .................................................................................................. [Storage Objects: 0]
  | o- ramdisk ................................................................................................ [Storage Objects: 0]
  o- iscsi ............................................................................................................ [Targets: 0]
  o- loopback ......................................................................................................... [Targets: 0]
/&gt; 
[root@stor1 ~]# firewall-cmd --add-service=iscsi-target --permanent
success
[root@stor1 ~]# firewall-cmd --reload
success
[root@stor1 ~]# fdisk -l 

Disk /dev/sdb: 42.9 GB, 42949672960 bytes, 83886080 sectors
Units = sectors of 1 * 512 = 512 bytes
Sector size (logical/physical): 512 bytes / 512 bytes
I/O size (minimum/optimal): 512 bytes / 512 bytes
[root@stor1 ~]# fdisk /dev/sdb 
Welcome to fdisk (util-linux 2.23.2).

Changes will remain in memory only, until you decide to write them.
Be careful before using the write command.

Device does not contain a recognized partition table
Building a new DOS disklabel with disk identifier 0x923327a1.

Command (m for help): p

Disk /dev/sdb: 42.9 GB, 42949672960 bytes, 83886080 sectors
Units = sectors of 1 * 512 = 512 bytes
Sector size (logical/physical): 512 bytes / 512 bytes
I/O size (minimum/optimal): 512 bytes / 512 bytes
Disk label type: dos
Disk identifier: 0x923327a1

   Device Boot      Start         End      Blocks   Id  System

Command (m for help): n
Partition type:
   p   primary (0 primary, 0 extended, 4 free)
   e   extended
Select (default p): p
Partition number (1-4, default 1): 
First sector (2048-83886079, default 2048): 
Using default value 2048
Last sector, +sectors or +size&#123;K,M,G&#125; (2048-83886079, default 83886079): 
Using default value 83886079
Partition 1 of type Linux and of size 40 GiB is set

Command (m for help): p

Disk /dev/sdb: 42.9 GB, 42949672960 bytes, 83886080 sectors
Units = sectors of 1 * 512 = 512 bytes
Sector size (logical/physical): 512 bytes / 512 bytes
I/O size (minimum/optimal): 512 bytes / 512 bytes
Disk label type: dos
Disk identifier: 0x923327a1

   Device Boot      Start         End      Blocks   Id  System
/dev/sdb1            2048    83886079    41942016   83  Linux

Command (m for help): t
Selected partition 1
Hex code (type L to list all codes): 8e
Changed type of partition &#39;Linux&#39; to &#39;Linux LVM&#39;

Command (m for help): p

Disk /dev/sdb: 42.9 GB, 42949672960 bytes, 83886080 sectors
Units = sectors of 1 * 512 = 512 bytes
Sector size (logical/physical): 512 bytes / 512 bytes
I/O size (minimum/optimal): 512 bytes / 512 bytes
Disk label type: dos
Disk identifier: 0x923327a1

   Device Boot      Start         End      Blocks   Id  System
/dev/sdb1            2048    83886079    41942016   8e  Linux LVM

Command (m for help): w
The partition table has been altered!

Calling ioctl() to re-read partition table.
Syncing disks.
[root@stor1 ~]# pvcreate /dev/sbd1
  Device /dev/sbd1 not found.
[root@stor1 ~]# pvcreate /dev/sdb1
  Physical volume &quot;/dev/sdb1&quot; successfully created.
[root@stor1 ~]# vgcreate stor1 /dev/sdb1
  Volume group &quot;stor1&quot; successfully created
[root@stor1 ~]# lvcreate -l 100%FREE -n lvstor1 stor1
  Logical volume &quot;lvstor1&quot; created.
[root@stor1 ~]# lvscan 
  ACTIVE            &#39;/dev/stor1/lvstor1&#39; [&lt;40.00 GiB] inherit
  ACTIVE            &#39;/dev/centos/swap&#39; [&lt;3.88 GiB] inherit
  ACTIVE            &#39;/dev/centos/root&#39; [&lt;35.12 GiB] inherit
[root@stor1 ~]# mkfs.xfs /dev/stor1/lvstor1 
meta-data=/dev/stor1/lvstor1     isize=512    agcount=4, agsize=2621184 blks
         =                       sectsz=512   attr=2, projid32bit=1
         =                       crc=1        finobt=0, sparse=0
data     =                       bsize=4096   blocks=10484736, imaxpct=25
         =                       sunit=0      swidth=0 blks
naming   =version 2              bsize=4096   ascii-ci=0 ftype=1
log      =internal log           bsize=4096   blocks=5119, version=2
         =                       sectsz=512   sunit=0 blks, lazy-count=1
realtime =none                   extsz=4096   blocks=0, rtextents=0
[root@stor1 ~]# mkdir /stor1
[root@stor1 ~]# mount /dev/stor1/lvstor1 /stor1/
[root@stor1 ~]# targetcli
targetcli shell version 2.1.53
Copyright 2011-2013 by Datera, Inc and others.
For help on commands, type &#39;help&#39;.

/&gt; ls
o- / ......................................................................................................................... [...]
  o- backstores .............................................................................................................. [...]
  | o- block .................................................................................................. [Storage Objects: 0]
  | o- fileio ................................................................................................. [Storage Objects: 0]
  | o- pscsi .................................................................................................. [Storage Objects: 0]
  | o- ramdisk ................................................................................................ [Storage Objects: 0]
  o- iscsi ............................................................................................................ [Targets: 0]
  o- loopback ......................................................................................................... [Targets: 0]
/&gt; 
/&gt; cd backstores/fileio
/backstores/fileio&gt; create disk01 /stor1/disk01.img 1G
Created fileio disk01 with size 1073741824
/backstores/fileio&gt; ls
o- fileio ..................................................................................................... [Storage Objects: 1]
  o- disk01 .................................................................... [/stor1/disk01.img (1.0GiB) write-back deactivated]
    o- alua ....................................................................................................... [ALUA Groups: 1]
      o- default_tg_pt_gp ........................................................................... [ALUA state: Active/optimized]
/backstores/fileio&gt; create disk02 /stor1/disk02.img 20G
Created fileio disk02 with size 21474836480
/backstores/fileio&gt; ls
o- fileio ..................................................................................................... [Storage Objects: 2]
  o- disk01 .................................................................... [/stor1/disk01.img (1.0GiB) write-back deactivated]
  | o- alua ....................................................................................................... [ALUA Groups: 1]
  |   o- default_tg_pt_gp ........................................................................... [ALUA state: Active/optimized]
  o- disk02 ................................................................... [/stor1/disk02.img (20.0GiB) write-back deactivated]
    o- alua ....................................................................................................... [ALUA Groups: 1]
      o- default_tg_pt_gp ........................................................................... [ALUA state: Active/optimized]
/iscsi&gt; cd /iscsi/
/iscsi&gt; create iqn.2016-10.org.linuxplus.srv:target00
Created target iqn.2016-10.org.linuxplus.srv:target00.
Created TPG 1.
Global pref auto_add_default_portal=true
Created default portal listening on all IPs (0.0.0.0), port 3260.
/iscsi&gt; cd iqn.2016-10.org.linuxplus.srv:target00/tpg1/luns
/iscsi/iqn.20...t00/tpg1/luns&gt;  create /backstores/fileio/disk0
/backstores/fileio/disk01  /backstores/fileio/disk02  
/iscsi/iqn.20...t00/tpg1/luns&gt;  create /backstores/fileio/disk01
Created LUN 0.
/iscsi/iqn.20...t00/tpg1/luns&gt;  create /backstores/fileio/disk02
Created LUN 1.
/iscsi/iqn.20...t00/tpg1/luns&gt; ls
o- luns .................................................................................................................. [LUNs: 2]
  o- lun0 ................................................................... [fileio/disk01 (/stor1/disk01.img) (default_tg_pt_gp)]
  o- lun1 ................................................................... [fileio/disk02 (/stor1/disk02.img) (default_tg_pt_gp)]
/iscsi/iqn.20...t00/tpg1/luns&gt; cd ../acls 
[root@node1 ~]# yum install icssi-initiarot-utils #在node1和node2节点执行

#在node1执行
[root@node1 ~]# cat /etc/iscsi/initiatorname.iscsi 
InitiatorName=iqn.1994-05.com.redhat:50adb21c54
[root@node1 ~]# vim /etc/iscsi/initiatorname.iscsi 
[root@node1 ~]# cat /etc/iscsi/initiatorname.iscsi 
InitiatorName=iqn.1994-05.com.redhat:node1

#在node2执行
[root@node2 ~]# cat /etc/iscsi/initiatorname.iscsi 
InitiatorName=iqn.1994-05.com.redhat:6b7ee6fb2748
[root@node2 ~]# vim /etc/iscsi/initiatorname.iscsi 
[root@node2 ~]# cat /etc/iscsi/initiatorname.iscsi
InitiatorName=iqn.1994-05.com.redhat:node2

回到stor1服务器中执行：
/iscsi/iqn.20...t00/tpg1/acls&gt; create iqn.1994-05.com.redhat:node1
Created Node ACL for iqn.1994-05.com.redhat:node1
Created mapped LUN 1.
Created mapped LUN 0.
/iscsi/iqn.20...t00/tpg1/acls&gt; create iqn.1994-05.com.redhat:node2
Created Node ACL for iqn.1994-05.com.redhat:node2
Created mapped LUN 1.
Created mapped LUN 0.
/iscsi/iqn.20...t00/tpg1/acls&gt; ls /
o- / ......................................................................................................................... [...]
  o- backstores .............................................................................................................. [...]
  | o- block .................................................................................................. [Storage Objects: 0]
  | o- fileio ................................................................................................. [Storage Objects: 2]
  | | o- disk01 .................................................................. [/stor1/disk01.img (1.0GiB) write-back activated]
  | | | o- alua ................................................................................................... [ALUA Groups: 1]
  | | |   o- default_tg_pt_gp ....................................................................... [ALUA state: Active/optimized]
  | | o- disk02 ................................................................. [/stor1/disk02.img (20.0GiB) write-back activated]
  | |   o- alua ................................................................................................... [ALUA Groups: 1]
  | |     o- default_tg_pt_gp ....................................................................... [ALUA state: Active/optimized]
  | o- pscsi .................................................................................................. [Storage Objects: 0]
  | o- ramdisk ................................................................................................ [Storage Objects: 0]
  o- iscsi ............................................................................................................ [Targets: 1]
  | o- iqn.2016-10.org.linuxplus.srv:target00 ............................................................................ [TPGs: 1]
  |   o- tpg1 ............................................................................................... [no-gen-acls, no-auth]
  |     o- acls .......................................................................................................... [ACLs: 2]
  |     | o- iqn.1994-05.com.redhat:node1 ......................................................................... [Mapped LUNs: 2]
  |     | | o- mapped_lun0 ............................................................................... [lun0 fileio/disk01 (rw)]
  |     | | o- mapped_lun1 ............................................................................... [lun1 fileio/disk02 (rw)]
  |     | o- iqn.1994-05.com.redhat:node2 ......................................................................... [Mapped LUNs: 2]
  |     |   o- mapped_lun0 ............................................................................... [lun0 fileio/disk01 (rw)]
  |     |   o- mapped_lun1 ............................................................................... [lun1 fileio/disk02 (rw)]
  |     o- luns .......................................................................................................... [LUNs: 2]
  |     | o- lun0 ........................................................... [fileio/disk01 (/stor1/disk01.img) (default_tg_pt_gp)]
  |     | o- lun1 ........................................................... [fileio/disk02 (/stor1/disk02.img) (default_tg_pt_gp)]
  |     o- portals .................................................................................................... [Portals: 1]
  |       o- 0.0.0.0:3260 ..................................................................................................... [OK]
  o- loopback ......................................................................................................... [Targets: 0]

node1执行：
[root@node1 ~]# iscsiadm --mode discovery --type sendtargets --portal 192.168.1.202 #扫描后端存储
192.168.1.202:3260,1 iqn.2016-10.org.linuxplus.srv:target00
[root@node1 ~]# iscsiadm -m node --login d 2 
Logging in to [iface: default, target: iqn.2016-10.org.linuxplus.srv:target00, portal: 192.168.1.202,3260] (multiple)
Login to [iface: default, target: iqn.2016-10.org.linuxplus.srv:target00, portal: 192.168.1.202,3260] successful.
[root@node1 ~]# fdisk -l |grep sd
Disk /dev/sda: 42.9 GB, 42949672960 bytes, 83886080 sectors
/dev/sda1   *        2048     2099199     1048576   83  Linux
/dev/sda2         2099200    83886079    40893440   8e  Linux LVM
Disk /dev/sdb: 1073 MB, 1073741824 bytes, 2097152 sectors
Disk /dev/sdc: 21.5 GB, 21474836480 bytes, 41943040 sectors

node2执行：
[root@node2 ~]#  iscsiadm --mode discovery --type sendtargets --portal 192.168.1.202
192.168.1.202:3260,1 iqn.2016-10.org.linuxplus.srv:target00
[root@node2 ~]# iscsiadm -m node --login d 2 
Logging in to [iface: default, target: iqn.2016-10.org.linuxplus.srv:target00, portal: 192.168.1.202,3260] (multiple)
Login to [iface: default, target: iqn.2016-10.org.linuxplus.srv:target00, portal: 192.168.1.202,3260] successful.
[root@node2 ~]# fdisk -l | grep sd
Disk /dev/sda: 42.9 GB, 42949672960 bytes, 83886080 sectors
/dev/sda1   *        2048     2099199     1048576   83  Linux
/dev/sda2         2099200    83886079    40893440   8e  Linux LVM
Disk /dev/sdb: 1073 MB, 1073741824 bytes, 2097152 sectors
Disk /dev/sdc: 21.5 GB, 21474836480 bytes, 41943040 sectors
</code></pre>
<h1><span id="4-配置stonithdisk">4、配置STONITH（DISK）</span></h1><p><img src="/images/KVM/%E5%9F%BA%E4%BA%8EiSCSI%E7%9A%84KVM%E7%BE%A4%E9%9B%86%E6%9E%84%E5%BB%BA/93.jpg"></p>
<p>node1执行：</p>
<pre><code>[root@node1 ~]# pcs stonith describe fence_scsi
fence_scsi - Fence agent for SCSI persistent reservation

fence_scsi is an I/O fencing agent that uses SCSI-3 persistent reservations to control access to shared storage devices. These devices must support SCSI-3 persistent reservations (SPC-3 or greater) as well as the &quot;preempt-and-abort&quot; subcommand.
The fence_scsi agent works by having each node in the cluster register a unique key with the SCSI device(s). Once registered, a single node will become the reservation holder by creating a &quot;write exclusive, registrants only&quot; reservation on the device(s). The result is that only registered nodes may write to the device(s). When a node failure occurs, the fence_scsi agent will remove the key belonging to the failed node from the device(s). The failed node will no longer be able to write to the device(s). A manual reboot is required.

When used as a watchdog device you can define e.g. retry=1, retry-sleep=2 and verbose=yes parameters in /etc/sysconfigtonith if you have issues with it failing.

Stonith options:
  aptpl: Use the APTPL flag for registrations. This option is only used for the &#39;on&#39; action.
  devices: List of devices to use for current operation. Devices can be comma-separated list of raw devices (eg. /dev/sdc). Each device must
           support SCSI-3 persistent reservations.
  key: Key to use for the current operation. This key should be unique to a node. For the &quot;on&quot; action, the key specifies the key use to
       register the local node. For the &quot;off&quot; action, this key specifies the key to be removed from the device(s).
  port: Name of the node to be fenced. The node name is used to generate the key value used for the current operation. This option will be
        ignored when used with the -k option.
  logfile: Log output (stdout and stderr) to file
  quiet: Disable logging to stderr. Does not affect --verbose or --debug-file or logging to syslog.
  verbose: Verbose mode
  debug: Write debug information to given file
  delay: Wait X seconds before fencing is started
  login_timeout: Wait X seconds for cmd prompt after login
  power_timeout: Test X seconds for status change after ON/OFF
  power_wait: Wait X seconds after issuing ON/OFF
  shell_timeout: Wait X seconds for cmd prompt after issuing command
  retry_on: Count of attempts to retry power on
  corosync_cmap_path: Path to corosync-cmapctl binary
  sg_persist_path: Path to sg_persist binary
  sg_turs_path: Path to sg_turs binary
  vgs_path: Path to vgs binary
  pcmk_host_map: A mapping of host names to ports numbers for devices that do not support host names. Eg. node1:1;node2:2,3 would tell the
                 cluster to use port 1 for node1 and ports 2 and 3 for node2
  pcmk_host_list: A list of machines controlled by this device (Optional unless pcmk_host_check=static-list).
  pcmk_host_check: How to determine which machines are controlled by the device. Allowed values: dynamic-list (query the device via the
                   &#39;list&#39; command), static-list (check the pcmk_host_list attribute), status (query the device via the &#39;status&#39; command),
                   none (assume every device can fence every machine)
  pcmk_delay_max: Enable a random delay for stonith actions and specify the maximum of random delay. This prevents double fencing when using
                  slow devices such as sbd. Use this to enable a random delay for stonith actions. The overall delay is derived from this
                  random delay value adding a static delay so that the sum is kept below the maximum delay.
  pcmk_delay_base: Enable a base delay for stonith actions and specify base delay value. This prevents double fencing when different delays
                   are configured on the nodes. Use this to enable a static delay for stonith actions. The overall delay is derived from a
                   random delay value adding this static delay so that the sum is kept below the maximum delay.
  pcmk_action_limit: The maximum number of actions can be performed in parallel on this device Pengine property concurrent-fencing=true needs
                     to be configured first. Then use this to specify the maximum number of actions can be performed in parallel on this
                     device. -1 is unlimited.

Default operations:
  monitor: interval=60s
[root@node1 ~]# ll /dev/disk/by-id/|grep sdb
lrwxrwxrwx. 1 root root  9 Apr 15 19:36 scsi-36001405ac1f6f3fd0704cfab66c86851 -&gt; ../../sdb
lrwxrwxrwx. 1 root root  9 Apr 15 19:36 wwn-0x6001405ac1f6f3fd0704cfab66c86851 -&gt; ../../sdb

[root@node1 ~]# pcs stonith create scsi-shooter fence_scsi \
pcmk_host_list=&quot;node1-heartbeat node2-heartbeat&quot; \
devices=&quot;/dev/disk/by-id/wwn-0x6001405ac1f6f3fd0704cfab66c86851&quot; \
meta provides=unfencing

[root@node1 ~]# pcs status 
Cluster name: cluster1
Stack: corosync
Current DC: node1-heartbeat (version 1.1.23-1.el7_9.1-9acf116022) - partition with quorum
Last updated: Sat Apr 15 20:48:15 2023
Last change: Sat Apr 15 20:46:56 2023 by root via cibadmin on node1-heartbeat

2 nodes configured
1 resource instance configured

Online: [ node1-heartbeat node2-heartbeat ]

Full list of resources:

 scsi-shooter   (stonith:fence_scsi):   Started node1-heartbeat

Daemon Status:
  corosync: active/disabled
  pacemaker: active/disabled
  pcsd: active/enabled
</code></pre>
<h1><span id="5-配置dlm">5、配置DLM</span></h1><p><img src="/images/KVM/%E5%9F%BA%E4%BA%8EiSCSI%E7%9A%84KVM%E7%BE%A4%E9%9B%86%E6%9E%84%E5%BB%BA/94.jpg"></p>
<p>node1:</p>
<pre><code>[root@node1 ~]# yum install -y gfs2-utils dlm
[root@node1 ~]# rpm -qi gfs2-utils
Name        : gfs2-utils
Version     : 3.1.10
Release     : 11.el7_9.1
Architecture: x86_64
Install Date: Sat 15 Apr 2023 08:52:22 PM CST
Group       : System Environment/Kernel
Size        : 1006104
License     : GPLv2+ and LGPLv2+
Signature   : RSA/SHA256, Wed 18 Nov 2020 10:17:32 PM CST, Key ID 24c6a8a7f4a80eb5
Source RPM  : gfs2-utils-3.1.10-11.el7_9.1.src.rpm
Build Date  : Tue 17 Nov 2020 12:16:58 AM CST
Build Host  : x86-01.bsys.centos.org
Relocations : (not relocatable)
Packager    : CentOS BuildSystem &lt;http://bugs.centos.org&gt;
Vendor      : CentOS
URL         : https://pagure.io/gfs2-utils
Summary     : Utilities for managing the global file system (GFS2)
Description :
The gfs2-utils package contains a number of utilities for creating,
checking, modifying, and correcting any inconsistencies in GFS2
file systems.
[root@node1 ~]# rpm -qi dlm
Name        : dlm
Version     : 4.0.7
Release     : 1.el7
Architecture: x86_64
Install Date: Sat 15 Apr 2023 08:52:22 PM CST
Group       : System Environment/Kernel
Size        : 176589
License     : GPLv2 and GPLv2+ and LGPLv2+
Signature   : RSA/SHA256, Thu 10 Aug 2017 11:37:37 PM CST, Key ID 24c6a8a7f4a80eb5
Source RPM  : dlm-4.0.7-1.el7.src.rpm
Build Date  : Fri 04 Aug 2017 01:33:37 AM CST
Build Host  : c1bm.rdu2.centos.org
Relocations : (not relocatable)
Packager    : CentOS BuildSystem &lt;http://bugs.centos.org&gt;
Vendor      : CentOS
URL         : https://fedorahosted.org/cluster
Summary     : dlm control daemon and tool
Description :
The kernel dlm requires a user daemon to control membership.
</code></pre>
<p>node2:</p>
<pre><code>[root@node2 ~]# yum install -y gfs2-utils dlm
</code></pre>
<p><img src="/images/KVM/%E5%9F%BA%E4%BA%8EiSCSI%E7%9A%84KVM%E7%BE%A4%E9%9B%86%E6%9E%84%E5%BB%BA/95.jpg"></p>
<blockquote>
<p>clone-max&#x3D;2是指最多两个dlm，clone-host-max&#x3D;1 是指每个节点最多启动一个dlm</p>
</blockquote>
<p>node1:</p>
<pre><code>[root@node1 ~]# pcs resource create dlm ocf:pacemaker:controld \
op monitor interval=30s on-fail=fence \
clone interleave=true ordered=true
[root@node1 ~]# pcs status 
Cluster name: cluster1
Stack: corosync
Current DC: node1-heartbeat (version 1.1.23-1.el7_9.1-9acf116022) - partition with quorum
Last updated: Sat Apr 15 21:04:42 2023
Last change: Sat Apr 15 21:02:15 2023 by root via cibadmin on node1-heartbeat

2 nodes configured
3 resource instances configured

Online: [ node1-heartbeat node2-heartbeat ]

Full list of resources:

 scsi-shooter   (stonith:fence_scsi):   Started node1-heartbeat
 Clone Set: dlm-clone [dlm]
     Started: [ node1-heartbeat node2-heartbeat ]

Daemon Status:
  corosync: active/disabled
  pacemaker: active/disabled
  pcsd: active/enabled
</code></pre>
<h1><span id="6-配置clvm">6、配置CLVM</span></h1><p><img src="/images/KVM/%E5%9F%BA%E4%BA%8EiSCSI%E7%9A%84KVM%E7%BE%A4%E9%9B%86%E6%9E%84%E5%BB%BA/96.jpg"><br><img src="/images/KVM/%E5%9F%BA%E4%BA%8EiSCSI%E7%9A%84KVM%E7%BE%A4%E9%9B%86%E6%9E%84%E5%BB%BA/97.jpg"></p>
<p>node1:</p>
<pre><code>[root@node1 ~]# yum install -y lvm2-cluster.x86_64
[root@node1 ~]# cat /etc/lvm/lvm.conf |grep -v &quot;#&quot; | grep -v ^$ | grep -A 25 global
global &#123;
    umask = 077
    test = 0
    units = &quot;r&quot;
    si_unit_consistency = 1
    suffix = 1
    activation = 1
    proc = &quot;/proc&quot;
    etc = &quot;/etc&quot;
    locking_type = 1 
    wait_for_locks = 1
    fallback_to_clustered_locking = 1
    fallback_to_local_locking = 1
    locking_dir = &quot;/run/lock/lvm&quot;
    prioritise_write_locks = 1
    abort_on_internal_errors = 0
    metadata_read_only = 0
    mirror_segtype_default = &quot;raid1&quot;
    raid10_segtype_default = &quot;raid10&quot;
    sparse_segtype_default = &quot;thin&quot;
    use_lvmetad = 1
    use_lvmlockd = 0
    system_id_source = &quot;none&quot;
    use_lvmpolld = 1
    notify_dbus = 1
&#125;
[root@node1 ~]# whatis lvmconf
lvmconf (8)          - LVM configuration modifier
[root@node1 ~]# lvmconf --help 
Usage: /usr/sbin/lvmconf &lt;command&gt;

Commands:
Enable clvm:  --enable-cluster [--lockinglibdir &lt;dir&gt;] [--lockinglib &lt;lib&gt;]
Disable clvm: --disable-cluster
Enable halvm: --enable-halvm
Disable halvm: --disable-halvm
Set locking library: --lockinglibdir &lt;dir&gt; [--lockinglib &lt;lib&gt;]

Global options:
Config file location: --file &lt;configfile&gt;
Set services: --services [--mirrorservice] [--startstopservices]

Use the separate command &#39;lvmconfig&#39; to display configuration information
[root@node1 ~]# lvmconf --enable-cluster
global &#123;
    umask = 077
    test = 0
    units = &quot;r&quot;
    si_unit_consistency = 1
    suffix = 1
    activation = 1
    proc = &quot;/proc&quot;
    etc = &quot;/etc&quot;
    locking_type = 3 #通过上述命令，这个配置由1改成了3
    wait_for_locks = 1
    fallback_to_clustered_locking = 1
    fallback_to_local_locking = 1
    locking_dir = &quot;/run/lock/lvm&quot;
    prioritise_write_locks = 1
    abort_on_internal_errors = 0
    metadata_read_only = 0
    mirror_segtype_default = &quot;raid1&quot;
    raid10_segtype_default = &quot;raid10&quot;
    sparse_segtype_default = &quot;thin&quot;
    use_lvmetad = 0
    use_lvmlockd = 0
    system_id_source = &quot;none&quot;
    use_lvmpolld = 1
    notify_dbus = 1
&#125;
[root@node1 ~]# reboot
</code></pre>
<p>node2:</p>
<pre><code>[root@node2 ~]# yum install -y lvm2-cluster.x86_64
[root@node2 ~]# lvmconf --enable-cluster
[root@node2 ~]# reboot
[root@node1 ~]# pcs cluster start --all 
node1-heartbeat: Starting Cluster (corosync)...
node2-heartbeat: Starting Cluster (corosync)...
node2-heartbeat: Starting Cluster (pacemaker)...
node1-heartbeat: Starting Cluster (pacemaker)...
[root@node1 ~]# pcs status 
Cluster name: cluster1
Stack: corosync
Current DC: node2-heartbeat (version 1.1.23-1.el7_9.1-9acf116022) - partition with quorum
Last updated: Sat Apr 15 21:21:05 2023
Last change: Sat Apr 15 21:02:15 2023 by root via cibadmin on node1-heartbeat

2 nodes configured
3 resource instances configured

Online: [ node1-heartbeat node2-heartbeat ]

Full list of resources:

 scsi-shooter   (stonith:fence_scsi):   Stopped
 Clone Set: dlm-clone [dlm]
     Stopped: [ node1-heartbeat node2-heartbeat ]

Daemon Status:
  corosync: active/disabled
  pacemaker: active/disabled
  pcsd: active/enabled
</code></pre>
<p><img src="/images/KVM/%E5%9F%BA%E4%BA%8EiSCSI%E7%9A%84KVM%E7%BE%A4%E9%9B%86%E6%9E%84%E5%BB%BA/98.jpg"></p>
<p>node1:</p>
<pre><code>[root@node1 ~]# pcs resource describe clvm
Assumed agent name &#39;ocf:heartbeat:clvm&#39; (deduced from &#39;clvm&#39;)
ocf:heartbeat:clvm - clvmd

This agent manages the clvmd daemon.

Resource options:
  with_cmirrord: Start with cmirrord (cluster mirror log daemon).
  daemon_options: Options to clvmd. Refer to clvmd.8 for detailed descriptions.
  activate_vgs: Whether or not to activate all cluster volume groups after starting the clvmd or not. Note that clustered volume groups will always be
                deactivated before the clvmd stops regardless of what this option is set to.
  exclusive: If set, only exclusive volume groups will be monitored.

Default operations:
  start: interval=0s timeout=90s
  stop: interval=0s timeout=90s
  monitor: interval=30s timeout=90s
[root@node1 ~]# pcs resource create clvmd ocf:heartbeat:clvm op monitor interval=30s \
on-fail=fence clone interleave=true ordered=true
[root@node1 ~]# pcs status 
Cluster name: cluster1
Stack: corosync
Current DC: node2-heartbeat (version 1.1.23-1.el7_9.1-9acf116022) - partition with quorum
Last updated: Sat Apr 15 21:25:06 2023
Last change: Sat Apr 15 21:24:29 2023 by root via cibadmin on node1-heartbeat

2 nodes configured
5 resource instances configured

Online: [ node1-heartbeat node2-heartbeat ]

Full list of resources:

 scsi-shooter   (stonith:fence_scsi):   Started node1-heartbeat
 Clone Set: dlm-clone [dlm]
     Started: [ node1-heartbeat node2-heartbeat ]
 Clone Set: clvmd-clone [clvmd]
     Started: [ node1-heartbeat node2-heartbeat ]

Daemon Status:
  corosync: active/disabled
  pacemaker: active/disabled
  pcsd: active/enabled
[root@node1 ~]# systemctl status pacemaker.service 
● pacemaker.service - Pacemaker High Availability Cluster Manager
   Loaded: loaded (/usr/lib/systemd/system/pacemaker.service; disabled; vendor preset: disabled)
   Active: active (running) since Sat 2023-04-15 21:20:42 CST; 6min ago
     Docs: man:pacemakerd
           https://clusterlabs.org/pacemaker/doc/en-US/Pacemaker/1.1/html-single/Pacemaker_Explained/index.html
 Main PID: 2074 (pacemakerd)
   CGroup: /system.slice/pacemaker.service
           ├─2074 /usr/sbin/pacemakerd -f
           ├─2075 /usr/libexec/pacemaker/cib
           ├─2076 /usr/libexec/pacemaker/stonithd
           ├─2077 /usr/libexec/pacemaker/lrmd
           ├─2078 /usr/libexec/pacemaker/attrd
           ├─2079 /usr/libexec/pacemaker/pengine
           ├─2080 /usr/libexec/pacemaker/crmd
           ├─2231 dlm_controld -s 0
           └─2563 /usr/sbin/clvmd -T90 -d0 #可以看到多了clvmd的线程，依赖于dlm

Apr 15 21:21:05 node1 stonith-ng[2076]:   notice: Operation &#39;on&#39; targeting node1-heartbeat on node1-heartbeat for crmd.2056@node2-heartbeat.f507774c: OK
Apr 15 21:21:05 node1 crmd[2080]:   notice: node1-heartbeat was successfully unfenced by node1-heartbeat (at the request of node2-heartbeat)
Apr 15 21:21:06 node1 crmd[2080]:   notice: Result of probe operation for scsi-shooter on node1-heartbeat: 7 (not running)
Apr 15 21:21:06 node1 crmd[2080]:   notice: Result of probe operation for dlm on node1-heartbeat: 7 (not running)
Apr 15 21:21:06 node1 crmd[2080]:   notice: Result of start operation for scsi-shooter on node1-heartbeat: 0 (ok)
Apr 15 21:21:07 node1 dlm_controld[2231]: 150 dlm_controld 4.0.7 started
Apr 15 21:21:08 node1 crmd[2080]:   notice: Result of start operation for dlm on node1-heartbeat: 0 (ok)
Apr 15 21:24:29 node1 crmd[2080]:   notice: Result of probe operation for clvmd on node1-heartbeat: 7 (not running)
Apr 15 21:24:32 node1 clvmd[2563]: Cluster LVM daemon started - connected to Corosync
Apr 15 21:24:33 node1 crmd[2080]:   notice: Result of start operation for clvmd on node1-heartbeat: 0 (ok)
</code></pre>
<p>配置约束：Clmvd必须在dlm启动后启动，而且必须在同一节点运行</p>
<pre><code>[root@node1 ~]#  pcs constraint order start dlm-clone then clvmd-clone  #次序约束，先启动dlm，然后在启动clvmd
Adding dlm-clone clvmd-clone (kind: Mandatory) (Options: first-action=start then-action=start)
[root@node1 ~]# pcs constraint colocation add clvmd-clone with dlm-clone #位置约束，dlm和clvmd要同时在一个节点上运行
[root@node1 ~]#   pcs constraint  #查看约束
Location Constraints:
Ordering Constraints:
  start dlm-clone then start clvmd-clone (kind:Mandatory)
Colocation Constraints:
  clvmd-clone with dlm-clone (score:INFINITY)
Ticket Constraints:
</code></pre>
<p>创建lv</p>
<p><img src="/images/KVM/%E5%9F%BA%E4%BA%8EiSCSI%E7%9A%84KVM%E7%BE%A4%E9%9B%86%E6%9E%84%E5%BB%BA/99.jpg"></p>
<p>node1:</p>
<pre><code>[root@node1 ~]# fdisk -l | grep sdc
Disk /dev/sdc: 21.5 GB, 21474836480 bytes, 41943040 sectors
[root@node1 ~]# fdisk /dev/sdc
Welcome to fdisk (util-linux 2.23.2).

Changes will remain in memory only, until you decide to write them.
Be careful before using the write command.

Device does not contain a recognized partition table
Building a new DOS disklabel with disk identifier 0x760ad300.

Command (m for help): p

Disk /dev/sdc: 21.5 GB, 21474836480 bytes, 41943040 sectors
Units = sectors of 1 * 512 = 512 bytes
Sector size (logical/physical): 512 bytes / 512 bytes
I/O size (minimum/optimal): 512 bytes / 4194304 bytes
Disk label type: dos
Disk identifier: 0x760ad300

   Device Boot      Start         End      Blocks   Id  System

Command (m for help): n
Partition type:
   p   primary (0 primary, 0 extended, 4 free)
   e   extended
Select (default p): p
Partition number (1-4, default 1): 
First sector (8192-41943039, default 8192): 
Using default value 8192
Last sector, +sectors or +size&#123;K,M,G&#125; (8192-41943039, default 41943039): 
Using default value 41943039
Partition 1 of type Linux and of size 20 GiB is set

Command (m for help): p

Disk /dev/sdc: 21.5 GB, 21474836480 bytes, 41943040 sectors
Units = sectors of 1 * 512 = 512 bytes
Sector size (logical/physical): 512 bytes / 512 bytes
I/O size (minimum/optimal): 512 bytes / 4194304 bytes
Disk label type: dos
Disk identifier: 0x760ad300

   Device Boot      Start         End      Blocks   Id  System
/dev/sdc1            8192    41943039    20967424   83  Linux

Command (m for help): t
Selected partition 1
Hex code (type L to list all codes): 8e
Changed type of partition &#39;Linux&#39; to &#39;Linux LVM&#39;

Command (m for help): p

Disk /dev/sdc: 21.5 GB, 21474836480 bytes, 41943040 sectors
Units = sectors of 1 * 512 = 512 bytes
Sector size (logical/physical): 512 bytes / 512 bytes
I/O size (minimum/optimal): 512 bytes / 4194304 bytes
Disk label type: dos
Disk identifier: 0x760ad300

   Device Boot      Start         End      Blocks   Id  System
/dev/sdc1            8192    41943039    20967424   8e  Linux LVM

Command (m for help): w
The partition table has been altered!

Calling ioctl() to re-read partition table.
Syncing disks.
[root@node1 ~]# vgscan 
  Reading all physical volumes.  This may take a while...
  Found volume group &quot;centos&quot; using metadata type lvm2
  [root@node1 ~]# vgcreate vmvg0 /dev/sdc1
  Physical volume &quot;/dev/sdc1&quot; successfully created.
  Clustered volume group &quot;vmvg0&quot; successfully created
[root@node1 ~]# vgdisplay vmvg0
  --- Volume group ---
  VG Name               vmvg0
  System ID             
  Format                lvm2
  Metadata Areas        1
  Metadata Sequence No  1
  VG Access             read/write
  VG Status             resizable
  Clustered             yes #这是一个集群的lvm
  Shared                no
  MAX LV                0
  Cur LV                0
  Open LV               0
  Max PV                0
  Cur PV                1
  Act PV                1
  VG Size               19.99 GiB
  PE Size               4.00 MiB
  Total PE              5118
  Alloc PE / Size       0 / 0   
  Free  PE / Size       5118 / 19.99 GiB
  VG UUID               mbCxgE-6pfx-HKLT-5f4Z-vcRm-TKSo-3dEnNp
[root@node1 ~]# vgs #Attr下的wz--nc中的c表示这是一个集群的
  VG     #PV #LV #SN Attr   VSize   VFree 
  centos   1   2   0 wz--n- &lt;39.00g  4.00m
  vmvg0    1   0   0 wz--nc  19.99g 19.99g
[root@node1 ~]#  lvcreate -n  lvvm0 -l 100%FREE vmvg0  #创建lv
  Logical volume &quot;lvvm0&quot; created.
[root@node1 ~]# lvscan 
  ACTIVE            &#39;/dev/vmvg0/lvvm0&#39; [19.99 GiB] inherit
  ACTIVE            &#39;/dev/centos/swap&#39; [&lt;3.88 GiB] inherit
  ACTIVE            &#39;/dev/centos/root&#39; [&lt;35.12 GiB] inherit
</code></pre>
<p>node2:</p>
<pre><code>[root@node2 ~]# partprobe 
Warning: Unable to open /dev/sr0 read-write (Read-only file system).  /dev/sr0 has been opened read-only.
[root@node2 ~]# multipath -r
Apr 15 21:39:08 | DM multipath kernel driver not loaded
Apr 15 21:39:08 | /etc/multipath.conf does not exist, blacklisting all devices.
Apr 15 21:39:08 | A default multipath.conf file is located at
Apr 15 21:39:08 | /usr/share/doc/device-mapper-multipath-0.4.9/multipath.conf
Apr 15 21:39:08 | You can run /sbin/mpathconf --enable to create
Apr 15 21:39:08 | /etc/multipath.conf. See man mpathconf(8) for more details
Apr 15 21:39:08 | DM multipath kernel driver not loaded
[root@node2 ~]# fdisk -l | grep sdc
Disk /dev/sdc: 21.5 GB, 21474836480 bytes, 41943040 sectors
/dev/sdc1            8192    41943039    20967424   8e  Linux LVM
[root@node2 ~]# lvscan  #可以看到/dev/vmvg0/lvvm0
  ACTIVE            &#39;/dev/vmvg0/lvvm0&#39; [19.99 GiB] inherit
  ACTIVE            &#39;/dev/centos/swap&#39; [&lt;3.88 GiB] inherit
  ACTIVE            &#39;/dev/centos/root&#39; [&lt;35.12 GiB] inherit
</code></pre>
<h1><span id="7-配置gfs2">7、配置GFS2</span></h1><p><img src="/images/KVM/%E5%9F%BA%E4%BA%8EiSCSI%E7%9A%84KVM%E7%BE%A4%E9%9B%86%E6%9E%84%E5%BB%BA/100.jpg"><br><img src="/images/KVM/%E5%9F%BA%E4%BA%8EiSCSI%E7%9A%84KVM%E7%BE%A4%E9%9B%86%E6%9E%84%E5%BB%BA/101.jpg"></p>
<pre><code>[root@node1 ~]# lvscan 
  ACTIVE            &#39;/dev/vmvg0/lvvm0&#39; [19.99 GiB] inherit
  ACTIVE            &#39;/dev/centos/swap&#39; [&lt;3.88 GiB] inherit
  ACTIVE            &#39;/dev/centos/root&#39; [&lt;35.12 GiB] inherit
[root@node1 ~]# mkfs.gfs2 -p lock_dlm -j 2 -t cluster1:node1 /dev/vmvg0/lvvm0
-p=锁定的协议
-j=保存两个文件系统的日志，因为现在是双节点
-t=dlm里面使用的表
cluster1:node1=前面是集群的名称，后面是自定义名称

/dev/vmvg0/lvvm0 is a symbolic link to /dev/dm-2
This will destroy any data on /dev/dm-2
Are you sure you want to proceed? [y/n] y
Discarding device contents (may take a while on large devices): Done
Adding journals: Done 
Building resource groups: Done   
Creating quota file: Done
Writing superblock and syncing: Done
Device:                    /dev/vmvg0/lvvm0
Block size:                4096
Device size:               19.99 GB (5240832 blocks)
Filesystem size:           19.99 GB (5240829 blocks)
Journals:                  2
Journal size:              64MB
Resource groups:           82
Locking protocol:          &quot;lock_dlm&quot;
Lock table:                &quot;cluster1:node1&quot;
UUID:                      4a42f87d-29ff-44c5-af0b-1d1576d7df46

[root@node1 ~]# pcs resource create VMFS Filesystem \ #VMFS资源的名称
device=&quot;/dev/vmvg0/lvvm0&quot; \ #存储路径
directory=&quot;/vm&quot; \ #挂载点 
fstype=&quot;gfs2&quot; \ #文件格式类型
clone #克隆
Assumed agent name &#39;ocf:heartbeat:Filesystem&#39; (deduced from &#39;Filesystem&#39;)
[root@node1 vm]# df -HT
Filesystem              Type      Size  Used Avail Use% Mounted on
devtmpfs                devtmpfs  2.0G     0  2.0G   0% /dev
tmpfs                   tmpfs     2.0G   63M  2.0G   4% /dev/shm
tmpfs                   tmpfs     2.0G   13M  2.0G   1% /run
tmpfs                   tmpfs     2.0G     0  2.0G   0% /sys/fs/cgroup
/dev/mapper/centos-root xfs        38G  4.3G   34G  12% /
/dev/sda1               xfs       1.1G  206M  858M  20% /boot
tmpfs                   tmpfs     396M     0  396M   0% /run/user/0
/dev/mapper/vmvg0-lvvm0 gfs2       22G  137M   22G   1% /vm #已经挂载上了
</code></pre>
<p><strong>测试</strong></p>
<p>node1:</p>
<pre><code>[root@node1 ~]# df -HT 
Filesystem              Type      Size  Used Avail Use% Mounted on
devtmpfs                devtmpfs  2.0G     0  2.0G   0% /dev
tmpfs                   tmpfs     2.0G   63M  2.0G   4% /dev/shm
tmpfs                   tmpfs     2.0G   13M  2.0G   1% /run
tmpfs                   tmpfs     2.0G     0  2.0G   0% /sys/fs/cgroup
/dev/mapper/centos-root xfs        38G  4.3G   34G  12% /
/dev/sda1               xfs       1.1G  206M  858M  20% /boot
tmpfs                   tmpfs     396M     0  396M   0% /run/user/0
/dev/mapper/vmvg0-lvvm0 gfs2       22G  137M   22G   1% /vm
[root@node1 ~]# cd /vm
[root@node1 vm]# touch test.txt
[root@node1 vm]# echo test &gt; test.txt 
[root@node1 vm]# ls -l
total 8
-rw-r--r--. 1 root root 5 Apr 16 20:57 test.txt
</code></pre>
<p>node2:</p>
<pre><code>[root@node2 ~]# cd /vm
[root@node2 vm]# ls
test.txt
[root@node2 vm]# cat test.txt 
test
[root@node2 vm]# cp test.txt test2.txt  #测试节点2是否可以读写
[root@node2 vm]# cat test2.txt 
test
</code></pre>
<p><strong>配置约束</strong></p>
<pre><code>[root@node1 ~]# pcs constraint order clvmd-clone then VMFS-clone
Adding clvmd-clone VMFS-clone (kind: Mandatory) (Options: first-action=start then-action=start)
[root@node1 ~]# pcs constraint colocation add VMFS-clone with clvmd-clone
[root@node1 ~]# pcs status 
Cluster name: cluster1
Stack: corosync
Current DC: node2-heartbeat (version 1.1.23-1.el7_9.1-9acf116022) - partition with quorum
Last updated: Sun Apr 16 20:55:31 2023
Last change: Sun Apr 16 20:51:30 2023 by root via cibadmin on node1-heartbeat

2 nodes configured
7 resource instances configured

Online: [ node1-heartbeat node2-heartbeat ]

Full list of resources:

 scsi-shooter   (stonith:fence_scsi):   Started node1-heartbeat
 Clone Set: dlm-clone [dlm]
     Started: [ node1-heartbeat node2-heartbeat ]
 Clone Set: clvmd-clone [clvmd]
     Started: [ node1-heartbeat node2-heartbeat ]
 Clone Set: VMFS-clone [VMFS]
     Started: [ node1-heartbeat node2-heartbeat ]

Daemon Status:
  corosync: active/disabled
  pacemaker: active/disabled
  pcsd: active/enabled
  
[root@node2 vm]# pcs constraint #查看约束
Location Constraints:
Ordering Constraints:
  start dlm-clone then start clvmd-clone (kind:Mandatory)
  start clvmd-clone then start VMFS-clone (kind:Mandatory)
Colocation Constraints:
  clvmd-clone with dlm-clone (score:INFINITY)
  VMFS-clone with clvmd-clone (score:INFINITY)
Ticket Constraints:
</code></pre>
<p><strong>配置Selinux</strong></p>
<p>node1:</p>
<pre><code>[root@node1 vm]# yum install policycoreutils-python
[root@node1 vm]# semanage fcontext -a -t virt_image_t &quot;/vm(/.*)?&quot;
[root@node1 vm]# restorecon -R -v /vm
restorecon reset /vm context system_u:object_r:unlabeled_t:s0-&gt;system_u:object_r:virt_image_t:s0
restorecon reset /vm/test.txt context unconfined_u:object_r:unlabeled_t:s0-&gt;unconfined_u:object_r:virt_image_t:s0
restorecon reset /vm/test2.txt context unconfined_u:object_r:unlabeled_t:s0-&gt;unconfined_u:object_r:virt_image_t:s0
</code></pre>
<p>node2:</p>
<pre><code>[root@node1 vm]# yum install policycoreutils-python
[root@node2 vm]# semanage fcontext -a -t virt_image_t &quot;/vm(/.*)?&quot;
[root@node2 vm]# restorecon -R -v /vm #很重要！
</code></pre>
<h1><span id="8-向集群中添加虚拟机资源">8、向集群中添加虚拟机资源</span></h1><h2><span id="1-将虚拟机数据迁移到iscsi的共享目录">1、将虚拟机数据迁移到iSCSI的共享目录</span></h2><pre><code>[root@node1 vmdata]# virsh list --all  #查看关机的虚拟机
 Id    Name                           State
----------------------------------------------------
 -     Centos7.9                      shut off

[root@node1 vmdata]# virsh domblklist --domain Centos7.9  #获取硬盘路径
Target     Source
------------------------------------------------
vda        /vmdata/Centos7.9.qcow2
hda        -

[root@node1 vmdata]# df -HT #查看Iscsi的挂载点在/vm
Filesystem              Type      Size  Used Avail Use% Mounted on
devtmpfs                devtmpfs  2.0G     0  2.0G   0% /dev
tmpfs                   tmpfs     2.0G   63M  2.0G   4% /dev/shm
tmpfs                   tmpfs     2.0G   13M  2.0G   1% /run
tmpfs                   tmpfs     2.0G     0  2.0G   0% /sys/fs/cgroup
/dev/mapper/centos-root xfs        38G   13G   25G  35% /
/dev/sda1               xfs       1.1G  206M  858M  20% /boot
tmpfs                   tmpfs     396M     0  396M   0% /run/user/0
/dev/mapper/vmvg0-lvvm0 gfs2       22G  137M   22G   1% /vm
[root@node1 vmdata]# mv /vmdata/Centos7.9.qcow2 /vm #将数据盘迁移到/vm

[root@node1 vmdata]# sar -n DEV 1 4 #期间可以多开窗口查看网络流量
[root@node1 vm]# mkdir -p /vm/qemu_config
[root@node1 vm]# virsh dumpxml --domain Centos7.9 &gt; /vm/qemu_config/Centos7.9.xml #将配置文件输出到iSCSI的挂载点
[root@node1 vm]# virsh undefine --domain Centos7.9  #取消原主机定义
Domain Centos7.9 has been undefined
[root@node1 vm]# vim /vm/qemu_config/Centos7.9.xml #修改硬盘路径为iSCSI的挂载点
      &lt;source file=&#39;/vm/Centos7.9.qcow2&#39;/&gt;
[root@node1 vm]# firewall-cmd --add-port=16509/tcp --permanent #别忘记添加防火墙规则
success
[root@node1 vm]# firewall-cmd --add-port=49152-49251/tcp --permanent 
success
[root@node1 vm]# firewall-cmd --reload 
success
</code></pre>
<p><img src="/images/KVM/%E5%9F%BA%E4%BA%8EiSCSI%E7%9A%84KVM%E7%BE%A4%E9%9B%86%E6%9E%84%E5%BB%BA/102.jpg"></p>
<h2><span id="2-测试动态迁移">2、测试动态迁移</span></h2><p>node1:</p>
<pre><code>[root@node1 vm]# virsh define --file /vm/qemu_config/Centos7.9.xml 
Domain Centos7.9 defined from /vm/qemu_config/Centos7.9.xml

[root@node1 vm]# virsh start --domain Centos7.9 
Domain Centos7.9 started

[root@node1 vm]# virsh migrate --domain Centos7.9 --desturi qemu+ssh://root@node2-storge/system --live  --persistent --verbose #热迁移到node2
[100%]
[root@node1 vm]# virsh shutdown --domain Centos7.9 #关机

[root@node1 ~]# virsh undefine --domain Centos7.9 #取消定义

[root@node1 ~]# pcs resource create Centos7.9 VirtualDomain hypervisor=&quot;qemu:///system&quot; config=&quot;/vm/qemu_config/Centos7.9.xml&quot; migration_transport=ssh meta allow-migrate=&quot;true&quot; #在集群中定义主机

[root@node1 ~]# pcs status 
Cluster name: cluster1
Stack: corosync
Current DC: node2-heartbeat (version 1.1.23-1.el7_9.1-9acf116022) - partition with quorum
Last updated: Wed Apr 19 10:09:00 2023
Last change: Wed Apr 19 10:08:55 2023 by root via crm_resource on node2-heartbeat

2 nodes configured
8 resource instances configured

Online: [ node1-heartbeat node2-heartbeat ]

Full list of resources:

 scsi-shooter   (stonith:fence_scsi):   Started node1-heartbeat
 Clone Set: dlm-clone [dlm]
     Started: [ node1-heartbeat node2-heartbeat ]
 Clone Set: clvmd-clone [clvmd]
     Started: [ node1-heartbeat node2-heartbeat ]
 Clone Set: VMFS-clone [VMFS]
     Started: [ node1-heartbeat node2-heartbeat ]
 Centos7.9  (ocf::heartbeat:VirtualDomain): Started node2-heartbeat

Daemon Status:
  corosync: active/disabled
  pacemaker: active/disabled
  pcsd: active/enabled
[root@node1 ~]# pcs constraint order start VMFS-clone then Centos7.9 #配置顺序约束
Adding VMFS-clone Centos7.9 (kind: Mandatory) (Options: first-action=start then-action=start)

[root@node1 ~]# pcs constraint 
Location Constraints:
Ordering Constraints:
  start dlm-clone then start clvmd-clone (kind:Mandatory)
  start clvmd-clone then start VMFS-clone (kind:Mandatory)
  start VMFS-clone then start Centos7.9 (kind:Mandatory)
Colocation Constraints:
  clvmd-clone with dlm-clone (score:INFINITY)
  VMFS-clone with clvmd-clone (score:INFINITY)
Ticket Constraints:

[root@node1 ~]# pcs resource move Centos7.9 node1-heartbeat #热迁移
</code></pre>
<blockquote>
<p>经过多次测试，由于semanage fcontext -a -t virt_image_t “&#x2F;vm(&#x2F;.*)?”配置未生效，导致热迁移提示权限错误，原因就是因为selinux禁止了，关闭selinux后热迁移成功</p>
</blockquote>
<script type="text&#x2F;javascript" src="https://unpkg.com/kity@2.0.4/dist/kity.min.js"></script><script type="text&#x2F;javascript" src="https://unpkg.com/kityminder-core@1.4.50/dist/kityminder.core.min.js"></script><script defer="true" type="text&#x2F;javascript" src="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.js"></script><link rel="stylesheet" type="text&#x2F;css" href="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.css">
        </article>

        
            
  <div class="nexmoe-post-copyright">
    <strong>Author：</strong>张博丞<br>
    
      <strong>From：</strong><a href="/%E5%8E%9F%E5%88%9B" title="原创" target="_blank" rel="noopener">原创</a><br>
    
    <strong>Link：</strong><a href="https://zhangboc.github.io/2023/04/19/KVM/6.KVM%E8%99%9A%E6%8B%9F%E5%8C%96%E8%BF%9B%E9%98%B6%E4%B8%8E%E6%8F%90%E9%AB%98%E8%A7%86%E9%A2%91%E8%AF%BE%E7%A8%8B%E4%B9%8B%E5%9F%BA%E4%BA%8EiSCSI%E7%9A%84KVM%E7%BE%A4%E9%9B%86%E6%9E%84%E5%BB%BA/" title="https:&#x2F;&#x2F;zhangboc.github.io&#x2F;2023&#x2F;04&#x2F;19&#x2F;KVM&#x2F;6.KVM%E8%99%9A%E6%8B%9F%E5%8C%96%E8%BF%9B%E9%98%B6%E4%B8%8E%E6%8F%90%E9%AB%98%E8%A7%86%E9%A2%91%E8%AF%BE%E7%A8%8B%E4%B9%8B%E5%9F%BA%E4%BA%8EiSCSI%E7%9A%84KVM%E7%BE%A4%E9%9B%86%E6%9E%84%E5%BB%BA&#x2F;" target="_blank" rel="noopener">https:&#x2F;&#x2F;zhangboc.github.io&#x2F;2023&#x2F;04&#x2F;19&#x2F;KVM&#x2F;6.KVM%E8%99%9A%E6%8B%9F%E5%8C%96%E8%BF%9B%E9%98%B6%E4%B8%8E%E6%8F%90%E9%AB%98%E8%A7%86%E9%A2%91%E8%AF%BE%E7%A8%8B%E4%B9%8B%E5%9F%BA%E4%BA%8EiSCSI%E7%9A%84KVM%E7%BE%A4%E9%9B%86%E6%9E%84%E5%BB%BA&#x2F;</a><br>

    
      <strong>版权声明：</strong>本文采用 <a href="https://creativecommons.org/licenses/by-nc-sa/3.0/cn/deed.zh" target="_blank">CC BY-NC-SA 3.0 CN</a> 协议进行许可
    
  </div>


        

        <div class="nexmoe-post-meta nexmoe-rainbow">
    
        <a class="nexmoefont icon-appstore-fill -link" href="/categories/KVM/">KVM</a>
    
    
        <a class="nexmoefont icon-tag-fill -none-link" href="/tags/KVM/" rel="tag">KVM</a> <a class="nexmoefont icon-tag-fill -none-link" href="/tags/%E5%9F%BA%E4%BA%8EiSCSI%E7%9A%84KVM%E7%BE%A4%E9%9B%86%E6%9E%84%E5%BB%BA/" rel="tag">基于iSCSI的KVM群集构建</a>
    
</div>

    <div class="nexmoe-post-footer">
        <section class="nexmoe-comment">
    <div class="valine"></div>
<script src='https://lib.baomitu.com/valine/1.3.9/Valine.min.js'></script>
<script>
    // 使用方法 https://valine.js.org/quickstart.html
    new Valine({
        el: '.valine',
        appId: 'r5zxC0st0DDjPA9auXzMV7HY-gzGzoHsz',
        appKey: '3bqCsovpyfTPHUzTHovd3V3V'
    })
</script>
</section>
    </div>
</div>
<script type="text/javascript" src="/libs/codeBlock/codeBlockFuction.js"></script>
<!-- 代码语言 -->
<script type="text/javascript" src="/libs/codeBlock/codeLang.js"></script>
<!-- 代码块复制 -->
<script type="text/javascript" src="/libs/codeBlock/codeCopy.js"></script>
<script type="text/javascript" src="/libs/codeBlock/clipboard.min.js"></script>
<!-- 代码块收缩 -->
<script type="text/javascript" src="/libs/codeBlock/codeShrink.js"></script> 
<!-- 代码块折行 -->
<style type="text/css">code[class*="language-"], pre[class*="language-"] { white-space: pre !important; }</style>

        <div class="nexmoe-post-right">
          
            <div class="nexmoe-fixed">
              <div class="nexmoe-tool">
                <a href="#" aria-label="回到顶部" title="top"><button class="mdui-fab mdui-ripple"><i class="nexmoefont icon-caret-top"></i></button></a>
              </div>
            </div>
          
        </div>
    </div>
  </div>
  <div id="nexmoe-pendant">
    <div class="nexmoe-drawer mdui-drawer nexmoe-pd" id="drawer">
        
            <div class="nexmoe-pd-item">
                <div class="clock">
        <div class="memory"></div>
        <div class="memory"></div>
        <div class="memory"></div>
        <div class="memory"></div>
        <div class="memory"></div>
        <div class="memory"></div>
        <div class="memory"></div>
        <div class="memory"></div>
        <div class="memory"></div>
        <div class="memory"></div>
        <div class="memory"></div>
        <div class="memory"></div>
        <div class="memory"></div>
        <div class="memory"></div>
        <div class="memory"></div>
        <div class="memory"></div>
        <div class="memory"></div>
        <div class="memory"></div>
        <div class="memory"></div>
        <div class="memory"></div>
        <div class="memory"></div>
        <div class="memory"></div>
        <div class="memory"></div>
        <div class="memory"></div>
        <div class="memory"></div>
        <div class="memory"></div>
        <div class="memory"></div>
        <div class="memory"></div>
        <div class="memory"></div>
        <div class="memory"></div>
        <div class="memory"></div>
        <div class="memory"></div>
        <div class="memory"></div>
        <div class="memory"></div>
        <div class="memory"></div>
        <div class="memory"></div>
        <div class="memory"></div>
        <div class="memory"></div>
        <div class="memory"></div>
        <div class="memory"></div>
        <div class="memory"></div>
        <div class="memory"></div>
        <div class="memory"></div>
        <div class="memory"></div>
        <div class="memory"></div>
        <div class="memory"></div>
        <div class="memory"></div>
        <div class="memory"></div>
        <div class="memory"></div>
        <div class="memory"></div>
        <div class="memory"></div>
        <div class="memory"></div>
        <div class="memory"></div>
        <div class="memory"></div>
        <div class="memory"></div>
        <div class="memory"></div>
        <div class="memory"></div>
        <div class="memory"></div>
        <div class="memory"></div>
        <div class="memory"></div>
        <div class="needle" id="hours"></div>
        <div class="needle" id="minutes"></div>
        <div class="needle" id="seconds"></div>
        <div class="clock_logo">

        </div>

    </div>
<style>
    .clock {
        background-color: #ffffff;
        width: 70vw;
        height: 70vw;
        max-width: 70vh;
        max-height: 70vh;
        border: solid 2.8vw #242424;
        position: relative;
        overflow: hidden;
        border-radius: 50%;
        box-sizing: border-box;
        box-shadow: 0 1.4vw 2.8vw rgba(0, 0, 0, 0.8);
        zoom:0.2
    }

    .memory {
        position: absolute;
        top: 50%;
        left: 50%;
        transform-origin: center;
    }

    .memory:nth-child(1) {
        background-color: #424242;
        width: 2%;
        height: 8%;
        transform: translate(-50%, -50%) rotate(0deg) translateY(-520%);
    }

    .memory:nth-child(2) {
        background-color: #949494;
        width: 1%;
        height: 3%;
        transform: translate(-50%, -50%) rotate(6deg) translateY(-1461%);
    }

    .memory:nth-child(3) {
        background-color: #949494;
        width: 1%;
        height: 3%;
        transform: translate(-50%, -50%) rotate(12deg) translateY(-1461%);
    }

    .memory:nth-child(4) {
        background-color: #949494;
        width: 1%;
        height: 3%;
        transform: translate(-50%, -50%) rotate(18deg) translateY(-1461%);
    }

    .memory:nth-child(5) {
        background-color: #949494;
        width: 1%;
        height: 3%;
        transform: translate(-50%, -50%) rotate(24deg) translateY(-1461%);
    }

    .memory:nth-child(6) {
        background-color: #424242;
        width: 2%;
        height: 8%;
        transform: translate(-50%, -50%) rotate(30deg) translateY(-520%);
    }

    .memory:nth-child(7) {
        background-color: #949494;
        width: 1%;
        height: 3%;
        transform: translate(-50%, -50%) rotate(36deg) translateY(-1461%);
    }

    .memory:nth-child(8) {
        background-color: #949494;
        width: 1%;
        height: 3%;
        transform: translate(-50%, -50%) rotate(42deg) translateY(-1461%);
    }

    .memory:nth-child(9) {
        background-color: #949494;
        width: 1%;
        height: 3%;
        transform: translate(-50%, -50%) rotate(48deg) translateY(-1461%);
    }

    .memory:nth-child(10) {
        background-color: #949494;
        width: 1%;
        height: 3%;
        transform: translate(-50%, -50%) rotate(54deg) translateY(-1461%);
    }

    .memory:nth-child(11) {
        background-color: #424242;
        width: 2%;
        height: 8%;
        transform: translate(-50%, -50%) rotate(60deg) translateY(-520%);
    }

    .memory:nth-child(12) {
        background-color: #949494;
        width: 1%;
        height: 3%;
        transform: translate(-50%, -50%) rotate(66deg) translateY(-1461%);
    }

    .memory:nth-child(13) {
        background-color: #949494;
        width: 1%;
        height: 3%;
        transform: translate(-50%, -50%) rotate(72deg) translateY(-1461%);
    }

    .memory:nth-child(14) {
        background-color: #949494;
        width: 1%;
        height: 3%;
        transform: translate(-50%, -50%) rotate(78deg) translateY(-1461%);
    }

    .memory:nth-child(15) {
        background-color: #949494;
        width: 1%;
        height: 3%;
        transform: translate(-50%, -50%) rotate(84deg) translateY(-1461%);
    }

    .memory:nth-child(16) {
        background-color: #424242;
        width: 2%;
        height: 8%;
        transform: translate(-50%, -50%) rotate(90deg) translateY(-520%);
    }

    .memory:nth-child(17) {
        background-color: #949494;
        width: 1%;
        height: 3%;
        transform: translate(-50%, -50%) rotate(96deg) translateY(-1461%);
    }

    .memory:nth-child(18) {
        background-color: #949494;
        width: 1%;
        height: 3%;
        transform: translate(-50%, -50%) rotate(102deg) translateY(-1461%);
    }

    .memory:nth-child(19) {
        background-color: #949494;
        width: 1%;
        height: 3%;
        transform: translate(-50%, -50%) rotate(108deg) translateY(-1461%);
    }

    .memory:nth-child(20) {
        background-color: #949494;
        width: 1%;
        height: 3%;
        transform: translate(-50%, -50%) rotate(114deg) translateY(-1461%);
    }

    .memory:nth-child(21) {
        background-color: #424242;
        width: 2%;
        height: 8%;
        transform: translate(-50%, -50%) rotate(120deg) translateY(-520%);
    }

    .memory:nth-child(22) {
        background-color: #949494;
        width: 1%;
        height: 3%;
        transform: translate(-50%, -50%) rotate(126deg) translateY(-1461%);
    }

    .memory:nth-child(23) {
        background-color: #949494;
        width: 1%;
        height: 3%;
        transform: translate(-50%, -50%) rotate(132deg) translateY(-1461%);
    }

    .memory:nth-child(24) {
        background-color: #949494;
        width: 1%;
        height: 3%;
        transform: translate(-50%, -50%) rotate(138deg) translateY(-1461%);
    }

    .memory:nth-child(25) {
        background-color: #949494;
        width: 1%;
        height: 3%;
        transform: translate(-50%, -50%) rotate(144deg) translateY(-1461%);
    }

    .memory:nth-child(26) {
        background-color: #424242;
        width: 2%;
        height: 8%;
        transform: translate(-50%, -50%) rotate(150deg) translateY(-520%);
    }

    .memory:nth-child(27) {
        background-color: #949494;
        width: 1%;
        height: 3%;
        transform: translate(-50%, -50%) rotate(156deg) translateY(-1461%);
    }

    .memory:nth-child(28) {
        background-color: #949494;
        width: 1%;
        height: 3%;
        transform: translate(-50%, -50%) rotate(162deg) translateY(-1461%);
    }

    .memory:nth-child(29) {
        background-color: #949494;
        width: 1%;
        height: 3%;
        transform: translate(-50%, -50%) rotate(168deg) translateY(-1461%);
    }

    .memory:nth-child(30) {
        background-color: #949494;
        width: 1%;
        height: 3%;
        transform: translate(-50%, -50%) rotate(174deg) translateY(-1461%);
    }

    .memory:nth-child(31) {
        background-color: #424242;
        width: 2%;
        height: 8%;
        transform: translate(-50%, -50%) rotate(180deg) translateY(-520%);
    }

    .memory:nth-child(32) {
        background-color: #949494;
        width: 1%;
        height: 3%;
        transform: translate(-50%, -50%) rotate(186deg) translateY(-1461%);
    }

    .memory:nth-child(33) {
        background-color: #949494;
        width: 1%;
        height: 3%;
        transform: translate(-50%, -50%) rotate(192deg) translateY(-1461%);
    }

    .memory:nth-child(34) {
        background-color: #949494;
        width: 1%;
        height: 3%;
        transform: translate(-50%, -50%) rotate(198deg) translateY(-1461%);
    }

    .memory:nth-child(35) {
        background-color: #949494;
        width: 1%;
        height: 3%;
        transform: translate(-50%, -50%) rotate(204deg) translateY(-1461%);
    }

    .memory:nth-child(36) {
        background-color: #424242;
        width: 2%;
        height: 8%;
        transform: translate(-50%, -50%) rotate(210deg) translateY(-520%);
    }

    .memory:nth-child(37) {
        background-color: #949494;
        width: 1%;
        height: 3%;
        transform: translate(-50%, -50%) rotate(216deg) translateY(-1461%);
    }

    .memory:nth-child(38) {
        background-color: #949494;
        width: 1%;
        height: 3%;
        transform: translate(-50%, -50%) rotate(222deg) translateY(-1461%);
    }

    .memory:nth-child(39) {
        background-color: #949494;
        width: 1%;
        height: 3%;
        transform: translate(-50%, -50%) rotate(228deg) translateY(-1461%);
    }

    .memory:nth-child(40) {
        background-color: #949494;
        width: 1%;
        height: 3%;
        transform: translate(-50%, -50%) rotate(234deg) translateY(-1461%);
    }

    .memory:nth-child(41) {
        background-color: #424242;
        width: 2%;
        height: 8%;
        transform: translate(-50%, -50%) rotate(240deg) translateY(-520%);
    }

    .memory:nth-child(42) {
        background-color: #949494;
        width: 1%;
        height: 3%;
        transform: translate(-50%, -50%) rotate(246deg) translateY(-1461%);
    }

    .memory:nth-child(43) {
        background-color: #949494;
        width: 1%;
        height: 3%;
        transform: translate(-50%, -50%) rotate(252deg) translateY(-1461%);
    }

    .memory:nth-child(44) {
        background-color: #949494;
        width: 1%;
        height: 3%;
        transform: translate(-50%, -50%) rotate(258deg) translateY(-1461%);
    }

    .memory:nth-child(45) {
        background-color: #949494;
        width: 1%;
        height: 3%;
        transform: translate(-50%, -50%) rotate(264deg) translateY(-1461%);
    }

    .memory:nth-child(46) {
        background-color: #424242;
        width: 2%;
        height: 8%;
        transform: translate(-50%, -50%) rotate(270deg) translateY(-520%);
    }

    .memory:nth-child(47) {
        background-color: #949494;
        width: 1%;
        height: 3%;
        transform: translate(-50%, -50%) rotate(276deg) translateY(-1461%);
    }

    .memory:nth-child(48) {
        background-color: #949494;
        width: 1%;
        height: 3%;
        transform: translate(-50%, -50%) rotate(282deg) translateY(-1461%);
    }

    .memory:nth-child(49) {
        background-color: #949494;
        width: 1%;
        height: 3%;
        transform: translate(-50%, -50%) rotate(288deg) translateY(-1461%);
    }

    .memory:nth-child(50) {
        background-color: #949494;
        width: 1%;
        height: 3%;
        transform: translate(-50%, -50%) rotate(294deg) translateY(-1461%);
    }

    .memory:nth-child(51) {
        background-color: #424242;
        width: 2%;
        height: 8%;
        transform: translate(-50%, -50%) rotate(300deg) translateY(-520%);
    }

    .memory:nth-child(52) {
        background-color: #949494;
        width: 1%;
        height: 3%;
        transform: translate(-50%, -50%) rotate(306deg) translateY(-1461%);
    }

    .memory:nth-child(53) {
        background-color: #949494;
        width: 1%;
        height: 3%;
        transform: translate(-50%, -50%) rotate(312deg) translateY(-1461%);
    }

    .memory:nth-child(54) {
        background-color: #949494;
        width: 1%;
        height: 3%;
        transform: translate(-50%, -50%) rotate(318deg) translateY(-1461%);
    }

    .memory:nth-child(55) {
        background-color: #949494;
        width: 1%;
        height: 3%;
        transform: translate(-50%, -50%) rotate(324deg) translateY(-1461%);
    }

    .memory:nth-child(56) {
        background-color: #424242;
        width: 2%;
        height: 8%;
        transform: translate(-50%, -50%) rotate(330deg) translateY(-520%);
    }

    .memory:nth-child(57) {
        background-color: #949494;
        width: 1%;
        height: 3%;
        transform: translate(-50%, -50%) rotate(336deg) translateY(-1461%);
    }

    .memory:nth-child(58) {
        background-color: #949494;
        width: 1%;
        height: 3%;
        transform: translate(-50%, -50%) rotate(342deg) translateY(-1461%);
    }

    .memory:nth-child(59) {
        background-color: #949494;
        width: 1%;
        height: 3%;
        transform: translate(-50%, -50%) rotate(348deg) translateY(-1461%);
    }

    .memory:nth-child(60) {
        background-color: #949494;
        width: 1%;
        height: 3%;
        transform: translate(-50%, -50%) rotate(354deg) translateY(-1461%);
    }

    .needle {
        position: absolute;
        top: 50%;
        left: 50%;
        transform-origin: center;
    }

    .needle#hours {
        background-color: #1f1f1f;
        width: 4%;
        height: 30%;
        transform-origin: center 75%;
        transform: translate(-50%, -75%);
    }

    .needle#hours.moving {
        transition: transform 150ms ease-out;
    }

    .needle#hours:after {
        content: '';
        background-color: #1f1f1f;
        width: 4vw;
        height: 4vw;
        max-width: 4vh;
        max-height: 4vh;
        display: block;
        position: absolute;
        top: 75%;
        left: 50%;
        box-sizing: border-box;
        border-radius: 50%;
        transform: translate(-50%, -50%);
    }

    .needle#minutes {
        background-color: #1f1f1f;
        width: 2%;
        height: 45%;
        transform-origin: center 75%;
        transform: translate(-50%, -75%);
    }

    .needle#minutes.moving {
        transition: transform 150ms ease-out;
    }

    .needle#minutes:after {
        content: '';
        background-color: #1f1f1f;
        width: 4vw;
        height: 4vw;
        max-width: 4vh;
        max-height: 4vh;
        display: block;
        position: absolute;
        top: 75%;
        left: 50%;
        box-sizing: border-box;
        border-radius: 50%;
        transform: translate(-50%, -50%);
    }

    .needle#seconds {
        background-color: #cb2f2f;
        width: 1%;
        height: 50%;
        transform-origin: center 75%;
        transform: translate(-50%, -75%);
    }

    .needle#seconds.moving {
        transition: transform 150ms ease-out;
    }

    .needle#seconds:after {
        content: '';
        background-color: #cb2f2f;
        width: 2.5vw;
        height: 2.5vw;
        max-width: 2.5vh;
        max-height: 2.5vh;
        display: block;
        position: absolute;
        top: 75%;
        left: 50%;
        box-sizing: border-box;
        border-radius: 50%;
        transform: translate(-50%, -50%);
    }
    .clock_logo{
        width: 10vw;
        height: 10vw;
        max-width: 10vh;
        max-height: 10vh;
        position: absolute;
        top: 50%;
        left: 50%;
        box-sizing: border-box;
        border-radius: 50%;
        transform: translate(-50%, -50%);
        background-size: 100% 100%;
        background-repeat: no-repeat;
    }
    @media (min-width: 100vh) {
        .clock {
            border: solid 2.8vh #242424;
            box-shadow: 0 1.4vh 2.8vh rgba(0, 0, 0, 0.8);
        }
    }

</style>





            </div>
        
            <div class="nexmoe-pd-item">
                <div class="qweather" >
    <div id="he-plugin-standard"></div>
    <div class="qweather-logo">

    </div>

</div>
<style>
    .qweather{
        position: relative;
    }
    .qweather-logo{
        position: absolute;
        right: 0;
        top: -15px;
        width: 40px;
        height: 40px;
        background-size: 100% 100%;
        background-repeat: no-repeat;
    }
</style>
<script>
  WIDGET = {
    "CONFIG": {
      "layout": "2",
      "width": "260",
      "height": "220",
      "background": "5",
      "dataColor": "e67249",
      "borderRadius": "15",
      "key": "f74d1e1690e6432d801e97fa2f05a162"
    }
  }
</script>
<script src="https://widget.qweather.net/standard/static/js/he-standard-common.js?v=2.0"></script>

            </div>
        
</div>
<style>
    .nexmoe-pd {
        left: auto;
        top: 40px;
        right: 0;
    }
    .nexmoe-pd-item{
       display: flex;
        justify-content: center;
        margin-bottom: 30px;
    }
</style>

  </div>
  <script src="https://lib.baomitu.com/lazysizes/5.1.0/lazysizes.min.js"></script>
<script src="https://lib.baomitu.com/highlight.js/10.0.0/highlight.min.js"></script>
<script src="https://lib.baomitu.com/mdui/0.4.3/js/mdui.min.js"></script>

<script>
	hljs.initHighlightingOnLoad();
</script>

<script src="https://lib.baomitu.com/jquery/3.5.1/jquery.slim.min.js"></script>
<script src="/lib/fancybox/js/jquery.fancybox.min.js"></script>


<script src="/js/app.js?v=1682237265539"></script>

<script src="https://lib.baomitu.com/justifiedGallery/3.8.1/js/jquery.justifiedGallery.min.js"></script>
<script>
	$(".justified-gallery").justifiedGallery({
		rowHeight: 160,
		margins: 10,
	});
</script>

  





<!-- hexo injector body_end start -->
<script src="/js/clock.js"></script>

<script src="https://lib.baomitu.com/clipboard.js/2.0.8/clipboard.min.js"></script>

<script src="/lib/codeBlock/codeBlockFuction.js"></script>

<script src="/lib/codeBlock/codeLang.js"></script>

<script src="/lib/codeBlock/codeCopy.js"></script>

<script src="/lib/codeBlock/codeShrink.js"></script>

<link rel="stylesheet" href="/lib/codeBlock/matery.css">

<script src="https://code.jquery.com/jquery-3.6.0.js"></script>

<script src="/js/search.js"></script>

<script src="/js/webapp.js"></script>
<!-- hexo injector body_end end --><script src="/live2D/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2D/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"debug":true,"model":{"jsonPath":"/live2D/assets/xiaomai.model.json"},"display":{"position":"left","width":150,"height":300},"mobile":{"show":true},"react":{"opacity":1},"log":false});</script></body>
</html>

<script>(function(i,s,o,g,r,a,m){i["DaoVoiceObject"]=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;a.charset="utf-8";m.parentNode.insertBefore(a,m)})(window,document,"script",('https:' == document.location.protocol ? 'https:' : 'http:') + "//widget.daovoice.io/widget/5e784416.js","daovoice")</script>
<script>
  daovoice('init', {
    app_id: "5e784416"
  });
  daovoice('update');
</script>

