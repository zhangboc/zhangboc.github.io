<!DOCTYPE html>

<html lang="en">

<head>
  
  <meta name="baidu-site-verification" content="code-J1Qg17G6wT" />
  <title>Ceph与KVM集成 - Hexo</title>
  <meta charset="UTF-8">
  <meta name="description" content="">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5">
  
  

    <!-- Site Verification -->
    <meta name="baidu-site-verification" content="code-J1Qg17G6wT" />

  <link rel="shortcut icon" href="/images/head/head.jpg" type="image/png" />
  <meta property="og:type" content="article">
<meta property="og:title" content="Ceph与KVM集成">
<meta property="og:url" content="https://zhangboc.github.io/2023/04/20/Ceph/14.Ceph%E4%B8%8EKVM%E9%9B%86%E6%88%90/Ceph%E4%B8%8EKVM%E9%9B%86%E6%88%90/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://zhangboc.github.io/images/Ceph/Ceph%E4%B8%8EKVM%E9%9B%86%E6%88%90/1.jpg">
<meta property="og:image" content="https://zhangboc.github.io/images/Ceph/Ceph%E4%B8%8EKVM%E9%9B%86%E6%88%90/2.jpg">
<meta property="og:image" content="https://zhangboc.github.io/images/Ceph/Ceph%E4%B8%8EKVM%E9%9B%86%E6%88%90/3.jpg">
<meta property="og:image" content="https://zhangboc.github.io/images/Ceph/Ceph%E4%B8%8EKVM%E9%9B%86%E6%88%90/4.jpg">
<meta property="og:image" content="https://zhangboc.github.io/images/Ceph/Ceph%E4%B8%8EKVM%E9%9B%86%E6%88%90/5.jpg">
<meta property="og:image" content="https://zhangboc.github.io/images/Ceph/Ceph%E4%B8%8EKVM%E9%9B%86%E6%88%90/6.jpg">
<meta property="og:image" content="https://zhangboc.github.io/images/Ceph/Ceph%E4%B8%8EKVM%E9%9B%86%E6%88%90/7.jpg">
<meta property="og:image" content="https://zhangboc.github.io/images/Ceph/Ceph%E4%B8%8EKVM%E9%9B%86%E6%88%90/8.jpg">
<meta property="og:image" content="https://zhangboc.github.io/images/Ceph/Ceph%E4%B8%8EKVM%E9%9B%86%E6%88%90/9.jpg">
<meta property="og:image" content="https://zhangboc.github.io/images/Ceph/Ceph%E4%B8%8EKVM%E9%9B%86%E6%88%90/10.jpg">
<meta property="og:image" content="https://zhangboc.github.io/images/Ceph/Ceph%E4%B8%8EKVM%E9%9B%86%E6%88%90/11.jpg">
<meta property="og:image" content="https://zhangboc.github.io/images/Ceph/Ceph%E4%B8%8EKVM%E9%9B%86%E6%88%90/12.jpg">
<meta property="og:image" content="https://zhangboc.github.io/images/Ceph/Ceph%E4%B8%8EKVM%E9%9B%86%E6%88%90/13.jpg">
<meta property="article:published_time" content="2023-04-19T16:00:00.000Z">
<meta property="article:modified_time" content="2023-04-20T02:26:06.733Z">
<meta property="article:author" content="John Doe">
<meta property="article:tag" content="KVM">
<meta property="article:tag" content="Ceph">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://zhangboc.github.io/images/Ceph/Ceph%E4%B8%8EKVM%E9%9B%86%E6%88%90/1.jpg">
  <link rel="stylesheet" href="https://lib.baomitu.com/highlight.js/9.15.8/styles/atom-one-dark.min.css" crossorigin>
  <link rel="stylesheet" href="/lib/mdui_043tiny/css/mdui.css">
  <link rel="stylesheet" href="/lib/iconfont/iconfont.css">
  <link rel="stylesheet" href="/lib/fancybox/css/jquery.fancybox.min.css">
  <link rel="stylesheet" href="https://lib.baomitu.com/justifiedGallery/3.8.1/css/justifiedGallery.min.css">
  
    <link rel="stylesheet" href="//at.alicdn.com/t/font_2421060_8z08qcz5sq3.css">
  
  <link rel="stylesheet" href="/css/style.css?v=1682237265517">
<meta name="generator" content="Hexo 6.3.0"></head>

<body class="mdui-drawer-body-left">
  
  <div id="nexmoe-background">
    <div class="nexmoe-bg" style="background-image: url(/images/background/xiaomai.jpg)"></div>
    <div class="nexmoe-small" style="background-image: url(/images/background/lihui.png)"></div>
    <div class="mdui-appbar mdui-shadow-0">
      <div class="mdui-toolbar">
        <a mdui-drawer="{target: '#drawer', swipe: true}" title="menu" class="mdui-btn mdui-btn-icon mdui-ripple"><i class="mdui-icon nexmoefont icon-menu"></i></a>
        <div class="mdui-toolbar-spacer"></div>
        <!--<a href="javascript:;" class="mdui-btn mdui-btn-icon"><i class="mdui-icon material-icons">search</i></a>-->
        <a href="/" title="John Doe" class="mdui-btn mdui-btn-icon"><img src="/images/head/head.jpg" alt="John Doe"></a>
       </div>
    </div>
  </div>
  <div id="nexmoe-header">
      <div class="nexmoe-drawer mdui-drawer" id="drawer">
    <div class="nexmoe-avatar mdui-ripple">
        <a href="/" title="John Doe">
            <img src="/images/head/head.jpg" alt="John Doe" alt="John Doe">
        </a>
    </div>
    <div class="nexmoe-count">
        <div class="nexmoe-count-item"><span>文章</span>26 <div class="item-radius"></div><div class="item-radius item-right"></div> </div>
        <div class="nexmoe-count-item"><span>标签</span>20<div class="item-radius"></div><div class="item-radius item-right"></div></div>
        <div class="nexmoe-count-item"><span>分类</span>7<div class="item-radius"></div><div class="item-radius item-right"></div></div>
    </div>
    <div class="nexmoe-list mdui-list" mdui-collapse="{accordion: true}">
        
        <a class="nexmoe-list-item mdui-list-item mdui-ripple" href="/" title="回到首页">
            <i class="mdui-list-item-icon nexmoefont icon-meishi"></i>
            <div class="mdui-list-item-content">
                回到首页
            </div>
        </a>
        
        <a class="nexmoe-list-item mdui-list-item mdui-ripple" href="/archives.html" title="文章归档">
            <i class="mdui-list-item-icon nexmoefont icon-hanbao1"></i>
            <div class="mdui-list-item-content">
                文章归档
            </div>
        </a>
        
        <a class="nexmoe-list-item mdui-list-item mdui-ripple" href="/about/index.html" title="关于我">
            <i class="mdui-list-item-icon nexmoefont icon-jiubei1"></i>
            <div class="mdui-list-item-content">
                关于我
            </div>
        </a>
        
        <a class="nexmoe-list-item mdui-list-item mdui-ripple" href="/friend/index.html" title="我的朋友">
            <i class="mdui-list-item-icon nexmoefont icon-cola"></i>
            <div class="mdui-list-item-content">
                我的朋友
            </div>
        </a>
        
        <a class="nexmoe-list-item mdui-list-item mdui-ripple" href="/download/index.html" title="下载中心">
            <i class="mdui-list-item-icon nexmoefont icon-tangguo"></i>
            <div class="mdui-list-item-content">
                下载中心
            </div>
        </a>
        
    </div>
    <aside id="nexmoe-sidebar">
  
  
<!-- 站内搜索 -->

<div class="nexmoe-widget-wrap">
    <div class="nexmoe-widget nexmoe-search" >
        <form id="search-form">
            <label><input type="text" id="local-search-input" name="q" results="0" placeholder="站内搜索" class="input form-control" autocomplete="off" autocorrect="off"/></label>
            <!-- 清空/重置搜索框 -->
            <i class="fa fa-times" onclick="resetSearch()"></i>
        </form>
    </div>
    <div id="local-search-result"></div> <!-- 搜索结果区 -->
    <!-- <p class='no-result'></p> 无匹配时显示，注意在 CSS 中设置默认隐藏 -->
</div>


  
  <div class="nexmoe-widget-wrap">
    <div class="nexmoe-widget nexmoe-social">
        <a class="mdui-ripple" href="http://wpa.qq.com/msgrd?v=3&uin=1605643129&Site=%E5%8C%97%E4%BA%ACSEO&Menu=yes" target="_blank" mdui-tooltip="{content: 'QQ'}" style="color: rgb(64, 196, 255);background-color: rgba(64, 196, 255, .1);">
            <i class="nexmoefont icon-QQ"></i>
        </a><a class="mdui-ripple" href="mailto:1605643129@qq.com" target="_blank" mdui-tooltip="{content: 'mail'}" style="color: rgb(249,8,8);background-color: rgba(249,8,8,.1);">
            <i class="nexmoefont icon-mail-fill"></i>
        </a><a class="mdui-ripple" href="https://blog.csdn.net/qq_40855827?type=blog" target="_blank" mdui-tooltip="{content: 'CSDN'}" style="color: rgb(199,29,35);background-color: rgba(199,29,35,.1);">
            <i class="nexmoefont icon-csdn"></i>
        </a><a class="mdui-ripple" href="https://home.cnblogs.com/u/1882665" target="_blank" mdui-tooltip="{content: '博客园'}" style="color: rgb(66, 214, 29);background-color: rgba(66, 214, 29, .1);">
            <i class="nexmoefont icon-bokeyuan"></i>
        </a><a class="mdui-ripple" href="https://github.com/zhangboc" target="_blank" mdui-tooltip="{content: 'GitHub'}" style="color: rgb(25, 23, 23);background-color: rgba(25, 23, 23, .15);">
            <i class="nexmoefont icon-github"></i>
        </a><a class="mdui-ripple" href="https://gitee.com/with-the-wind-yue" target="_blank" mdui-tooltip="{content: 'gitee'}" style="color: rgb(255, 255, 255);background-color: rgb(199,29,35);">
            <i class="nexmoefont icon-mayun"></i>
        </a>
    </div>
</div>
  
  
  <div class="nexmoe-widget-wrap">
    <h3 class="nexmoe-widget-title">分类</h3>
    <div class="nexmoe-widget">

      <ul class="category-list">

        


        

        

        <li class="category-list-item">
          <a class="category-list-link" href="/categories/Ceph/">Ceph</a>
          <span class="category-list-count">19</span>
        </li>

        

        <li class="category-list-item">
          <a class="category-list-link" href="/categories/KVM/">KVM</a>
          <span class="category-list-count">7</span>
        </li>

        

        <li class="category-list-item">
          <a class="category-list-link" href="/categories/Ceph/Kubernetes/">Kubernetes</a>
          <span class="category-list-count">1</span>
        </li>

        

        <li class="category-list-item">
          <a class="category-list-link" href="/categories/Ceph/OpenStack/">OpenStack</a>
          <span class="category-list-count">2</span>
        </li>

        

        <li class="category-list-item">
          <a class="category-list-link" href="/categories/Ceph/SDK/">SDK</a>
          <span class="category-list-count">1</span>
        </li>

        

        <li class="category-list-item">
          <a class="category-list-link" href="/categories/hexo/">hexo</a>
          <span class="category-list-count">1</span>
        </li>

        
      </ul>

    </div>
  </div>


  
  
  <div class="nexmoe-widget-wrap">
    <div id="randomtagcloud" class="nexmoe-widget tagcloud nexmoe-rainbow">
      <a href="/tags/Ceph/" style="font-size: 20px;">Ceph</a> <a href="/tags/CephFS/" style="font-size: 10px;">CephFS</a> <a href="/tags/Ceph%E5%AE%88%E6%8A%A4%E8%BF%9B%E7%A8%8B/" style="font-size: 10px;">Ceph守护进程</a> <a href="/tags/Ceph%E7%AE%80%E4%BB%8B/" style="font-size: 10px;">Ceph简介</a> <a href="/tags/Cinder/" style="font-size: 10px;">Cinder</a> <a href="/tags/CrushMap/" style="font-size: 10px;">CrushMap</a> <a href="/tags/KVM/" style="font-size: 17.5px;">KVM</a> <a href="/tags/KVM%E8%99%9A%E6%8B%9F%E6%9C%BA%E8%BF%81%E7%A7%BB/" style="font-size: 10px;">KVM虚拟机迁移</a> <a href="/tags/KVM%E8%99%9A%E6%8B%9F%E7%BD%91%E7%BB%9C%E9%AB%98%E7%BA%A7%E9%85%8D%E7%BD%AE/" style="font-size: 10px;">KVM虚拟网络高级配置</a> <a href="/tags/Kubernetes/" style="font-size: 10px;">Kubernetes</a> <a href="/tags/Linux-HA/" style="font-size: 15px;">Linux HA</a> <a href="/tags/NFS/" style="font-size: 10px;">NFS</a> <a href="/tags/OSD/" style="font-size: 10px;">OSD</a> <a href="/tags/OpenStack/" style="font-size: 12.5px;">OpenStack</a> <a href="/tags/RBD/" style="font-size: 12.5px;">RBD</a> <a href="/tags/RGW/" style="font-size: 12.5px;">RGW</a> <a href="/tags/chatjs/" style="font-size: 10px;">chatjs</a> <a href="/tags/%E5%9F%BA%E4%BA%8EiSCSI%E7%9A%84KVM%E7%BE%A4%E9%9B%86%E6%9E%84%E5%BB%BA/" style="font-size: 10px;">基于iSCSI的KVM群集构建</a> <a href="/tags/%E6%95%85%E9%9A%9C%E6%8E%92%E6%9F%A5/" style="font-size: 10px;">故障排查</a> <a href="/tags/%E9%9B%86%E7%BE%A4%E6%B5%8B%E8%AF%95/" style="font-size: 10px;">集群测试</a>
    </div>
    
  </div>

  
  
  <div class="nexmoe-widget-wrap">
    <h3 class="nexmoe-widget-title">文章</h3>
    <div class="nexmoe-widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/">2023</a><span class="archive-list-count">26</span></li></ul>
    </div>
  </div>


<style>
.nexmoe-widget .archive-list-count{
	position : absolute;
	right: 15px;
	top:9px;
	color: #DDD;
}
</style>

  
</aside>
    <div class="nexmoe-copyright">
        &copy; 2023 John Doe
        Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
        & <a href="https://github.com/zhangboc/hexo.github.io/" target="_blank">ZhangboCheng</a><br/>
        <a href="http://beian.miit.gov.cn" target="_blank">辽ICP备2021002341号</a><br/>
        
        <div style="font-size: 12px">
            <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
            本站总访问量  <a id="busuanzi_value_site_pv"></a> 次<br />
            本站访客数<a id="busuanzi_value_site_uv"></a>人次
        </div>
        <span id="timeDate">载入天数...</span><span id="times">载入时分秒...</span>
        <script>
            var now = new Date(); 
            function createtime() { 
                var grt= new Date("08/10/2018 17:38:00");//在此处修改你的建站时间，格式：月/日/年 时:分:秒
                now.setTime(now.getTime()+250); 
                days = (now - grt ) / 1000 / 60 / 60 / 24; dnum = Math.floor(days); 
                hours = (now - grt ) / 1000 / 60 / 60 - (24 * dnum); hnum = Math.floor(hours); 
                if(String(hnum).length ==1 ){hnum = "0" + hnum;} minutes = (now - grt ) / 1000 /60 - (24 * 60 * dnum) - (60 * hnum); 
                mnum = Math.floor(minutes); if(String(mnum).length ==1 ){mnum = "0" + mnum;} 
                seconds = (now - grt ) / 1000 - (24 * 60 * 60 * dnum) - (60 * 60 * hnum) - (60 * mnum); 
                snum = Math.round(seconds); if(String(snum).length ==1 ){snum = "0" + snum;} 
                document.getElementById("timeDate").innerHTML = "本站已安全运行 "+dnum+" 天 "; 
                document.getElementById("times").innerHTML = hnum + " 小时 " + mnum + " 分 " + snum + " 秒"; 
    } 
setInterval("createtime()",250);
</script>


        
        
    </div>

</div><!-- .nexmoe-drawer -->

  </div>
  <div id="nexmoe-content">
    <div class="nexmoe-primary">
        <div class="nexmoe-post">
    
        <div class="nexmoe-post-cover" style="padding-bottom: 26.666666666666668%;">
            <img data-src="https://img1.baidu.com/it/u=413643897,2296924942&fm=253&fmt=auto&app=138&f=JPEG?w=800&h=500" data-sizes="auto" alt="Ceph与KVM集成" class="lazyload">
            <h1>Ceph与KVM集成</h1>
        </div>
    

        <div class="nexmoe-post-meta nexmoe-rainbow" style="margin:10px 0!important;">
    <a><i class="nexmoefont icon-calendar-fill"></i>2023年04月20日</a>
    <a><i class="nexmoefont icon-areachart"></i>10.6k 字</a>
    <a><i class="nexmoefont icon-time-circle-fill"></i>大概 61 分钟</a>
</div>

        <div class="nexmoe-post-right">
            
        </div>

        <article>
            <h1><span id></span></h1><span id="more"></span>

<!-- toc -->

<ul>
<li><a href="#%E4%B8%80-%E6%9F%A5%E7%9C%8B%E8%99%9A%E6%8B%9F%E6%9C%BA%E6%98%AF%E5%90%A6%E6%94%AF%E6%8C%81%E8%99%9A%E6%8B%9F%E5%8C%96">一、查看虚拟机是否支持虚拟化</a></li>
<li><a href="#%E4%BA%8C-%E5%AE%89%E8%A3%85kvm">二、安装KVM</a></li>
<li><a href="#%E4%B8%89-%E9%80%9A%E8%BF%87kvm%E5%AE%89%E8%A3%85%E8%99%9A%E6%8B%9F%E6%9C%BA">三、通过KVM安装虚拟机</a></li>
<li><a href="#%E5%9B%9B-qemu%E5%AF%B9%E6%8E%A5rbd%E5%AD%98%E5%82%A8%E5%9D%97">四、QEMU对接RBD存储块</a><ul>
<li><a href="#%E4%BA%94-libvirt%E5%AF%B9%E6%8E%A5kvm%E8%AF%A6%E8%A7%A3">五、Libvirt对接KVM详解</a></li>
<li><a href="#51-%E5%88%9B%E5%BB%BA%E4%B8%80%E4%B8%AA%E6%B1%A0-%E4%BB%A5%E4%B8%8B%E7%A4%BA%E4%BE%8B%E4%BD%BF%E7%94%A8%E6%B1%A0%E5%90%8D%E7%A7%B0libvirt-pool">5.1、创建一个池。以下示例使用池名称libvirt-pool.：</a></li>
<li><a href="#52-%E4%BD%BF%E7%94%A8rbd%E5%B7%A5%E5%85%B7%E5%88%9D%E5%A7%8B%E5%8C%96%E6%B1%A0%E4%BB%A5%E4%BE%9B-rbd-%E4%BD%BF%E7%94%A8">5.2、使用rbd工具初始化池以供 RBD 使用：</a></li>
<li><a href="#53-%E5%88%9B%E5%BB%BA-ceph-%E7%94%A8%E6%88%B7%E6%88%96%E7%94%A8%E4%BA%8Eclientadmin097-%E5%8F%8A%E6%9B%B4%E6%97%A9%E7%89%88%E6%9C%AC-%E4%BB%A5%E4%B8%8B%E7%A4%BA%E4%BE%8B%E4%BD%BF%E7%94%A8-ceph-%E7%94%A8%E6%88%B7%E5%90%8Dclientlibvirt-%E5%92%8C%E5%BC%95%E7%94%A8libvirt-pool">5.3、创建 Ceph 用户（或用于client.admin0.9.7 及更早版本）。以下示例使用 Ceph 用户名client.libvirt 和引用libvirt-pool。</a></li>
<li><a href="#54-%E4%BD%BF%E7%94%A8-qemu%E5%9C%A8-rbd-%E6%B1%A0%E4%B8%AD%E5%88%9B%E5%BB%BA%E6%98%A0%E5%83%8F-%E4%BB%A5%E4%B8%8B%E7%A4%BA%E4%BE%8B%E4%BD%BF%E7%94%A8%E5%9B%BE%E5%83%8F%E5%90%8D%E7%A7%B0new-libvirt-image-%E5%92%8C%E5%BC%95%E7%94%A8libvirt-pool">5.4、使用 QEMU在 RBD 池中创建映像。以下示例使用图像名称new-libvirt-image 和引用libvirt-pool。</a></li>
<li><a href="#55-%E9%85%8D%E7%BD%AE%E8%99%9A%E6%8B%9F%E6%9C%BA">5.5、配置虚拟机</a><ul>
<li><a href="#551-%E4%BD%BF%E7%94%A8-virsh-edit%E6%89%93%E5%BC%80%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6">5.5.1、使用 virsh edit打开配置文件。</a></li>
<li><a href="#552-%E5%A6%82%E6%9E%9C%E6%82%A8%E7%9A%84-ceph-%E5%AD%98%E5%82%A8%E9%9B%86%E7%BE%A4%E5%90%AF%E7%94%A8%E4%BA%86ceph-%E8%BA%AB%E4%BB%BD%E9%AA%8C%E8%AF%81%E9%BB%98%E8%AE%A4%E6%83%85%E5%86%B5%E4%B8%8B%E5%90%AF%E7%94%A8%E6%82%A8%E5%BF%85%E9%A1%BB%E7%94%9F%E6%88%90%E4%B8%80%E4%B8%AA%E5%AF%86%E9%92%A5">5.5.2、如果您的 Ceph 存储集群启用了Ceph 身份验证（默认情况下启用），您必须生成一个密钥。</a></li>
<li><a href="#553-%E5%AE%9A%E4%B9%89%E5%AF%86%E9%92%A5">5.5.3、定义密钥。</a></li>
<li><a href="#554-%E8%8E%B7%E5%8F%96clientlibvirt%E5%AF%86%E9%92%A5%E5%B9%B6%E5%B0%86%E5%AF%86%E9%92%A5%E5%AD%97%E7%AC%A6%E4%B8%B2%E4%BF%9D%E5%AD%98%E5%88%B0%E6%96%87%E4%BB%B6%E4%B8%AD">5.5.4、获取client.libvirt密钥并将密钥字符串保存到文件中。</a></li>
<li><a href="#555-%E8%AE%BE%E7%BD%AE%E5%AF%86%E9%92%A5%E7%9A%84-uuid">5.5.5、设置密钥的 UUID。</a></li>
<li><a href="#556-%E4%BF%AE%E6%94%B9%E8%99%9A%E6%8B%9F%E6%9C%BA%E6%96%87%E4%BB%B6%E5%A2%9E%E5%8A%A0%E8%AE%A4%E8%AF%81">5.5.6、修改虚拟机文件，增加认证</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#%E5%85%AD-kvm%E5%AF%B9%E6%8E%A5%E6%B5%8B%E8%AF%95%E5%8F%8A%E6%89%A9%E5%AE%B9">六、KVM对接测试及扩容</a><ul>
<li><a href="#61-%E5%AF%B9%E6%8E%A5%E6%B5%8B%E8%AF%95">6.1、对接测试</a></li>
<li><a href="#62-%E6%89%A9%E5%AE%B9%E5%A4%A7%E5%B0%8F">6.2、扩容大小</a></li>
</ul>
</li>
<li><a href="#%E4%B8%83-%E7%B3%BB%E7%BB%9F%E7%9B%98%E5%AD%98%E5%82%A8%E8%87%B3ceph%E4%B9%9F%E5%8F%AF%E7%94%A8%E4%BA%8E%E8%BF%81%E7%A7%BB%E5%88%B0ceph%E9%9B%86%E7%BE%A4%E4%B8%AD">七、系统盘存储至Ceph（也可用于迁移到ceph集群中）</a><ul>
<li><a href="#71-%E4%B8%BB%E6%9C%BA%E5%81%9C%E6%9C%BA">7.1、主机停机</a></li>
<li><a href="#72-%E8%BD%AC%E6%8D%A2%E6%A0%BC%E5%BC%8F%E5%AD%98%E6%94%BE%E5%9C%A8ceph%E9%9B%86%E7%BE%A4%E4%B8%AD">7.2、转换格式存放在ceph集群中</a></li>
<li><a href="#73-%E4%BF%AE%E6%94%B9%E4%B8%BB%E6%9C%BAxml%E6%96%87%E4%BB%B6">7.3、修改主机xml文件</a></li>
</ul>
</li>
<li><a href="#%E5%85%AB-%E6%8F%AD%E7%A7%98%E4%BA%91%E4%B8%BB%E6%9C%BA%E7%A7%92%E7%BA%A7%E9%83%A8%E7%BD%B2%E5%A5%A5%E7%A7%98">八、揭秘云主机秒级部署奥秘</a><ul>
<li><a href="#81-%E5%88%9B%E5%BB%BA%E5%BF%AB%E7%85%A7">8.1、创建快照</a></li>
<li><a href="#82-%E5%AF%B9%E5%BF%AB%E7%85%A7%E5%A2%9E%E5%8A%A0%E4%BF%9D%E6%8A%A4">8.2、对快照增加保护</a></li>
<li><a href="#83-%E6%9F%A5%E7%9C%8B%E5%BF%AB%E7%85%A7%E4%BF%9D%E6%8A%A4">8.3、查看快照保护</a></li>
<li><a href="#84-%E5%85%8B%E9%9A%86%E9%95%9C%E5%83%8F">8.4、克隆镜像</a></li>
<li><a href="#85-%E6%9F%A5%E7%9C%8B%E5%85%8B%E9%9A%86%E9%95%9C%E5%83%8F">8.5、查看克隆镜像</a></li>
<li><a href="#86-%E9%85%8D%E7%BD%AE%E8%99%9A%E6%8B%9F%E6%9C%BAxml%E6%96%87%E4%BB%B6">8.6、配置虚拟机xml文件</a></li>
<li><a href="#87-%E5%BC%95%E5%85%A5xml%E6%96%87%E4%BB%B6">8.7、引入XML文件</a></li>
<li><a href="#88-%E5%BC%80%E6%9C%BA%E5%B9%B6%E6%B5%8B%E8%AF%95">8.8、开机并测试</a></li>
</ul>
</li>
</ul>
<!-- tocstop -->

<h1><span id="一-查看虚拟机是否支持虚拟化">一、查看虚拟机是否支持虚拟化</span></h1><p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/huangyanqi/p/8591586.html">KVM参考文档</a><br><a target="_blank" rel="noopener" href="https://docs.ceph.com/en/octopus/rbd/qemu-rbd/">Ceph与KVM集成官方文档-qemu</a><br><a target="_blank" rel="noopener" href="https://docs.ceph.com/en/octopus/rbd/libvirt/">Ceph与KVM集成官方文档-libvirt</a></p>
<pre><code>[root@node-1 ~]# lscpu | grep vmx #查看并没有开启嵌套虚拟化，需要在VMware中开启
[root@node-1 ~]#  poweroff #关机
</code></pre>
<p><img src="/images/Ceph/Ceph%E4%B8%8EKVM%E9%9B%86%E6%88%90/1.jpg"></p>
<h1><span id="二-安装kvm">二、安装KVM</span></h1><pre><code>[root@node-1 ~]# yum groupinstall &quot;Virtualization Host&quot; -y
启动服务：
[root@node-1 ~]# systemctl start libvirtd &amp;&amp; systemctl enable libvirtd
查看KVM状态：
[root@node-1 ~]# virsh list --all #安装成功
 Id    名称                         状态
----------------------------------------------------
[root@node-1 ~]# yum install virt-manager -y #安装图形化管理工具，适合没有KVM基础的人
[root@node-1 ~]#  yum install dejavu-lgc-sans-fonts #如果图形化工具打开乱码可以尝试安装这个包，如果还不行，就修改系统的语言为英文
</code></pre>
<h1><span id="三-通过kvm安装虚拟机">三、通过KVM安装虚拟机</span></h1><pre><code>[root@node-1 ~]# qemu-img create -f qcow2 /var/lib/libvirt/images/demo.img 4G #在images文件夹下创建一个4G的块设备，叫demo.img
Formatting &#39;/var/lib/libvirt/images/demo.img&#39;, fmt=qcow size=4294967296 encryption=off 

[root@node-1 ~]# file /var/lib/libvirt/images/demo.img #查看文件类型
/var/lib/libvirt/images/demo.img: QEMU QCOW Image (v1), 4294967296 bytes
[root@node-1 ~]# qemu-img info /var/lib/libvirt/images/demo.img #查看创建信息
image: /var/lib/libvirt/images/demo.img
file format: qcow2
virtual size: 4.0G (4294967296 bytes)
disk size: 20K
cluster_size: 4096
[root@node-1 ~]# yum install libguestfs-tools virt-install.noarch lrzsz -y
[root@node-1 ~]# virt-install --help
usage: virt-install --name NAME --memory MB STORAGE INSTALL [options]

从指定安装源创建新虚拟机。

optional arguments:
  -h, --help            show this help message and exit
  --version             show program&#39;s version number and exit
  --connect URI         通过 libvirt URI 连接到虚拟机管理程序

通用选项:
  -n NAME, --name NAME  客户机实例名称
  --memory MEMORY       Configure guest memory allocation. Ex:
                        --memory 1024 (in MiB)
                        --memory 512,maxmemory=1024
                        --memory 512,maxmemory=1024,hotplugmemorymax=2048,hotplugmemoryslots=2
  --vcpus VCPUS         Number of vcpus to configure for your guest. Ex:
                        --vcpus 5
                        --vcpus 5,maxvcpus=10,cpuset=1-4,6,8
                        --vcpus sockets=2,cores=4,threads=2
  --cpu CPU             CPU model and features. Ex:
                        --cpu coreduo,+x2apic
                        --cpu host-passthrough
                        --cpu host
  --metadata METADATA   配置客户机元数据。例如：
                        --metadata name=foo,title=&quot;My pretty title&quot;,uuid=...
                        --metadata description=&quot;My nice long description&quot;

安装方法选项:
  --cdrom CDROM         光驱安装介质
  -l LOCATION, --location LOCATION
                        安装源 (例如：nfs:host:/path, http://host/path,
                        ftp://host/path)
  --pxe                 使用 PXE 协议从网络引导
  --import              在已有的磁盘镜像中构建客户机
  --livecd              将光驱介质视为 Live CD
  -x EXTRA_ARGS, --extra-args EXTRA_ARGS
                        将附加参数添加到由 --location
                        引导的内核中
  --initrd-inject INITRD_INJECT
                        添加指定文件到由 --location 指定的 initrd
                        根中
  --os-variant DISTRO_VARIANT
                        在客户机上安装的操作系统，例如：&#39;fedor
                        a18&#39;、&#39;rhel6&#39;、&#39;winxp&#39; 等。
  --boot BOOT           配置客户机引导设置。例如：
                        --boot hd,cdrom,menu=on
                        --boot init=/sbin/init (针对容器)
  --idmap IDMAP         为 LXC 容器启用用户名称空间。例如：
                        --idmap uid_start=0,uid_target=1000,uid_count=10

设备选项:
  --disk DISK           指定存储的各种选项。例如：
                        --disk size=10 (在默认位置创建 10GiB 镜像)
                        --disk /my/existing/disk,cache=none
                        --disk device=cdrom,bus=scsi
                        --disk=?
  -w NETWORK, --network NETWORK
                        配置客户机网络接口。例如：
                        --network bridge=mybr0
                        --network network=my_libvirt_virtual_net
                        --network network=mynet,model=virtio,mac=00:11...
                        --network none
                        --network help
  --graphics GRAPHICS   配置客户机显示设置。例如：
                        --graphics vnc
                        --graphics spice,port=5901,tlsport=5902
                        --graphics none
                        --graphics vnc,password=foobar,port=5910,keymap=ja
  --controller CONTROLLER
                        配置客户机控制器设备。例如：
                        --controller type=usb,model=ich9-ehci1
  --input INPUT         配置客户机输入设备。例如：
                        --input tablet
                        --input keyboard,bus=usb
  --serial SERIAL       配置客户机串口设备
  --parallel PARALLEL   配置客户机并口设备
  --channel CHANNEL     配置客户机通信通道
  --console CONSOLE     配置文本控制台连接主机与客户机
  --hostdev HOSTDEV     配置物理 USB/PCI 等主机设备与客户机共享
  --filesystem FILESYSTEM
                        传递主机目录到客户机。例如：
                        --filesystem /my/source/dir,/dir/in/guest
                        --filesystem template_name,/,type=template
  --sound [SOUND]       配置客户机声音设备仿真
  --watchdog WATCHDOG   配置客户机 watchdog 设备
  --video VIDEO         配置客户机视频硬件。
  --smartcard SMARTCARD
                        配置客户机智能卡设备。例如：
                        --smartcard mode=passthrough
  --redirdev REDIRDEV   配置客户机重定向设备。例如：
                        --redirdev usb,type=tcp,server=192.168.1.1:4000
  --memballoon MEMBALLOON
                        配置客户机 memballoon 设备。例如：
                        --memballoon model=virtio
  --tpm TPM             配置客户机 TPM 设备。例如：
                        --tpm /dev/tpm
  --rng RNG             Configure a guest RNG device. Ex:
                        --rng /dev/urandom
  --panic PANIC         配置客户机 panic 设备。例如：
                        --panic default
  --memdev MEMDEV       Configure a guest memory device. Ex:
                        --memdev dimm,target_size=1024

客户机配置选项:
  --security SECURITY   设置域安全驱动配置。
  --cputune CPUTUNE     Tune CPU parameters for the domain process.
  --numatune NUMATUNE   为域进程调整 NUMA 策略。
  --memtune MEMTUNE     为域进程调整内存策略。
  --blkiotune BLKIOTUNE
                        为域进程调整 blkio 策略。
  --memorybacking MEMORYBACKING
                        为域进程设置内存后备策略。例如：
                        --memorybacking hugepages=on
  --features FEATURES   设置域 &lt;features&gt; XML。例如：
                        --features acpi=off
                        --features apic=on,eoi=on
  --clock CLOCK         设置域 &lt;clock&gt; XML。例如：
                        --clock offset=localtime,rtc_tickpolicy=catchup
  --pm PM               配置 VM 电源管理功能
  --events EVENTS       配置 VM 生命周期管理策略
  --resource RESOURCE   配置 VM 资源分区(cgroups)
  --sysinfo SYSINFO     Configure SMBIOS System Information. Ex:
                        --sysinfo emulate
                        --sysinfo host
                        --sysinfo bios_vendor=Vendor_Inc.,bios_version=1.2.3-abc,...
                        --sysinfo system_manufacturer=System_Corp.,system_product=Computer,...
                        --sysinfo baseBoard_manufacturer=Baseboard_Corp.,baseBoard_product=Motherboard,...
  --qemu-commandline QEMU_COMMANDLINE
                        Pass arguments directly to the qemu emulator. Ex:
                        --qemu-commandline=&#39;-display gtk,gl=on&#39;
                        --qemu-commandline env=DISPLAY=:0.1

虚拟化平台选项:
  -v, --hvm             这个客户机应该是一个全虚拟化客户机
  -p, --paravirt        这个客户机应该是一个半虚拟化客户机
  --container           这个客户机应该是一个容器客户机
  --virt-type HV_TYPE   要使用的管理程序名称 (kvm, qemu, xen, ...)
  --arch ARCH           模拟 CPU 架构
  --machine MACHINE     机器类型为仿真类型

其它选项:
  --autostart           主机启动时自动启动域。
  --transient           Create a transient domain.
  --wait WAIT           请等待数分钟以便完成安装。
  --noautoconsole       不要自动尝试连接到客户端控制台
  --noreboot            安装完成后不启动客户机。
  --print-xml [XMLONLY]
                        打印生成的 XML 域，而不是创建客户机。
  --dry-run             运行安装程序，但不创建设备或定义客户
                        机。
  --check CHECK         启用或禁用验证检查。例如：
                        --check path_in_use=off
                        --check all=off
  -q, --quiet           抑制非错误输出
  -d, --debug           输入故障排除信息

使用 &#39;--option=?&#39; 或 &#39;--option help&#39; 来查看可用的子选项
请参考 man 手册，以便了解示例和完整的选项语法。

[root@node-1 ~]# virt-install --name demo --memory 1024 --vcpus 1 --disk /var/lib/libvirt/images/demo.img --network default --graphics vnc,password=redhat,listen=0.0.0.0 --cdrom /root/CentOS-7-x86_64-Minimal-2009.iso --noautoconsole #开始安装
WARNING  未检测到操作系统，虚拟机性能可能会受到影响。使用 --os-variant 选项指定操作系统以获得最佳性能。

开始安装......
ERROR    内部错误：process exited while connecting to monitor: 2023-03-18T14:47:07.198668Z qemu-kvm: -drive file=/root/CentOS-7-x86_64-Minimal-2009.iso,format=raw,if=none,id=drive-ide0-0-1,readonly=on: could not open disk image /root/CentOS-7-x86_64-Minimal-2009.iso: Could not open &#39;/root/CentOS-7-x86_64-Minimal-2009.iso&#39;: Permission denied
域安装失败，您可以运行下列命令重启您的域：
&#39;virsh start virsh --connect qemu:///system start demo&#39;
否则请重新开始安装。
</code></pre>
<pre><code>#通过上述报错后可得出权限不足
[root@node-1 ~]# tail -f /var/log/libvirt/qemu/demo.log #查看报错日志
[root@node-1 ~]# vim /etc/libvirt/qemu.conf #设置root权限
</code></pre>
<p><img src="/images/Ceph/Ceph%E4%B8%8EKVM%E9%9B%86%E6%88%90/2.jpg"></p>
<pre><code>[root@node-1 ~]# virt-install --name demo --memory 1024 --vcpus 1 --disk /var/lib/libvirt/images/demo.img --network default --graphics vnc,password=redhat,listen=0.0.0.0 --cdrom /root/CentOS-7-x86_64-Minimal-2009.iso --noautoconsole #再次执行创建成功
WARNING  未检测到操作系统，虚拟机性能可能会受到影响。使用 --os-variant 选项指定操作系统以获得最佳性能。

开始安装......
域安装仍在进行。您可以重新连接
到控制台以便完成安装进程。
参数详解：
--name：主机名称
--memory：内存大小：M
--vcpus：CPU核心数：H
--disk：硬盘路径
--network: 指定默认网络
--graphics: 指定使用VNC，并且设置VNC密码为redhat，监听全部地址
--cdrom:使用光盘的方式进行安装
--noautoconsole:不要自动尝试连接到客户端控制台
[root@node-1 ~]# virsh list --all  #查看创建成功
 Id    名称                         状态
----------------------------------------------------
 1     demo                           running
[root@node-1 ~]# virsh vncdisplay demo #查看主机demo的VNC监听地址
:0
</code></pre>
<p><a target="_blank" rel="noopener" href="https://downloads.realvnc.com/download/file/viewer.files/VNC-Viewer-7.0.1-Windows.exe">VNC-viewer下载地址</a></p>
<p>输入KVM的地址加监听的端口号，并点击继续:</p>
<p><img src="/images/Ceph/Ceph%E4%B8%8EKVM%E9%9B%86%E6%88%90/3.jpg"></p>
<p>输入密码：redhat</p>
<p><img src="/images/Ceph/Ceph%E4%B8%8EKVM%E9%9B%86%E6%88%90/4.jpg"></p>
<p>安装操作系统</p>
<p><img src="/images/Ceph/Ceph%E4%B8%8EKVM%E9%9B%86%E6%88%90/5.jpg"><br><img src="/images/Ceph/Ceph%E4%B8%8EKVM%E9%9B%86%E6%88%90/6.jpg"></p>
<pre><code>[root@node-1 ~]# virsh start demo #主机重启后可能需要手动开机
域 demo 已开始
[root@node-1 ~]# cat /etc/libvirt/qemu/demo.xml  #查看生成的xml文件
&lt;!--
WARNING: THIS IS AN AUTO-GENERATED FILE. CHANGES TO IT ARE LIKELY TO BE
OVERWRITTEN AND LOST. Changes to this xml configuration should be made using:
  virsh edit demo
or other application using the libvirt API.
--&gt;

&lt;domain type=&#39;kvm&#39;&gt;
  &lt;name&gt;demo&lt;/name&gt;
  &lt;uuid&gt;a379dd0c-025c-4fd8-bbe0-0835c9ce03a1&lt;/uuid&gt;
  &lt;memory unit=&#39;KiB&#39;&gt;1048576&lt;/memory&gt;
  &lt;currentMemory unit=&#39;KiB&#39;&gt;1048576&lt;/currentMemory&gt;
  &lt;vcpu placement=&#39;static&#39;&gt;1&lt;/vcpu&gt;
  &lt;os&gt;
    &lt;type arch=&#39;x86_64&#39; machine=&#39;pc-i440fx-rhel7.0.0&#39;&gt;hvm&lt;/type&gt;
    &lt;boot dev=&#39;hd&#39;/&gt;
  &lt;/os&gt;
  &lt;features&gt;
    &lt;acpi/&gt;
    &lt;apic/&gt;
  &lt;/features&gt;
  &lt;cpu mode=&#39;custom&#39; match=&#39;exact&#39; check=&#39;partial&#39;&gt;
    &lt;model fallback=&#39;allow&#39;&gt;Broadwell-noTSX-IBRS&lt;/model&gt;
    &lt;feature policy=&#39;require&#39; name=&#39;md-clear&#39;/&gt;
    &lt;feature policy=&#39;require&#39; name=&#39;spec-ctrl&#39;/&gt;
    &lt;feature policy=&#39;require&#39; name=&#39;ssbd&#39;/&gt;
  &lt;/cpu&gt;
  &lt;clock offset=&#39;utc&#39;&gt;
    &lt;timer name=&#39;rtc&#39; tickpolicy=&#39;catchup&#39;/&gt;
    &lt;timer name=&#39;pit&#39; tickpolicy=&#39;delay&#39;/&gt;
    &lt;timer name=&#39;hpet&#39; present=&#39;no&#39;/&gt;
  &lt;/clock&gt;
  &lt;on_poweroff&gt;destroy&lt;/on_poweroff&gt;
  &lt;on_reboot&gt;restart&lt;/on_reboot&gt;
  &lt;on_crash&gt;destroy&lt;/on_crash&gt;
  &lt;pm&gt;
    &lt;suspend-to-mem enabled=&#39;no&#39;/&gt;
    &lt;suspend-to-disk enabled=&#39;no&#39;/&gt;
  &lt;/pm&gt;
  &lt;devices&gt;
    &lt;emulator&gt;/usr/libexec/qemu-kvm&lt;/emulator&gt;
    &lt;disk type=&#39;file&#39; device=&#39;disk&#39;&gt;
      &lt;driver name=&#39;qemu&#39; type=&#39;qcow2&#39;/&gt;
      &lt;source file=&#39;/var/lib/libvirt/images/demo.img&#39;/&gt;
      &lt;target dev=&#39;hda&#39; bus=&#39;ide&#39;/&gt;
      &lt;address type=&#39;drive&#39; controller=&#39;0&#39; bus=&#39;0&#39; target=&#39;0&#39; unit=&#39;0&#39;/&gt;
    &lt;/disk&gt;
    &lt;disk type=&#39;file&#39; device=&#39;cdrom&#39;&gt;
      &lt;driver name=&#39;qemu&#39; type=&#39;raw&#39;/&gt;
      &lt;target dev=&#39;hdb&#39; bus=&#39;ide&#39;/&gt;
      &lt;readonly/&gt;
      &lt;address type=&#39;drive&#39; controller=&#39;0&#39; bus=&#39;0&#39; target=&#39;0&#39; unit=&#39;1&#39;/&gt;
    &lt;/disk&gt;
    &lt;controller type=&#39;usb&#39; index=&#39;0&#39; model=&#39;ich9-ehci1&#39;&gt;
      &lt;address type=&#39;pci&#39; domain=&#39;0x0000&#39; bus=&#39;0x00&#39; slot=&#39;0x04&#39; function=&#39;0x7&#39;/&gt;
    &lt;/controller&gt;
    &lt;controller type=&#39;usb&#39; index=&#39;0&#39; model=&#39;ich9-uhci1&#39;&gt;
      &lt;master startport=&#39;0&#39;/&gt;
      &lt;address type=&#39;pci&#39; domain=&#39;0x0000&#39; bus=&#39;0x00&#39; slot=&#39;0x04&#39; function=&#39;0x0&#39; multifunction=&#39;on&#39;/&gt;
    &lt;/controller&gt;
    &lt;controller type=&#39;usb&#39; index=&#39;0&#39; model=&#39;ich9-uhci2&#39;&gt;
      &lt;master startport=&#39;2&#39;/&gt;
      &lt;address type=&#39;pci&#39; domain=&#39;0x0000&#39; bus=&#39;0x00&#39; slot=&#39;0x04&#39; function=&#39;0x1&#39;/&gt;
    &lt;/controller&gt;
    &lt;controller type=&#39;usb&#39; index=&#39;0&#39; model=&#39;ich9-uhci3&#39;&gt;
      &lt;master startport=&#39;4&#39;/&gt;
      &lt;address type=&#39;pci&#39; domain=&#39;0x0000&#39; bus=&#39;0x00&#39; slot=&#39;0x04&#39; function=&#39;0x2&#39;/&gt;
    &lt;/controller&gt;
    &lt;controller type=&#39;pci&#39; index=&#39;0&#39; model=&#39;pci-root&#39;/&gt;
    &lt;controller type=&#39;ide&#39; index=&#39;0&#39;&gt;
      &lt;address type=&#39;pci&#39; domain=&#39;0x0000&#39; bus=&#39;0x00&#39; slot=&#39;0x01&#39; function=&#39;0x1&#39;/&gt;
    &lt;/controller&gt;
    &lt;interface type=&#39;network&#39;&gt;
      &lt;mac address=&#39;52:54:00:bf:29:21&#39;/&gt;
      &lt;source network=&#39;default&#39;/&gt;
      &lt;model type=&#39;rtl8139&#39;/&gt;
      &lt;address type=&#39;pci&#39; domain=&#39;0x0000&#39; bus=&#39;0x00&#39; slot=&#39;0x03&#39; function=&#39;0x0&#39;/&gt;
    &lt;/interface&gt;
    &lt;serial type=&#39;pty&#39;&gt;
      &lt;target type=&#39;isa-serial&#39; port=&#39;0&#39;&gt;
        &lt;model name=&#39;isa-serial&#39;/&gt;
      &lt;/target&gt;
    &lt;/serial&gt;
    &lt;console type=&#39;pty&#39;&gt;
      &lt;target type=&#39;serial&#39; port=&#39;0&#39;/&gt;
    &lt;/console&gt;
    &lt;input type=&#39;mouse&#39; bus=&#39;ps2&#39;/&gt;
    &lt;input type=&#39;keyboard&#39; bus=&#39;ps2&#39;/&gt;
    &lt;graphics type=&#39;vnc&#39; port=&#39;-1&#39; autoport=&#39;yes&#39; listen=&#39;0.0.0.0&#39; passwd=&#39;redhat&#39;&gt;
      &lt;listen type=&#39;address&#39; address=&#39;0.0.0.0&#39;/&gt;
    &lt;/graphics&gt;
    &lt;video&gt;
      &lt;model type=&#39;cirrus&#39; vram=&#39;16384&#39; heads=&#39;1&#39; primary=&#39;yes&#39;/&gt;
      &lt;address type=&#39;pci&#39; domain=&#39;0x0000&#39; bus=&#39;0x00&#39; slot=&#39;0x02&#39; function=&#39;0x0&#39;/&gt;
    &lt;/video&gt;
    &lt;memballoon model=&#39;virtio&#39;&gt;
      &lt;address type=&#39;pci&#39; domain=&#39;0x0000&#39; bus=&#39;0x00&#39; slot=&#39;0x05&#39; function=&#39;0x0&#39;/&gt;
    &lt;/memballoon&gt;
  &lt;/devices&gt;
&lt;/domain&gt;
</code></pre>
<h1><span id="四-qemu对接rbd存储块">四、QEMU对接RBD存储块</span></h1><p><img src="/images/Ceph/Ceph%E4%B8%8EKVM%E9%9B%86%E6%88%90/7.jpg"></p>
<pre><code>[root@node-1 ~]# ceph osd lspools #查看当前pool
4 .rgw.root
5 default.rgw.control
6 default.rgw.meta
7 default.rgw.log
13 ceph-demo
14 default.rgw.buckets.index
15 default.rgw.buckets.data
16 cephfs_data
17 cephfs_metadata
18 kubernetes
[root@node-1 ~]# qemu-img create -f raw rbd:ceph-demo/kvm-test.img 5G  #通过qemu在ceph的存储池中创建一个RBD块设备
Formatting &#39;rbd:ceph-demo/kvm-test.img&#39;, fmt=raw size=5368709120 cluster_size=0 
[root@node-1 ~]# rbd info ceph-demo/kvm-test.img #查看创建的块设备
rbd image &#39;kvm-test.img&#39;:
    size 5 GiB in 1280 objects
    order 22 (4 MiB objects)
    snapshot_count: 0
    id: 58e90a051900e
    block_name_prefix: rbd_data.58e90a051900e
    format: 2
    features: layering, exclusive-lock, object-map, fast-diff, deep-flatten
    op_features: 
    flags: 
    create_timestamp: Sat Mar 18 23:23:31 2023
    access_timestamp: Sat Mar 18 23:23:31 2023
    modify_timestamp: Sat Mar 18 23:23:31 2023
[root@node-1 ~]# rbd -p ceph-demo ls #查看块设备
kvm-test.img
rbd-bakup.img
rbd.img
test-demo
test-demo-1.img
test-demo-3.img
[root@node-1 ~]# qemu-img resize rbd:ceph-demo/kvm-test.img 6G #通过qume调整rbd大小
Image resized.
[root@node-1 ~]# rbd info ceph-demo/kvm-test.img
rbd image &#39;kvm-test.img&#39;:
    size 6 GiB in 1536 objects
    order 22 (4 MiB objects)
    snapshot_count: 0
    id: 58e90a051900e
    block_name_prefix: rbd_data.58e90a051900e
    format: 2
    features: layering, exclusive-lock, object-map, fast-diff, deep-flatten
    op_features: 
    flags: 
    create_timestamp: Sat Mar 18 23:23:31 2023
    access_timestamp: Sat Mar 18 23:27:12 2023
    modify_timestamp: Sat Mar 18 23:23:31 2023
</code></pre>
<h2><span id="五-libvirt对接kvm详解">五、Libvirt对接KVM详解</span></h2><p><img src="/images/Ceph/Ceph%E4%B8%8EKVM%E9%9B%86%E6%88%90/8.jpg"></p>
<h2><span id="51-创建一个池-以下示例使用池名称libvirt-pool">5.1、创建一个池。以下示例使用池名称libvirt-pool.：</span></h2><pre><code>[root@node-1 ~]# ceph osd pool create libvirt-pool 16 16
pool &#39;libvirt-pool&#39; created
验证池是否存在。
[root@node-1 ~]# ceph osd lspools
4 .rgw.root
5 default.rgw.control
6 default.rgw.meta
7 default.rgw.log
13 ceph-demo
14 default.rgw.buckets.index
15 default.rgw.buckets.data
16 cephfs_data
17 cephfs_metadata
18 kubernetes
19 libvirt-pool #创建成功
</code></pre>
<h2><span id="52-使用rbd工具初始化池以供-rbd-使用">5.2、使用rbd工具初始化池以供 RBD 使用：</span></h2><p><code>[root@node-1 ~]# rbd pool init libvirt-pool #默认为RBD格式</code></p>
<h2><span id="53-创建-ceph-用户或用于clientadmin097-及更早版本-以下示例使用-ceph-用户名clientlibvirt-和引用libvirt-pool">5.3、创建 Ceph 用户（或用于client.admin0.9.7 及更早版本）。以下示例使用 Ceph 用户名client.libvirt 和引用libvirt-pool。</span></h2><pre><code>[root@node-1 ~]# ceph auth get-or-create client.libvirt mon &#39;profile rbd&#39; osd &#39;profile rbd pool=libvirt-pool&#39;
[client.libvirt]
    key = AQBW2hVkmdgYDBAAk/8RRIomBvQ1RjAuwJtRgw==
验证名称是否存在。
[root@node-1 ~]# ceph auth list 
mds.node-1
    key: AQCs2QpkNSE5LhAA66qFcFeSCcO7eIVGfH2kuA==
    caps: [mds] allow
    caps: [mon] allow profile mds
    caps: [osd] allow rwx
mds.node-2
    key: AQCt2Qpk7YOGIhAAeXR14T7zOVBW7B8j0t77JQ==
    caps: [mds] allow
    caps: [mon] allow profile mds
    caps: [osd] allow rwx
mds.node-3
    key: AQCu2Qpkty3yJxAAnSykxl8bEmuHqJ8TKTINDA==
    caps: [mds] allow
    caps: [mon] allow profile mds
    caps: [osd] allow rwx
osd.0
    key: AQC+0QZkOgr3FhAAQv9XW7FIaZAxchn1osNoLA==
    caps: [mgr] allow profile osd
    caps: [mon] allow profile osd
    caps: [osd] allow *
osd.1
    key: AQDN0QZkomSUHBAAzHUP9FglHxndMZwzPlXwrQ==
    caps: [mgr] allow profile osd
    caps: [mon] allow profile osd
    caps: [osd] allow *
osd.2
    key: AQDf0QZk0A++IRAAQFRGoyjoaPhB+FgatmxA4A==
    caps: [mgr] allow profile osd
    caps: [mon] allow profile osd
    caps: [osd] allow *
osd.3
    key: AQDu0QZkcuv5CBAApo23xWc/aF79lfRu1ZjL0g==
    caps: [mgr] allow profile osd
    caps: [mon] allow profile osd
    caps: [osd] allow *
osd.4
    key: AQAL0gZkQylZBBAA7nm9rCSwdqiuKn+rRewcsw==
    caps: [mgr] allow profile osd
    caps: [mon] allow profile osd
    caps: [osd] allow *
osd.5
    key: AQAY0gZkU/U3AhAAjgysqCuvYyk4wgkHz/YQQQ==
    caps: [mgr] allow profile osd
    caps: [mon] allow profile osd
    caps: [osd] allow *
client.admin
    key: AQCnzgZkNmvADRAAKAZNkmurOI4dLuviFjVvsQ==
    caps: [mds] allow *
    caps: [mgr] allow *
    caps: [mon] allow *
    caps: [osd] allow *
client.bootstrap-mds
    key: AQCnzgZkqHfADRAA7TQKHkEqb3OrkdxV9MF4Uw==
    caps: [mon] allow profile bootstrap-mds
client.bootstrap-mgr
    key: AQCnzgZkUoHADRAAdJMFHJU2vzIthSaVj3shaQ==
    caps: [mon] allow profile bootstrap-mgr
client.bootstrap-osd
    key: AQCnzgZkzonADRAAFrpte0n08NP07vpuCeNp3g==
    caps: [mon] allow profile bootstrap-osd
client.bootstrap-rbd
    key: AQCnzgZk05LADRAAVNTqEPcfoB7mQ2zoy0FiIQ==
    caps: [mon] allow profile bootstrap-rbd
client.bootstrap-rbd-mirror
    key: AQCnzgZknsXADRAAjFAgSZT+AsV+cm6CZbP9bw==
    caps: [mon] allow profile bootstrap-rbd-mirror
client.bootstrap-rgw
    key: AQCnzgZkK9PADRAAzwV5uTQbWpYyn7vcM8DAQQ==
    caps: [mon] allow profile bootstrap-rgw
client.kubernetes
    key: AQAEQRFkrYSrBxAAUNZRT6BxLS0jHzIzMQg4CQ==
    caps: [mon] profile rbd
    caps: [osd] profile rbd pool=kubernetes
client.libvirt
    key: AQBW2hVkmdgYDBAAk/8RRIomBvQ1RjAuwJtRgw==
    caps: [mon] profile rbd
    caps: [osd] profile rbd pool=libvirt-pool
client.rgw.node-1
    key: AQAPtQlk8KNzFRAAOinyE+NbWbcHfsmQnSRbyg==
    caps: [mon] allow rw
    caps: [osd] allow rwx
client.rgw.node-2
    key: AQDutwlkmakzHRAAVmxW6zS80nYyqS827qG9zg==
    caps: [mon] allow rw
    caps: [osd] allow rwx
mgr.node-1
    key: AQA60AZkz43bERAAjFnhLCkPoQX6AoxPoQZ/hA==
    caps: [mds] allow *
    caps: [mon] allow profile mgr
    caps: [osd] allow *
mgr.node-2
    key: AQA70AZk33pwBBAABdE45uQJTEtWF0fD26vYkg==
    caps: [mds] allow *
    caps: [mon] allow profile mgr
    caps: [osd] allow *
mgr.node-3
    key: AQA70AZkQwPlMxAAO/1EZp+zpQ3QB8H2OsN8/g==
    caps: [mds] allow *
    caps: [mon] allow profile mgr
    caps: [osd] allow *
installed auth entries:
</code></pre>
<blockquote>
<p>注意：libvirt将使用 ID 访问 Ceph libvirt，而不是 Ceph 名称client.libvirt。ID和名称的区别详见用户管理-用户和 用户管理-CLI 。</p>
</blockquote>
<h2><span id="54-使用-qemu在-rbd-池中创建映像-以下示例使用图像名称new-libvirt-image-和引用libvirt-pool">5.4、使用 QEMU在 RBD 池中创建映像。以下示例使用图像名称new-libvirt-image 和引用libvirt-pool。</span></h2><pre><code>[root@node-1 ~]# qemu-img create -f rbd rbd:libvirt-pool/new-libvirt-image 2G #这里-f指定的rbd也可替换成raw，效果一样
Formatting &#39;rbd:libvirt-pool/new-libvirt-image&#39;, fmt=rbd size=2147483648 cluster_size=0
验证块是否存在。
[root@node-1 ~]# rbd -p libvirt-pool ls
new-libvirt-image
[root@node-1 ~]# qemu-img info rbd:libvirt-pool/new-libvirt-image
image: rbd:libvirt-pool/new-libvirt-image
file format: raw
virtual size: 2.0G (2147483648 bytes)
disk size: unavailable
</code></pre>
<blockquote>
<p>如果您希望为此客户端启用调试日志和管理套接字，您可以将以下部分添加到&#x2F;etc&#x2F;ceph&#x2F;ceph.conf：</p>
</blockquote>
<pre><code>[client.libvirt]
log file = /var/log/ceph/qemu-guest-$pid.log
admin socket = /var/run/ceph/$cluster-$type.$id.$pid.$cctid.asok
</code></pre>
<blockquote>
<p>部分名称client.libvirt应与您在上面创建的 cephx 用户匹配。如果启用了 SELinux 或 AppArmor，请注意这可能会阻止客户端进程（通过 libvirt 的 qemu）执行某些操作，例如写入日志或操作图像或管理套接字到目标位置（或）。&#x2F;var&#x2F; log&#x2F;ceph&#x2F;var&#x2F;run&#x2F;ceph</p>
</blockquote>
<h2><span id="55-配置虚拟机">5.5、配置虚拟机</span></h2><h3><span id="551-使用-virsh-edit打开配置文件">5.5.1、使用 virsh edit打开配置文件。</span></h3><pre><code>[root@node-1 ~]# virsh edit demo #增加如下配置
    &lt;disk type=&#39;network&#39; device=&#39;disk&#39;&gt;
      &lt;driver name=&#39;qemu&#39; type=&#39;raw&#39;/&gt;
      &lt;source protocol=&#39;rbd&#39; name=&#39;libvirt-pool/new-libvirt-image&#39;&gt;
        &lt;host name=&#39;192.168.187.201&#39; port=&#39;6789&#39;/&gt;
        &lt;host name=&#39;192.168.187.202&#39; port=&#39;6789&#39;/&gt;
        &lt;host name=&#39;192.168.187.202&#39; port=&#39;6789&#39;/&gt;
      &lt;/source&gt;
      &lt;target dev=&#39;vdb&#39; bus=&#39;virtio&#39;/&gt;

    &lt;/disk&gt;

[root@node-1 ~]# virsh edit demo
&lt;domain type=&#39;kvm&#39;&gt;
  &lt;name&gt;demo&lt;/name&gt;
  &lt;uuid&gt;a379dd0c-025c-4fd8-bbe0-0835c9ce03a1&lt;/uuid&gt;
  &lt;memory unit=&#39;KiB&#39;&gt;1048576&lt;/memory&gt;
  &lt;currentMemory unit=&#39;KiB&#39;&gt;1048576&lt;/currentMemory&gt;
  &lt;vcpu placement=&#39;static&#39;&gt;1&lt;/vcpu&gt;
  &lt;os&gt;
    &lt;type arch=&#39;x86_64&#39; machine=&#39;pc-i440fx-rhel7.0.0&#39;&gt;hvm&lt;/type&gt;
    &lt;boot dev=&#39;hd&#39;/&gt;
  &lt;/os&gt;
  &lt;features&gt;
    &lt;acpi/&gt;
    &lt;apic/&gt;
  &lt;/features&gt;
  &lt;cpu mode=&#39;custom&#39; match=&#39;exact&#39; check=&#39;partial&#39;&gt;
    &lt;model fallback=&#39;allow&#39;&gt;Broadwell-noTSX-IBRS&lt;/model&gt;
    &lt;feature policy=&#39;require&#39; name=&#39;md-clear&#39;/&gt;
    &lt;feature policy=&#39;require&#39; name=&#39;spec-ctrl&#39;/&gt;
    &lt;feature policy=&#39;require&#39; name=&#39;ssbd&#39;/&gt;
  &lt;/cpu&gt;
  &lt;clock offset=&#39;utc&#39;&gt;
    &lt;timer name=&#39;rtc&#39; tickpolicy=&#39;catchup&#39;/&gt;
    &lt;timer name=&#39;pit&#39; tickpolicy=&#39;delay&#39;/&gt;
    &lt;timer name=&#39;hpet&#39; present=&#39;no&#39;/&gt;
  &lt;/clock&gt;
  &lt;on_poweroff&gt;destroy&lt;/on_poweroff&gt;
  &lt;on_reboot&gt;restart&lt;/on_reboot&gt;
  &lt;on_crash&gt;destroy&lt;/on_crash&gt;
  &lt;pm&gt;
    &lt;suspend-to-mem enabled=&#39;no&#39;/&gt;
    &lt;suspend-to-disk enabled=&#39;no&#39;/&gt;
  &lt;/pm&gt;
  &lt;devices&gt;
    &lt;emulator&gt;/usr/libexec/qemu-kvm&lt;/emulator&gt;
    &lt;disk type=&#39;file&#39; device=&#39;disk&#39;&gt;
      &lt;driver name=&#39;qemu&#39; type=&#39;qcow2&#39;/&gt;
      &lt;source file=&#39;/var/lib/libvirt/images/demo.img&#39;/&gt;
      &lt;target dev=&#39;hda&#39; bus=&#39;ide&#39;/&gt;
      &lt;address type=&#39;drive&#39; controller=&#39;0&#39; bus=&#39;0&#39; target=&#39;0&#39; unit=&#39;0&#39;/&gt;
    &lt;/disk&gt;
    &lt;disk type=&#39;file&#39; device=&#39;cdrom&#39;&gt;
      &lt;driver name=&#39;qemu&#39; type=&#39;raw&#39;/&gt;
      &lt;target dev=&#39;hdb&#39; bus=&#39;ide&#39;/&gt;
      &lt;readonly/&gt;
      &lt;address type=&#39;drive&#39; controller=&#39;0&#39; bus=&#39;0&#39; target=&#39;0&#39; unit=&#39;1&#39;/&gt;
    &lt;/disk&gt;
    &lt;disk type=&#39;network&#39; device=&#39;disk&#39;&gt;
      &lt;driver name=&#39;qemu&#39; type=&#39;raw&#39;/&gt;
      &lt;source protocol=&#39;rbd&#39; name=&#39;libvirt-pool/new-libvirt-image&#39;&gt;
        &lt;host name=&#39;192.168.187.201&#39; port=&#39;6789&#39;/&gt;
        &lt;host name=&#39;192.168.187.202&#39; port=&#39;6789&#39;/&gt;
        &lt;host name=&#39;192.168.187.203&#39; port=&#39;6789&#39;/&gt;
      &lt;/source&gt;
      &lt;target dev=&#39;vdb&#39; bus=&#39;virtio&#39;/&gt;
    &lt;/disk&gt;
    &lt;controller type=&#39;usb&#39; index=&#39;0&#39; model=&#39;ich9-ehci1&#39;&gt;
      &lt;address type=&#39;pci&#39; domain=&#39;0x0000&#39; bus=&#39;0x00&#39; slot=&#39;0x04&#39; function=&#39;0x7&#39;/&gt;
&quot;/tmp/virshJs10SR.xml&quot; 102L, 3801C written
</code></pre>
<pre><code>&lt;disk type=&#39;network&#39; device=&#39;disk&#39;&gt;
        &lt;source protocol=&#39;rbd&#39; name=&#39;libvirt-pool/new-libvirt-image&#39;&gt;
                &lt;host name=&#39;&#123;monitor-host&#125;&#39; port=&#39;6789&#39;/&gt;
        &lt;/source&gt;
        &lt;target dev=&#39;vdb&#39; bus=&#39;virtio&#39;/&gt;
&lt;/disk&gt;
</code></pre>
<blockquote>
<p>替换{monitor-host}为您的主机名，并根据需要替换池和&#x2F;或映像名称。您可以<host> 为 Ceph 监视器添加多个条目。该属性是将出现在VM 目录dev下的逻辑设备名称。&#x2F;dev可选bus属性指示要模拟的磁盘设备的类型。<br>有效设置是特定于驱动程序的（例如，“ide”、“scsi”、“virtio”、“xen”、“usb”或“sata”）。</host></p>
</blockquote>
<blockquote>
<p>重要提示：使用edit而不是vim。如果用文本编辑器 编辑配置文件，可能无法识别更改。如果 下的 XML 文件内容与 的果 不一致，则您的 VM 可能无法正常工作。sudo virsh edit&#x2F;etc&#x2F;libvirt&#x2F;qemulibvirt&#x2F;etc&#x2F;libvirt&#x2F;qemusudo virsh dumpxml {vmdomain-name}</p>
</blockquote>
<h3><span id="552-如果您的-ceph-存储集群启用了ceph-身份验证默认情况下启用您必须生成一个密钥">5.5.2、如果您的 Ceph 存储集群启用了Ceph 身份验证（默认情况下启用），您必须生成一个密钥。</span></h3><pre><code>[root@node-1 ~]# cat &gt; secret.xml &lt;&lt;EOF
&lt;secret ephemeral=&#39;no&#39; private=&#39;no&#39;&gt;
        &lt;usage type=&#39;ceph&#39;&gt;
                &lt;name&gt;client.libvirt secret&lt;/name&gt;
        &lt;/usage&gt;
&lt;/secret&gt;
EOF
</code></pre>
<h3><span id="553-定义密钥">5.5.3、定义密钥。</span></h3><pre><code>[root@node-1 ~]# sudo virsh secret-define --file secret.xml 
生成 secret efade415-5404-4b67-bd1e-165c6f64cbba
[root@node-1 ~]# virsh secret-list 
 UUID                                  用量
--------------------------------------------------------------------------------
 efade415-5404-4b67-bd1e-165c6f64cbba  ceph client.libvirt secret
[root@node-1 ~]# virsh secret-dumpxml efade415-5404-4b67-bd1e-165c6f64cbba
&lt;secret ephemeral=&#39;no&#39; private=&#39;no&#39;&gt;
  &lt;uuid&gt;efade415-5404-4b67-bd1e-165c6f64cbba&lt;/uuid&gt;
  &lt;usage type=&#39;ceph&#39;&gt;
    &lt;name&gt;client.libvirt secret&lt;/name&gt;
  &lt;/usage&gt;
&lt;/secret&gt;
</code></pre>
<h3><span id="554-获取clientlibvirt密钥并将密钥字符串保存到文件中">5.5.4、获取client.libvirt密钥并将密钥字符串保存到文件中。</span></h3><pre><code>[root@node-1 ~]# ceph auth get-key client.libvirt | sudo tee client.libvirt.key
AQBW2hVkmdgYDBAAk/8RRIomBvQ1RjAuwJtRgw==
</code></pre>
<h3><span id="555-设置密钥的-uuid">5.5.5、设置密钥的 UUID。</span></h3><blockquote>
<p>这里的 efade415-5404-4b67-bd1e-165c6f64cbba就是virsh secret-list 获取到的，$(cat client.libvirt.key)就是ceph auth get-key client.libvirt 获取的</p>
</blockquote>
<pre><code>[root@node-1 ~]# sudo virsh secret-set-value --secret efade415-5404-4b67-bd1e-165c6f64cbba --base64 $(cat client.libvirt.key) &amp;&amp; rm client.libvirt.key secret.xml
secret 值设定

rm：是否删除普通文件 &quot;client.libvirt.key&quot;？y
rm：是否删除普通文件 &quot;secret.xml&quot;？y
[root@node-1 ~]#  virsh secret-get-value efade415-5404-4b67-bd1e-165c6f64cbba #查看值
AQBW2hVkmdgYDBAAk/8RRIomBvQ1RjAuwJtRgw==
</code></pre>
<h3><span id="556-修改虚拟机文件增加认证">5.5.6、修改虚拟机文件，增加认证</span></h3><pre><code>增加如下配置，在source和target之间
...
&lt;/source&gt;
&lt;auth username=&#39;libvirt&#39;&gt;
        &lt;secret type=&#39;ceph&#39; uuid=&#39;&#123;uuid of secret&#125;&#39;/&gt;
&lt;/auth&gt;
&lt;target ...
[root@node-1 ~]# virsh edit demo
&lt;domain type=&#39;kvm&#39;&gt;
  &lt;name&gt;demo&lt;/name&gt;
  &lt;uuid&gt;a379dd0c-025c-4fd8-bbe0-0835c9ce03a1&lt;/uuid&gt;
  &lt;memory unit=&#39;KiB&#39;&gt;1048576&lt;/memory&gt;
  &lt;currentMemory unit=&#39;KiB&#39;&gt;1048576&lt;/currentMemory&gt;
  &lt;vcpu placement=&#39;static&#39;&gt;1&lt;/vcpu&gt;
  &lt;os&gt;
    &lt;type arch=&#39;x86_64&#39; machine=&#39;pc-i440fx-rhel7.0.0&#39;&gt;hvm&lt;/type&gt;
    &lt;boot dev=&#39;hd&#39;/&gt;
  &lt;/os&gt;
  &lt;features&gt;
    &lt;acpi/&gt;
    &lt;apic/&gt;
  &lt;/features&gt;
  &lt;cpu mode=&#39;custom&#39; match=&#39;exact&#39; check=&#39;partial&#39;&gt;
    &lt;model fallback=&#39;allow&#39;&gt;Broadwell-noTSX-IBRS&lt;/model&gt;
    &lt;feature policy=&#39;require&#39; name=&#39;md-clear&#39;/&gt;
    &lt;feature policy=&#39;require&#39; name=&#39;spec-ctrl&#39;/&gt;
    &lt;feature policy=&#39;require&#39; name=&#39;ssbd&#39;/&gt;
  &lt;/cpu&gt;
  &lt;clock offset=&#39;utc&#39;&gt;
    &lt;timer name=&#39;rtc&#39; tickpolicy=&#39;catchup&#39;/&gt;
    &lt;timer name=&#39;pit&#39; tickpolicy=&#39;delay&#39;/&gt;
    &lt;timer name=&#39;hpet&#39; present=&#39;no&#39;/&gt;
  &lt;/clock&gt;
  &lt;on_poweroff&gt;destroy&lt;/on_poweroff&gt;
  &lt;on_reboot&gt;restart&lt;/on_reboot&gt;
  &lt;on_crash&gt;destroy&lt;/on_crash&gt;
  &lt;pm&gt;
    &lt;suspend-to-mem enabled=&#39;no&#39;/&gt;
    &lt;suspend-to-disk enabled=&#39;no&#39;/&gt;
  &lt;/pm&gt;
  &lt;devices&gt;
    &lt;emulator&gt;/usr/libexec/qemu-kvm&lt;/emulator&gt;
    &lt;disk type=&#39;file&#39; device=&#39;disk&#39;&gt;
      &lt;driver name=&#39;qemu&#39; type=&#39;qcow2&#39;/&gt;
      &lt;source file=&#39;/var/lib/libvirt/images/demo.img&#39;/&gt;
      &lt;target dev=&#39;hda&#39; bus=&#39;ide&#39;/&gt;
      &lt;address type=&#39;drive&#39; controller=&#39;0&#39; bus=&#39;0&#39; target=&#39;0&#39; unit=&#39;0&#39;/&gt;
    &lt;/disk&gt;
    &lt;disk type=&#39;file&#39; device=&#39;cdrom&#39;&gt;
      &lt;driver name=&#39;qemu&#39; type=&#39;raw&#39;/&gt;
      &lt;target dev=&#39;hdb&#39; bus=&#39;ide&#39;/&gt;
      &lt;readonly/&gt;
      &lt;address type=&#39;drive&#39; controller=&#39;0&#39; bus=&#39;0&#39; target=&#39;0&#39; unit=&#39;1&#39;/&gt;
    &lt;/disk&gt;
    &lt;disk type=&#39;network&#39; device=&#39;disk&#39;&gt;
      &lt;driver name=&#39;qemu&#39; type=&#39;raw&#39;/&gt;
      &lt;source protocol=&#39;rbd&#39; name=&#39;libvirt-pool/new-libvirt-image&#39;&gt;
        &lt;host name=&#39;192.168.187.201&#39; port=&#39;6789&#39;/&gt;
        &lt;host name=&#39;192.168.187.202&#39; port=&#39;6789&#39;/&gt;
        &lt;host name=&#39;192.168.187.203&#39; port=&#39;6789&#39;/&gt;
      &lt;/source&gt;
      &lt;auth username=&#39;libvirt&#39;&gt;
        &lt;secret type=&#39;ceph&#39; uuid=&#39;efade415-5404-4b67-bd1e-165c6f64cbba&#39;/&gt;
      &lt;/auth&gt;
      &lt;target dev=&#39;vdb&#39; bus=&#39;virtio&#39;/&gt;
&quot;/tmp/virshBHe7Hw.xml&quot; 106L, 4003C written
</code></pre>
<h1><span id="六-kvm对接测试及扩容">六、KVM对接测试及扩容</span></h1><h2><span id="61-对接测试">6.1、对接测试</span></h2><pre><code>[root@node-1 ~]# virsh destroy demo  #停机
域 demo 被删除


[root@node-1 ~]# virsh list --all  #查看
 Id    名称                         状态
----------------------------------------------------
 -     demo                           关闭

[root@node-1 ~]# virsh start demo #开机
域 demo 已开始
[root@node-1 ~]# sudo virsh qemu-monitor-command --hmp demo &#39;info block&#39; #查看硬件设备情况，已经能看到drive-virtio-disk1了
drive-ide0-0-0: removable=0 io-status=ok file=/var/lib/libvirt/images/demo.img ro=0 drv=qcow2 encrypted=0 bps=0 bps_rd=0 bps_wr=0 iops=0 iops_rd=0 iops_wr=0
drive-ide0-0-1: removable=1 locked=0 tray-open=0 io-status=ok [not inserted]
drive-virtio-disk1: removable=0 io-status=ok file=rbd:libvirt-pool/new-libvirt-image:id=libvirt:key=AQBW2hVkmdgYDBAAk/8RRIomBvQ1RjAuwJtRgw==:auth_supported=cephx\\;none:mon_host=192.168.187.201\\:6789\\;192.168.187.202\\:6789\\;192.168.187.203\\:6789 ro=0 drv=raw encrypted=0 bps=0 bps_rd=0 bps_wr=0 iops=0 iops_rd=0 iops_wr=0
[root@node-1 ~]# virsh domblklist demo --details #更明显的查看
类型     Device     目标     源
------------------------------------------------
file       disk       hda        /var/lib/libvirt/images/demo.img
file       cdrom      hdb        -
network    disk       vdb        libvirt-pool/new-libvirt-image
</code></pre>
<p><img src="/images/Ceph/Ceph%E4%B8%8EKVM%E9%9B%86%E6%88%90/9.jpg"></p>
<h2><span id="62-扩容大小">6.2、扩容大小</span></h2><blockquote>
<p>扩容完需要重启主机，可以在网上找找文档，怎么避免重启</p>
</blockquote>
<pre><code>[root@node-1 ~]# qemu-img resize rbd:libvirt-pool/new-libvirt-image 5G 
Image resized.
[root@node-1 ~]# qemu-img info rbd:libvirt-pool/new-libvirt-image
image: rbd:libvirt-pool/new-libvirt-image
file format: raw
virtual size: 5.0G (5368709120 bytes)
disk size: unavailable
</code></pre>
<p><img src="/images/Ceph/Ceph%E4%B8%8EKVM%E9%9B%86%E6%88%90/10.jpg"></p>
<h1><span id="七-系统盘存储至ceph也可用于迁移到ceph集群中">七、系统盘存储至Ceph（也可用于迁移到ceph集群中）</span></h1><h2><span id="71-主机停机">7.1、主机停机</span></h2><pre><code>[root@node-1 ~]# virsh destroy demo 
域 demo 被删除
</code></pre>
<h2><span id="72-转换格式存放在ceph集群中">7.2、转换格式存放在ceph集群中</span></h2><pre><code>[root@node-1 ~]# qemu-img convert -f qcow2 /var/lib/libvirt/images/demo.img -O raw rbd:libvirt-pool/demo.img #保留本地镜像，并将格式转换成raw，上传到libvirt-pool中，取名为：demo.img
[root@node-1 ~]# rbd ls libvirt-pool #查看上传成功
demo.img
new-libvirt-image
[root@node-1 ~]# rbd info libvirt-pool/demo.img #查看具体信息
rbd image &#39;demo.img&#39;:
    size 4 GiB in 1024 objects
    order 22 (4 MiB objects)
    snapshot_count: 0
    id: 58f742a8909ec
    block_name_prefix: rbd_data.58f742a8909ec
    format: 2
    features: layering, exclusive-lock, object-map, fast-diff, deep-flatten
    op_features: 
    flags: 
    create_timestamp: Sun Mar 19 00:45:28 2023
    access_timestamp: Sun Mar 19 00:45:28 2023
    modify_timestamp: Sun Mar 19 00:45:28 2023
</code></pre>
<h2><span id="73-修改主机xml文件">7.3、修改主机xml文件</span></h2><pre><code>    &lt;disk type=&#39;network&#39; device=&#39;disk&#39;&gt;
      &lt;driver name=&#39;qemu&#39; type=&#39;raw&#39;/&gt;
      &lt;auth username=&#39;libvirt&#39;&gt;
        &lt;secret type=&#39;ceph&#39; uuid=&#39;efade415-5404-4b67-bd1e-165c6f64cbba&#39;/&gt;
      &lt;/auth&gt;
      &lt;source protocol=&#39;rbd&#39; name=&#39;libvirt-pool/demo.image&#39;&gt;
        &lt;host name=&#39;192.168.187.201&#39; port=&#39;6789&#39;/&gt;
        &lt;host name=&#39;192.168.187.202&#39; port=&#39;6789&#39;/&gt;
        &lt;host name=&#39;192.168.187.203&#39; port=&#39;6789&#39;/&gt;
      &lt;/source&gt;
      &lt;target dev=&#39;hda&#39; bus=&#39;virtio&#39;/&gt;
    &lt;/disk&gt;
[root@node-1 ~]# vim /etc/libvirt/qemu/demo.xml #将原来的sda硬盘的配置替换成ceph的格式
&lt;!--
WARNING: THIS IS AN AUTO-GENERATED FILE. CHANGES TO IT ARE LIKELY TO BE
OVERWRITTEN AND LOST. Changes to this xml configuration should be made using:
  virsh edit demo
or other application using the libvirt API.
--&gt;

&lt;domain type=&#39;kvm&#39;&gt;
  &lt;name&gt;demo&lt;/name&gt;
  &lt;uuid&gt;a379dd0c-025c-4fd8-bbe0-0835c9ce03a1&lt;/uuid&gt;
  &lt;memory unit=&#39;KiB&#39;&gt;1048576&lt;/memory&gt;
  &lt;currentMemory unit=&#39;KiB&#39;&gt;1048576&lt;/currentMemory&gt;
  &lt;vcpu placement=&#39;static&#39;&gt;1&lt;/vcpu&gt;
  &lt;os&gt;
    &lt;type arch=&#39;x86_64&#39; machine=&#39;pc-i440fx-rhel7.0.0&#39;&gt;hvm&lt;/type&gt;
    &lt;boot dev=&#39;hd&#39;/&gt;
  &lt;/os&gt;
  &lt;features&gt;
    &lt;acpi/&gt;
    &lt;apic/&gt;
  &lt;/features&gt;
  &lt;cpu mode=&#39;custom&#39; match=&#39;exact&#39; check=&#39;partial&#39;&gt;
    &lt;model fallback=&#39;allow&#39;&gt;Broadwell-noTSX-IBRS&lt;/model&gt;
    &lt;feature policy=&#39;require&#39; name=&#39;md-clear&#39;/&gt;
    &lt;feature policy=&#39;require&#39; name=&#39;spec-ctrl&#39;/&gt;
    &lt;feature policy=&#39;require&#39; name=&#39;ssbd&#39;/&gt;
  &lt;/cpu&gt;
  &lt;clock offset=&#39;utc&#39;&gt;
    &lt;timer name=&#39;rtc&#39; tickpolicy=&#39;catchup&#39;/&gt;
    &lt;timer name=&#39;pit&#39; tickpolicy=&#39;delay&#39;/&gt;
    &lt;timer name=&#39;hpet&#39; present=&#39;no&#39;/&gt;
  &lt;/clock&gt;
  &lt;on_poweroff&gt;destroy&lt;/on_poweroff&gt;
  &lt;on_reboot&gt;restart&lt;/on_reboot&gt;
  &lt;on_crash&gt;destroy&lt;/on_crash&gt;
  &lt;pm&gt;
    &lt;suspend-to-mem enabled=&#39;no&#39;/&gt;
    &lt;suspend-to-disk enabled=&#39;no&#39;/&gt;
  &lt;/pm&gt;
  &lt;devices&gt;
    &lt;emulator&gt;/usr/libexec/qemu-kvm&lt;/emulator&gt;
    &lt;disk type=&#39;network&#39; device=&#39;disk&#39;&gt;
      &lt;driver name=&#39;qemu&#39; type=&#39;raw&#39;/&gt;
      &lt;auth username=&#39;libvirt&#39;&gt;
        &lt;secret type=&#39;ceph&#39; uuid=&#39;efade415-5404-4b67-bd1e-165c6f64cbba&#39;/&gt;
      &lt;/auth&gt;
      &lt;source protocol=&#39;rbd&#39; name=&#39;libvirt-pool/demo.image&#39;&gt;
        &lt;host name=&#39;192.168.187.201&#39; port=&#39;6789&#39;/&gt;
        &lt;host name=&#39;192.168.187.202&#39; port=&#39;6789&#39;/&gt;
        &lt;host name=&#39;192.168.187.203&#39; port=&#39;6789&#39;/&gt;
      &lt;/source&gt;
      &lt;target dev=&#39;hda&#39; bus=&#39;virtio&#39;/&gt;
    &lt;/disk&gt;
    &lt;disk type=&#39;network&#39; device=&#39;disk&#39;&gt;
      &lt;driver name=&#39;qemu&#39; type=&#39;raw&#39;/&gt;
      &lt;auth username=&#39;libvirt&#39;&gt;
        &lt;secret type=&#39;ceph&#39; uuid=&#39;efade415-5404-4b67-bd1e-165c6f64cbba&#39;/&gt;
      &lt;/auth&gt;
      &lt;source protocol=&#39;rbd&#39; name=&#39;libvirt-pool/new-libvirt-image&#39;&gt;
        &lt;host name=&#39;192.168.187.201&#39; port=&#39;6789&#39;/&gt;
        &lt;host name=&#39;192.168.187.202&#39; port=&#39;6789&#39;/&gt;
        &lt;host name=&#39;192.168.187.203&#39; port=&#39;6789&#39;/&gt;
      &lt;/source&gt;
      &lt;target dev=&#39;vdb&#39; bus=&#39;virtio&#39;/&gt;
      &lt;address type=&#39;pci&#39; domain=&#39;0x0000&#39; bus=&#39;0x00&#39; slot=&#39;0x06&#39; function=&#39;0x0&#39;/&gt;
    &lt;/disk&gt;
    &lt;controller type=&#39;usb&#39; index=&#39;0&#39; model=&#39;ich9-ehci1&#39;&gt;
      &lt;address type=&#39;pci&#39; domain=&#39;0x0000&#39; bus=&#39;0x00&#39; slot=&#39;0x04&#39; function=&#39;0x7&#39;/&gt;
    &lt;/controller&gt;
    &lt;controller type=&#39;usb&#39; index=&#39;0&#39; model=&#39;ich9-uhci1&#39;&gt;
      &lt;master startport=&#39;0&#39;/&gt;
      &lt;address type=&#39;pci&#39; domain=&#39;0x0000&#39; bus=&#39;0x00&#39; slot=&#39;0x04&#39; function=&#39;0x0&#39; multifunction=&#39;on&#39;/&gt;
    &lt;/controller&gt;
    &lt;controller type=&#39;usb&#39; index=&#39;0&#39; model=&#39;ich9-uhci2&#39;&gt;
      &lt;master startport=&#39;2&#39;/&gt;
      &lt;address type=&#39;pci&#39; domain=&#39;0x0000&#39; bus=&#39;0x00&#39; slot=&#39;0x04&#39; function=&#39;0x1&#39;/&gt;
    &lt;/controller&gt;
    &lt;controller type=&#39;usb&#39; index=&#39;0&#39; model=&#39;ich9-uhci3&#39;&gt;
      &lt;master startport=&#39;4&#39;/&gt;
      &lt;address type=&#39;pci&#39; domain=&#39;0x0000&#39; bus=&#39;0x00&#39; slot=&#39;0x04&#39; function=&#39;0x2&#39;/&gt;
    &lt;/controller&gt;
    &lt;controller type=&#39;pci&#39; index=&#39;0&#39; model=&#39;pci-root&#39;/&gt;
    &lt;controller type=&#39;ide&#39; index=&#39;0&#39;&gt;
      &lt;address type=&#39;pci&#39; domain=&#39;0x0000&#39; bus=&#39;0x00&#39; slot=&#39;0x01&#39; function=&#39;0x1&#39;/&gt;
    &lt;/controller&gt;
    &lt;interface type=&#39;network&#39;&gt;
      &lt;mac address=&#39;52:54:00:bf:29:21&#39;/&gt;
      &lt;source network=&#39;default&#39;/&gt;
      &lt;model type=&#39;rtl8139&#39;/&gt;
      &lt;address type=&#39;pci&#39; domain=&#39;0x0000&#39; bus=&#39;0x00&#39; slot=&#39;0x03&#39; function=&#39;0x0&#39;/&gt;
    &lt;/interface&gt;
    &lt;serial type=&#39;pty&#39;&gt;
      &lt;target type=&#39;isa-serial&#39; port=&#39;0&#39;&gt;
        &lt;model name=&#39;isa-serial&#39;/&gt;
      &lt;/target&gt;
    &lt;/serial&gt;
    &lt;console type=&#39;pty&#39;&gt;
      &lt;target type=&#39;serial&#39; port=&#39;0&#39;/&gt;
    &lt;/console&gt;
    &lt;input type=&#39;mouse&#39; bus=&#39;ps2&#39;/&gt;
    &lt;input type=&#39;keyboard&#39; bus=&#39;ps2&#39;/&gt;
    &lt;graphics type=&#39;vnc&#39; port=&#39;-1&#39; autoport=&#39;yes&#39; listen=&#39;0.0.0.0&#39; passwd=&#39;redhat&#39;&gt;
      &lt;listen type=&#39;address&#39; address=&#39;0.0.0.0&#39;/&gt;
    &lt;/graphics&gt;
    &lt;video&gt;
      &lt;model type=&#39;cirrus&#39; vram=&#39;16384&#39; heads=&#39;1&#39; primary=&#39;yes&#39;/&gt;
      &lt;address type=&#39;pci&#39; domain=&#39;0x0000&#39; bus=&#39;0x00&#39; slot=&#39;0x02&#39; function=&#39;0x0&#39;/&gt;
    &lt;/video&gt;
    &lt;memballoon model=&#39;virtio&#39;&gt;
      &lt;address type=&#39;pci&#39; domain=&#39;0x0000&#39; bus=&#39;0x00&#39; slot=&#39;0x05&#39; function=&#39;0x0&#39;/&gt;
    &lt;/memballoon&gt;
  &lt;/devices&gt;
&lt;/domain&gt;
[root@node-1 ~]# virsh start demo #主机开机测试
[root@node-1 ~]# virsh list  #查看运行正常
 Id    名称                         状态
----------------------------------------------------
 6     demo                           running
</code></pre>
<p><strong>主机运行正常，且数据完成迁移；</strong></p>
<p><img src="/images/Ceph/Ceph%E4%B8%8EKVM%E9%9B%86%E6%88%90/11.jpg"></p>
<h1><span id="八-揭秘云主机秒级部署奥秘">八、揭秘云主机秒级部署奥秘</span></h1><h2><span id="81-创建快照">8.1、创建快照</span></h2><pre><code>[root@node-1 ~]# rbd snap create libvirt-pool/demo.img@Centos7-template
[root@node-1 ~]# rbd snap ls libvirt-pool/demo.img
SNAPID NAME             SIZE  PROTECTED TIMESTAMP                
     4 Centos7-template 4 GiB yes       Sun Mar 19 01:02:04 2023
</code></pre>
<h2><span id="82-对快照增加保护">8.2、对快照增加保护</span></h2><pre><code>[root@node-1 ~]# rbd snap protect libvirt-pool/demo.img@Centos7-template
</code></pre>
<h2><span id="83-查看快照保护">8.3、查看快照保护</span></h2><pre><code>[root@node-1 ~]#  rbd info libvirt-pool/demo.img@Centos7-template
rbd image &#39;demo.img&#39;:
    size 4 GiB in 1024 objects
    order 22 (4 MiB objects)
    snapshot_count: 1
    id: 58f742a8909ec
    block_name_prefix: rbd_data.58f742a8909ec
    format: 2
    features: layering, exclusive-lock, object-map, fast-diff, deep-flatten
    op_features: 
    flags: 
    create_timestamp: Sun Mar 19 00:45:28 2023
    access_timestamp: Sun Mar 19 00:45:28 2023
    modify_timestamp: Sun Mar 19 00:45:28 2023 
    protected: True #保护中
</code></pre>
<h2><span id="84-克隆镜像">8.4、克隆镜像</span></h2><pre><code>[root@node-1 ~]# rbd clone libvirt-pool/demo.img@Centos7-template libvirt-pool/clone-vm1.img
[root@node-1 ~]# rbd clone libvirt-pool/demo.img@Centos7-template libvirt-pool/clone-vm2.img
</code></pre>
<h2><span id="85-查看克隆镜像">8.5、查看克隆镜像</span></h2><pre><code>[root@node-1 ~]# rbd info libvirt-pool/clone-vm1.img
rbd image &#39;clone-vm1.img&#39;:
    size 4 GiB in 1024 objects
    order 22 (4 MiB objects)
    snapshot_count: 0
    id: 58ff55e9ad1d0
    block_name_prefix: rbd_data.58ff55e9ad1d0
    format: 2
    features: layering, exclusive-lock, object-map, fast-diff, deep-flatten
    op_features: 
    flags: 
    create_timestamp: Sun Mar 19 01:06:58 2023
    access_timestamp: Sun Mar 19 01:06:58 2023
    modify_timestamp: Sun Mar 19 01:06:58 2023
    parent: libvirt-pool/demo.img@Centos7-template #父镜像
    overlap: 4 GiB
</code></pre>
<h2><span id="86-配置虚拟机xml文件">8.6、配置虚拟机xml文件</span></h2><p>修改配置文件步骤：</p>
<ol>
<li>修改xml中的主机名称</li>
<li>删除UUI的</li>
<li>删除vdb的硬盘配置</li>
<li>修改vba的硬盘配置</li>
</ol>
<pre><code>[root@node-1 ~]# cd /etc/libvirt/qemu/

[root@node-1 qemu]# ls
demo-bak.xml  demo.xml  networks
[root@node-1 qemu]# cp demo.xml clone-vm1.xml 
[root@node-1 qemu]# cp demo.xml clone-vm2.xml
[root@node-1 qemu]# vim clone-vm1.xml
&lt;!--
WARNING: THIS IS AN AUTO-GENERATED FILE. CHANGES TO IT ARE LIKELY TO BE
OVERWRITTEN AND LOST. Changes to this xml configuration should be made using:
  virsh edit demo
or other application using the libvirt API.
--&gt;

&lt;domain type=&#39;kvm&#39;&gt;
  &lt;name&gt;clone-vm1&lt;/name&gt;
  &lt;memory unit=&#39;KiB&#39;&gt;1048576&lt;/memory&gt;
  &lt;currentMemory unit=&#39;KiB&#39;&gt;1048576&lt;/currentMemory&gt;
  &lt;vcpu placement=&#39;static&#39;&gt;1&lt;/vcpu&gt;
  &lt;os&gt;
    &lt;type arch=&#39;x86_64&#39; machine=&#39;pc-i440fx-rhel7.0.0&#39;&gt;hvm&lt;/type&gt;
    &lt;boot dev=&#39;hd&#39;/&gt;
  &lt;/os&gt;
  &lt;features&gt;
    &lt;acpi/&gt;
    &lt;apic/&gt;
  &lt;/features&gt;
  &lt;cpu mode=&#39;custom&#39; match=&#39;exact&#39; check=&#39;partial&#39;&gt;
    &lt;model fallback=&#39;allow&#39;&gt;Broadwell-noTSX-IBRS&lt;/model&gt;
    &lt;feature policy=&#39;require&#39; name=&#39;md-clear&#39;/&gt;
    &lt;feature policy=&#39;require&#39; name=&#39;spec-ctrl&#39;/&gt;
    &lt;feature policy=&#39;require&#39; name=&#39;ssbd&#39;/&gt;
  &lt;/cpu&gt;
  &lt;clock offset=&#39;utc&#39;&gt;
    &lt;timer name=&#39;rtc&#39; tickpolicy=&#39;catchup&#39;/&gt;
    &lt;timer name=&#39;pit&#39; tickpolicy=&#39;delay&#39;/&gt;
    &lt;timer name=&#39;hpet&#39; present=&#39;no&#39;/&gt;
  &lt;/clock&gt;
  &lt;on_poweroff&gt;destroy&lt;/on_poweroff&gt;
  &lt;on_reboot&gt;restart&lt;/on_reboot&gt;
  &lt;on_crash&gt;destroy&lt;/on_crash&gt;
  &lt;pm&gt;
    &lt;suspend-to-mem enabled=&#39;no&#39;/&gt;
    &lt;suspend-to-disk enabled=&#39;no&#39;/&gt;
  &lt;/pm&gt;
  &lt;devices&gt;
    &lt;emulator&gt;/usr/libexec/qemu-kvm&lt;/emulator&gt;
    &lt;disk type=&#39;network&#39; device=&#39;disk&#39;&gt;
      &lt;driver name=&#39;qemu&#39; type=&#39;raw&#39;/&gt;
      &lt;auth username=&#39;libvirt&#39;&gt;
        &lt;secret type=&#39;ceph&#39; uuid=&#39;efade415-5404-4b67-bd1e-165c6f64cbba&#39;/&gt;
      &lt;/auth&gt;
      &lt;source protocol=&#39;rbd&#39; name=&#39;libvirt-pool/clone-vm1.img&#39;&gt;
        &lt;host name=&#39;192.168.187.201&#39; port=&#39;6789&#39;/&gt;
        &lt;host name=&#39;192.168.187.202&#39; port=&#39;6789&#39;/&gt;
        &lt;host name=&#39;192.168.187.203&#39; port=&#39;6789&#39;/&gt;
      &lt;/source&gt;
      &lt;target dev=&#39;hda&#39; bus=&#39;virtio&#39;/&gt;

    &lt;/disk&gt;
    &lt;controller type=&#39;usb&#39; index=&#39;0&#39; model=&#39;ich9-ehci1&#39;&gt;
      &lt;address type=&#39;pci&#39; domain=&#39;0x0000&#39; bus=&#39;0x00&#39; slot=&#39;0x04&#39; function=&#39;0x7&#39;/&gt;
    &lt;/controller&gt;
    &lt;controller type=&#39;usb&#39; index=&#39;0&#39; model=&#39;ich9-uhci1&#39;&gt;
      &lt;master startport=&#39;0&#39;/&gt;
      &lt;address type=&#39;pci&#39; domain=&#39;0x0000&#39; bus=&#39;0x00&#39; slot=&#39;0x04&#39; function=&#39;0x0&#39; multifunction=&#39;on&#39;/&gt;
    &lt;/controller&gt;
    &lt;controller type=&#39;usb&#39; index=&#39;0&#39; model=&#39;ich9-uhci2&#39;&gt;
      &lt;master startport=&#39;2&#39;/&gt;
      &lt;address type=&#39;pci&#39; domain=&#39;0x0000&#39; bus=&#39;0x00&#39; slot=&#39;0x04&#39; function=&#39;0x1&#39;/&gt;
    &lt;/controller&gt;
    &lt;controller type=&#39;usb&#39; index=&#39;0&#39; model=&#39;ich9-uhci3&#39;&gt;
      &lt;master startport=&#39;4&#39;/&gt;
      &lt;address type=&#39;pci&#39; domain=&#39;0x0000&#39; bus=&#39;0x00&#39; slot=&#39;0x04&#39; function=&#39;0x2&#39;/&gt;
    &lt;/controller&gt;
    &lt;controller type=&#39;pci&#39; index=&#39;0&#39; model=&#39;pci-root&#39;/&gt;
    &lt;controller type=&#39;ide&#39; index=&#39;0&#39;&gt;
      &lt;address type=&#39;pci&#39; domain=&#39;0x0000&#39; bus=&#39;0x00&#39; slot=&#39;0x01&#39; function=&#39;0x1&#39;/&gt;
    &lt;/controller&gt;
    &lt;interface type=&#39;network&#39;&gt;
      &lt;mac address=&#39;52:54:00:bf:29:21&#39;/&gt;
      &lt;source network=&#39;default&#39;/&gt;
      &lt;model type=&#39;rtl8139&#39;/&gt;
      &lt;address type=&#39;pci&#39; domain=&#39;0x0000&#39; bus=&#39;0x00&#39; slot=&#39;0x03&#39; function=&#39;0x0&#39;/&gt;
    &lt;/interface&gt;
    &lt;serial type=&#39;pty&#39;&gt;
      &lt;target type=&#39;isa-serial&#39; port=&#39;0&#39;&gt;
        &lt;model name=&#39;isa-serial&#39;/&gt;
      &lt;/target&gt;
    &lt;/serial&gt;
    &lt;console type=&#39;pty&#39;&gt;
      &lt;target type=&#39;serial&#39; port=&#39;0&#39;/&gt;
    &lt;/console&gt;
    &lt;input type=&#39;mouse&#39; bus=&#39;ps2&#39;/&gt;
    &lt;input type=&#39;keyboard&#39; bus=&#39;ps2&#39;/&gt;
    &lt;graphics type=&#39;vnc&#39; port=&#39;-1&#39; autoport=&#39;yes&#39; listen=&#39;0.0.0.0&#39; passwd=&#39;redhat&#39;&gt;
      &lt;listen type=&#39;address&#39; address=&#39;0.0.0.0&#39;/&gt;
    &lt;/graphics&gt;
    &lt;video&gt;
      &lt;model type=&#39;cirrus&#39; vram=&#39;16384&#39; heads=&#39;1&#39; primary=&#39;yes&#39;/&gt;
      &lt;address type=&#39;pci&#39; domain=&#39;0x0000&#39; bus=&#39;0x00&#39; slot=&#39;0x02&#39; function=&#39;0x0&#39;/&gt;
    &lt;/video&gt;
    &lt;memballoon model=&#39;virtio&#39;&gt;
      &lt;address type=&#39;pci&#39; domain=&#39;0x0000&#39; bus=&#39;0x00&#39; slot=&#39;0x05&#39; function=&#39;0x0&#39;/&gt;
    &lt;/memballoon&gt;
  &lt;/devices&gt;
&lt;/domain&gt;

[root@node-1 qemu]# vim clone-vm2.xml
&lt;!--
WARNING: THIS IS AN AUTO-GENERATED FILE. CHANGES TO IT ARE LIKELY TO BE
OVERWRITTEN AND LOST. Changes to this xml configuration should be made using:
  virsh edit demo
or other application using the libvirt API.
--&gt;

&lt;domain type=&#39;kvm&#39;&gt;
  &lt;name&gt;clone-vm2&lt;/name&gt;
  &lt;memory unit=&#39;KiB&#39;&gt;1048576&lt;/memory&gt;
  &lt;currentMemory unit=&#39;KiB&#39;&gt;1048576&lt;/currentMemory&gt;
  &lt;vcpu placement=&#39;static&#39;&gt;1&lt;/vcpu&gt;
  &lt;os&gt;
    &lt;type arch=&#39;x86_64&#39; machine=&#39;pc-i440fx-rhel7.0.0&#39;&gt;hvm&lt;/type&gt;
    &lt;boot dev=&#39;hd&#39;/&gt;
  &lt;/os&gt;
  &lt;features&gt;
    &lt;acpi/&gt;
    &lt;apic/&gt;
  &lt;/features&gt;
  &lt;cpu mode=&#39;custom&#39; match=&#39;exact&#39; check=&#39;partial&#39;&gt;
    &lt;model fallback=&#39;allow&#39;&gt;Broadwell-noTSX-IBRS&lt;/model&gt;
    &lt;feature policy=&#39;require&#39; name=&#39;md-clear&#39;/&gt;
    &lt;feature policy=&#39;require&#39; name=&#39;spec-ctrl&#39;/&gt;
    &lt;feature policy=&#39;require&#39; name=&#39;ssbd&#39;/&gt;
  &lt;/cpu&gt;
  &lt;clock offset=&#39;utc&#39;&gt;
    &lt;timer name=&#39;rtc&#39; tickpolicy=&#39;catchup&#39;/&gt;
    &lt;timer name=&#39;pit&#39; tickpolicy=&#39;delay&#39;/&gt;
    &lt;timer name=&#39;hpet&#39; present=&#39;no&#39;/&gt;
  &lt;/clock&gt;
  &lt;on_poweroff&gt;destroy&lt;/on_poweroff&gt;
  &lt;on_reboot&gt;restart&lt;/on_reboot&gt;
  &lt;on_crash&gt;destroy&lt;/on_crash&gt;
  &lt;pm&gt;
    &lt;suspend-to-mem enabled=&#39;no&#39;/&gt;
    &lt;suspend-to-disk enabled=&#39;no&#39;/&gt;
  &lt;/pm&gt;
  &lt;devices&gt;
    &lt;emulator&gt;/usr/libexec/qemu-kvm&lt;/emulator&gt;
    &lt;disk type=&#39;network&#39; device=&#39;disk&#39;&gt;
      &lt;driver name=&#39;qemu&#39; type=&#39;raw&#39;/&gt;
      &lt;auth username=&#39;libvirt&#39;&gt;
        &lt;secret type=&#39;ceph&#39; uuid=&#39;efade415-5404-4b67-bd1e-165c6f64cbba&#39;/&gt;
      &lt;/auth&gt;
      &lt;source protocol=&#39;rbd&#39; name=&#39;libvirt-pool/clone-vm2.img&#39;&gt;
        &lt;host name=&#39;192.168.187.201&#39; port=&#39;6789&#39;/&gt;
        &lt;host name=&#39;192.168.187.202&#39; port=&#39;6789&#39;/&gt;
        &lt;host name=&#39;192.168.187.203&#39; port=&#39;6789&#39;/&gt;
      &lt;/source&gt;
      &lt;target dev=&#39;hda&#39; bus=&#39;virtio&#39;/&gt;
    &lt;/disk&gt;
    &lt;controller type=&#39;usb&#39; index=&#39;0&#39; model=&#39;ich9-ehci1&#39;&gt;
      &lt;address type=&#39;pci&#39; domain=&#39;0x0000&#39; bus=&#39;0x00&#39; slot=&#39;0x04&#39; function=&#39;0x7&#39;/&gt;
    &lt;/controller&gt;
    &lt;controller type=&#39;usb&#39; index=&#39;0&#39; model=&#39;ich9-uhci1&#39;&gt;
      &lt;master startport=&#39;0&#39;/&gt;
      &lt;address type=&#39;pci&#39; domain=&#39;0x0000&#39; bus=&#39;0x00&#39; slot=&#39;0x04&#39; function=&#39;0x0&#39; multifunction=&#39;on&#39;/&gt;
    &lt;/controller&gt;
    &lt;controller type=&#39;usb&#39; index=&#39;0&#39; model=&#39;ich9-uhci2&#39;&gt;
      &lt;master startport=&#39;2&#39;/&gt;
      &lt;address type=&#39;pci&#39; domain=&#39;0x0000&#39; bus=&#39;0x00&#39; slot=&#39;0x04&#39; function=&#39;0x1&#39;/&gt;
    &lt;/controller&gt;
    &lt;controller type=&#39;usb&#39; index=&#39;0&#39; model=&#39;ich9-uhci3&#39;&gt;
      &lt;master startport=&#39;4&#39;/&gt;
      &lt;address type=&#39;pci&#39; domain=&#39;0x0000&#39; bus=&#39;0x00&#39; slot=&#39;0x04&#39; function=&#39;0x2&#39;/&gt;
    &lt;/controller&gt;
    &lt;controller type=&#39;pci&#39; index=&#39;0&#39; model=&#39;pci-root&#39;/&gt;
    &lt;controller type=&#39;ide&#39; index=&#39;0&#39;&gt;
      &lt;address type=&#39;pci&#39; domain=&#39;0x0000&#39; bus=&#39;0x00&#39; slot=&#39;0x01&#39; function=&#39;0x1&#39;/&gt;
    &lt;/controller&gt;
    &lt;interface type=&#39;network&#39;&gt;
      &lt;mac address=&#39;52:54:00:bf:29:21&#39;/&gt;
      &lt;source network=&#39;default&#39;/&gt;
      &lt;model type=&#39;rtl8139&#39;/&gt;
      &lt;address type=&#39;pci&#39; domain=&#39;0x0000&#39; bus=&#39;0x00&#39; slot=&#39;0x03&#39; function=&#39;0x0&#39;/&gt;
    &lt;/interface&gt;
    &lt;serial type=&#39;pty&#39;&gt;
      &lt;target type=&#39;isa-serial&#39; port=&#39;0&#39;&gt;
        &lt;model name=&#39;isa-serial&#39;/&gt;
      &lt;/target&gt;
    &lt;/serial&gt;
    &lt;console type=&#39;pty&#39;&gt;
      &lt;target type=&#39;serial&#39; port=&#39;0&#39;/&gt;
    &lt;/console&gt;
    &lt;input type=&#39;mouse&#39; bus=&#39;ps2&#39;/&gt;
    &lt;input type=&#39;keyboard&#39; bus=&#39;ps2&#39;/&gt;
    &lt;graphics type=&#39;vnc&#39; port=&#39;-1&#39; autoport=&#39;yes&#39; listen=&#39;0.0.0.0&#39; passwd=&#39;redhat&#39;&gt;
      &lt;listen type=&#39;address&#39; address=&#39;0.0.0.0&#39;/&gt;
    &lt;/graphics&gt;
    &lt;video&gt;
      &lt;model type=&#39;cirrus&#39; vram=&#39;16384&#39; heads=&#39;1&#39; primary=&#39;yes&#39;/&gt;
      &lt;address type=&#39;pci&#39; domain=&#39;0x0000&#39; bus=&#39;0x00&#39; slot=&#39;0x02&#39; function=&#39;0x0&#39;/&gt;
    &lt;/video&gt;
    &lt;memballoon model=&#39;virtio&#39;&gt;
      &lt;address type=&#39;pci&#39; domain=&#39;0x0000&#39; bus=&#39;0x00&#39; slot=&#39;0x05&#39; function=&#39;0x0&#39;/&gt;
    &lt;/memballoon&gt;
  &lt;/devices&gt;
&lt;/domain&gt;
</code></pre>
<h2><span id="87-引入xml文件">8.7、引入XML文件</span></h2><pre><code>[root@node-1 qemu]# virsh define clone-vm1.xml 
定义域 clone-vm1（从 clone-vm1.xml）
[root@node-1 qemu]# virsh define clone-vm2.xml 
定义域 clone-vm2（从 clone-vm2.xml）
</code></pre>
<h2><span id="88-开机并测试">8.8、开机并测试</span></h2><pre><code>[root@node-1 qemu]# virsh list --all 
 Id    名称                         状态
----------------------------------------------------
 6     demo                           running
 -     clone-vm1                      关闭
 -     clone-vm2                      关闭


[root@node-1 qemu]# virsh start clone-vm1
域 clone-vm1 已开始

[root@node-1 qemu]# virsh start clone-vm2
域 clone-vm2 已开始

[root@node-1 qemu]# virsh domblklist clone-vm1 
目标     源
------------------------------------------------
hda        libvirt-pool/clone-vm1.img


[root@node-1 qemu]# virsh domblklist clone-vm2
目标     源
------------------------------------------------
hda        libvirt-pool/clone-vm2.img

[root@node-1 qemu]# virsh vncdisplay clone-vm1
:1

[root@node-1 qemu]# virsh vncdisplay clone-vm2
:2
</code></pre>
<p><img src="/images/Ceph/Ceph%E4%B8%8EKVM%E9%9B%86%E6%88%90/12.jpg"><br><img src="/images/Ceph/Ceph%E4%B8%8EKVM%E9%9B%86%E6%88%90/13.jpg"></p>
<script type="text&#x2F;javascript" src="https://unpkg.com/kity@2.0.4/dist/kity.min.js"></script><script type="text&#x2F;javascript" src="https://unpkg.com/kityminder-core@1.4.50/dist/kityminder.core.min.js"></script><script defer="true" type="text&#x2F;javascript" src="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.js"></script><link rel="stylesheet" type="text&#x2F;css" href="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.css">
        </article>

        
            
  <div class="nexmoe-post-copyright">
    <strong>Author：</strong>张博丞<br>
    
      <strong>From：</strong><a href="/%E5%8E%9F%E5%88%9B" title="原创" target="_blank" rel="noopener">原创</a><br>
    
    <strong>Link：</strong><a href="https://zhangboc.github.io/2023/04/20/Ceph/14.Ceph%E4%B8%8EKVM%E9%9B%86%E6%88%90/Ceph%E4%B8%8EKVM%E9%9B%86%E6%88%90/" title="https:&#x2F;&#x2F;zhangboc.github.io&#x2F;2023&#x2F;04&#x2F;20&#x2F;Ceph&#x2F;14.Ceph%E4%B8%8EKVM%E9%9B%86%E6%88%90&#x2F;Ceph%E4%B8%8EKVM%E9%9B%86%E6%88%90&#x2F;" target="_blank" rel="noopener">https:&#x2F;&#x2F;zhangboc.github.io&#x2F;2023&#x2F;04&#x2F;20&#x2F;Ceph&#x2F;14.Ceph%E4%B8%8EKVM%E9%9B%86%E6%88%90&#x2F;Ceph%E4%B8%8EKVM%E9%9B%86%E6%88%90&#x2F;</a><br>

    
      <strong>版权声明：</strong>本文采用 <a href="https://creativecommons.org/licenses/by-nc-sa/3.0/cn/deed.zh" target="_blank">CC BY-NC-SA 3.0 CN</a> 协议进行许可
    
  </div>


        

        <div class="nexmoe-post-meta nexmoe-rainbow">
    
        <a class="nexmoefont icon-appstore-fill -link" href="/categories/KVM/">KVM</a><a class="nexmoefont icon-appstore-fill -link" href="/categories/KVM/Ceph/">Ceph</a>
    
    
        <a class="nexmoefont icon-tag-fill -none-link" href="/tags/Ceph/" rel="tag">Ceph</a> <a class="nexmoefont icon-tag-fill -none-link" href="/tags/KVM/" rel="tag">KVM</a>
    
</div>

    <div class="nexmoe-post-footer">
        <section class="nexmoe-comment">
    <div class="valine"></div>
<script src='https://lib.baomitu.com/valine/1.3.9/Valine.min.js'></script>
<script>
    // 使用方法 https://valine.js.org/quickstart.html
    new Valine({
        el: '.valine',
        appId: 'r5zxC0st0DDjPA9auXzMV7HY-gzGzoHsz',
        appKey: '3bqCsovpyfTPHUzTHovd3V3V'
    })
</script>
</section>
    </div>
</div>
<script type="text/javascript" src="/libs/codeBlock/codeBlockFuction.js"></script>
<!-- 代码语言 -->
<script type="text/javascript" src="/libs/codeBlock/codeLang.js"></script>
<!-- 代码块复制 -->
<script type="text/javascript" src="/libs/codeBlock/codeCopy.js"></script>
<script type="text/javascript" src="/libs/codeBlock/clipboard.min.js"></script>
<!-- 代码块收缩 -->
<script type="text/javascript" src="/libs/codeBlock/codeShrink.js"></script> 
<!-- 代码块折行 -->
<style type="text/css">code[class*="language-"], pre[class*="language-"] { white-space: pre !important; }</style>

        <div class="nexmoe-post-right">
          
            <div class="nexmoe-fixed">
              <div class="nexmoe-tool">
                <a href="#" aria-label="回到顶部" title="top"><button class="mdui-fab mdui-ripple"><i class="nexmoefont icon-caret-top"></i></button></a>
              </div>
            </div>
          
        </div>
    </div>
  </div>
  <div id="nexmoe-pendant">
    <div class="nexmoe-drawer mdui-drawer nexmoe-pd" id="drawer">
        
            <div class="nexmoe-pd-item">
                <div class="clock">
        <div class="memory"></div>
        <div class="memory"></div>
        <div class="memory"></div>
        <div class="memory"></div>
        <div class="memory"></div>
        <div class="memory"></div>
        <div class="memory"></div>
        <div class="memory"></div>
        <div class="memory"></div>
        <div class="memory"></div>
        <div class="memory"></div>
        <div class="memory"></div>
        <div class="memory"></div>
        <div class="memory"></div>
        <div class="memory"></div>
        <div class="memory"></div>
        <div class="memory"></div>
        <div class="memory"></div>
        <div class="memory"></div>
        <div class="memory"></div>
        <div class="memory"></div>
        <div class="memory"></div>
        <div class="memory"></div>
        <div class="memory"></div>
        <div class="memory"></div>
        <div class="memory"></div>
        <div class="memory"></div>
        <div class="memory"></div>
        <div class="memory"></div>
        <div class="memory"></div>
        <div class="memory"></div>
        <div class="memory"></div>
        <div class="memory"></div>
        <div class="memory"></div>
        <div class="memory"></div>
        <div class="memory"></div>
        <div class="memory"></div>
        <div class="memory"></div>
        <div class="memory"></div>
        <div class="memory"></div>
        <div class="memory"></div>
        <div class="memory"></div>
        <div class="memory"></div>
        <div class="memory"></div>
        <div class="memory"></div>
        <div class="memory"></div>
        <div class="memory"></div>
        <div class="memory"></div>
        <div class="memory"></div>
        <div class="memory"></div>
        <div class="memory"></div>
        <div class="memory"></div>
        <div class="memory"></div>
        <div class="memory"></div>
        <div class="memory"></div>
        <div class="memory"></div>
        <div class="memory"></div>
        <div class="memory"></div>
        <div class="memory"></div>
        <div class="memory"></div>
        <div class="needle" id="hours"></div>
        <div class="needle" id="minutes"></div>
        <div class="needle" id="seconds"></div>
        <div class="clock_logo">

        </div>

    </div>
<style>
    .clock {
        background-color: #ffffff;
        width: 70vw;
        height: 70vw;
        max-width: 70vh;
        max-height: 70vh;
        border: solid 2.8vw #242424;
        position: relative;
        overflow: hidden;
        border-radius: 50%;
        box-sizing: border-box;
        box-shadow: 0 1.4vw 2.8vw rgba(0, 0, 0, 0.8);
        zoom:0.2
    }

    .memory {
        position: absolute;
        top: 50%;
        left: 50%;
        transform-origin: center;
    }

    .memory:nth-child(1) {
        background-color: #424242;
        width: 2%;
        height: 8%;
        transform: translate(-50%, -50%) rotate(0deg) translateY(-520%);
    }

    .memory:nth-child(2) {
        background-color: #949494;
        width: 1%;
        height: 3%;
        transform: translate(-50%, -50%) rotate(6deg) translateY(-1461%);
    }

    .memory:nth-child(3) {
        background-color: #949494;
        width: 1%;
        height: 3%;
        transform: translate(-50%, -50%) rotate(12deg) translateY(-1461%);
    }

    .memory:nth-child(4) {
        background-color: #949494;
        width: 1%;
        height: 3%;
        transform: translate(-50%, -50%) rotate(18deg) translateY(-1461%);
    }

    .memory:nth-child(5) {
        background-color: #949494;
        width: 1%;
        height: 3%;
        transform: translate(-50%, -50%) rotate(24deg) translateY(-1461%);
    }

    .memory:nth-child(6) {
        background-color: #424242;
        width: 2%;
        height: 8%;
        transform: translate(-50%, -50%) rotate(30deg) translateY(-520%);
    }

    .memory:nth-child(7) {
        background-color: #949494;
        width: 1%;
        height: 3%;
        transform: translate(-50%, -50%) rotate(36deg) translateY(-1461%);
    }

    .memory:nth-child(8) {
        background-color: #949494;
        width: 1%;
        height: 3%;
        transform: translate(-50%, -50%) rotate(42deg) translateY(-1461%);
    }

    .memory:nth-child(9) {
        background-color: #949494;
        width: 1%;
        height: 3%;
        transform: translate(-50%, -50%) rotate(48deg) translateY(-1461%);
    }

    .memory:nth-child(10) {
        background-color: #949494;
        width: 1%;
        height: 3%;
        transform: translate(-50%, -50%) rotate(54deg) translateY(-1461%);
    }

    .memory:nth-child(11) {
        background-color: #424242;
        width: 2%;
        height: 8%;
        transform: translate(-50%, -50%) rotate(60deg) translateY(-520%);
    }

    .memory:nth-child(12) {
        background-color: #949494;
        width: 1%;
        height: 3%;
        transform: translate(-50%, -50%) rotate(66deg) translateY(-1461%);
    }

    .memory:nth-child(13) {
        background-color: #949494;
        width: 1%;
        height: 3%;
        transform: translate(-50%, -50%) rotate(72deg) translateY(-1461%);
    }

    .memory:nth-child(14) {
        background-color: #949494;
        width: 1%;
        height: 3%;
        transform: translate(-50%, -50%) rotate(78deg) translateY(-1461%);
    }

    .memory:nth-child(15) {
        background-color: #949494;
        width: 1%;
        height: 3%;
        transform: translate(-50%, -50%) rotate(84deg) translateY(-1461%);
    }

    .memory:nth-child(16) {
        background-color: #424242;
        width: 2%;
        height: 8%;
        transform: translate(-50%, -50%) rotate(90deg) translateY(-520%);
    }

    .memory:nth-child(17) {
        background-color: #949494;
        width: 1%;
        height: 3%;
        transform: translate(-50%, -50%) rotate(96deg) translateY(-1461%);
    }

    .memory:nth-child(18) {
        background-color: #949494;
        width: 1%;
        height: 3%;
        transform: translate(-50%, -50%) rotate(102deg) translateY(-1461%);
    }

    .memory:nth-child(19) {
        background-color: #949494;
        width: 1%;
        height: 3%;
        transform: translate(-50%, -50%) rotate(108deg) translateY(-1461%);
    }

    .memory:nth-child(20) {
        background-color: #949494;
        width: 1%;
        height: 3%;
        transform: translate(-50%, -50%) rotate(114deg) translateY(-1461%);
    }

    .memory:nth-child(21) {
        background-color: #424242;
        width: 2%;
        height: 8%;
        transform: translate(-50%, -50%) rotate(120deg) translateY(-520%);
    }

    .memory:nth-child(22) {
        background-color: #949494;
        width: 1%;
        height: 3%;
        transform: translate(-50%, -50%) rotate(126deg) translateY(-1461%);
    }

    .memory:nth-child(23) {
        background-color: #949494;
        width: 1%;
        height: 3%;
        transform: translate(-50%, -50%) rotate(132deg) translateY(-1461%);
    }

    .memory:nth-child(24) {
        background-color: #949494;
        width: 1%;
        height: 3%;
        transform: translate(-50%, -50%) rotate(138deg) translateY(-1461%);
    }

    .memory:nth-child(25) {
        background-color: #949494;
        width: 1%;
        height: 3%;
        transform: translate(-50%, -50%) rotate(144deg) translateY(-1461%);
    }

    .memory:nth-child(26) {
        background-color: #424242;
        width: 2%;
        height: 8%;
        transform: translate(-50%, -50%) rotate(150deg) translateY(-520%);
    }

    .memory:nth-child(27) {
        background-color: #949494;
        width: 1%;
        height: 3%;
        transform: translate(-50%, -50%) rotate(156deg) translateY(-1461%);
    }

    .memory:nth-child(28) {
        background-color: #949494;
        width: 1%;
        height: 3%;
        transform: translate(-50%, -50%) rotate(162deg) translateY(-1461%);
    }

    .memory:nth-child(29) {
        background-color: #949494;
        width: 1%;
        height: 3%;
        transform: translate(-50%, -50%) rotate(168deg) translateY(-1461%);
    }

    .memory:nth-child(30) {
        background-color: #949494;
        width: 1%;
        height: 3%;
        transform: translate(-50%, -50%) rotate(174deg) translateY(-1461%);
    }

    .memory:nth-child(31) {
        background-color: #424242;
        width: 2%;
        height: 8%;
        transform: translate(-50%, -50%) rotate(180deg) translateY(-520%);
    }

    .memory:nth-child(32) {
        background-color: #949494;
        width: 1%;
        height: 3%;
        transform: translate(-50%, -50%) rotate(186deg) translateY(-1461%);
    }

    .memory:nth-child(33) {
        background-color: #949494;
        width: 1%;
        height: 3%;
        transform: translate(-50%, -50%) rotate(192deg) translateY(-1461%);
    }

    .memory:nth-child(34) {
        background-color: #949494;
        width: 1%;
        height: 3%;
        transform: translate(-50%, -50%) rotate(198deg) translateY(-1461%);
    }

    .memory:nth-child(35) {
        background-color: #949494;
        width: 1%;
        height: 3%;
        transform: translate(-50%, -50%) rotate(204deg) translateY(-1461%);
    }

    .memory:nth-child(36) {
        background-color: #424242;
        width: 2%;
        height: 8%;
        transform: translate(-50%, -50%) rotate(210deg) translateY(-520%);
    }

    .memory:nth-child(37) {
        background-color: #949494;
        width: 1%;
        height: 3%;
        transform: translate(-50%, -50%) rotate(216deg) translateY(-1461%);
    }

    .memory:nth-child(38) {
        background-color: #949494;
        width: 1%;
        height: 3%;
        transform: translate(-50%, -50%) rotate(222deg) translateY(-1461%);
    }

    .memory:nth-child(39) {
        background-color: #949494;
        width: 1%;
        height: 3%;
        transform: translate(-50%, -50%) rotate(228deg) translateY(-1461%);
    }

    .memory:nth-child(40) {
        background-color: #949494;
        width: 1%;
        height: 3%;
        transform: translate(-50%, -50%) rotate(234deg) translateY(-1461%);
    }

    .memory:nth-child(41) {
        background-color: #424242;
        width: 2%;
        height: 8%;
        transform: translate(-50%, -50%) rotate(240deg) translateY(-520%);
    }

    .memory:nth-child(42) {
        background-color: #949494;
        width: 1%;
        height: 3%;
        transform: translate(-50%, -50%) rotate(246deg) translateY(-1461%);
    }

    .memory:nth-child(43) {
        background-color: #949494;
        width: 1%;
        height: 3%;
        transform: translate(-50%, -50%) rotate(252deg) translateY(-1461%);
    }

    .memory:nth-child(44) {
        background-color: #949494;
        width: 1%;
        height: 3%;
        transform: translate(-50%, -50%) rotate(258deg) translateY(-1461%);
    }

    .memory:nth-child(45) {
        background-color: #949494;
        width: 1%;
        height: 3%;
        transform: translate(-50%, -50%) rotate(264deg) translateY(-1461%);
    }

    .memory:nth-child(46) {
        background-color: #424242;
        width: 2%;
        height: 8%;
        transform: translate(-50%, -50%) rotate(270deg) translateY(-520%);
    }

    .memory:nth-child(47) {
        background-color: #949494;
        width: 1%;
        height: 3%;
        transform: translate(-50%, -50%) rotate(276deg) translateY(-1461%);
    }

    .memory:nth-child(48) {
        background-color: #949494;
        width: 1%;
        height: 3%;
        transform: translate(-50%, -50%) rotate(282deg) translateY(-1461%);
    }

    .memory:nth-child(49) {
        background-color: #949494;
        width: 1%;
        height: 3%;
        transform: translate(-50%, -50%) rotate(288deg) translateY(-1461%);
    }

    .memory:nth-child(50) {
        background-color: #949494;
        width: 1%;
        height: 3%;
        transform: translate(-50%, -50%) rotate(294deg) translateY(-1461%);
    }

    .memory:nth-child(51) {
        background-color: #424242;
        width: 2%;
        height: 8%;
        transform: translate(-50%, -50%) rotate(300deg) translateY(-520%);
    }

    .memory:nth-child(52) {
        background-color: #949494;
        width: 1%;
        height: 3%;
        transform: translate(-50%, -50%) rotate(306deg) translateY(-1461%);
    }

    .memory:nth-child(53) {
        background-color: #949494;
        width: 1%;
        height: 3%;
        transform: translate(-50%, -50%) rotate(312deg) translateY(-1461%);
    }

    .memory:nth-child(54) {
        background-color: #949494;
        width: 1%;
        height: 3%;
        transform: translate(-50%, -50%) rotate(318deg) translateY(-1461%);
    }

    .memory:nth-child(55) {
        background-color: #949494;
        width: 1%;
        height: 3%;
        transform: translate(-50%, -50%) rotate(324deg) translateY(-1461%);
    }

    .memory:nth-child(56) {
        background-color: #424242;
        width: 2%;
        height: 8%;
        transform: translate(-50%, -50%) rotate(330deg) translateY(-520%);
    }

    .memory:nth-child(57) {
        background-color: #949494;
        width: 1%;
        height: 3%;
        transform: translate(-50%, -50%) rotate(336deg) translateY(-1461%);
    }

    .memory:nth-child(58) {
        background-color: #949494;
        width: 1%;
        height: 3%;
        transform: translate(-50%, -50%) rotate(342deg) translateY(-1461%);
    }

    .memory:nth-child(59) {
        background-color: #949494;
        width: 1%;
        height: 3%;
        transform: translate(-50%, -50%) rotate(348deg) translateY(-1461%);
    }

    .memory:nth-child(60) {
        background-color: #949494;
        width: 1%;
        height: 3%;
        transform: translate(-50%, -50%) rotate(354deg) translateY(-1461%);
    }

    .needle {
        position: absolute;
        top: 50%;
        left: 50%;
        transform-origin: center;
    }

    .needle#hours {
        background-color: #1f1f1f;
        width: 4%;
        height: 30%;
        transform-origin: center 75%;
        transform: translate(-50%, -75%);
    }

    .needle#hours.moving {
        transition: transform 150ms ease-out;
    }

    .needle#hours:after {
        content: '';
        background-color: #1f1f1f;
        width: 4vw;
        height: 4vw;
        max-width: 4vh;
        max-height: 4vh;
        display: block;
        position: absolute;
        top: 75%;
        left: 50%;
        box-sizing: border-box;
        border-radius: 50%;
        transform: translate(-50%, -50%);
    }

    .needle#minutes {
        background-color: #1f1f1f;
        width: 2%;
        height: 45%;
        transform-origin: center 75%;
        transform: translate(-50%, -75%);
    }

    .needle#minutes.moving {
        transition: transform 150ms ease-out;
    }

    .needle#minutes:after {
        content: '';
        background-color: #1f1f1f;
        width: 4vw;
        height: 4vw;
        max-width: 4vh;
        max-height: 4vh;
        display: block;
        position: absolute;
        top: 75%;
        left: 50%;
        box-sizing: border-box;
        border-radius: 50%;
        transform: translate(-50%, -50%);
    }

    .needle#seconds {
        background-color: #cb2f2f;
        width: 1%;
        height: 50%;
        transform-origin: center 75%;
        transform: translate(-50%, -75%);
    }

    .needle#seconds.moving {
        transition: transform 150ms ease-out;
    }

    .needle#seconds:after {
        content: '';
        background-color: #cb2f2f;
        width: 2.5vw;
        height: 2.5vw;
        max-width: 2.5vh;
        max-height: 2.5vh;
        display: block;
        position: absolute;
        top: 75%;
        left: 50%;
        box-sizing: border-box;
        border-radius: 50%;
        transform: translate(-50%, -50%);
    }
    .clock_logo{
        width: 10vw;
        height: 10vw;
        max-width: 10vh;
        max-height: 10vh;
        position: absolute;
        top: 50%;
        left: 50%;
        box-sizing: border-box;
        border-radius: 50%;
        transform: translate(-50%, -50%);
        background-size: 100% 100%;
        background-repeat: no-repeat;
    }
    @media (min-width: 100vh) {
        .clock {
            border: solid 2.8vh #242424;
            box-shadow: 0 1.4vh 2.8vh rgba(0, 0, 0, 0.8);
        }
    }

</style>





            </div>
        
            <div class="nexmoe-pd-item">
                <div class="qweather" >
    <div id="he-plugin-standard"></div>
    <div class="qweather-logo">

    </div>

</div>
<style>
    .qweather{
        position: relative;
    }
    .qweather-logo{
        position: absolute;
        right: 0;
        top: -15px;
        width: 40px;
        height: 40px;
        background-size: 100% 100%;
        background-repeat: no-repeat;
    }
</style>
<script>
  WIDGET = {
    "CONFIG": {
      "layout": "2",
      "width": "260",
      "height": "220",
      "background": "5",
      "dataColor": "e67249",
      "borderRadius": "15",
      "key": "f74d1e1690e6432d801e97fa2f05a162"
    }
  }
</script>
<script src="https://widget.qweather.net/standard/static/js/he-standard-common.js?v=2.0"></script>

            </div>
        
</div>
<style>
    .nexmoe-pd {
        left: auto;
        top: 40px;
        right: 0;
    }
    .nexmoe-pd-item{
       display: flex;
        justify-content: center;
        margin-bottom: 30px;
    }
</style>

  </div>
  <script src="https://lib.baomitu.com/lazysizes/5.1.0/lazysizes.min.js"></script>
<script src="https://lib.baomitu.com/highlight.js/10.0.0/highlight.min.js"></script>
<script src="https://lib.baomitu.com/mdui/0.4.3/js/mdui.min.js"></script>

<script>
	hljs.initHighlightingOnLoad();
</script>

<script src="https://lib.baomitu.com/jquery/3.5.1/jquery.slim.min.js"></script>
<script src="/lib/fancybox/js/jquery.fancybox.min.js"></script>


<script src="/js/app.js?v=1682237265522"></script>

<script src="https://lib.baomitu.com/justifiedGallery/3.8.1/js/jquery.justifiedGallery.min.js"></script>
<script>
	$(".justified-gallery").justifiedGallery({
		rowHeight: 160,
		margins: 10,
	});
</script>

  





<!-- hexo injector body_end start -->
<script src="/js/clock.js"></script>

<script src="https://lib.baomitu.com/clipboard.js/2.0.8/clipboard.min.js"></script>

<script src="/lib/codeBlock/codeBlockFuction.js"></script>

<script src="/lib/codeBlock/codeLang.js"></script>

<script src="/lib/codeBlock/codeCopy.js"></script>

<script src="/lib/codeBlock/codeShrink.js"></script>

<link rel="stylesheet" href="/lib/codeBlock/matery.css">

<script src="https://code.jquery.com/jquery-3.6.0.js"></script>

<script src="/js/search.js"></script>

<script src="/js/webapp.js"></script>
<!-- hexo injector body_end end --><script src="/live2D/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2D/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"debug":true,"model":{"jsonPath":"/live2D/assets/xiaomai.model.json"},"display":{"position":"left","width":150,"height":300},"mobile":{"show":true},"react":{"opacity":1},"log":false});</script></body>
</html>

<script>(function(i,s,o,g,r,a,m){i["DaoVoiceObject"]=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;a.charset="utf-8";m.parentNode.insertBefore(a,m)})(window,document,"script",('https:' == document.location.protocol ? 'https:' : 'http:') + "//widget.daovoice.io/widget/5e784416.js","daovoice")</script>
<script>
  daovoice('init', {
    app_id: "5e784416"
  });
  daovoice('update');
</script>

